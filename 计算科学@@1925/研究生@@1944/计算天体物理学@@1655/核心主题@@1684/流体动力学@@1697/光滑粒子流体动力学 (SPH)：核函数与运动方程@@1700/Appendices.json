{"hands_on_practices": [{"introduction": "在光滑粒子流体动力学（SPH）中，光滑核函数是方法的核心。本练习将通过一个基础但至关重要的计算，来加深您对核函数归一化属性的理解。我们将关注应用最广泛的三维三次样条核函数，通过直接积分来推导其归一化常数，这是确保SPH模拟质量守恒和提供单位分解的关键一步。", "problem": "在三维光滑粒子流体动力学 (SPH) 中，光滑核函数 $W(\\mathbf{r},h)$ 要求是非负、紧支、径向对称且归一化的，使得其在全空间上的体积分为1，即满足 $\\int W(\\mathbf{r},h)\\,d^{3}\\mathbf{r}=1$。考虑广泛使用的支持半径为 $2h$ 的三次样条（也称为 $M_{4}$）核函数，它由无量纲半径 $q=r/h$ 定义为\n$$\nW(r,h)=\\sigma\\,h^{-3}\\,f(q),\\quad q=\\frac{r}{h},\n$$\n其中分段函数为\n$$\nf(q)=\\begin{cases}\n1-\\frac{3}{2}q^{2}+\\frac{3}{4}q^{3},  0 \\le q  1 \\\\\n\\frac{1}{4}(2-q)^{3},  1 \\le q  2 \\\\\n0,  q \\ge 2\n\\end{cases}\n$$\n从归一化要求和适当的三维体积积分出发，推导归一化常数 $\\sigma$，以确保 $\\int W(\\mathbf{r},h)\\,d^{3}\\mathbf{r}=1$。你的推导过程应仅使用基本原理（径向对称性、变量替换和归一化条件），并必须明确计算所有必要的积分。明确验证所得的核函数对于任意光滑长度 $h$ 都满足归一化条件。以闭式解析表达式的形式给出 $\\sigma$ 的最终答案。不需要进行数值近似，也不需要取整。", "solution": "在三维空间中，球对称核函数的归一化条件是\n$$\n\\int_{\\mathbb{R}^{3}} W(\\mathbf{r},h)\\,d^{3}\\mathbf{r} \\;=\\; 4\\pi\\int_{0}^{\\infty} W(r,h)\\,r^{2}\\,dr \\;=\\; 1.\n$$\n已知 $W(r,h)=\\sigma\\,h^{-3}\\,f(q)$，其中 $q=r/h$，且当 $q\\ge 2$ 时 $f(q)=0$，因此径向积分是紧支的，变为\n$$\n4\\pi\\int_{0}^{2h} \\sigma\\,h^{-3}\\,f\\!\\left(\\frac{r}{h}\\right)\\,r^{2}\\,dr.\n$$\n引入变量替换 $q=r/h$，从而 $r=hq$ 且 $dr=h\\,dq$。那么 $r^{2}=h^{2}q^{2}$，积分变换为\n$$\n4\\pi\\int_{0}^{2} \\sigma\\,h^{-3}\\,f(q)\\,(h^{2}q^{2})\\,(h\\,dq)\n\\;=\\;\n4\\pi\\,\\sigma\\int_{0}^{2} f(q)\\,q^{2}\\,dq.\n$$\n因此归一化条件简化为\n$$\n4\\pi\\,\\sigma\\int_{0}^{2} f(q)\\,q^{2}\\,dq \\;=\\; 1,\n$$\n从而\n$$\n\\sigma \\;=\\; \\frac{1}{4\\pi}\\left[\\int_{0}^{2} f(q)\\,q^{2}\\,dq\\right]^{-1}.\n$$\n我们现在通过在 $q=1$ 处拆分来计算积分 $I=\\int_{0}^{2} f(q)\\,q^{2}\\,dq$：\n$$\nI \\;=\\; \\int_{0}^{1} \\left(1-\\frac{3}{2}q^{2}+\\frac{3}{4}q^{3}\\right)q^{2}\\,dq\n\\;+\\;\n\\int_{1}^{2} \\frac{1}{4}(2-q)^{3} q^{2}\\,dq.\n$$\n计算第一个积分 $I_{1}$：\n$$\nI_{1} \\;=\\; \\int_{0}^{1}\\left(q^{2}-\\frac{3}{2}q^{4}+\\frac{3}{4}q^{5}\\right)\\,dq\n\\;=\\;\n\\left[\\frac{q^{3}}{3}-\\frac{3}{2}\\cdot\\frac{q^{5}}{5}+\\frac{3}{4}\\cdot\\frac{q^{6}}{6}\\right]_{0}^{1}\n\\;=\\;\n\\frac{1}{3}-\\frac{3}{10}+\\frac{1}{8}.\n$$\n通分后，可得\n$$\nI_{1} \\;=\\; \\frac{40}{120}-\\frac{36}{120}+\\frac{15}{120} \\;=\\; \\frac{19}{120}.\n$$\n通过展开被积函数来计算第二个积分 $I_{2}$：\n$$\n(2-q)^{3}=8-12q+6q^{2}-q^{3},\\quad\n\\frac{1}{4}(2-q)^{3}q^{2}\n=2q^{2}-3q^{3}+\\frac{3}{2}q^{4}-\\frac{1}{4}q^{5}.\n$$\n因此\n$$\nI_{2} \\;=\\; \\int_{1}^{2} \\left(2q^{2}-3q^{3}+\\frac{3}{2}q^{4}-\\frac{1}{4}q^{5}\\right)\\,dq\n\\;=\\;\n\\left[\\frac{2}{3}q^{3}-\\frac{3}{4}q^{4}+\\frac{3}{10}q^{5}-\\frac{1}{24}q^{6}\\right]_{1}^{2}.\n$$\n在 $q=2$ 处求值：\n$$\n\\frac{2}{3}\\cdot 8 - \\frac{3}{4}\\cdot 16 + \\frac{3}{10}\\cdot 32 - \\frac{1}{24}\\cdot 64\n\\;=\\;\n\\frac{16}{3} - 12 + \\frac{48}{5} - \\frac{8}{3}\n\\;=\\;\n\\frac{4}{15}.\n$$\n在 $q=1$ 处求值：\n$$\n\\frac{2}{3} - \\frac{3}{4} + \\frac{3}{10} - \\frac{1}{24}\n\\;=\\;\n\\frac{80}{120}-\\frac{90}{120}+\\frac{36}{120}-\\frac{5}{120}\n\\;=\\;\n\\frac{21}{120} \\;=\\; \\frac{7}{40}.\n$$\n因此\n$$\nI_{2} \\;=\\; \\frac{4}{15} - \\frac{7}{40}\n\\;=\\;\n\\frac{32}{120}-\\frac{21}{120}\n\\;=\\;\n\\frac{11}{120}.\n$$\n合并 $I_{1}$ 和 $I_{2}$：\n$$\nI \\;=\\; \\frac{19}{120}+\\frac{11}{120} \\;=\\; \\frac{30}{120} \\;=\\; \\frac{1}{4}.\n$$\n将 $I=\\frac{1}{4}$ 代入 $\\sigma$ 的表达式中：\n$$\n\\sigma \\;=\\; \\frac{1}{4\\pi}\\left(\\frac{1}{4}\\right)^{-1}\n\\;=\\;\n\\frac{1}{\\pi}.\n$$\n最后，明确地验证归一化：\n$$\n\\int W(\\mathbf{r},h)\\,d^{3}\\mathbf{r}\n\\;=\\;\n4\\pi\\,\\sigma\\int_{0}^{2} f(q)\\,q^{2}\\,dq\n\\;=\\;\n4\\pi\\cdot \\frac{1}{\\pi}\\cdot \\frac{1}{4}\n\\;=\\;\n1,\n$$\n与光滑长度 $h$ 无关。因此，所求的归一化常数为 $\\sigma=\\frac{1}{\\pi}$。", "answer": "$$\\boxed{\\frac{1}{\\pi}}$$", "id": "3534778"}, {"introduction": "选择合适的核函数不仅是理论要求，更直接影响到SPH模拟的稳定性和物理真实性。本练习将引导您探究一个关键的数值问题——配对不稳定性，这种不稳定性与核函数的傅里叶谱特性密切相关。您将通过定量分析，比较三次样条核函数和Wendland核函数在特定粒子配置下的稳定性，从而理解在现代SPH模拟中选择特定核函数以抑制非物理伪影的深层原因。", "problem": "在光滑粒子流体动力学 (SPH) 中，配对（或成团）不稳定性与光滑核在离散粒子格点上可表示的波数处存在负谱功率有关。考虑在三维空间中，一个间距为 $\\Delta x$ 的简单立方格点上的均匀、等质量粒子分布。光滑长度为 $h$，三次样条核（$M_{4}$ B样条）和 Wendland $C^{4}$ 核的紧支集半径均为 $\\kappa h$，其中 $\\kappa=2$。邻居数定义为 $N_{\\rm ngb} \\equiv n V_{\\rm supp}$，其中数密度为 $n$，支撑体积为 $V_{\\rm supp}=\\frac{4}{3}\\pi (\\kappa h)^{3}$。对于简单立方格点，奈奎斯特波数值为 $k_{N}=\\pi/\\Delta x$。对于等质量、均匀采样的构型，一个防止配对的充分谱稳定性判据是，对于格点上表示的所有波数 $k$，核的径向傅里叶变换是非负的。等价地，如果核的径向傅里叶变换首次变为负值的符号变化发生在 $k h = x_{c}$ 处，那么稳定性要求 $k_{N} h  x_{c}$。一个公认的性质是，三次样条核的三维径向傅里叶变换在 $k h = x_{c} \\approx 3.8317$（数值确定）处首次变为负值，而 Wendland $C^{4}$ 核在三维空间中对于所有 $k \\ge 0$ 都具有非负的径向傅里叶变换。\n\n给定目标邻居数 $N_{\\rm ngb}=64$，请仅使用上述基本定义，推导出无量纲谱覆盖参数 $k_{N} h$ 作为 $N_{\\rm ngb}$ 和 $\\kappa$ 的函数，为 $\\kappa=2$ 和 $N_{\\rm ngb}=64$ 计算其值，然后通过与 $x_{c}$ 进行定量比较，确定每个核在给定格点上是否对配对效应稳定。\n\n将你的最终结果以行矩阵 $\\bigl[s_{\\rm M4}\\;\\;s_{\\rm WC4}\\bigr]$ 的形式报告，其中 $s_{\\rm M4}$ 对应三次样条 $M_{4}$ 核，$s_{\\rm WC4}$ 对应 Wendland $C^{4}$ 核，使用的约定是：如果稳定则 $s=1$，如果不稳定则 $s=0$。不需要单位。提供一个唯一的最终答案。没有舍入要求；如果你选择提供中间数值估计，请将其舍入到四位有效数字，但最终矩阵条目必须是精确整数。", "solution": "我们的目标是推导无量纲谱覆盖参数 $k_{N} h$ 与邻居数 $N_{\\rm ngb}$ 的关系，并据此判断两种核函数的稳定性。\n\n邻居数 $N_{\\rm ngb}$ 定义为数密度 $n$ 和核的支撑体积 $V_{\\rm supp}$ 的乘积：\n$$N_{\\rm ngb} = n V_{\\rm supp}$$\n对于粒子间距为 $\\Delta x$ 的简单立方格点，数密度 $n = 1/(\\Delta x)^3$。对于支撑半径为 $\\kappa h$ 的球形核，其支撑体积为 $V_{\\rm supp} = \\frac{4}{3}\\pi (\\kappa h)^3$。\n将这些代入 $N_{\\rm ngb}$ 的定义：\n$$N_{\\rm ngb} = \\frac{1}{(\\Delta x)^3} \\left( \\frac{4}{3}\\pi (\\kappa h)^3 \\right) = \\frac{4\\pi\\kappa^3}{3} \\left( \\frac{h}{\\Delta x} \\right)^3$$\n格点的奈奎斯特波数为 $k_N = \\pi / \\Delta x$。我们需要求解的参数是 $k_N h = \\pi (h / \\Delta x)$。\n首先，从 $N_{\\rm ngb}$ 的表达式中求解比率 $h/\\Delta x$：\n$$\\frac{h}{\\Delta x} = \\left( \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3} \\right)^{1/3}$$\n然后，将此表达式代入 $k_N h$ 的方程中：\n$$k_N h = \\pi \\left( \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3} \\right)^{1/3} = \\left( \\pi^3 \\frac{3 N_{\\rm ngb}}{4\\pi\\kappa^3} \\right)^{1/3} = \\left( \\frac{3\\pi^2 N_{\\rm ngb}}{4\\kappa^3} \\right)^{1/3}$$\n现在，代入给定参数 $N_{\\rm ngb}=64$ 和 $\\kappa=2$：\n$$k_N h = \\left( \\frac{3\\pi^2 (64)}{4(2)^3} \\right)^{1/3} = \\left( \\frac{192\\pi^2}{32} \\right)^{1/3} = \\left( 6\\pi^2 \\right)^{1/3}$$\n其数值约为：\n$$k_N h \\approx (6 \\times 9.8696)^{1/3} = (59.2176)^{1/3} \\approx 3.8978$$\n稳定性判据为 $k_N h  x_c$，其中 $x_c$ 是核的傅里叶变换首次变为负值时的 $k h$ 值。\n\n1.  **三次样条 ($M_4$) 核：**\n    临界值 $x_{c, M4} \\approx 3.8317$。\n    由于 $k_N h \\approx 3.8978 > x_{c, M4}$，稳定性判据不满足。\n    因此，三次样条核是不稳定的 ($s_{\\rm M4}=0$)。\n\n2.  **Wendland $C^4$ 核：**\n    Wendland $C^4$ 核的傅里叶变换对所有波数都是非负的，因此 $x_{c, WC4} = \\infty$。\n    由于 $k_N h  \\infty$，稳定性判据满足。\n    因此，Wendland $C^4$ 核是稳定的 ($s_{\\rm WC4}=1$)。\n\n最终结果的行矩阵为 `[0 1]`。", "answer": "$$\\boxed{\\begin{pmatrix} 0  1 \\end{pmatrix}}$$", "id": "3534793"}, {"introduction": "理论的最终检验在于实践。本节的终极实践是一个编码挑战，旨在将前面学到的概念付诸于一个完整的数值实验中。您将设计并实现一个收敛性研究，通过编写代码来评估SPH梯度算子的精度，这是一个验证数值方法正确性的黄金标准。这个练习将要求您处理邻居搜索、周期性边界条件等实际问题，并根据解析解来量化误差，从而深刻体会理论精度如何在计算中得到验证。", "problem": "设计并实现一个针对光滑粒子流体动力学 (SPH) 的收敛性研究，重点关注应用于二维空间中光滑解析标量场的 SPH 梯度算子的精度。该研究必须基于第一性原理，并评估 SPH 梯度近似的质量加权均方根误差如何随粒子数 $N$ 和核函数 $W(r,h)$ 的选择而变化。该研究必须以纯数学术语表述，并使用定义在单位域上的无量纲量。\n\n您必须从 SPH 中常用的连续核表示和粒子近似定义出发。考虑一个定义在周期性方形域 $[0,1]^2$ 上的标量场 $f(\\mathbf{x})$，粒子位置为 $\\{\\mathbf{x}_i\\}_{i=1}^N$，粒子质量相等，为 $m_i = \\frac{1}{N}$，光滑长度 $h$ 定义为 $h = \\eta \\sqrt{\\frac{1}{N}}$，其中 $\\eta > 0$ 是一个无量纲参数。粒子数密度为 $n = \\frac{N}{1} = N$，并且必须使用单位环面上的最小镜像约定来施加周期性边界条件。待采样的解析场为\n$$\nf(x,y) = \\sin(2\\pi x)\\cos(2\\pi y),\n$$\n其精确梯度为\n$$\n\\nabla f(x,y) = \\left(2\\pi \\cos(2\\pi x)\\cos(2\\pi y),\\; -2\\pi \\sin(2\\pi x)\\sin(2\\pi y)\\right).\n$$\n\n使用以下两种二维空间中的各向同性、径向对称、紧支集 SPH 核函数，每种核函数都经过归一化，使得\n$$\n\\int_{\\mathbb{R}^2} W(r,h)\\,d^2\\mathbf{r} = 1,\n$$\n其支撑半径为 $r \\leq 2h$ 且 $q \\equiv \\frac{r}{h}$:\n\n- $2$D 中的三次样条 (Monaghan-M4) 核函数：\n$$\nW(r,h) = \\frac{\\sigma}{h^2} \\times\n\\begin{cases}\n1 - \\frac{3}{2}q^2 + \\frac{3}{4}q^3,  0 \\le q  1 \\\\\n\\frac{1}{4}(2 - q)^3,  1 \\le q  2 \\\\\n0,  q \\ge 2\n\\end{cases}\n,\n\\quad \\text{其中} \\quad \\sigma = \\frac{10}{7\\pi}.\n$$\n\n- $2$D 中的 Wendland $C^2$ 核函数：\n$$\nW(r,h) = \\frac{\\sigma}{h^2} \\times\n\\begin{cases}\n\\left(1 - \\frac{q}{2}\\right)^4(1 + 2q),  0 \\le q \\le 2 \\\\\n0,  q > 2\n\\end{cases}\n,\n\\quad \\text{其中} \\quad \\sigma = \\frac{7}{4\\pi}.\n$$\n\n径向对称核函数 $W(r,h)$ 的梯度必须实现为\n$$\n\\nabla W(\\mathbf{r},h) = \\frac{\\sigma}{h^3}\\,\\frac{dw}{dq}\\,\\frac{\\mathbf{r}}{r},\n$$\n对于 $r > 0$，其中 $w(q)$ 是核函数的无量纲核心，使得 $W(r,h) = \\frac{\\sigma}{h^2}w(q)$，而 $\\frac{dw}{dq}$ 是其关于 $q$ 的导数。通过设 $\\nabla W(\\mathbf{0},h) = \\mathbf{0}$ 来处理 $r=0$ 的情况。\n\n使用粒子近似法定义每个粒子处的 SPH 密度\n$$\n\\rho_i = \\sum_{j=1}^N m_j\\, W(|\\mathbf{x}_i - \\mathbf{x}_j|,h),\n$$\n并将每个粒子处标量场的 SPH 梯度估计量定义为\n$$\n\\left(\\nabla f\\right)_i^{\\text{SPH}} = \\sum_{j=1}^N m_j\\,\\frac{f_j}{\\rho_j}\\,\\nabla W(\\mathbf{x}_i - \\mathbf{x}_j,h).\n$$\n每个测试用例要报告的误差度量是遍及所有粒子的质量加权均方根 $L^2$ 误差，\n$$\nE = \\left[ \\sum_{i=1}^N m_i\\,\\left\\|\\left(\\nabla f\\right)_i^{\\text{SPH}} - \\nabla f(\\mathbf{x}_i)\\right\\|_2^2 \\right]^{1/2}.\n$$\n\n算法要求：\n- 在覆盖 $[0,1]^2$ 的均匀笛卡尔格点上采样粒子位置 $\\mathbf{x}_i$，使用 $N = n_x \\times n_y$，其中 $n_x = n_y = \\sqrt{N}$（选择本身是完全平方数的 $N$ 值）。通过单位平方上的最小镜像约定施加周期性边界条件。\n- 实现一个单元链表邻居搜索算法，单元尺寸等于核函数支撑半径 $2h$，并且只累加 $r \\le 2h$ 的粒子对的贡献。\n- 在给定的测试用例中，对所有粒子使用恒定的 $h$，设为 $h = \\eta \\sqrt{1/N}$。\n- 计算所有 $j$ 的 $\\rho_j$，然后使用指定的估计量计算所有 $i$ 的 $\\left(\\nabla f\\right)_i^{\\text{SPH}}$。\n\n测试套件：\n提供以下测试用例的结果，每个用例由核函数类型、粒子数和光滑参数 $\\eta$ 指定：\n- 案例 1：三次样条核函数，$N = 625$（即 $25 \\times 25$ 网格），$\\eta = 1.5$。\n- 案例 2：三次样条核函数，$N = 2500$（即 $50 \\times 50$ 网格），$\\eta = 1.5$。\n- 案例 3：Wendland $C^2$ 核函数，$N = 625$，$\\eta = 1.5$。\n- 案例 4：Wendland $C^2$ 核函数，$N = 2500$，$\\eta = 1.5$。\n- 案例 5（邻居较少的边缘情况）：三次样条核函数，$N = 100$（即 $10 \\times 10$ 网格），$\\eta = 0.8$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含按上述顺序排列的测试套件的五个计算误差值 $E$，格式为方括号括起来的逗号分隔列表（例如 $[e_1,e_2,e_3,e_4,e_5]$），其中每个 $e_k$ 是一个不带单位的浮点数。不应打印任何其他文本。", "solution": "用户提供的问题是计算天体物理学领域，特别是在光滑粒子流体动力学（SPH）领域中一个适定且科学合理的问题。它要求实现一个 SPH 梯度算子的收敛性研究。该问题是自洽的，提供了所有必需的数学定义、物理常数（在无量纲系统中）和算法要求。所指定的 SPH 形式体系、核函数和误差度量均为该领域的标准。因此，该问题被认为是有效的，并将提供完整的解决方案。\n\n问题的核心是使用 SPH 近似一个已知标量场 $f(\\mathbf{x})$ 的梯度，并量化该近似的误差。该解决方案涉及一个基于 SPH 第一性原理的多步数值算法。\n\n**1. SPH 原理与公式**\n\n光滑粒子流体动力学是一种拉格朗日方法，其中流体或连续场由一组离散粒子表示。在位置 $\\mathbf{x}$ 处任意场 $A(\\mathbf{x})$ 的值，通过使用一个光滑核函数 $W$ 对邻近粒子进行加权平均来近似。\n\n场 $A$ 的 SPH 表示由卷积分给出：\n$$\n\\langle A(\\mathbf{x}) \\rangle = \\int A(\\mathbf{x'}) W(\\mathbf{x} - \\mathbf{x'}, h) \\,d\\mathbf{x'}\n$$\n其中 $h$ 是光滑长度，它定义了空间平均的范围。在粒子近似中，该积分被离散化为对粒子的求和：\n$$\nA_i = \\sum_{j=1}^N \\frac{m_j}{\\rho_j} A_j W(|\\mathbf{x}_i - \\mathbf{x}_j|, h)\n$$\n这里，$m_j$ 和 $\\rho_j$ 分别是粒子 $j$ 的质量和密度，项 $m_j/\\rho_j$ 近似了与粒子 $j$ 相关联的体积元 $d\\mathbf{x'}$。粒子 $i$ 处的 SPH 密度 $\\rho_i$ 本身通过求和计算得出：\n$$\n\\rho_i = \\sum_{j=1}^N m_j W(|\\mathbf{x}_i - \\mathbf{x}_j|, h)\n$$\n对于本问题，所有粒子具有相等的质量 $m_i = m = \\frac{1}{N}$。\n\n场 $f(\\mathbf{x})$ 的梯度通过对卷积分求梯度来近似，这将导数转移到了核函数上：\n$$\n\\langle \\nabla f(\\mathbf{x}) \\rangle = \\int f(\\mathbf{x'}) \\nabla W(\\mathbf{x} - \\mathbf{x'}, h) \\,d\\mathbf{x'}\n$$\n如问题中所述，相应的粒子近似为：\n$$\n\\left(\\nabla f\\right)_i^{\\text{SPH}} = \\sum_{j=1}^N m_j\\,\\frac{f_j}{\\rho_j}\\,\\nabla_i W(\\mathbf{x}_i - \\mathbf{x}_j,h)\n$$\n其中 $\\nabla_i W$ 表示核函数关于粒子 $i$ 坐标的梯度。这需要一个两遍法：首先，计算所有粒子的密度 $\\rho_j$；其次，使用这些密度计算每个粒子 $i$ 处的梯度。\n\n**2. 核函数及其梯度**\n\n问题指定了两个为 $q = r/h \\le 2$ 定义的紧支集核函数，其中 $r = |\\mathbf{x}_i - \\mathbf{x}_j|$。一个径向对称核函数 $W(r,h) = \\frac{\\sigma}{h^d}w(q)$（其中维度 $d=2$）的梯度由下式给出：\n$$\n\\nabla_i W(\\mathbf{x}_i - \\mathbf{x}_j,h) = \\frac{d W}{dr} \\frac{\\mathbf{x}_i - \\mathbf{x}_j}{r} = \\left(\\frac{d W}{dq}\\frac{dq}{dr}\\right) \\frac{\\mathbf{r}_{ij}}{r} = \\left(\\frac{\\sigma}{h^d}\\frac{dw}{dq}\\frac{1}{h}\\right) \\frac{\\mathbf{r}_{ij}}{r} = \\frac{\\sigma}{h^{d+1}}\\frac{dw}{dq}\\frac{\\mathbf{r}_{ij}}{r}\n$$\n其中 $\\mathbf{r}_{ij} = \\mathbf{x}_i - \\mathbf{x}_j$。对于 $d=2$，这与所提供的公式 $\\nabla W = \\frac{\\sigma}{h^3}\\frac{dw}{dq}\\frac{\\mathbf{r}}{r}$ 相匹配。\n\n- **三次样条 (M4) 核函数：**\n  - $w(q) = 1 - \\frac{3}{2}q^2 + \\frac{3}{4}q^3$，对于 $0 \\le q  1$。\n  - $w(q) = \\frac{1}{4}(2 - q)^3$，对于 $1 \\le q  2$。\n  - 导数 $\\frac{dw}{dq}$ 为：\n    - $\\frac{dw}{dq} = -3q + \\frac{9}{4}q^2$，对于 $0 \\le q  1$。\n    - $\\frac{dw}{dq} = -\\frac{3}{4}(2 - q)^2$，对于 $1 \\le q  2$。\n\n- **Wendland $C^2$ 核函数：**\n  - $w(q) = (1 - \\frac{q}{2})^4(1 + 2q)$，对于 $0 \\le q \\le 2$。\n  - 导数 $\\frac{dw}{dq}$ 使用乘法法则求得：\n    - $\\frac{dw}{dq} = 4(1-\\frac{q}{2})^3(-\\frac{1}{2})(1+2q) + (1-\\frac{q}{2})^4(2) = 2(1-\\frac{q}{2})^3 \\left[ -(1+2q) + (1-\\frac{q}{2}) \\right] = -5q(1 - \\frac{q}{2})^3$，对于 $0 \\le q \\le 2$。\n\n**3. 算法实现**\n\n对于每个由核函数类型、粒子数 $N$ 和光滑参数 $\\eta$ 定义的测试用例，模拟按以下步骤进行。\n\n- **粒子设置：** 粒子被放置在一个均匀的 $n_x \\times n_y$ 网格上，其中 $n_x = n_y = \\sqrt{N}$。为避免边界效应，位置取在 $[0,1]^2$ 域的单元中心。光滑长度设为 $h = \\eta / \\sqrt{N}$。\n\n- **邻居搜索：** 对每个粒子 $i$ 遍历所有 $N$ 个粒子进行直接求和将是一个 $O(N^2)$ 的操作。由于核函数具有紧支集（半径为 $2h$），只有在此距离内的粒子有贡献。使用单元链表算法以达到 $O(N)$ 的复杂度。将域划分为大小为 $2h \\times 2h$ 的单元格网格。每个粒子被分配到一个单元中。对于一个给定的粒子，仅通过搜索其自身单元和相邻的8个单元来寻找邻居。对单元索引应用周期性边界条件，以处理靠近域边界的粒子。\n\n- **周期性边界条件：** 周期性域是一个二维环面。粒子 $\\mathbf{x}_i$ 和 $\\mathbf{x}_j$ 之间的最短分离向量 $\\mathbf{r}_{ij}$ 使用最小镜像约定找到。对于大小为 1 的域，向量差的每个分量，例如 $dx = x_i - x_j$，通过计算 $dx' = dx - \\text{round}(dx)$ 映射到区间 $[-0.5, 0.5]$。\n\n- **计算过程：**\n  1.  **密度计算：** 遍历所有粒子 $i$。对每个 $i$，使用单元链表寻找邻居 $j$。计算 $\\mathbf{r}_{ij}$、其大小 $r$ 以及核函数值 $W(r, h)$。对贡献求和以找到 $\\rho_i$。\n  2.  **梯度计算：** 再次遍历所有粒子 $i$。对于每个邻居 $j$，使用解析导数 $\\frac{dw}{dq}$ 计算核函数梯度向量 $\\nabla_i W(\\mathbf{r}_{ij}, h)$。根据 SPH 梯度公式，使用预先计算的密度 $\\rho_j$ 和场值 $f_j$ 对贡献求和。\n\n- **误差评估：** 在每个粒子位置计算解析梯度 $\\nabla f(\\mathbf{x}_i)$。计算 SPH 近似与精确梯度之间的欧几里得距离的平方：$\\|\\left(\\nabla f\\right)_i^{\\text{SPH}} - \\nabla f(\\mathbf{x}_i)\\|_2^2$。最终误差 $E$ 是这些平方误差在所有粒子上的质量加权平均值的平方根。\n\n这个严谨的流程能够精确评估 SPH 梯度算子的精度，将其作为粒子分辨率和核函数选择的函数。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nimport itertools\n\ndef solve():\n    \"\"\"\n    Main function to run the SPH convergence study for the specified test cases.\n    \"\"\"\n\n    def get_kernel_functions(kernel_type):\n        \"\"\"Returns the kernel value function, its derivative, and sigma.\"\"\"\n        if kernel_type == 'cubic_spline':\n            sigma = 10.0 / (7.0 * np.pi)\n\n            def W_func(q):\n                if 0 = q  1:\n                    return 1.0 - 1.5 * q**2 + 0.75 * q**3\n                elif 1 = q  2:\n                    return 0.25 * (2.0 - q)**3\n                return 0.0\n\n            def dWdq_func(q):\n                if 0 = q  1:\n                    return -3.0 * q + 2.25 * q**2\n                elif 1 = q  2:\n                    return -0.75 * (2.0 - q)**2\n                return 0.0\n\n        elif kernel_type == 'wendland_c2':\n            sigma = 7.0 / (4.0 * np.pi)\n\n            def W_func(q):\n                if 0 = q = 2:\n                    return (1.0 - 0.5 * q)**4 * (1.0 + 2.0 * q)\n                return 0.0\n\n            def dWdq_func(q):\n                if 0 = q = 2:\n                    return -5.0 * q * (1.0 - 0.5 * q)**3\n                return 0.0\n        else:\n            raise ValueError(\"Unknown kernel type\")\n            \n        return W_func, dWdq_func, sigma\n\n    def run_simulation(kernel_type, N, eta):\n        \"\"\"\n        Runs a single SPH simulation case.\n        \"\"\"\n        # 1. Setup\n        nx = int(np.sqrt(N))\n        ny = nx\n        \n        # Create particle positions on a uniform lattice (cell-centered)\n        x = np.linspace(0.5 / nx, 1.0 - 0.5 / nx, nx)\n        y = np.linspace(0.5 / ny, 1.0 - 0.5 / ny, ny)\n        xv, yv = np.meshgrid(x, y)\n        positions = np.vstack([xv.ravel(), yv.ravel()]).T\n\n        mass = 1.0 / N\n        h = eta / np.sqrt(N)\n        support_radius = 2.0 * h\n        support_radius_sq = support_radius**2\n\n        W_func, dWdq_func, sigma = get_kernel_functions(kernel_type)\n\n        # 2. Build Cell-linked List\n        cell_size = support_radius\n        n_cells_dim = int(np.ceil(1.0 / cell_size))\n        \n        grid = [[] for _ in range(n_cells_dim * n_cells_dim)]\n        particle_cell_indices = np.floor(positions / cell_size).astype(int)\n\n        for i in range(N):\n            cx, cy = particle_cell_indices[i]\n            cell_idx = cx * n_cells_dim + cy\n            grid[cell_idx].append(i)\n\n        # 3. Compute Densities\n        rho = np.zeros(N)\n        h_sq = h**2\n        \n        for i in range(N):\n            pos_i = positions[i]\n            cx, cy = particle_cell_indices[i]\n            rho_i = 0.0\n            \n            for dx, dy in itertools.product([-1, 0, 1], repeat=2):\n                ncx = (cx + dx) % n_cells_dim\n                ncy = (cy + dy) % n_cells_dim\n                cell_idx = ncx * n_cells_dim + ncy\n                \n                for j in grid[cell_idx]:\n                    rij_vec = pos_i - positions[j]\n                    rij_vec -= np.round(rij_vec) # Minimum Image Convention\n                    r_sq = np.sum(rij_vec**2)\n\n                    if r_sq  support_radius_sq:\n                        r = np.sqrt(r_sq)\n                        q = r / h\n                        W_val = (sigma / h_sq) * W_func(q)\n                        rho_i += mass * W_val\n            rho[i] = rho_i\n\n        # 4. Compute SPH Gradient\n        f_values = np.sin(2 * np.pi * positions[:, 0]) * np.cos(2 * np.pi * positions[:, 1])\n        grad_sph = np.zeros((N, 2))\n        h_cubed = h**3\n\n        for i in range(N):\n            pos_i = positions[i]\n            cx, cy = particle_cell_indices[i]\n            grad_i = np.zeros(2)\n\n            for dx, dy in itertools.product([-1, 0, 1], repeat=2):\n                ncx = (cx + dx) % n_cells_dim\n                ncy = (cy + dy) % n_cells_dim\n                cell_idx = ncx * n_cells_dim + ncy\n                \n                for j in grid[cell_idx]:\n                    rij_vec = pos_i - positions[j]\n                    rij_vec -= np.round(rij_vec)\n                    r_sq = np.sum(rij_vec**2)\n\n                    if 1e-12  r_sq  support_radius_sq: # r > 0 check\n                        r = np.sqrt(r_sq)\n                        q = r / h\n                        dWdq_val = dWdq_func(q)\n                        grad_W_vec = (sigma / h_cubed) * dWdq_val * (rij_vec / r)\n                        grad_i += mass * (f_values[j] / rho[j]) * grad_W_vec\n            grad_sph[i, :] = grad_i\n\n        # 5. Compute Error\n        grad_exact_x = 2 * np.pi * np.cos(2 * np.pi * positions[:, 0]) * np.cos(2 * np.pi * positions[:, 1])\n        grad_exact_y = -2 * np.pi * np.sin(2 * np.pi * positions[:, 0]) * np.sin(2 * np.pi * positions[:, 1])\n        grad_exact = np.vstack([grad_exact_x, grad_exact_y]).T\n\n        diff_vecs = grad_sph - grad_exact\n        sq_errors = np.sum(diff_vecs**2, axis=1)\n        l2_error = np.sqrt(np.sum(mass * sq_errors))\n        \n        return l2_error\n\n    test_cases = [\n        ('cubic_spline', 625, 1.5),\n        ('cubic_spline', 2500, 1.5),\n        ('wendland_c2', 625, 1.5),\n        ('wendland_c2', 2500, 1.5),\n        ('cubic_spline', 100, 0.8),\n    ]\n\n    results = []\n    for kernel, N_particles, eta_param in test_cases:\n        error = run_simulation(kernel, N_particles, eta_param)\n        results.append(error)\n\n    print(f\"[{','.join(f'{r:.10f}' for r in results)}]\")\n\nsolve()\n```", "id": "3534781"}]}