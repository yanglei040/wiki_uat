{"hands_on_practices": [{"introduction": "宇宙学模拟的保真度从根本上受其初始条件质量的限制。本实践将探讨如何使用拉格朗日微扰理论（LPT）生成这些初始位形。通过推导控制方程并分析不同阶LPT的演化，您将量化不恰当的初始设置如何引入非物理的“瞬变”模式，并学习如何通过选择合适的LPT阶数和初始红移来抑制它们。[@problem_id:3507115]", "problem": "考虑一个在空间平坦的 Friedmann–Lemaître–Robertson–Walker (FLRW) 背景中，在牛顿引力下演化的无旋、无压冷暗物质流体。在拉格朗日微扰理论 (LPT) 中，欧拉位置写作 $\\boldsymbol{x}(\\boldsymbol{q},t) = \\boldsymbol{q} + \\boldsymbol{\\psi}(\\boldsymbol{q},t)$，其中 $\\boldsymbol{q}$ 是拉格朗日坐标，$\\boldsymbol{\\psi}$ 是位移场。假设一个 Einstein–de Sitter (EdS) 宇宙学模型，其中 $\\Omega_{\\mathrm{m}} = 1$，$\\Omega_{\\Lambda} = 0$，并且标度因子 $a(t)$ 被归一化，使得在 $z=0$ 时 $a(t_0) = 1$。一阶 LPT (Zel'dovich 近似, ZA) 位移为 $\\boldsymbol{\\psi}^{(1)} = - D_{1}(a) \\boldsymbol{\\nabla}\\phi^{(1)}$，其中 $D_{1}(a)$ 是线性增长因子，$\\phi^{(1)}$ 满足一个以线性密度对比为源的泊松方程。二阶 LPT (2LPT) 位移为 $\\boldsymbol{\\psi}^{(2)} = D_{2}(a) \\boldsymbol{\\nabla}\\phi^{(2)}$，其中 $\\phi^{(2)}$ 是一个标量势。\n\n任务 A (推导)：从共动坐标系下自引力流体的牛顿第二定律、质量守恒以及无旋位移的假设出发，推导二阶 LPT 标量势 $\\phi^{(2)}$ 的控制方程，该方程用一阶势 $\\phi^{(1)}$ 的空间导数表示。您的推导必须从基本定律（膨胀背景下的连续性方程和欧拉方程，以及引力势的泊松方程）开始，并得出一个泊松型方程，其源项是 $\\phi^{(1)}$ 的黑塞矩阵的二次方。您必须明确给出 $\\boldsymbol{\\nabla}^{2}\\phi^{(2)}$ 的方程，用 $\\phi^{(1)}$ 的二阶导数表示，所有数学实体均使用 LaTeX 格式。\n\n任务 B (时间演化和暂现模)：在 EdS 极限下，二阶增长函数满足一个由一阶二次源驱动的二阶常微分方程。仅使用第一性原理，推导 EdS 模型中 $D_{2}(a)$ 的通解结构，证明它由一个与 $a^{2}$ 成正比的特解加上分别与 $a$ 和 $a^{-3/2}$ 成正比的齐次模组成。在初始红移 $z_{\\mathrm{init}}$ (其中 $a_{\\mathrm{init}} = 1/(1+z_{\\mathrm{init}})$) 处，施加以下初始条件设定：\n- 对于一阶 LPT (ZA) 初始条件：设置 $D_{2}(a_{\\mathrm{init}}) = 0$ 且 $\\mathrm{d}D_{2}/\\mathrm{d}a\\big|_{a_{\\mathrm{init}}} = 0$。\n- 对于二阶 LPT (2LPT) 初始条件：将 $D_{2}(a_{\\mathrm{init}})$ 和 $\\mathrm{d}D_{2}/\\mathrm{d}a\\big|_{a_{\\mathrm{init}}}$ 设置为与 EdS 特解一致的增长模值。\n\n对每种情况，求解齐次贡献的系数，并写出在两种初始条件选择下，于 $a=1$ 处求值的 $D_{2}(a)$，用 $a_{\\mathrm{init}}$ 明确表示。\n\n任务 C (量化物质功率谱中的暂现抑制)：对于给定的初始条件设定，将 $z=0$ 时的暂现抑制度量 $s$ 定义为二阶增长振幅平方相对于真实增长模值的分数减少量，\n$$\ns \\equiv 1 - \\left(\\frac{D_{2}^{\\mathrm{IC}}(a=1)}{D_{2}^{\\mathrm{true}}(a=1)}\\right)^{2},\n$$\n这是一个无量纲的十进制数。这里 $D_{2}^{\\mathrm{true}}(a)$ 表示 EdS 增长模特解，$D_{2}^{\\mathrm{IC}}(a)$ 是由所选初始条件产生并在 $a=1$ 处求值的实际 $D_{2}$。这个 $s$ 可作为与二阶增长的平方成比例的领头单圈物质功率谱修正的分数抑制的代理指标。\n\n对于一阶 LPT (ZA) 和二阶 LPT (2LPT) 两种初始条件，计算在 $z=0$ 时的 $s$，使用以下初始红移测试集：\n- 典型情况：$z_{\\mathrm{init}} = 99$，\n- 中间情况：$z_{\\mathrm{init}} = 49$，\n- 边界低红移情况：$z_{\\mathrm{init}} = 9$，\n- 高红移边缘情况：$z_{\\mathrm{init}} = 199$。\n\n所有输出都是无单位的十进制数。您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果。对于上面列出的每个测试用例，按顺序输出两个数字：首先是一阶 LPT (ZA) 的 $s$，然后是二阶 LPT (2LPT) 的 $s$。例如，最终输出必须是 $\\left[\\ldots\\right]$ 的形式，精确包含 $8$ 个浮点数，顺序为 $\\left[s_{\\mathrm{ZA}}(99), s_{\\mathrm{2LPT}}(99), s_{\\mathrm{ZA}}(49), s_{\\mathrm{2LPT}}(49), s_{\\mathrm{ZA}}(9), s_{\\mathrm{2LPT}}(9), s_{\\mathrm{ZA}}(199), s_{\\mathrm{2LPT}}(199)\\right]$。", "solution": "我们考虑在由牛顿宇宙学描述的空间平坦的 Friedmann–Lemaître–Robertson–Walker (FLRW) 背景中的一种无压、无旋的冷暗物质流体。欧拉位置为 $\\boldsymbol{x}(\\boldsymbol{q},t) = \\boldsymbol{q} + \\boldsymbol{\\psi}(\\boldsymbol{q},t)$，其中 $\\boldsymbol{q}$ 是拉格朗日坐标，$\\boldsymbol{\\psi}$ 是位移场。控制方程是在共动坐标系下的牛顿第二定律、质量守恒以及引力势 $\\Phi$ 的泊松方程：\n$$\n\\frac{\\mathrm{d}^{2}\\boldsymbol{x}}{\\mathrm{d}t^{2}} + 2 H \\frac{\\mathrm{d}\\boldsymbol{x}}{\\mathrm{d}t} = - \\frac{1}{a^{2}} \\boldsymbol{\\nabla}_{x} \\Phi,\n$$\n$$\n\\boldsymbol{\\nabla}_{x}^{2} \\Phi = 4 \\pi G a^{2} \\bar{\\rho} \\, \\delta,\n$$\n$$\n1 + \\delta = \\frac{1}{J}, \\quad J \\equiv \\det\\left(\\frac{\\partial x_{i}}{\\partial q_{j}}\\right) = \\det\\left(\\delta_{ij} + \\frac{\\partial \\psi_{i}}{\\partial q_{j}}\\right),\n$$\n其中 $H \\equiv \\dot{a}/a$，$\\bar{\\rho}$ 是平均物质密度，$\\delta$ 是密度对比。\n\n我们假设无旋性，因此每一阶的位移都是有势的：\n$$\n\\boldsymbol{\\psi}^{(1)} = - D_{1}(a) \\boldsymbol{\\nabla}\\phi^{(1)}, \\quad \\boldsymbol{\\psi}^{(2)} = D_{2}(a) \\boldsymbol{\\nabla}\\phi^{(2)},\n$$\n其中 $\\phi^{(1)}$ 和 $\\phi^{(2)}$ 是拉格朗日空间中的标量势，而 $D_{1}$、$D_{2}$ 是依赖于时间的增长函数。在 Einstein–de Sitter (EdS) 模型中，线性增长因子为 $D_{1}(a) = a$。\n\n任务 A：二阶 LPT 势方程的推导。我们将雅可比矩阵 $J$ 在位移梯度 $\\Psi_{ij} \\equiv \\partial \\psi_{i}/\\partial q_{j}$ 上展开到二阶。使用行列式的恒等式，\n$$\nJ = 1 + \\mathrm{Tr}(\\Psi) + \\frac{1}{2}\\left[\\left(\\mathrm{Tr}(\\Psi)\\right)^{2} - \\mathrm{Tr}\\left(\\Psi^{2}\\right)\\right] + \\mathcal{O}(\\Psi^{3}),\n$$\n密度对比展开到二阶为\n$$\n\\delta^{(1)} = - \\mathrm{Tr}\\left(\\Psi^{(1)}\\right), \\quad \\delta^{(2)} = - \\mathrm{Tr}\\left(\\Psi^{(2)}\\right) + \\frac{1}{2}\\left[\\left(\\mathrm{Tr}\\left(\\Psi^{(1)}\\right)\\right)^{2} - \\mathrm{Tr}\\left(\\left(\\Psi^{(1)}\\right)^{2}\\right)\\right].\n$$\n对于 $\\boldsymbol{\\psi}^{(1)} = - D_{1} \\boldsymbol{\\nabla}\\phi^{(1)}$ 和 $\\boldsymbol{\\psi}^{(2)} = D_{2} \\boldsymbol{\\nabla}\\phi^{(2)}$，我们有\n$$\n\\Psi^{(1)}_{ij} = - D_{1} \\partial_{i}\\partial_{j}\\phi^{(1)}, \\quad \\Psi^{(2)}_{ij} = D_{2} \\partial_{i}\\partial_{j}\\phi^{(2)},\n$$\n从而得到\n$$\n\\delta^{(1)} = D_{1} \\nabla^{2} \\phi^{(1)}, \\quad \\delta^{(2)} = - D_{2} \\nabla^{2} \\phi^{(2)} + \\frac{D_{1}^{2}}{2}\\left[\\left(\\nabla^{2}\\phi^{(1)}\\right)^{2} - \\sum_{i,j} \\left(\\partial_{i}\\partial_{j}\\phi^{(1)}\\right)^{2}\\right].\n$$\n在二阶上，欧拉-泊松系统为 $\\delta^{(2)}$ 引入了一个在一阶场中是二次的源项。通过施加质量守恒以及与欧拉方程和泊松方程的一致性，二阶势 $\\phi^{(2)}$ 必须满足一个泊松型方程，其源项在适当的时间依赖性下抵消了纯二次的雅可比项。要求 $\\delta^{(2)}$ 与增长模对齐并匹配其空间依赖性，即可得到标准的 2LPT 势方程：\n$$\n\\nabla^{2} \\phi^{(2)} = \\sum_{i>j} \\left[ \\left(\\partial_{i}\\partial_{i} \\phi^{(1)}\\right)\\left(\\partial_{j}\\partial_{j} \\phi^{(1)}\\right) - \\left(\\partial_{i}\\partial_{j} \\phi^{(1)}\\right)^{2} \\right].\n$$\n等价地，用完整索引写出，\n$$\n\\nabla^{2} \\phi^{(2)} = \\frac{1}{2}\\left[\\left(\\nabla^{2}\\phi^{(1)}\\right)^{2} - \\sum_{i,j} \\left(\\partial_{i}\\partial_{j}\\phi^{(1)}\\right)^{2}\\right],\n$$\n这是在网格上构建 2LPT 初始位移时使用的经过充分检验的表达式。\n\n任务 B：$D_{2}(a)$ 的时间演化和暂现模。在 EdS 模型中，二阶增长遵循一个线性非齐次常微分方程，其源项为一阶增长的二次组合。用标度因子表示的一种方便形式是\n$$\n\\frac{\\mathrm{d}^{2} D_{2}}{\\mathrm{d} a^{2}} + \\frac{3}{2a} \\frac{\\mathrm{d} D_{2}}{\\mathrm{d} a} - \\frac{3}{2a^{2}} D_{2} = - \\frac{3}{2a^{2}} D_{1}^{2},\n$$\n其中右侧项来自欧拉-泊松系统中的二次源项，并且在 EdS 模型中 $D_{1}(a) = a$。齐次方程\n$$\n\\frac{\\mathrm{d}^{2}y}{\\mathrm{d} a^{2}} + \\frac{3}{2a} \\frac{\\mathrm{d} y}{\\mathrm{d} a} - \\frac{3}{2a^{2}} y = 0\n$$\n有两个独立解 $y_{1}(a) \\propto a$ 和 $y_{2}(a) \\propto a^{-3/2}$。非齐次方程的一个特解是\n$$\nD_{2}^{\\mathrm{part}}(a) = - \\frac{3}{7} a^{2}.\n$$\n因此，通解为\n$$\nD_{2}(a) = - \\frac{3}{7} a^{2} + A a + B a^{-3/2},\n$$\n其中常数 $A$ 和 $B$ 由初始条件确定。\n\n对于一阶 LPT (ZA) 初始条件，二阶分量在初始时不存在，这意味着\n$$\nD_{2}(a_{\\mathrm{init}}) = 0, \\quad \\left.\\frac{\\mathrm{d}D_{2}}{\\mathrm{d}a}\\right|_{a_{\\mathrm{init}}} = 0.\n$$\n施加这两个条件可以得到关于 $A$ 和 $B$ 的一个线性方程组：\n$$\n0 = - \\frac{3}{7} a_{\\mathrm{init}}^{2} + A a_{\\mathrm{init}} + B a_{\\mathrm{init}}^{-3/2},\n$$\n$$\n0 = - \\frac{6}{7} a_{\\mathrm{init}} + A - \\frac{3}{2} B a_{\\mathrm{init}}^{-5/2}.\n$$\n解得，\n$$\nB = - \\frac{6}{35} a_{\\mathrm{init}}^{7/2}, \\quad A = \\frac{3}{5} a_{\\mathrm{init}}.\n$$\n在 $a=1$ 处求值，\n$$\nD_{2}^{\\mathrm{ZA}}(1) = - \\frac{3}{7} + \\frac{3}{5} a_{\\mathrm{init}} - \\frac{6}{35} a_{\\mathrm{init}}^{7/2}.\n$$\n\n对于二阶 LPT (2LPT) 初始条件，我们将初始的二阶位移及其时间导数设置为增长模的值以消除暂现模：\n$$\nD_{2}(a_{\\mathrm{init}}) = - \\frac{3}{7} a_{\\mathrm{init}}^{2}, \\quad \\left.\\frac{\\mathrm{d}D_{2}}{\\mathrm{d}a}\\right|_{a_{\\mathrm{init}}} = - \\frac{6}{7} a_{\\mathrm{init}}.\n$$\n施加这些条件得到 $A = 0$ 和 $B = 0$，因此\n$$\nD_{2}^{\\mathrm{2LPT}}(a) = - \\frac{3}{7} a^{2}, \\quad D_{2}^{\\mathrm{2LPT}}(1) = - \\frac{3}{7}.\n$$\n\n任务 C：暂现抑制度量。我们定义\n$$\ns \\equiv 1 - \\left(\\frac{D_{2}^{\\mathrm{IC}}(1)}{D_{2}^{\\mathrm{true}}(1)}\\right)^{2},\n$$\n其中 $D_{2}^{\\mathrm{true}}(1) = - 3/7$ 是在 $a=1$ 时的 EdS 增长模值。对于一阶 LPT 初始条件，\n$$\ns_{\\mathrm{ZA}}(z_{\\mathrm{init}}) = 1 - \\left( \\frac{ - \\frac{3}{7} + \\frac{3}{5} a_{\\mathrm{init}} - \\frac{6}{35} a_{\\mathrm{init}}^{7/2} }{ - \\frac{3}{7} } \\right)^{2} = 1 - \\left( 1 - \\frac{ \\frac{3}{5} a_{\\mathrm{init}} - \\frac{6}{35} a_{\\mathrm{init}}^{7/2} }{ \\frac{3}{7} } \\right)^{2}.\n$$\n对于小的 $a_{\\mathrm{init}}$，此式在 $a_{\\mathrm{init}}$ 的领头阶上可近似为 $s_{\\mathrm{ZA}} \\approx \\frac{14}{5} a_{\\mathrm{init}}$，这反映了 Zel'dovich 近似中众所周知的 $a_{\\mathrm{init}}$ 暂现标度关系。对于二阶 LPT 初始条件，\n$$\ns_{\\mathrm{2LPT}}(z_{\\mathrm{init}}) = 1 - \\left( \\frac{ - \\frac{3}{7} }{ - \\frac{3}{7} } \\right)^{2} = 0,\n$$\n这表明当增长模在初始化时匹配时，二阶暂现模被完全抑制。\n\n算法实现。程序为每个测试用例计算 $a_{\\mathrm{init}} = 1/(1+z_{\\mathrm{init}})$，通过上述精确表达式计算 $D_{2}^{\\mathrm{ZA}}(1)$，然后除以 $D_{2}^{\\mathrm{true}}(1) = - 3/7$，取平方，再用 1 减去该值得到 $s_{\\mathrm{ZA}}$。对于 $s_{\\mathrm{2LPT}}$，在 EdS 增长模匹配中，其值对所有 $z_{\\mathrm{init}}$ 恒为 0。最终输出以指定的顺序和格式汇总结果，生成一个不带单位的、用方括号括起来的浮点数列表。\n\n测试集覆盖范围。$z_{\\mathrm{init}} = 99$ 和 $z_{\\mathrm{init}} = 49$ 的情况测试了典型的初始化选择；$z_{\\mathrm{init}} = 9$ 是一个具有可观暂现模的边界低红移情况；$z_{\\mathrm{init}} = 199$ 是一个暂现模被强烈抑制的高红移边缘情况。所有输出都是无量纲的小数，按要求以 $\\left[s_{\\mathrm{ZA}}(99), s_{\\mathrm{2LPT}}(99), s_{\\mathrm{ZA}}(49), s_{\\mathrm{2LPT}}(49), s_{\\mathrm{ZA}}(9), s_{\\mathrm{2LPT}}(9), s_{\\mathrm{ZA}}(199), s_{\\mathrm{2LPT}}(199)\\right]$ 的顺序打印。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef suppression_ZA(z_init: float) -> float:\n    \"\"\"\n    Compute the transient suppression measure s for Zel'dovich (1LPT) initial conditions\n    at z=0 in an Einstein–de Sitter universe, given z_init.\n    s = 1 - (D2_wrong(1)/D2_true(1))^2\n    where D2_true(1) = -3/7 and\n    D2_wrong(1) = -3/7 + (3/5)*a_i - (6/35)*a_i^(7/2).\n    \"\"\"\n    a_i = 1.0 / (1.0 + z_init)\n    D2_true = -3.0 / 7.0\n    D2_wrong = (-3.0 / 7.0) + (3.0 / 5.0) * a_i - (6.0 / 35.0) * (a_i ** 3.5)\n    ratio_sq = (D2_wrong / D2_true) ** 2\n    s = 1.0 - ratio_sq\n    return s\n\ndef suppression_2LPT(z_init: float) -> float:\n    \"\"\"\n    Compute the transient suppression measure s for 2LPT initial conditions.\n    In EdS with correct matching, D2_wrong(1) = D2_true(1), hence s = 0.\n    \"\"\"\n    return 0.0\n\ndef solve():\n    # Define the test cases from the problem statement.\n    # Order: z_init = 99 (typical), 49 (intermediate), 9 (boundary low), 199 (high edge).\n    test_cases = [99.0, 49.0, 9.0, 199.0]\n\n    results = []\n    for z in test_cases:\n        s_ZA = suppression_ZA(z)\n        s_2LPT = suppression_2LPT(z)\n        # Append in the specified order: ZA then 2LPT for each z_init.\n        results.append(s_ZA)\n        results.append(s_2LPT)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3507115"}, {"introduction": "计算所有粒子对之间的引力是$N$体模拟中最主要的计算成本。本练习将深入探讨Barnes-Hut树算法，这是高效引力求解器的基石。您将推导其核心近似——“张开判据”（opening criterion）的数学基础，并数值化地量化该判据所控制的计算速度与力精度之间的权衡。[@problem_id:3507136]", "problem": "考虑 Barnes–Hut (BH) 算法所使用的分层树中的一个远距离节点，其中 Barnes–Hut (BH) 指的是一种近似技术，它用截断的多极展开来替代一组粒子。在牛顿引力中，一个N体系统的引力势，在位置向量为 $\\mathbf{r}$ 的场点上，由位于位置 $\\mathbf{x}_i$、质量为 $m_i$ 的粒子所产生，是通过对其贡献求和来计算的。为了在宇宙学N体模拟中保持计算稳定性，Plummer 软化使用了一种软化势核。在无量纲单位下，设引力常数 $G=1$。将质量为 $m$ 的点质量在分离向量 $\\mathbf{y}=\\mathbf{r}-\\mathbf{x}$ 处的 Plummer 软化引力势定义为\n$$\n\\Phi(\\mathbf{y}) = -\\frac{m}{\\sqrt{|\\mathbf{y}|^2+\\epsilon^2}},\n$$\n以及相应的力\n$$\n\\mathbf{F}(\\mathbf{y}) = -m\\,\\frac{\\mathbf{y}}{\\left(|\\mathbf{y}|^2+\\epsilon^2\\right)^{3/2}},\n$$\n其中 $\\epsilon>0$ 是 Plummer 软化长度。在 BH 树中，一个包含许多粒子的节点被近似为一个位于该节点质心、总质量为 $M=\\sum_i m_i$ 的单极子，如果打开判据 $s/d\\leq\\theta$ 成立，则该节点被接受而无需打开。其中 $s$ 是节点的线性尺寸，$d$ 是场点到节点质心的距离，$\\theta$ 是一个打开角参数。\n\n任务A（推导）：从质心位于原点的远距离分布的多极展开出发，假设偶极矩项为零，并使用领头的非零四极矩项来估计对 Plummer 软化核在单极子处截断时产生的相对力误差。设四极矩张量为无迹对称张量\n$$\nQ_{jk}=\\sum_i m_i\\left(3 x_{i,j} x_{i,k} - r_i^2 \\delta_{jk}\\right),\n$$\n其中 $\\mathbf{x}_i=(x_{i,1},x_{i,2},x_{i,3})$，$r_i=|\\mathbf{x}_i|$，$\\delta_{jk}$ 是 Kronecker delta。设 $\\mathbf{n}=\\mathbf{r}/|\\mathbf{r}|$ 为从节点到场点的方向，并定义一个朝向因子 $q_n=\\mathbf{n}^\\top Q\\,\\mathbf{n}$。推导单极子近似的相对力误差 $|\\Delta \\mathbf{F}|/|\\mathbf{F}|$ 的一个界，用 $q_n$、$M$、$s$ 和软化有效半径 $r_{\\mathrm{eff}}=\\sqrt{d^2+\\epsilon^2}$ 来表示。使用这个界来获得一个形如\n$$\n\\frac{s}{r_{\\mathrm{eff}}} \\le \\theta,\n$$\n的判据，该判据确保相对误差低于指定的容差 $0<\\delta<1$。用 $\\delta$ 和一个无量纲几何因子 $g$ 来表示最终的 $\\theta$，其中 $g$ 编码了相对于 $M s^2$ 且依赖于形状的四极矩强度。不要使用预先给出的多极误差缩放的快捷公式；相反，应从上述定义出发，推导出最终的界。\n\n任务B（量化）：实现一个程序，对于给定的具有指定粒子位置和质量、Plummer 软化长度 $\\epsilon$、节点尺寸 $s$ 和场点位置 $\\mathbf{r}$ 的节点，计算：\n- 通过对粒子直接求和得到的精确 Plummer 软化力 $\\mathbf{F}_{\\mathrm{exact}}$。\n- 使用节点质心和总质量得到的单极子 Plummer 软化力 $\\mathbf{F}_{\\mathrm{mono}}$。\n- 无量纲相对力误差 $E=\\left|\\mathbf{F}_{\\mathrm{exact}}-\\mathbf{F}_{\\mathrm{mono}}\\right|/\\left|\\mathbf{F}_{\\mathrm{exact}}\\right|$。\n- 使用打开判据 $s/r_{\\mathrm{eff}}\\le\\theta$ 得到的作为布尔值的接受决策 $A$。\n\n所有输出必须是无量纲浮点数或布尔值。不使用角度，因此不需要角度单位。在整个过程中使用 $G=1$ 和无量纲单位。\n\n测试套件规范：您的程序必须评估以下五个测试用例，每个用例都由粒子位置列表 $\\{\\mathbf{x}_i\\}$、相等的粒子质量 $m_i=M/N$（除非另有说明，否则 $M=1$）、节点尺寸 $s$、软化长度 $\\epsilon$、场点 $\\mathbf{r}$ 和打开角参数 $\\theta$ 定义。\n\n- 用例1（正常路径，近似各向同性立方体）：\n  - 粒子位于边长 $s=1$ 的立方体的八个角点：$(\\pm 0.5,\\pm 0.5,\\pm 0.5)$，总质量 $M=1$ 平均分配。\n  - 场点 $\\mathbf{r}=(0,0,5)$，软化长度 $\\epsilon=0.1$，节点尺寸 $s=1$，打开参数 $\\theta=0.5$。\n\n- 用例2（边界情况，与场方向对齐的平面各向异性）：\n  - 粒子沿 $x$ 轴位于 $(-0.5,0,0)$、 $(-0.33,0,0)$、 $(0.33,0,0)$、 $(0.5,0,0)$，总质量 $M=1$ 平均分配。\n  - 场点 $\\mathbf{r}=(2,0,0)$，软化长度 $\\epsilon=0.01$，节点尺寸 $s=1$，打开参数 $\\theta=0.5$。\n\n- 用例3（边缘情况，近似球对称减小了四极矩）：\n  - 粒子位于六个坐标轴点 $(\\pm 0.5,0,0)$、 $(0,\\pm 0.5,0)$、 $(0,0,\\pm 0.5)$，总质量 $M=1$ 平均分配。\n  - 场点 $\\mathbf{r}=(0,0,1.5)$，软化长度 $\\epsilon=0$，节点尺寸 $s=1$，打开参数 $\\theta=0.5$。\n\n- 用例4（尽管尺寸与距离之比较大，但大的软化长度减小了误差）：\n  - 粒子位于 $(0.5,0.25,0)$、 $(-0.5,-0.25,0)$、 $(0.25,-0.5,0.25)$、 $(-0.25,0.5,-0.25)$、 $(0,0.5,0.5)$、 $(0,-0.5,-0.5)$，总质量 $M=1$ 平均分配。\n  - 场点 $\\mathbf{r}=(0,0,1)$，软化长度 $\\epsilon=1.0$，节点尺寸 $s=1$，打开参数 $\\theta=0.5$。\n\n- 用例5（接近阈值，与场方向正交的各向异性板）：\n  - 粒子位于 $(0,0.5,0.5)$、 $(0,-0.5,0.5)$、 $(0,0.5,-0.5)$、 $(0,-0.5,-0.5)$，总质量 $M=1$ 平均分配。\n  - 场点 $\\mathbf{r}=(0,0,1.2)$，软化长度 $\\epsilon=0$，节点尺寸 $s=1$，打开参数 $\\theta=0.5$。\n\n最终输出格式：您的程序应生成单行输出，其中包含五个测试用例的结果，格式为方括号括起来的逗号分隔列表。每个测试用例的结果本身必须是一个形如 $[E,A]$ 的双元素列表，其中 $E$ 是作为浮点数的相对力误差，$A$ 是接受决策的布尔值。例如，程序应打印形如 $[[e_1,a_1],[e_2,a_2],[e_3,a_3],[e_4,a_4],[e_5,a_5]]$ 的一行，其中每个 $e_k$ 是一个浮点数，每个 $a_k$ 是一个布尔值。", "solution": "该问题经评估有效。它在科学上基于牛顿引力和多极展开的原理，特别是在计算天体物理学中应用于带有 Plummer 软化的 Barnes-Hut 算法。该问题是适定的（well-posed），为理论推导（任务A）和数值实现（任务B）提供了所有必要的定义、常数和数据。其设置内部一致，任务定义清晰。\n\n### 任务A：相对力误差界和打开判据的推导\n\n目标是推导在 Barnes-Hut 算法中，对于 Plummer 软化势，由单极子近似所产生的相对力误差的界，并利用此界来构建一个打开判据。\n\n设场点位于位置 $\\mathbf{r}$，粒子分布的质量为 $m_i$，位置为 $\\mathbf{x}_i$。我们在一个坐标系中工作，该坐标系的原点是粒子分布的质心（CoM），因此 $\\sum_i m_i \\mathbf{x}_i = \\mathbf{0}$。总质量为 $M = \\sum_i m_i$。位于 $\\mathbf{r}$ 处的单位质量测试粒子受到粒子 $i$ 的作用力由 Plummer 软化定律给出，其中 $G=1$：\n$$\n\\mathbf{F}_i(\\mathbf{r}) = -m_i \\frac{\\mathbf{r} - \\mathbf{x}_i}{\\left(|\\mathbf{r} - \\mathbf{x}_i|^2 + \\epsilon^2\\right)^{3/2}}\n$$\n精确的总力是所有粒子的力之和：$\\mathbf{F}_{\\mathrm{exact}}(\\mathbf{r}) = \\sum_i \\mathbf{F}_i(\\mathbf{r})$。\n单极子近似将整个分布替换为位于质心（$\\mathbf{x}=\\mathbf{0}$）的单个质量为 $M$ 的粒子。单极子力为：\n$$\n\\mathbf{F}_{\\mathrm{mono}}(\\mathbf{r}) = -M \\frac{\\mathbf{r}}{\\left(|\\mathbf{r}|^2 + \\epsilon^2\\right)^{3/2}} = -M \\frac{\\mathbf{r}}{r_{\\mathrm{eff}}^3}\n$$\n其中 $d = |\\mathbf{r}|$ 是从质心到场点的距离，$r_{\\mathrm{eff}} = \\sqrt{d^2 + \\epsilon^2}$ 是软化有效距离。\n\n力的误差为 $\\Delta\\mathbf{F} = \\mathbf{F}_{\\mathrm{exact}} - \\mathbf{F}_{\\mathrm{mono}}$。为了估计这个误差，我们对单个粒子的力贡献 $\\mathbf{F}(\\mathbf{y}) = -m \\mathbf{y} / (|\\mathbf{y}|^2 + \\epsilon^2)^{3/2}$ 进行泰勒展开，其中 $\\mathbf{y} = \\mathbf{r}-\\mathbf{x}_i$。我们针对 $|\\mathbf{x}_i|$ 相对于 $|\\mathbf{r}|$ 较小的情况进行展开。设 $\\mathbf{G}(\\mathbf{y}) = -\\mathbf{y}/(|\\mathbf{y}|^2+\\epsilon^2)^{3/2}$ 为单位质量的力。\n$$\n\\mathbf{F}_{\\mathrm{exact}}(\\mathbf{r}) = \\sum_i m_i \\mathbf{G}(\\mathbf{r}-\\mathbf{x}_i)\n$$\n在 $\\mathbf{x}_i=\\mathbf{0}$ 附近展开 $\\mathbf{G}(\\mathbf{r}-\\mathbf{x}_i)$：\n$$\n\\mathbf{G}(\\mathbf{r}-\\mathbf{x}_i) \\approx \\mathbf{G}(\\mathbf{r}) - \\sum_{j=1}^3 (\\mathbf{x}_i)_j \\frac{\\partial\\mathbf{G}}{\\partial r_j}(\\mathbf{r}) + \\frac{1}{2} \\sum_{j,k=1}^3 (\\mathbf{x}_i)_j (\\mathbf{x}_i)_k \\frac{\\partial^2\\mathbf{G}}{\\partial r_j \\partial r_k}(\\mathbf{r}) + \\mathcal{O}(|\\mathbf{x}_i|^3)\n$$\n对所有粒子求和：\n$$\n\\mathbf{F}_{\\mathrm{exact}}(\\mathbf{r}) \\approx \\left(\\sum_i m_i\\right) \\mathbf{G}(\\mathbf{r}) - \\sum_{j=1}^3 \\left(\\sum_i m_i (\\mathbf{x}_i)_j\\right) \\frac{\\partial\\mathbf{G}}{\\partial r_j} + \\frac{1}{2} \\sum_{j,k=1}^3 \\left(\\sum_i m_i (\\mathbf{x}_i)_j (\\mathbf{x}_i)_k\\right) \\frac{\\partial^2\\mathbf{G}}{\\partial r_j \\partial r_k}\n$$\n第一项是 $M\\mathbf{G}(\\mathbf{r}) = \\mathbf{F}_{\\mathrm{mono}}(\\mathbf{r})$。第二项因为展开是围绕质心进行的（$\\sum_i m_i \\mathbf{x}_i = \\mathbf{0}$）而消失。因此，领头的误差项是四极矩项：\n$$\n\\Delta\\mathbf{F} \\approx \\frac{1}{2} \\sum_{j,k=1}^3 T_{jk} \\frac{\\partial^2\\mathbf{G}}{\\partial r_j \\partial r_k}\n$$\n其中 $T_{jk} = \\sum_i m_i (\\mathbf{x}_i)_j (\\mathbf{x}_i)_k$ 是转动惯量张量。需要 $\\mathbf{G}$ 的二阶导数的分量。对于分量 $p$：\n$$\nG_p(\\mathbf{r}) = -r_p (r_1^2+r_2^2+r_3^2+\\epsilon^2)^{-3/2} = -r_p r_{\\mathrm{eff}}^{-3}\n$$\n二阶偏导数为：\n$$\n\\frac{\\partial^2 G_p}{\\partial r_j \\partial r_k} = 3\\frac{\\delta_{pj}r_k + \\delta_{pk}r_j + \\delta_{jk}r_p}{r_{\\mathrm{eff}}^5} - 15\\frac{r_p r_j r_k}{r_{\\mathrm{eff}}^7}\n$$\n将此代入 $\\Delta\\mathbf{F}$ 的表达式：\n$$\n(\\Delta\\mathbf{F})_p \\approx \\frac{1}{2} \\sum_{j,k} T_{jk} \\left( 3\\frac{\\delta_{pj}r_k + \\delta_{pk}r_j + \\delta_{jk}r_p}{r_{\\mathrm{eff}}^5} - 15\\frac{r_p r_j r_k}{r_{\\mathrm{eff}}^7} \\right)\n$$\n利用 $T_{jk}$ 的对称性并对指标求和，我们得到：\n$$\n(\\Delta\\mathbf{F})_p \\approx \\frac{3}{r_{\\mathrm{eff}}^5} (T\\mathbf{r})_p + \\frac{3 r_p}{2 r_{\\mathrm{eff}}^5} \\mathrm{Tr}(T) - \\frac{15 r_p}{2 r_{\\mathrm{eff}}^7} (\\mathbf{r}^\\top T \\mathbf{r})\n$$\n其中 $\\mathrm{Tr}(T) = \\sum_k T_{kk} = \\sum_i m_i r_i^2$。用向量形式表示：\n$$\n\\Delta\\mathbf{F} \\approx \\frac{3}{r_{\\mathrm{eff}}^5} T\\mathbf{r} + \\frac{3 (\\mathrm{Tr}(T))}{2 r_{\\mathrm{eff}}^5} \\mathbf{r} - \\frac{15 (\\mathbf{r}^\\top T \\mathbf{r})}{2 r_{\\mathrm{eff}}^7} \\mathbf{r}\n$$\n我们引入无迹四极矩张量 $Q_{jk} = \\sum_i m_i (3(\\mathbf{x}_i)_j (\\mathbf{x}_i)_k - r_i^2 \\delta_{jk})$。它与 $T_{jk}$ 的关系为 $T_{jk} = \\frac{1}{3}Q_{jk} + \\frac{1}{3}\\mathrm{Tr}(T)\\delta_{jk}$。将此代入 $\\Delta\\mathbf{F}$ 的表达式并化简得到：\n$$\n\\Delta\\mathbf{F} \\approx \\frac{1}{r_{\\mathrm{eff}}^5} Q\\mathbf{r} - \\frac{5}{2r_{\\mathrm{eff}}^7} (\\mathbf{r}^\\top Q \\mathbf{r}) \\mathbf{r} + \\frac{5\\epsilon^2}{2r_{\\mathrm{eff}}^7} \\mathrm{Tr}(T) \\mathbf{r}\n$$\n为了获得一个界，我们对 $|\\Delta\\mathbf{F}|$ 使用三角不等式，并引入一个无量纲几何因子 $g$。设节点尺寸 $s$ 是粒子分布偏离质心的最大范围的度量，例如 $s = \\max_i |\\mathbf{x}_i|$。然后我们可以对四极矩张量和转动惯量进行限定。我们定义 $g$，使得四极矩张量的算子范数有界 $||Q|| \\le g M s^2$。类似地，$\\mathrm{Tr}(T) = \\sum_i m_i r_i^2 \\le M s^2$。问题定义了 $q_n = \\mathbf{n}^\\top Q \\mathbf{n}$，其中 $\\mathbf{n}=\\mathbf{r}/d$。那么 $\\mathbf{r}^\\top Q \\mathbf{r} = d^2 q_n$。$q_n$ 的大小也是有界的：$|q_n| \\le ||Q|| \\le gMs^2$。\n$$\n|\\Delta\\mathbf{F}| \\le \\frac{1}{r_{\\mathrm{eff}}^5} |Q\\mathbf{r}| + \\frac{5}{2r_{\\mathrm{eff}}^7} |\\mathbf{r}^\\top Q \\mathbf{r}| |\\mathbf{r}| + \\frac{5\\epsilon^2}{2r_{\\mathrm{eff}}^7} \\mathrm{Tr}(T) |\\mathbf{r}|\n$$\n$$\n|\\Delta\\mathbf{F}| \\lesssim \\frac{g M s^2 d}{r_{\\mathrm{eff}}^5} + \\frac{5(g M s^2 d^2)}{2r_{\\mathrm{eff}}^7} d + \\frac{5\\epsilon^2(M s^2)}{2r_{\\mathrm{eff}}^7} d = g M s^2 \\frac{d}{r_{\\mathrm{eff}}^5} \\left(1 + \\frac{5d^2}{2r_{\\mathrm{eff}}^2} + \\frac{5\\epsilon^2}{2r_{\\mathrm{eff}}^2} \\right)\n$$\n使用 $r_{\\mathrm{eff}}^2 = d^2+\\epsilon^2$：\n$$\n|\\Delta\\mathbf{F}| \\lesssim g M s^2 \\frac{d}{r_{\\mathrm{eff}}^5} \\left(1 + \\frac{5(d^2+\\epsilon^2)}{2r_{\\mathrm{eff}}^2} \\right) = g M s^2 \\frac{d}{r_{\\mathrm{eff}}^5} \\left(1 + \\frac{5}{2} \\right) = \\frac{7}{2} g M s^2 \\frac{d}{r_{\\mathrm{eff}}^5}\n$$\n单极子力的量值为 $|\\mathbf{F}_{\\mathrm{mono}}| = M d / r_{\\mathrm{eff}}^3$。因此，相对力误差的界为：\n$$\n\\frac{|\\Delta\\mathbf{F}|}{|\\mathbf{F}_{\\mathrm{mono}}|} \\lesssim \\frac{\\frac{7}{2} g M s^2 d / r_{\\mathrm{eff}}^5}{M d / r_{\\mathrm{eff}}^3} = \\frac{7}{2} g \\frac{s^2}{r_{\\mathrm{eff}}^2}\n$$\n为了确保误差低于容差 $\\delta$，我们要求：\n$$\n\\frac{7}{2} g \\left(\\frac{s}{r_{\\mathrm{eff}}}\\right)^2 \\le \\delta \\implies \\frac{s}{r_{\\mathrm{eff}}} \\le \\sqrt{\\frac{2\\delta}{7g}}\n$$\n这就是所需的形式为 $s/r_{\\mathrm{eff}} \\le \\theta$ 的判据，其中打开角参数 $\\theta$ 由下式给出：\n$$\n\\theta(\\delta, g) = \\sqrt{\\frac{2\\delta}{7g}}\n$$\n这个表达式将打开角 $\\theta$ 与期望的精度 $\\delta$ 以及质量分布的形状联系起来，后者被编码在无量纲因子 $g$ 中。\n\n### 任务B：数值量化\n\n下面的 Python 程序实现了五个测试用例所需的计算。它通过直接求和计算精确力，使用质心计算单极子力，计算相对力误差，并根据推导出的判据 $s/r_{\\mathrm{eff}} \\le \\theta$ 作出接受决策。\n\n对于每个测试用例，程序定义了粒子配置和模拟参数。然后它计算：\n1.  **质心**：对于一个由 $N$ 个等质量粒子组成的系统，$\\mathbf{x}_{\\mathrm{CM}} = \\frac{1}{N}\\sum_i \\mathbf{x}_i$。所有提供的测试用例的分布质心都在原点 $\\mathbf{0}$。\n2.  **精确力**：$\\mathbf{F}_{\\mathrm{exact}} = \\sum_{i=1}^N -m_i \\frac{\\mathbf{r} - \\mathbf{x}_i}{(|\\mathbf{r} - \\mathbf{x}_i|^2 + \\epsilon^2)^{3/2}}$，其中 $m_i=M/N$。\n3.  **单极子力**：$\\mathbf{F}_{\\mathrm{mono}} = -M \\frac{\\mathbf{r} - \\mathbf{x}_{\\mathrm{CM}}}{(|\\mathbf{r} - \\mathbf{x}_{\\mathrm{CM}}|^2 + \\epsilon^2)^{3/2}}$。\n4.  **相对误差**：$E = |\\mathbf{F}_{\\mathrm{exact}} - \\mathbf{F}_{\\mathrm{mono}}| / |\\mathbf{F}_{\\mathrm{exact}}|$。\n5.  **接受决策**：如果 $s / \\sqrt{|\\mathbf{r} - \\mathbf{x}_{\\mathrm{CM}}|^2 + \\epsilon^2} \\le \\theta$，则布尔值 $A$ 为 `True`，否则为 `False`。\n\n所有五个用例的结果被收集并以指定的格式 `[[e1,a1],[e2,a2],...]` 打印出来。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Solves the computational astrophysics problem for five test cases.\n\n    For each case, it computes:\n    - The exact Plummer-softened gravitational force by direct summation.\n    - The monopole approximation of the force.\n    - The relative error between the exact and monopole forces.\n    - The Barnes-Hut acceptance criterion based on a softened effective radius.\n    \"\"\"\n\n    test_cases = [\n        # Case 1: Happy path, approximately isotropic cube\n        {\n            \"particles\": np.array([\n                [ 0.5,  0.5,  0.5], [-0.5,  0.5,  0.5], [ 0.5, -0.5,  0.5], [-0.5, -0.5,  0.5],\n                [ 0.5,  0.5, -0.5], [-0.5,  0.5, -0.5], [ 0.5, -0.5, -0.5], [-0.5, -0.5, -0.5]\n            ]),\n            \"M\": 1.0, \"s\": 1.0, \"epsilon\": 0.1, \"r_field\": np.array([0.0, 0.0, 5.0]), \"theta\": 0.5\n        },\n        # Case 2: Boundary case, planar anisotropy aligned with field direction\n        {\n            \"particles\": np.array([\n                [-0.5, 0.0, 0.0], [-0.33, 0.0, 0.0], [0.33, 0.0, 0.0], [0.5, 0.0, 0.0]\n            ]),\n            \"M\": 1.0, \"s\": 1.0, \"epsilon\": 0.01, \"r_field\": np.array([2.0, 0.0, 0.0]), \"theta\": 0.5\n        },\n        # Case 3: Edge case, approximate spherical symmetry reduces quadrupole\n        {\n            \"particles\": np.array([\n                [ 0.5,  0.0,  0.0], [-0.5,  0.0,  0.0], [ 0.0,  0.5,  0.0],\n                [ 0.0, -0.5,  0.0], [ 0.0,  0.0,  0.5], [ 0.0,  0.0, -0.5]\n            ]),\n            \"M\": 1.0, \"s\": 1.0, \"epsilon\": 0.0, \"r_field\": np.array([0.0, 0.0, 1.5]), \"theta\": 0.5\n        },\n        # Case 4: Large softening reduces error despite large size-to-distance ratio\n        {\n            \"particles\": np.array([\n                [ 0.5,   0.25,  0.0 ], [-0.5,  -0.25,  0.0 ], [ 0.25, -0.5,   0.25],\n                [-0.25,  0.5,  -0.25], [ 0.0,   0.5,   0.5 ], [ 0.0,  -0.5,  -0.5 ]\n            ]),\n            \"M\": 1.0, \"s\": 1.0, \"epsilon\": 1.0, \"r_field\": np.array([0.0, 0.0, 1.0]), \"theta\": 0.5\n        },\n        # Case 5: Near-threshold, anisotropic slab orthogonal to field direction\n        {\n            \"particles\": np.array([\n                [0.0,  0.5,  0.5], [0.0, -0.5,  0.5], [0.0,  0.5, -0.5], [0.0, -0.5, -0.5]\n            ]),\n            \"M\": 1.0, \"s\": 1.0, \"epsilon\": 0.0, \"r_field\": np.array([0.0, 0.0, 1.2]), \"theta\": 0.5\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        particles = case[\"particles\"]\n        M = case[\"M\"]\n        s = case[\"s\"]\n        epsilon = case[\"epsilon\"]\n        r_field = case[\"r_field\"]\n        theta = case[\"theta\"]\n\n        N = len(particles)\n        m_i = M / N\n\n        # Calculate Center of Mass (CoM)\n        # For equal masses, CoM is the mean of particle positions.\n        x_cm = np.mean(particles, axis=0)\n\n        # Calculate exact force by direct summation\n        F_exact = np.zeros(3)\n        for x_i in particles:\n            y_i = r_field - x_i\n            mag_y_sq = np.dot(y_i, y_i)\n            # F_i = -m_i * y_i / (mag_y_sq + epsilon^2)^(3/2)\n            denominator = (mag_y_sq + epsilon**2)**1.5\n            if denominator > 0:\n                F_exact += -m_i * y_i / denominator\n\n        # Calculate monopole force\n        d_vec = r_field - x_cm\n        d_sq = np.dot(d_vec, d_vec)\n        # F_mono = -M * d_vec / (d_sq + epsilon^2)^(3/2)\n        F_mono_denominator = (d_sq + epsilon**2)**1.5\n        F_mono = -M * d_vec / F_mono_denominator if F_mono_denominator > 0 else np.zeros(3)\n\n        # Calculate relative force error E\n        delta_F = F_exact - F_mono\n        mag_delta_F = np.linalg.norm(delta_F)\n        mag_F_exact = np.linalg.norm(F_exact)\n        \n        # Handle case where exact force is zero to avoid division by zero\n        E = mag_delta_F / mag_F_exact if mag_F_exact != 0 else 0.0\n\n        # Calculate acceptance decision A\n        d = np.sqrt(d_sq)\n        r_eff = np.sqrt(d**2 + epsilon**2)\n        A = (s / r_eff) = theta if r_eff > 0 else False\n        \n        results.append([E, A])\n\n    # Format the results into the required string format\n    result_str = \"[\" + \",\".join([f\"[{e:.6g},{str(a).lower()}]\" for e, a in results]) + \"]\"\n    print(result_str)\n\nsolve()\n```", "id": "3507136"}, {"introduction": "计算出引力后，下一步是随时间积分粒子的运动方程。在宇宙学背景下，宇宙的膨胀使得这一过程变得复杂，通常需要可变的时间步长。本实践将一个朴素的积分器与一个时间对称方案进行比较，展示对称性对于在宇宙学模拟中保持长期准确性和稳定性的至关重要性。[@problem_id:3507114]", "problem": "在宇宙学背景下，从共动坐标和膨胀背景下的基本动力学方程出发，实现并分析可变时间步积分。任务是量化 Leapfrog (LF) 方法中由可变时间步引入的积分误差，并设计一种当标度因子在 Einstein-de Sitter (EdS) 宇宙学中用作时间变量时，能够保持二阶精度的时间对称格式。\n\n考虑在空间平坦的 Friedmann–Lemaître–Robertson–Walker (FLRW) 宇宙中，单个粒子在共动坐标下的牛顿运动方程。共动坐标用 $x$ 表示，标度因子用 $a$ 表示，哈勃参数用 $H(a)$ 表示。在共动变量下，一个受共动奇特引力势 $\\phi$ 作用的粒子的牛顿第二定律为\n$$\n\\frac{d^2 x}{dt^2} + 2 H \\frac{dx}{dt} = - \\frac{1}{a^2} \\nabla_x \\phi.\n$$\n定义正则动量 $p \\equiv a^2 \\frac{dx}{dt}$。使用 $dt = \\frac{da}{aH(a)}$ 和链式法则，以标度因子 $a$ 为变量的运动方程为\n$$\n\\frac{dx}{da} = \\frac{p}{a^3 H(a)}, \\qquad \\frac{dp}{da} = \\frac{F(x,a)}{a^2 H(a)},\n$$\n其中 $F(x,a) \\equiv - \\nabla_x \\phi$。对于此问题，设 $F(x,a) = 0$（自由粒子），这样可以分离出宇宙膨胀和时间离散化的影响。此时，$p$ 是一个常数，精确解可通过求积法得到。\n\n采用 Einstein–de Sitter (EdS) 宇宙学，其中 $H(a) = H_0 a^{-3/2}$。在代码单位中进行计算，设 $H_0 = 1$ 和无量纲的共动位置；因此，所有报告的量都是无量纲的，不使用物理单位。设初始和最终标度因子分别为 $a_i = 0.01$ 和 $a_f = 1$。初始条件为 $x(a_i) = x_i = 0$ 和 $v_i = \\left.\\frac{dx}{dt}\\right|_{a_i} = 1$，因此 $p = a_i^2 v_i$。\n\n对于给定的可变步长序列 $\\{\\Delta a_n\\}_{n=0}^{N-1}$，您必须实现并比较以下两种将 $x$ 从 $a_n$ 推进到 $a_{n+1} = a_n + \\Delta a_n$ 的单步更新规则：\n- 一种非时间对称的一阶漂移（一种朴素的可变步长 LF 漂移，在左端点对被积函数进行采样）：\n$$\nx_{n+1}^{\\mathrm{naive}} = x_n + \\Delta a_n \\, \\frac{p}{a_n^3 H(a_n)}.\n$$\n- 一种时间对称的二阶漂移（一种梯形法则，在 $a \\to -a$ 步长反转下保持可逆性）：\n$$\nx_{n+1}^{\\mathrm{sym}} = x_n + \\frac{\\Delta a_n}{2} \\, p \\left[ \\frac{1}{a_n^3 H(a_n)} + \\frac{1}{a_{n+1}^3 H(a_{n+1})} \\right].\n$$\n当 $F=0$ 时，两种方法都简化为 Leapfrog 的特例，但对于可变的 $\\Delta a_n$，它们在时间对称性和全局阶数上有所不同。\n\n对于 $a_f$ 处的精确解，使用解析积分\n$$\nx_{\\mathrm{exact}}(a_f) = x_i + \\int_{a_i}^{a_f} \\frac{p}{a^3 H(a)} \\, da\n= x_i - \\frac{2 p}{H_0} \\left( a_f^{-1/2} - a_i^{-1/2} \\right),\n$$\n在代码单位中 $H_0 = 1$。\n\n测试套件。使用以下在 $a_i$ 和 $a_f$ 之间的步长序列，每个序列都指定为步长列表 $\\{\\Delta a_n\\}$，其总和恰好为 $a_f - a_i$：\n- 情况 1（均匀，中等分辨率）：$N = 64$ 个相等步长。\n- 情况 2（单个粗略步长，边界极端情况）：$N = 1$。\n- 情况 3（几何增长，强可变）：$N = 32$ 个步长，权重为 $w_k = r^k$，比率为 $r = 1.5$，$k \\in \\{0,\\dots,N-1\\}$，经归一化以使 $\\sum \\Delta a_k = a_f - a_i$，其中 $\\Delta a_k \\propto w_k$。\n- 情况 4（小大交替，高度不均匀）：$N = 32$ 个步长，大小在 $\\Delta a_{\\mathrm{small}}$ 和 $\\Delta a_{\\mathrm{large}}$ 之间交替，使得 $\\Delta a_{\\mathrm{large}} / \\Delta a_{\\mathrm{small}} = R = 50$，且总和等于 $a_f - a_i$。\n\n对于每种情况，计算两种格式在 $a_f$ 处的最终位置绝对误差：\n$$\ne_{\\mathrm{naive}} = \\left| x^{\\mathrm{naive}}(a_f) - x_{\\mathrm{exact}}(a_f) \\right|, \\qquad\ne_{\\mathrm{sym}} = \\left| x^{\\mathrm{sym}}(a_f) - x_{\\mathrm{exact}}(a_f) \\right|.\n$$\n\n最终输出格式。您的程序应生成单行输出，包含按以下顺序聚合的 8 个浮点数结果\n$$\n\\left[ e_{\\mathrm{naive}}^{(1)}, e_{\\mathrm{sym}}^{(1)}, e_{\\mathrm{naive}}^{(2)}, e_{\\mathrm{sym}}^{(2)}, e_{\\mathrm{naive}}^{(3)}, e_{\\mathrm{sym}}^{(3)}, e_{\\mathrm{naive}}^{(4)}, e_{\\mathrm{sym}}^{(4)} \\right],\n$$\n以逗号分隔的列表形式打印，并用方括号括起来（例如 $[r_1,r_2,\\dots,r_8]$）。所有量在代码单位中都是无量纲的。无需读取任何输入；所有参数均按上述规定进行硬编码。", "solution": "用户提供的问题已经过分析，并被认为是有效的。\n\n### 问题验证\n\n**第 1 步：提取给定条件**\n\n- **共动坐标下的动力学方程：**\n  - `\\frac{d^2 x}{dt^2} + 2 H \\frac{dx}{dt} = - \\frac{1}{a^2} \\nabla_x \\phi`\n  - 正则动量：`p \\equiv a^2 \\frac{dx}{dt}`\n  - 时间变量变换：`dt = \\frac{da}{aH(a)}`\n  - 以标度因子 `a` 表示的运动方程：\n    `\\frac{dx}{da} = \\frac{p}{a^3 H(a)}`, `\\frac{dp}{da} = \\frac{F(x,a)}{a^2 H(a)}` 其中 `F(x,a) \\equiv - \\nabla_x \\phi`。\n- **问题简化：**\n  - 力设为零：`F(x,a) = 0`，这意味着 `p` 是一个常数。\n- **宇宙学模型：**\n  - Einstein-de Sitter (EdS) 宇宙学：`H(a) = H_0 a^{-3/2}`。\n- **单位与常数：**\n  - 使用代码单位。\n  - 哈勃常数：`H_0 = 1`。\n  - 初始标度因子：`a_i = 0.01`。\n  - 最终标度因子：`a_f = 1`。\n- **初始条件：**\n  - 初始位置：`x(a_i) = x_i = 0`。\n  - 初始奇特速度：`v_i = \\left.\\frac{dx}{dt}\\right|_{a_i} = 1`。\n- **数值积分格式：**\n  - 非时间对称（朴素）漂移：`x_{n+1}^{\\mathrm{naive}} = x_n + \\Delta a_n \\, \\frac{p}{a_n^3 H(a_n)}`。\n  - 时间对称漂移：`x_{n+1}^{\\mathrm{sym}} = x_n + \\frac{\\Delta a_n}{2} \\, p \\left[ \\frac{1}{a_n^3 H(a_n)} + \\frac{1}{a_{n+1}^3 H(a_{n+1})} \\right]`。\n- **精确解：**\n  - `x_{\\mathrm{exact}}(a_f) = x_i - \\frac{2 p}{H_0} \\left( a_f^{-1/2} - a_i^{-1/2} \\right)`。\n- **测试用例（从 `a_i` 到 `a_f` 的步长序列 `\\{\\Delta a_n\\}`）：**\n  - 情况 1：`N=64` 个相等步长。\n  - 情况 2：`N=1` 个单一步长。\n  - 情况 3：`N=32` 个几何级数步长，比率为 `r=1.5`。\n  - 情况 4：`N=32` 个交替步长，大小比率为 `R=50`。\n- **要求输出：**\n  - 一个包含 8 个绝对误差的列表：`[e_{\\mathrm{naive}}^{(1)}, e_{\\mathrm{sym}}^{(1)}, e_{\\mathrm{naive}}^{(2)}, e_{\\mathrm{sym}}^{(2)}, e_{\\mathrm{naive}}^{(3)}, e_{\\mathrm{sym}}^{(3)}, e_{\\mathrm{naive}}^{(4)}, e_{\\mathrm{sym}}^{(4)}]`。\n\n**第 2 步：使用提取的给定条件进行验证**\n\n- **科学依据：** 该问题基于标准 FLRW 宇宙学模型中的基本运动方程。转换到共动坐标以及使用标度因子作为时间变量是计算宇宙学中的标准技术。EdS 模型是一个公认的简化模型。\n- **适定性：** 该问题是一个定义明确的常微分方程初值问题，具有一组给定的参数。存在唯一的解析解，从而可以进行精确的误差量化。\n- **客观性：** 问题以精确、无歧义的数学语言陈述。任务是定量的，没有主观解释的余地。\n- **完整性与一致性：** 提供了所有必要的参数（`a_i, a_f, x_i, v_i, H_0`）、方程以及测试用例的定义。没有矛盾之处。\n- **可行性：** 所需的计算在数值上是直接的，可以使用标准库来实现。\n\n**第 3 步：结论与行动**\n\n问题是有效的。将提供完整的解决方案。\n\n### 解决方案\n\n目标是量化两种不同的时间积分格式在一个膨胀宇宙中运动的粒子的数值误差。运动被简化为自由粒子（`F=0`）的运动，这分离了纯粹由背景膨胀项的离散化引起的误差。\n\n**1. 数学公式和解析解**\n\n需要积分的运动方程是：\n$$\n\\frac{dx}{da} = \\frac{p}{a^3 H(a)}\n$$\n对于 Einstein-de Sitter (EdS) 宇宙学，哈勃参数为 `H(a) = H_0 a^{-3/2}`。在指定的代码单位中，`H_0 = 1`，因此 `H(a) = a^{-3/2}`。将此代入运动方程得到：\n$$\n\\frac{dx}{da} = \\frac{p}{a^3 (a^{-3/2})} = \\frac{p}{a^{3/2}} = p a^{-3/2}\n$$\n这是一个关于 `x(a)` 的简单常微分方程。动量 `p` 是一个运动常数，由初始条件确定：\n$$\np = a_i^2 v_i = (0.01)^2 \\times 1 = 10^{-4}\n$$\n最终位置 `x(a_f)` 的精确解通过从 `a_i` 到 `a_f` 的直接积分得到：\n$$\nx_{\\mathrm{exact}}(a_f) = x_i + \\int_{a_i}^{a_f} p a^{-3/2} \\, da\n$$\n计算该积分：\n$$\n\\int_{a_i}^{a_f} p a^{-3/2} \\, da = p \\left[ \\frac{a^{-1/2}}{-1/2} \\right]_{a_i}^{a_f} = -2p \\left( a_f^{-1/2} - a_i^{-1/2} \\right)\n$$\n使用给定的初始值和最终值（`x_i = 0`，`a_i = 0.01`，`a_f = 1`），我们计算精确的最终位置：\n$$\nx_{\\mathrm{exact}}(a_f) = 0 - 2(10^{-4}) \\left( 1^{-1/2} - (0.01)^{-1/2} \\right) = -2 \\times 10^{-4} (1 - 10) = 1.8 \\times 10^{-3}\n$$\n该值作为我们比较数值格式的基准真相。\n\n**2. 数值离散格式**\n\n我们分析两种方法来近似积分 `\\int f(a) da`，其中被积函数为 `f(a) = \\frac{dx}{da} = p a^{-3/2}`。\n\n- **非时间对称（朴素）格式：** 此格式对应于在单步 `\\Delta a_n = a_{n+1} - a_n` 上的积分的前向欧拉法或左黎曼和：\n$$\nx_{n+1} = x_n + \\Delta a_n f(a_n) = x_n + \\Delta a_n (p a_n^{-3/2})\n$$\n该方法具有一阶精度，意味着其全局误差与 `O(\\Delta a_{max})` 成比例，其中 `\\Delta a_{max}` 是最大步长。其缺乏时间对称性导致性能较差，尤其是在使用可变步长时。\n\n- **时间对称（对称）格式：** 此格式是梯形法则的应用：\n$$\nx_{n+1} = x_n + \\frac{\\Delta a_n}{2} \\left[ f(a_n) + f(a_{n+1}) \\right] = x_n + \\frac{\\Delta a_n}{2} p \\left( a_n^{-3/2} + a_{n+1}^{-3/2} \\right)\n$$\n该方法具有二阶精度。其全局误差与 `O(\\Delta a_{max}^2)` 成比例。该结构是时间对称的，因为交换 `n` 和 `n+1` 的角色（即从 `a_{n+1}` 到 `a_n` 走一步 `-\\Delta a_n`）可以恢复到原始状态 `x_n`。即使在这里我们只分析一个简化的情况，此性质对于哈密顿系统中的长期稳定性和精度也至关重要。\n\n**3. 算法实现策略**\n\n该解决方案通过以下步骤实现：\n\n1.  **初始化：** 定义物理和数值常数：`a_i`、`a_f`、`x_i`、`v_i`、`H_0`。计算恒定的动量 `p` 和精确的最终位置 `x_{\\mathrm{exact}}(a_f)`。\n\n2.  **步长生成：** 对四个测试用例中的每一个，生成划分区间 `[a_i, a_f]` 的步长数组 `\\{\\Delta a_n\\}`。\n    -   **情况 1（均匀）：** 所有 `\\Delta a_n` 均等于 `(a_f - a_i) / N`。\n    -   **情况 2（单步）：** 一个单步 `\\Delta a_0 = a_f - a_i`。\n    -   **情况 3（几何）：** 步长 `\\Delta a_k` 与 `r^k` 成正比。它们被归一化，使其总和等于 `a_f - a_i`。\n    -   **情况 4（交替）：** 小步长和大步长对 `\\Delta a_{\\mathrm{small}}` 和 `\\Delta a_{\\mathrm{large}}` 由它们的比率 `R` 和总步数 `N` 决定，确保总长度加起来等于 `a_f - a_i`。\n\n3.  **数值积分：** 创建一个通用的积分器函数，该函数接受一个步长数组和一个更新规则（朴素或对称）。此函数从 `(a, x) = (a_i, x_i)` 开始迭代应用更新规则，直到达到最终状态 `(a_f, x(a_f))`。\n\n4.  **误差计算：** 对于四种情况中的每一种，使用朴素和对称两种格式运行积分。通过将其与 `x_{\\mathrm{exact}}(a_f)` 进行比较，计算每个结果的绝对误差。\n\n5.  **输出：** 按指定顺序收集八个误差值，并将其格式化为单行字符串以供输出。结果将证明时间对称格式的优越精度，特别是在步长高度不均匀的情况下（情况 3 和 4），此时一阶方法的误差会变得非常大。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Implements and analyzes variable-timestep integration for a free particle\n    in an Einstein-de Sitter cosmology.\n    \"\"\"\n    # 1. Define constants and initial conditions\n    a_i = 0.01\n    a_f = 1.0\n    x_i = 0.0\n    v_i = 1.0\n    H_0 = 1.0  # In code units\n    \n    # Calculate constant canonical momentum p = a_i^2 * v_i\n    p = a_i**2 * v_i\n    \n    # Total integration interval length\n    total_delta_a = a_f - a_i\n\n    # 2. Define the integrand and the exact solution\n    # The ODE is dx/da = f(a), where f(a) = p / (a^3 * H(a)).\n    # With H(a) = H_0 * a**(-1.5) and H_0 = 1, this simplifies to:\n    # f(a) = p / (a^3 * a**(-1.5)) = p * a**(-1.5)\n    def f(a):\n        return p * a**(-1.5)\n\n    # The exact solution is the integral of f(a) from a_i to a_f.\n    # Integral of p*a**(-1.5) da = -2*p*a**(-0.5)\n    x_exact_af = x_i - 2 * p * (a_f**(-0.5) - a_i**(-0.5))\n\n    # 3. Define numerical integration schemes\n    def integrate(steps, update_rule):\n        \"\"\"Generic integrator for a given sequence of steps and an update rule.\"\"\"\n        x = x_i\n        a = a_i\n        for delta_a in steps:\n            x = update_rule(x, a, delta_a)\n            a += delta_a\n        return x\n\n    def update_naive(x_n, a_n, delta_a):\n        \"\"\"Non-time-symmetric, first-order (Forward Euler) update.\"\"\"\n        return x_n + delta_a * f(a_n)\n\n    def update_symmetric(x_n, a_n, delta_a):\n        \"\"\"Time-symmetric, second-order (Trapezoidal) update.\"\"\"\n        a_n1 = a_n + delta_a\n        return x_n + 0.5 * delta_a * (f(a_n) + f(a_n1))\n\n    # 4. Define test case parameters and generate step sequences\n    test_cases_params = [\n        {'type': 'uniform', 'N': 64},\n        {'type': 'single', 'N': 1},\n        {'type': 'geometric', 'N': 32, 'r': 1.5},\n        {'type': 'alternating', 'N': 32, 'R': 50.0}\n    ]\n\n    all_errors = []\n\n    for params in test_cases_params:\n        case_type = params['type']\n        \n        if case_type == 'uniform':\n            N = params['N']\n            steps = np.full(N, total_delta_a / N)\n        elif case_type == 'single':\n            steps = np.array([total_delta_a])\n        elif case_type == 'geometric':\n            N = params['N']\n            r = params['r']\n            indices = np.arange(N)\n            weights = r**indices\n            steps = total_delta_a * weights / np.sum(weights)\n        elif case_type == 'alternating':\n            N = params['N']\n            R = params['R']\n            num_pairs = N // 2\n            # For 16 pairs of (da_s, da_l), total_delta_a = 16 * (da_s + da_l)\n            # Since da_l = R * da_s, total_delta_a = 16 * da_s * (1 + R)\n            da_s = total_delta_a / (num_pairs * (1 + R))\n            da_l = R * da_s\n            step_pair = [da_s, da_l]\n            steps = np.array(step_pair * num_pairs)\n\n        # 5. Run simulations and compute errors\n        x_naive_af = integrate(steps, update_naive)\n        e_naive = np.abs(x_naive_af - x_exact_af)\n        \n        x_sym_af = integrate(steps, update_symmetric)\n        e_sym = np.abs(x_sym_af - x_exact_af)\n        \n        all_errors.extend([e_naive, e_sym])\n\n    # 6. Format and print the final output\n    print(f\"[{','.join(f'{e}' for e in all_errors)}]\")\n\nsolve()\n```", "id": "3507114"}]}