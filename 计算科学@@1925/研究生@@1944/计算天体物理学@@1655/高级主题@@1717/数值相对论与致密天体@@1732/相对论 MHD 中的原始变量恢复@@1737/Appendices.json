{"hands_on_practices": [{"introduction": "在天体物理学的高能流体中，守恒变量的量值可能变得极大。一个简单的数值实现可能会遭遇“灾难性相消”（catastrophic cancellation）的问题，即两个几乎相等的大数相减导致精度的灾难性损失。本练习 [@problem_id:3530442] 提供了一个动手分析的机会，旨在让你通过代数推导识别这些潜在的数值陷阱，并阐明开发更稳健数值格式的必要性，这对于处理极端相对论效应至关重要。", "problem": "在平直时空的狭义相对论磁流体力学（RMHD）中，设度规符号为 $(-,+,+,+)$，单位取 $c=1$ 和 $4\\pi=1$，考虑一个均匀流，其三维速度 $\\vec{v}$ 严格平行于一个均匀磁场 $\\vec{B}$，因此对于固定的单位矢量 $\\hat{n}$ 和速度 $0 \\le v  1$，有 $\\vec{v} = v\\,\\hat{n}$ 和 $\\vec{B} = B\\,\\hat{n}$。该流体具有静止质量密度 $\\rho$、压力 $p$、比焓 $h$ 以及焓密度 $w \\equiv \\rho h$。洛伦兹因子为 $\\gamma \\equiv (1-v^{2})^{-1/2}$。理想 RMHD 磁场四维矢量定义为 $b^{0} \\equiv \\gamma\\,\\vec{v}\\cdot\\vec{B}$ 和 $b^{i} \\equiv B^{i}/\\gamma + \\gamma\\,(\\vec{v}\\cdot\\vec{B})\\,v^{i}$，其不变量为 $b^{2} \\equiv b^{\\mu}b_{\\mu} = B^{2}/\\gamma^{2} + (\\vec{v}\\cdot\\vec{B})^{2}$。在瓦伦西亚表述中，实验室参考系下的守恒变量为\n- $D \\equiv \\rho \\gamma$，\n- $S_{i} \\equiv (w+b^{2})\\,\\gamma^{2}\\,v_{i} - b^{0} b_{i}$，\n- $\\tau \\equiv T^{00} - D$，其中 $T^{\\mu\\nu} = (w+b^{2})\\,u^{\\mu}u^{\\nu} + (p + b^{2}/2)\\,g^{\\mu\\nu} - b^{\\mu} b^{\\nu}$ 且 $u^{\\mu} = \\gamma(1,v^{i})$。\n\n定义辅助量 $W \\equiv w\\,\\gamma^{2}$ 和 $Q \\equiv W + b^{2}$，以及磁化参数 $\\sigma \\equiv b^{2}/W$。你将分析超相对论区域 $h\\gamma \\gg 1$，同时保持 $\\sigma$ 为有限值（单位量级）。仅处理 $\\vec{v}\\parallel\\vec{B}$ 的对齐情况。\n\n完全基于上述定义和恒等式，完成以下任务：\n\n1. 针对对齐情况，推导 $S^{2} \\equiv S_{i}S^{i}$ 和 $\\tau$ 关于 $W$、$b^{2}$、$B^{2}$、$v$、$\\gamma$、$p$ 和 $D$ 的表达式。利用 $\\vec{v}\\parallel\\vec{B}$ 时发生的精确相消，尽可能简化 $S^{2}$。评论构成 $S_{i}$ 和 $\\tau$ 的各项大值的标度关系，并指出在 $h\\gamma \\gg 1$ 时何处可能发生数值相消。\n\n2. 使用 $W$ 和 $Q$ 作为主要尺度，提出可以避免在 $h\\gamma \\gg 1$ 时精度损失的重新标度的无量纲组合，并论证为何这些组合是良态的。特别地，论证在对齐情况下使用 $S^{2}/Q^{2}$ 和 $\\tau/W$ 的合理性。\n\n3. 在 $h\\gamma \\gg 1$ 且 $\\sigma$ 保持固定的有限值的渐近区域中，通过舍去当 $h\\gamma \\to \\infty$ 时趋于零的项，评估 $S^{2}/Q^{2}$ 和 $\\tau/W$ 的主阶极限。最终结果仅用 $v$ 和 $\\sigma$ 表示。\n\n答案规格：\n- 将你的最终答案以包含两个表达式的单个有序对形式给出，排列成行矩阵 $\\bigl(S^{2}/Q^{2},\\,\\tau/W\\bigr)$。\n- 无需进行数值计算或四舍五入；给出无单位的精确、封闭形式的解析表达式。", "solution": "该问题陈述经证实具有科学依据，是适定的、客观的且自洽的。其定义和情景在计算天体物理学和狭义相对论磁流体力学领域是标准的。我将开始解答。\n\n本分析针对均匀流，其中三维速度 $\\vec{v}$ 平行于磁场 $\\vec{B}$。它们由 $\\vec{v} = v\\,\\hat{n}$ 和 $\\vec{B} = B\\,\\hat{n}$ 给出，其中 $\\hat{n}$ 是单位矢量。度规符号为 $(-,+,+,+)$，单位取 $c=1$, $4\\pi=1$。\n\n首先，我们计算此对齐情况下磁场四维矢量 $b^{\\mu}$ 的分量及其不变量大小 $b^2$。\n标量积为 $\\vec{v}\\cdot\\vec{B} = vB$。磁场大小的平方为 $B^2 = \\vec{B}\\cdot\\vec{B}$。\n$b^{\\mu}$ 的时间分量是 $b^0 = \\gamma(\\vec{v}\\cdot\\vec{B}) = \\gamma v B$。\n空间分量是 $b^i = B^i/\\gamma + \\gamma(\\vec{v}\\cdot\\vec{B})v^i = (B\\hat{n}^i)/\\gamma + \\gamma(vB)(v\\hat{n}^i) = (B/\\gamma + \\gamma v^2 B)\\hat{n}^i$。\n使用恒等式 $1/\\gamma+\\gamma v^2 = \\sqrt{1-v^2} + v^2/\\sqrt{1-v^2} = (1-v^2+v^2)/\\sqrt{1-v^2} = 1/\\sqrt{1-v^2} = \\gamma$，我们将 $b^i$ 简化为 $b^i = B\\gamma\\hat{n}^i$。\n接着计算不变量 $b^2$ 为 $b^2 = b^\\mu b_\\mu = -(b^0)^2 + b_i b^i = -(\\gamma v B)^2 + (B\\gamma\\hat{n}_i)(B\\gamma\\hat{n}^i) = -B^2\\gamma^2 v^2 + B^2\\gamma^2 = B^2\\gamma^2(1-v^2) = B^2\\gamma^2(1/\\gamma^2) = B^2$。\n因此，对于对齐情况，不变量 $b^2$ 就是实验室参考系下的磁场能量密度 $B^2$。\n\n**第1部分：$S^2$ 和 $\\tau$ 的推导及数值相消分析。**\n\n我们推导守恒动量密度矢量 $S_i$ 的表达式。\n$S_i \\equiv (w+b^2)\\gamma^2 v_i - b^0 b_i$。\n代入对齐情况的表达式（$v_i = v\\hat{n}_i$, $b^2=B^2$, $b^0=\\gamma v B$, $b_i=\\gamma B \\hat{n}_i$）：\n$$S_i = (w+B^2)\\gamma^2 v\\hat{n}_i - (\\gamma v B)(\\gamma B \\hat{n}_i) = (w\\gamma^2 v + B^2\\gamma^2 v - B^2\\gamma^2 v)\\hat{n}_i$$\n总动量的磁场部分与麦克斯韦应力贡献之间发生了一个关键的相消。在超相对论极限（$\\gamma\\gg 1$）下，$B^2\\gamma^2 v\\hat{n}_i$ 和 $-B^2\\gamma^2 v\\hat{n}_i$ 这两项单独来看都很大，但它们精确相消。如果不小心处理，这是数值计算中灾难性相消的来源。\n$S_i$ 的简化表达式为 $S_i = w\\gamma^2 v\\hat{n}_i$。\n使用定义 $W \\equiv w\\gamma^2$，上式变为 $S_i = W v \\hat{n}_i$。\n大小的平方，$S^2 \\equiv S_i S^i$，则为：\n$$S^2 = (W v \\hat{n}_i)(W v \\hat{n}^i) = (Wv)^2 (\\hat{n}_i \\hat{n}^i) = (Wv)^2$$\n因为在平直空间中 $\\hat{n}_i \\hat{n}^i=1$。\n\n接下来，我们推导守恒能量 $\\tau$ 的表达式。\n$\\tau \\equiv T^{00} - D$。\n应力-能量张量的 $00$ 分量是 $T^{00} = (w+b^2)(u^0)^2 + (p+b^2/2)g^{00} - b^0 b^0$。\n当 $u^0=\\gamma$，$g^{00}=-1$，$b^2=B^2$ 且 $b^0=\\gamma v B$ 时：\n$$T^{00} = (w+B^2)\\gamma^2 + (p+B^2/2)(-1) - (\\gamma v B)^2$$\n$$T^{00} = w\\gamma^2 + B^2\\gamma^2 - p - \\frac{B^2}{2} - \\gamma^2 v^2 B^2$$\n$$T^{00} = w\\gamma^2 - p - \\frac{B^2}{2} + B^2\\gamma^2 (1-v^2) = w\\gamma^2 - p - \\frac{B^2}{2} + B^2 = w\\gamma^2 - p + \\frac{B^2}{2}$$\n在这个 $T^{00}$ 的计算中，也发生了一次显著的相消。$(w+b^2)(u^0)^2 = (w+B^2)\\gamma^2$ 项和 $-(b^0)^2 = -B^2\\gamma^2 v^2$ 项都很大，与 $\\gamma^2$ 成比例。它们的组合简化为 $w\\gamma^2 + B^2$。如果没有这个解析简化，数值计算将涉及大数相减。\n现在，我们求 $\\tau$：\n$$\\tau = T^{00} - D = \\left(w\\gamma^2 - p + \\frac{B^2}{2}\\right) - \\rho\\gamma$$\n使用定义 $W=w\\gamma^2$ 和 $D=\\rho\\gamma$，并注意到此情况下 $B^2=b^2$：\n$$\\tau = W - p + \\frac{b^2}{2} - D$$\n\n**第2部分：重新标度变量的合理性论证。**\n\n在超相对论区域 $h\\gamma \\gg 1$ 中，当磁化强度 $\\sigma=b^2/W$ 为有限值时，$W$ 和 $b^2$ 都可能非常大。使用具有相似标度关系的量之比可以提高数值稳定性。给定的主要尺度是 $W$ 和 $Q \\equiv W+b^2 = W(1+\\sigma)$。\n\n提议使用变量 $S^2/Q^2$。使用我们推导出的表达式 $S^2=(Wv)^2$ 和 $Q$ 的定义：\n$$\\frac{S^2}{Q^2} = \\frac{(Wv)^2}{(W+b^2)^2} = \\frac{W^2 v^2}{W^2(1+b^2/W)^2} = \\frac{v^2}{(1+\\sigma)^2}$$\n$S^2$ 和 $Q^2$ 都与 $W^2$ 成比例。它们的比值独立于大尺度 $W$，并用行为良好的速度 $v$ 和有限磁化强度 $\\sigma$ 来表示。这使其成为一个良态量，对于非零的 $v$，其量级为单位量级。\n\n提议使用变量 $\\tau/W$。使用我们关于 $\\tau$ 的表达式：\n$$\\frac{\\tau}{W} = \\frac{W - p + b^2/2 - D}{W} = 1 - \\frac{p}{W} + \\frac{b^2}{2W} - \\frac{D}{W}$$\n代入 $\\sigma=b^2/W$ 和 $D/W = (\\rho\\gamma)/(w\\gamma^2) = \\rho/w = \\rho/(\\rho h) = 1/h$：\n$$\\frac{\\tau}{W} = 1 - \\frac{p}{W} + \\frac{\\sigma}{2} - \\frac{1}{h\\gamma^2} = 1 + \\frac{\\sigma}{2} - \\frac{p}{w\\gamma^2} - \\frac{1}{h\\gamma^2}$$\n等等，$D/W = (\\rho\\gamma)/(w\\gamma^2) = (\\rho\\gamma)/(\\rho h \\gamma^2) = 1/(h\\gamma)$。\n所以，正确的表达式是：\n$$\\frac{\\tau}{W} = 1 - \\frac{p}{W} + \\frac{\\sigma}{2} - \\frac{1}{h\\gamma}$$\n$\\tau$ 和 $W$ 都由大的能量尺度主导。它们的比值将这些尺度归一化，得到一个单位量级的量，因为 $\\sigma$ 是有限的，并且在超相对论极限下，$p/W$ 和 $D/W$ 项预计会很小。这避免了使用单个大数 $\\tau$ 来表示一个物理状态，而这个大数可能是通过其他大数相减计算得出的。\n\n**第3部分：$h\\gamma \\to \\infty$ 时的渐近极限。**\n\n我们在 $h\\gamma \\to \\infty$ 且 $\\sigma$ 为固定有限值的区域中，评估重新标度的量的主阶极限。\n\n对于 $S^2/Q^2$：\n表达式 $\\frac{v^2}{(1+\\sigma)^2}$ 是精确的，并且不直接依赖于 $h$ 或 $\\gamma$。因此，它的极限就是表达式本身。\n$$\\lim_{h\\gamma \\to \\infty} \\frac{S^2}{Q^2} = \\frac{v^2}{(1+\\sigma)^2}$$\n\n对于 $\\tau/W$：\n我们分析表达式 $\\frac{\\tau}{W} = 1 + \\frac{\\sigma}{2} - \\frac{p}{W} - \\frac{D}{W}$。我们必须评估最后两项的极限。\n$D/W = 1/(h\\gamma)$ 项。根据该区域的定义，$h\\gamma \\to \\infty$，所以此项趋于零：\n$$\\lim_{h\\gamma \\to \\infty} \\frac{D}{W} = 0$$\n$p/W = p/(w\\gamma^2) = p/(\\rho h \\gamma^2)$ 项。我们可以将其写为 $\\frac{p}{\\rho h} \\frac{1}{\\gamma^2}$。根据比焓的定义 $h=1+e+p/\\rho$（其中 $e$ 是比内能），我们知道 $p/\\rho  h$，所以比值 $p/(\\rho h)$ 的界限在 $0$ 和 $1$ 之间。因此，$p/W  1/\\gamma^2$。在此上下文中，“超相对论区域”一词意味着洛伦兹因子很大，即 $\\gamma \\gg 1$。根据这一标准解释，当 $\\gamma \\to \\infty$ 时，$p/W$ 项趋于零。\n$$\\lim_{h\\gamma \\to \\infty} \\frac{p}{W} = 0$$\n因此，$\\tau/W$ 的主阶极限是：\n$$\\lim_{h\\gamma \\to \\infty} \\frac{\\tau}{W} = 1 + \\frac{\\sigma}{2} - 0 - 0 = 1 + \\frac{\\sigma}{2}$$\n\n最终结果是这两个极限表达式组成的有序对。\n第一个表达式是 $\\frac{v^2}{(1+\\sigma)^2}$。\n第二个表达式是 $1 + \\frac{\\sigma}{2}$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n\\frac{v^2}{(1+\\sigma)^2},  1 + \\frac{\\sigma}{2}\n\\end{pmatrix}\n}\n$$", "id": "3530442"}, {"introduction": "一旦我们认识到数值计算中存在的风险，下一步便是选择合适的算法。并非所有数值方法都生而平等；有些方法在本质上比其他方法更稳健，特别是当解位于物理允许参数空间的边界附近时。这个思想实验 [@problem_id:3530523] 将挑战你批判性地评估不同的反演策略，并识别那些能确保在病态情况下收敛的关键特性，例如有界求解和约束强制。", "problem": "考虑狭义相对论中的相对论磁流体力学（RMHD），使用闵可夫斯基度规，并采用光速 $c=1$ 的单位制。流体遵循理想气体状态方程（EOS），绝热指数为 $\\Gamma = 4/3$。在 Valencia 格式中，守恒变量为实验室参考系下测得的静质量密度 $D$、动量密度 $S_i$、扣除静质量的能量密度 $\\tau$ 以及磁场 $B^i$。原始变量为静质量密度 $\\rho$、压强 $p$ 和三维速度 $v^i$；比焓为 $h = 1 + \\epsilon + p/\\rho$，其中 $\\epsilon$ 是比内能，洛伦兹因子为 $W = (1 - v^2)^{-1/2}$。理想气体状态方程意味着 $p = (\\Gamma - 1) \\rho \\epsilon$ 和 $h = 1 + \\Gamma \\epsilon = 1 + \\Gamma p / \\left[(\\Gamma - 1)\\rho\\right]$，因此对于 $\\Gamma = 4/3$，有 $h = 1 + 4 p / \\rho$。\n\n假设一个均匀状态，其磁场为 $B^i = (B, 0, 0)$，$B = 10$，动量矢量 $S^i$ 完全垂直于 $B^i$，即 $S^i = (0, S, 0)$，因此 $(B \\cdot v) = 0$。给定守恒静质量密度 $D = 31.6227766$ 和扣除静质量的守恒能量 $\\tau = 1498.85$。通过将动量平方 $S^2$ 设置为在给定 $\\tau$、$D$、$B^i$、理想气体状态方程以及垂直构型下，与物理约束条件 $p \\ge 0$ 和 $0 \\le v^2  1$ 一致的理论最大值 $S^2_{\\max}$ 的一个分数，来构造一个病态测试。具体来说，考虑\n$$\nS^2 = 0.995\\, S^2_{\\max}.\n$$\n我们的目标是在给定 $(D, S_i, \\tau, B^i)$ 的情况下，恢复原始变量 $(\\rho, p, v^i)$，同时保持约束条件 $p \\ge 0$ 和 $0 \\le v^2  1$。\n\n在维持物理约束的情况下，以下哪种恢复策略能在这个病态案例中成功？选择所有适用项。\n\nA. 针对辅助变量 $Z \\equiv \\rho h W^2$ 进行单变量、有界求根，使用单调的能量残差，并从动量关系式中计算 $v^2$，在每次迭代中通过投影（如果需要）显式强制执行 $p \\ge 0$ 和 $v^2  1$。\n\nB. 在 $v \\perp B$ 的简化假设下，直接对 $p$ 进行无界牛顿-拉弗森迭代，将 $Z$ 固定在一个初始估计值（例如 $Z \\approx \\tau + D$），并从动量方程更新 $v^2$，不进行约束投影。\n\nC. 一种基于熵的备用方案，用守恒熵反演（使用一个假定可用的守恒熵 $D s W$）代替能量方程，仅从熵计算 $p$，然后重构 $Z$ 和 $v^2$ 以匹配给定的 $S^2$，而不检查能量残差。\n\nD. 针对 $(Z, u)$（其中 $u \\equiv (B \\cdot v)$）进行二维求解，使用全局化方法（二分法或线搜索）和保约束投影，对 $Z$ 使用精确的单调区间，并设置边界 $|u| \\le |B| \\sqrt{v^2}$；如果一致，则在边界 $u=0$ 处恢复垂直情况。\n\n通过选择在所述条件下能够收敛到物理可行解的策略选项来回答。", "solution": "用户提供了一个计算相对论磁流体力学（RMHD）领域的问题，具体涉及在一个旨在测试数值算法鲁棒性的病态案例中，从一组给定的守恒变量 $(D, S_i, \\tau)$ 恢复原始变量 $(\\rho, p, v^i)$。\n\n### 步骤 1：提取已知条件\n\n-   **框架**：狭义相对论磁流体力学（RMHD），使用闵可夫斯基度规和 $c=1$。\n-   **状态方程 (EOS)**：理想气体，绝热指数 $\\Gamma = 4/3$。\n-   **守恒变量**：静质量密度 $D$，动量密度 $S_i$，扣除静质量的能量密度 $\\tau$，以及实验室参考系磁场 $B^i$。\n-   **原始变量**：静质量密度 $\\rho$，压强 $p$，以及三维速度 $v^i$。\n-   **辅助变量**：比焓 $h = 1 + \\epsilon + p/\\rho$，洛伦兹因子 $W = (1 - v^2)^{-1/2}$。\n-   **EOS 关系**：$p = (\\Gamma - 1) \\rho \\epsilon$ 和 $h = 1 + \\frac{\\Gamma p}{(\\Gamma - 1)\\rho}$，对于 $\\Gamma=4/3$ 则变为 $h = 1 + 4p/\\rho$。\n-   **状态构型**：磁场: $B^i = (B, 0, 0)$ 且 $B=10$。动量密度: $S^i = (0, S, 0)$，意味着 $S_i B^i = 0$。垂直流：假设 $(B \\cdot v) = 0$。\n-   **数值**：$D = 31.6227766$。$\\tau = 1498.85$。$S^2 = 0.995\\, S^2_{\\max}$，其中 $S^2_{\\max}$ 是在给定 $D, \\tau, B^i$ 和约束条件 $p \\ge 0$ 及 $0 \\le v^2  1$ 下的理论最大值。\n-   **控制方程 (根据 Valencia 格式的约定)**：静质量守恒：$D = \\rho W$。动量密度：$S_i = (\\rho h W^2 + B^2) v_i - (B \\cdot v) B_i$。能量密度 (减去静质量)：$\\tau = \\rho h W^2 - p - D + \\frac{1}{2}(v^2 B^2 + (B \\cdot v)^2)$。\n\n### 步骤 2：使用提取的已知条件进行验证\n\n-   **科学依据**：该问题设定在 RMHD 的成熟框架内。给出的守恒变量方程、理想气体 EOS 以及原始变量和守恒变量之间的关系在计算天体物理学领域是标准的，对应于 Valencia 格式的一个特定（且常见）的变体。该问题在科学上是合理的。\n-   **适定性**：从守恒变量到原始变量的反演是一个标准的计算问题。对于一组物理上有效的守恒变量，预计会存在一个唯一的物理可行解。条件 $S^2 = 0.995 S^2_{\\max}$ 将解置于物理可达区域（$p \\ge 0$ 和 $v^2  1$）的边界附近，使其成为数值算法的一个“病态”或困难的测试案例，但这并未使问题变得不适定。解的存在性仍然得到保证。\n-   **客观性**：问题以精确、客观和数学化的语言陈述，没有歧义或主观性陈述。\n-   **不完整性/矛盾**：问题提供了定义状态的完整信息。一个重要的一致性检查是条件 $S_i B^i = 0$ 是否意味着 $(B \\cdot v) = 0$。将动量方程与 $B^i$ 做点积：\n    $$S_i B^i = ((\\rho h W^2 + B^2) v_i - (B \\cdot v) B_i) B^i = (\\rho h W^2 + B^2) (v \\cdot B) - (B \\cdot v) B^2 = (\\rho h W^2)(v \\cdot B)$$\n    给定 $S_i B^i = 0$ 并且知道 $\\rho > 0$, $h \\ge 1$, $W^2 \\ge 1$，我们必须有 $(v \\cdot B) = 0$。因此，假设 $(B \\cdot v) = 0$ 是指定的 $S_i$ 和 $B^i$ 的直接且必然的推论，这使得整个设置内部一致。\n\n问题陈述在科学上是合理的、适定的、客观的且自洽的。\n\n### 结论与行动\n\n问题陈述有效。我将继续进行推导和选项评估。\n\n### 推导与选项分析\n\n问题要求确定哪些数值策略能够在一个具有挑战性的案例中，从守恒变量 $(D, S^2, \\tau)$ 成功恢复原始变量 $(\\rho, p, v^i)$，该案例的解位于物理状态空间的边界附近。\n\n对于给定的构型，其中 $(B \\cdot v) = 0$，控制方程简化为：\n1.  $D = \\rho W$\n2.  $S_i = (\\rho h W^2 + B^2) v_i \\implies S^2 = (\\rho h W^2 + B^2)^2 v^2$\n3.  $\\tau = \\rho h W^2 - p - D + \\frac{1}{2} v^2 B^2$\n\n现代、鲁棒的“守恒量到原始量”（con-to-prim）求解器的核心，是将这个包含三个非线性方程的系统，重新表述为一个单变量的求根问题，其残差函数是单调的。一个常用且成功的主变量选择是 $Z \\equiv \\rho h W^2$。\n\n让我们用 $Z$ 来表示所有其他量：\n从动量方程(2)中，我们可以解出 $v^2$:\n$$v^2 = \\frac{S^2}{(Z + B^2)^2}$$\n这立即对 $Z$ 施加了一个约束。由于 $v^2  1$，我们必须有 $S^2  (Z+B^2)^2$，这意味着 $Z > S - B^2$（因为 $Z+B^2$ 必须为正）。\n\n其他原始变量和辅助量也可以表示为 $Z$ 的函数：\n-   $W = (1 - v^2)^{-1/2} = \\left(1 - \\frac{S^2}{(Z + B^2)^2}\\right)^{-1/2}$\n-   $\\rho = D/W = D \\sqrt{1 - v^2}$\n-   $h = Z / (\\rho W^2) = Z / (D W)$\n-   压强 $p$ 从状态方程 $h = 1 + 4p/\\rho \\implies p = \\frac{\\rho(h-1)}{4}$ 得到。物理约束 $p \\ge 0$ 转化为 $h \\ge 1$，这意味着 $Z/(DW) \\ge 1$，或者 $Z \\ge DW = D/\\sqrt{1-v^2}$。\n\n将这些表达式代入能量方程(3)得到一个关于 $Z$ 的单一主方程：\n$$f(Z) = \\tau_{\\text{computed}}(Z) - \\tau_{\\text{given}} = 0$$\n其中\n$$\\tau_{\\text{computed}}(Z) = Z - p(Z) - D + \\frac{1}{2} v^2(Z) B^2$$\n可以证明，对于此类公式，函数 $f(Z)$ 在 $Z$ 的整个物理范围内是单调的，这使其非常适合有界求根算法（例如，二分法、Brent法）。如果能找到一个区间 $[Z_{\\text{low}}, Z_{\\text{high}}]$ 使得 $f(Z_{\\text{low}})$ 和 $f(Z_{\\text{high}})$ 异号，这些方法保证能收敛到唯一的根。\n\n该测试的“病态”性质，即 $S^2 = 0.995 S^2_{\\max}$，意味着解非常接近 $p=0$（冷极限）或 $v^2=1$（超相对论极限）的边界。已知这类情况会因梯度过大以及进入非物理区域（$p0$ 或 $v^2 > 1$）的风险，导致简单或不鲁棒的数值方案（例如，无界牛顿-拉弗森法）收敛失败。\n\n现在我们来评估每个选项：\n\n**A. 针对辅助变量 $Z \\equiv \\rho h W^2$ 进行单变量、有界求根，使用单调的能量残差，并从动量关系式中计算 $v^2$，在每次迭代中通过投影（如果需要）显式强制执行 $p \\ge 0$ 和 $v^2  1$。**\n\n这个选项精确地描述了上面概述的最先进、最鲁棒的方法。\n- **对 $Z$ 进行单变量、有界求根**：这是一个鲁棒求解器的核心。使用单调残差函数和有界求解器可以保证收敛。\n- **从动量关系式计算 $v^2$**：如推导所示，这是正确的步骤。\n- **显式强制执行约束**：这是处理病态案例的关键。通过在每一步检查 $p \\ge 0$ 和 $v^2  1$ 并相应地调整搜索区间，可以防止算法进入非物理区域。“投影”是一种处理可能越界的中间步骤的策略，以确保算法保持稳定。\n该策略被设计为鲁棒的，并且恰好能处理这类困难的反演问题。它会成功。\n\n**结论：正确**\n\n**B. 在 $v \\perp B$ 的简化假设下，直接对 $p$ 进行无界牛顿-拉弗森迭代，将 $Z$ 固定在一个初始估计值（例如 $Z \\approx \\tau + D$），并从动量方程更新 $v^2$，不进行约束投影。**\n\n这个选项描述了一个有缺陷且不鲁棒的策略。\n- **无界牛顿-拉弗森法**：这种方法是出了名的脆弱。它可能会发散或大步跨入非物理区域（$p0, v^2>1$），尤其是在靠近解的边界时，函数导数的表现会很差。问题的病态性质使得这种方法极有可能失败。\n- **固定 $Z$**：这是无稽之谈。$Z$ 是待求原始变量的函数。将其固定在一个初始估计值上，意味着除非初始猜测恰好完美，否则算法无法收敛到真正的解。\n- **不进行约束投影**：这明确地移除了处理病态案例所需的安全机制。\n该策略结合了一个脆弱的局部求解器、一个不正确的物理假设（固定的 $Z$）以及缺乏安全检查。它几乎注定会失败。\n\n**结论：不正确**\n\n**C. 一种基于熵的备用方案，用守恒熵反演（使用一个假定可用的守恒熵 $D s W$）代替能量方程，仅从熵计算 $p$，然后重构 $Z$ 和 $v^2$ 以匹配给定的 $S^2$，而不检查能量残差。**\n\n这个选项描述了一个解决错误问题的过程。在数值模拟中，由于数值耗散，演化的能量 $\\tau$ 和演化的熵 $K = D s W$ 将不可避免地变得略有不一致。基于熵的恢复方案找到的是与给定 $(D, S_i, K)$ 一致的状态 $(\\rho, p, v^i)$。最后一句“而不检查能量残差”是关键：它证实了该方法根本不试图用给定的 $\\tau$ 值来满足能量方程。因此，它不会恢复与问题输入 $\\tau$ 相对应的状态。尽管这类方案在完整模拟中当能量反演失败时可作为备用方案很有用，但它们并没有解决这里提出的具体数学问题。\n\n**结论：不正确**\n\n**D. 针对 $(Z, u)$（其中 $u \\equiv (B \\cdot v)$）进行二维求解，使用全局化方法（二分法或线搜索）和保约束投影，对 $Z$ 使用精确的单调区间，并设置边界 $|u| \\le |B| \\sqrt{v^2}$；如果一致，则在边界 $u=0$ 处恢复垂直情况。**\n\n这个选项描述了一个更通用、更鲁棒的求解器，它不从一开始就假设 $(B \\cdot v) = 0$。\n- 变量是 $Z$ 和 $u=(B \\cdot v)$。问题被简化为一个二维求根问题。对于给定的数据，$S_i B^i = 0$，这意味着 $Z u = 0$。由于 $Z > 0$，求解器会发现解必须位于边界 $u=0$ 上。\n- 求解器被描述为具有确保鲁棒性的特性：“全局化（二分法或线搜索）”确保全局收敛，“保约束投影”为病态案例提供了必要的安全性。\n- 使用“对 $Z$ 的精确单调区间”（可能意味着对于任何固定的 $u$，残差在 $Z$ 上是单调的）是实现鲁棒求解的特性。\n这是选项 A 中方法的推广。它是一个高度鲁棒的通用算法。鉴于这个问题的具体数据（$S_i B^i = 0$），该算法将正确地在 $u=0$ 边界上找到解，实际上简化为一维情况。这个通用而鲁棒的策略将会成功。\n\n**结论：正确**\n\n选项 A 和 D 都描述了鲁棒且设计良好的算法，能够处理问题中提出的数值上具有挑战性的案例。选项 A 是一个针对垂直情况的专用求解器，而选项 D 是一个通用求解器，它能将垂直情况作为边界条件正确处理。两者都会成功。", "answer": "$$\\boxed{AD}$$", "id": "3530523"}, {"introduction": "最后也是最关键的一步，是将理论知识和策略设计选择转化为一个可用的代码。本练习 [@problem_id:3530471] 将引导你为一个常见的物理场景实现一个完整的牛顿-拉弗森求解器。通过集成误差估计器和回溯线搜索，你将构建一个不仅能找到解，而且能稳健执行此过程的程序，它能主动强制施加物理约束并确保收敛。", "problem": "您的任务是为狭义相对論理想磁流体力学（MHD）中的原始变量恢复设计并实现一个误差估计器和迭代细化程序，该程序仅限于速度和磁场处处垂直的流体。所有计算都必须在无量纲单位下进行，其中光速等于 $1$。该系统在平直时空中考虑，其闵可夫斯基度规为 $\\eta^{\\mu\\nu} = \\mathrm{diag}(-1,1,1,1)$。\n\n从狭义相对論理想磁流体力学中的以下标准基本定义开始：\n- 四维速度为 $u^{\\mu} = \\gamma (1, \\mathbf{v})$，其中 $\\gamma = 1/\\sqrt{1 - v^2}$ 是洛伦兹因子，$\\mathbf{v}$ 是三维速度，且 $v^2 = \\mathbf{v}\\cdot\\mathbf{v}$。\n- 比焓为 $h = 1 + \\epsilon + p/\\rho$，其中 $\\rho$ 是静止质量密度，$p$ 是热压力，$\\epsilon$ 是比内能。对于 $\\Gamma$-律（多方）状态方程，$\\epsilon = p/[(\\Gamma - 1)\\rho]$，因此 $h = 1 + \\Gamma p / [(\\Gamma - 1)\\rho]$。\n- 磁四维矢量为 $b^{\\mu}$，它编码了在流体参考系中测量的磁场，并通过关系式 $b^0 = \\gamma (\\mathbf{v} \\cdot \\mathbf{B})$、$b^i = \\frac{B^i}{\\gamma} + \\gamma (\\mathbf{v} \\cdot \\mathbf{B}) v^i$ 和 $b^2 = b^{\\mu}b_{\\mu}$ 与实验室参考系中的磁场 $\\mathbf{B}$ 和速度 $\\mathbf{v}$ 相关。\n- 总能动量张量为\n$$\nT^{\\mu\\nu} = (\\rho h + b^2) u^{\\mu} u^{\\nu} + \\left(p + \\frac{1}{2} b^2 \\right) \\eta^{\\mu\\nu} - b^{\\mu} b^{\\nu}.\n$$\n\n在实验室参考系中定义守恒变量如下：\n- 质量密度 $D = \\rho \\gamma$。\n- 动量密度矢量分量 $S_i = T^{0i}$。\n- 能量密度（不包括静止质量）$\\tau = T^{00} - D$。\n\n在物理限制条件 $\\mathbf{v} \\cdot \\mathbf{B} = 0$（速度严格垂直于磁场）下，从上述基本定义出发，推导从原始变量 $(\\rho, p, \\mathbf{v}, \\mathbf{B})$ 到守恒变量 $(D, \\mathbf{S}, \\tau)$ 的映射。用 $\\rho$，$p$，$\\gamma$，$\\mathbf{v}$ 和 $\\mathbf{B}$ 完全表达该映射。然后，在相同的垂直约束条件下，构建从 $(D, \\mathbf{S}, \\tau)$ 和 $\\mathbf{B}$ 恢复 $(\\rho, p, \\mathbf{v})$ 的逆问题。\n\n构建一个误差估计器，对于给定的候选原始状态，它会重新计算守恒变量，并测量其与目标守恒状态之差的归一化欧几里得范数。设该估计器为\n$$\nE = \\sqrt{\n\\left(\\frac{D_{\\mathrm{cand}} - D_{\\mathrm{tgt}}}{D_{\\mathrm{tgt}} + \\delta}\\right)^2\n+\n\\left(\\frac{\\|\\mathbf{S}_{\\mathrm{cand}} - \\mathbf{S}_{\\mathrm{tgt}}\\|}{\\|\\mathbf{S}_{\\mathrm{tgt}}\\| + \\delta}\\right)^2\n+\n\\left(\\frac{\\tau_{\\mathrm{cand}} - \\tau_{\\mathrm{tgt}}}{|\\tau_{\\mathrm{tgt}}| + \\delta}\\right)^2\n},\n$$\n其中 $\\delta$ 是一个用于数值稳定的小正数。\n\n为垂直情况设计一个双变量牛顿法，该方法同时求解速度大小 $v$ 和压力 $p$，同时通过 $\\rho = D/\\gamma$ 从 $D$ 恢复 $\\rho$。使用误差估计器 $E$ 来指导迭代细化，方法是执行回溯线搜索，强制 $E$ 单调递减，并遵守物理约束条件 $0 \\le v  1$ 和 $p > 0$。您的方法必须：\n- 使用测试套件中提供的固定 $\\Gamma$ 值的 $\\Gamma$-律状态方程。\n- 从您推导的残差方程中解析计算雅可比矩阵的元素。\n- 当误差估计器满足 $E  10^{-10}$ 或达到最大迭代次数时停止。\n\n测试套件和输出规范：\n- 所有量均为无量纲单位（光速等于 $1$）。\n- 考虑四个测试用例，选择的真实原始变量在每个用例中都满足 $\\mathbf{v} \\perp \\mathbf{B}$。对于每个用例，从真实原始变量计算目标守恒变量，并尝试从一个不一致的初始猜测值开始恢复原始变量。在所有用例中均使用 $\\Gamma = 4/3$。\n\n测试用例（真实原始变量和初始猜测值）：\n1. 真实值：$\\rho = 1.0$, $p = 0.1$, $\\mathbf{v} = (0.2, 0, 0)$, $\\mathbf{B} = (0, 0.5, 0)$。初始猜测值：$v_{\\mathrm{init}} = 0.6$, $p_{\\mathrm{init}} = 0.2$。\n2. 真实值：$\\rho = 0.5$, $p = 0.05$, $\\mathbf{v} = (0.95, 0, 0)$, $\\mathbf{B} = (0, 1.0, 0)$。初始猜测值：$v_{\\mathrm{init}} = 0.5$, $p_{\\mathrm{init}} = 0.2$。\n3. 真实值：$\\rho = 10^{-3}$, $p = 10^{-3}$, $\\mathbf{v} = (0.3, 0, 0)$, $\\mathbf{B} = (0, 5.0, 0)$。初始猜测值：$v_{\\mathrm{init}} = 0.8$, $p_{\\mathrm{init}} = 10^{-2}$。\n4. 真实值：$\\rho = 1.0$, $p = 10^{-6}$, $\\mathbf{v} = (0.5, 0, 0)$, $\\mathbf{B} = (0, 0.1, 0)$。初始猜测值：$v_{\\mathrm{init}} = 0.1$, $p_{\\mathrm{init}} = 10^{-3}$。\n\n对于每个测试用例，您的程序必须在迭代细化后计算最终的误差估计器值 $E$，并指明是否达到收敛。最终输出必须是单行，包含一个扁平列表，按顺序有八个条目：$[E_1,\\mathrm{conv}_1,E_2,\\mathrm{conv}_2,E_3,\\mathrm{conv}_3,E_4,\\mathrm{conv}_4]$，其中每个 $E_i$ 是一个实数（浮点数），每个 $\\mathrm{conv}_i$ 是一个布尔值。该行条目必须用逗号分隔，并用方括号括起来，不得有任何附加文本。", "solution": "用户提供了一个在计算相对论天体物理学领域中定义明确的问题，该问题涉及在狭义相对论理想磁流体力学（MHD）中从守恒变量 $(D, \\mathbf{S}, \\tau)$ 恢复原始变量 $(\\rho, p, \\mathbf{v})$。该问题被限制在一个简化情况下，即流体三维速度 $\\mathbf{v}$ 处处垂直于磁场 $\\mathbf{B}$，即 $\\mathbf{v} \\cdot \\mathbf{B} = 0$。该系统由一个 $\\Gamma$-律状态方程描述。任务是设计并实现一个带有回溯线搜索的双变量牛顿-拉弗森方法来解决这个逆问题。\n\n问题陈述在科学上是合理的，其定义和方程与该领域的标准文献一致。所提供的测试用例在物理上是合理的，可作为该算法的有效基准。因此，该问题是有效的，我们继续进行推导和求解。\n\n首先，我们在垂直约束条件下推导守恒变量的显式形式。磁四维矢量 $b^{\\mu}$ 由 $b^0 = \\gamma (\\mathbf{v} \\cdot \\mathbf{B})$ 和 $b^i = B^i/\\gamma + \\gamma (\\mathbf{v} \\cdot \\mathbf{B}) v^i$ 定义。约束条件 $\\mathbf{v} \\cdot \\mathbf{B} = 0$ 将此简化为 $b^0 = 0$ 和 $b^i = B^i/\\gamma$。磁四维矢量的洛伦兹不变量平方是 $b^2 = b^{\\mu}b_{\\mu} = \\eta_{\\mu\\nu}b^{\\mu}b^{\\nu} = -(b^0)^2 + \\delta_{ij}b^i b^j = B^2/\\gamma^2$，其中 $B^2 = \\mathbf{B} \\cdot \\mathbf{B}$ 且 $\\gamma = (1-v^2)^{-1/2}$ 是洛伦兹因子，且 $v^2 = \\mathbf{v} \\cdot \\mathbf{v}$。\n\n理想磁流体力学的能动量张量为：\n$$\nT^{\\mu\\nu} = (\\rho h + b^2) u^{\\mu} u^{\\nu} + \\left(p + \\frac{1}{2} b^2 \\right) \\eta^{\\mu\\nu} - b^{\\mu} b^{\\nu}\n$$\n其中 $\\rho$ 是静止质量密度，$p$ 是热压力，$h$ 是比焓，由 $\\Gamma$-律状态方程给出为 $h = 1 + \\Gamma p / [(\\Gamma - 1)\\rho]$。四维速度是 $u^\\mu = \\gamma(1, \\mathbf{v})$。\n\n将 $b^{\\mu}$ 和 $b^2$ 的简化形式代入 $T^{\\mu\\nu}$，我们推导出实验室参考系下的守恒变量：\n1.  质量密度：$D = \\rho \\gamma$。\n2.  动量密度矢量：$S_i = T^{0i}$。\n    有 $u^0=\\gamma$、$u^i=\\gamma v^i$、$b^0=0$ 和 $\\eta^{0i}=0$，我们发现：\n    $$\n    S_i = \\left(\\rho h + \\frac{B^2}{\\gamma^2}\\right) u^0 u^i - b^0 b^i = \\left(\\rho h + \\frac{B^2}{\\gamma^2}\\right) \\gamma (\\gamma v^i) = (\\rho h \\gamma^2 + B^2) v^i\n    $$\n    因此，动量矢量为 $\\mathbf{S} = (\\rho h \\gamma^2 + B^2)\\mathbf{v}$。\n3.  能量密度（不包括静止质量）：$\\tau = T^{00} - D$。\n    有 $\\eta^{00}=-1$：\n    $$\n    T^{00} = \\left(\\rho h + \\frac{B^2}{\\gamma^2}\\right) (u^0)^2 + \\left(p + \\frac{B^2}{2\\gamma^2}\\right) \\eta^{00} - (b^0)^2 = (\\rho h \\gamma^2 + B^2) - \\left(p + \\frac{B^2}{2\\gamma^2}\\right)\n    $$\n    所以，$\\tau = \\rho h \\gamma^2 + B^2 - p - \\frac{B^2}{2\\gamma^2} - D$。\n\n对于逆问题，给定目标守恒状态 $(D_{\\mathrm{tgt}}, \\mathbf{S}_{\\mathrm{tgt}}, \\tau_{\\mathrm{tgt}})$ 和磁场 $\\mathbf{B}$。我们寻求原始状态 $(\\rho, p, \\mathbf{v})$。速度矢量 $\\mathbf{v}$ 的方向与动量矢量 $\\mathbf{S}_{\\mathrm{tgt}}$ 对齐，使其大小 $v = \\|\\mathbf{v}\\|$ 成为一个未知数。问题简化为求解两个变量 $v$ 和 $p$。我们可以通过 $\\rho = D_{\\mathrm{tgt}}/\\gamma(v)$ 将静止质量密度 $\\rho$ 与已知的 $D_{\\mathrm{tgt}}$ 和未知的 $v$ 直接关联起来。\n\n我们为两个未知数 $(v, p)$ 定义一个包含两个非线性方程的方程组，要求原始状态 $(v, p)$ 能再现目标守恒量 $S_{\\mathrm{tgt}} = \\|\\mathbf{S}_{\\mathrm{tgt}}\\|$ 和 $\\tau_{\\mathrm{tgt}}$。让我们定义残差 $f_1$ 和 $f_2$：\n$$\nf_1(v, p) = \\left( D_{\\mathrm{tgt}}\\gamma + \\frac{\\Gamma p \\gamma^2}{\\Gamma - 1} + B^2 \\right) v - S_{\\mathrm{tgt}} = 0\n$$\n$$\nf_2(v, p) = D_{\\mathrm{tgt}}(\\gamma-1) + p\\left(\\frac{\\Gamma \\gamma^2}{\\Gamma-1} - 1\\right) + B^2\\left(1 - \\frac{1}{2\\gamma^2}\\right) - \\tau_{\\mathrm{tgt}} = 0\n$$\n其中 $\\gamma = (1-v^2)^{-1/2}$，而 $D_{\\mathrm{tgt}}$, $S_{\\mathrm{tgt}}$, $\\tau_{\\mathrm{tgt}}$ 和 $B^2$ 是已知常数。\n\n我们使用牛顿-拉弗森方法求解该方程组 $\\mathbf{F}(v, p) = [f_1, f_2]^T = \\mathbf{0}$。迭代更新由 $\\mathbf{J} \\Delta\\mathbf{x} = -\\mathbf{F}$ 给出，其中 $\\mathbf{x} = [v, p]^T$ 且 $\\mathbf{J}$ 是雅可比矩阵 $J_{ij} = \\partial f_i / \\partial x_j$。我们必须解析地计算 $\\mathbf{J}$ 的元素。使用导数 $\\frac{d\\gamma}{dv} = v\\gamma^3$，我们得到：\n$$\nJ_{11} = \\frac{\\partial f_1}{\\partial v} = D_{\\mathrm{tgt}}\\gamma^3 + \\frac{\\Gamma p}{\\Gamma - 1}\\gamma^4(1+v^2) + B^2\n$$\n$$\nJ_{12} = \\frac{\\partial f_1}{\\partial p} = \\frac{\\Gamma v \\gamma^2}{\\Gamma - 1}\n$$\n$$\nJ_{21} = \\frac{\\partial f_2}{\\partial v} = v \\left( D_{\\mathrm{tgt}}\\gamma^3 + \\frac{2\\Gamma p \\gamma^4}{\\Gamma - 1} + B^2 \\right)\n$$\n$$\nJ_{22} = \\frac{\\partial f_2}{\\partial p} = \\frac{\\Gamma \\gamma^2}{\\Gamma - 1} - 1\n$$\n在每次迭代 $k$ 中，我们计算 $\\mathbf{F}(\\mathbf{x}_k)$ 和 $\\mathbf{J}(\\mathbf{x}_k)$ 并求解 $2 \\times 2$ 线性系统以获得更新步长 $\\Delta \\mathbf{x}_k$。\n\n为确保鲁棒性，我们将牛顿步嵌入到回溯线搜索中。新状态被提议为 $\\mathbf{x}_{k+1} = \\mathbf{x}_k + \\lambda \\Delta \\mathbf{x}_k$，其中 $\\lambda$ 从 $1$ 开始。我们检查候选状态是否物理（$0 \\le v_{k+1}  1$ 且 $p_{k+1} > 0$）以及它是否减小了误差估计器 $E$。误差估计器定义为：\n$$\nE = \\sqrt{\n\\left(\\frac{S_{\\mathrm{cand}} - S_{\\mathrm{tgt}}}{S_{\\mathrm{tgt}} + \\delta}\\right)^2\n+\n\\left(\\frac{\\tau_{\\mathrm{cand}} - \\tau_{\\mathrm{tgt}}}{|\\tau_{\\mathrm{tgt}}| + \\delta}\\right)^2\n}\n$$\n请注意，关于 $D$ 的项为零，因为我们的公式强制 $D_{\\mathrm{cand}} = D_{\\mathrm{tgt}}$。如果候选步长不被接受，则将 $\\lambda$减半，并重复检查。这确保了向解的单调收敛。当 $E$ 低于容差 $10^{-10}$ 或达到最大迭代次数时，迭代终止。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the test suite for primitive variable recovery.\n    \"\"\"\n    # Define the test cases from the problem statement.\n    # Format: (rho, p, v_vec, B_vec, v_init, p_init)\n    test_cases = [\n        (1.0, 0.1, np.array([0.2, 0, 0]), np.array([0, 0.5, 0]), 0.6, 0.2),\n        (0.5, 0.05, np.array([0.95, 0, 0]), np.array([0, 1.0, 0]), 0.5, 0.2),\n        (1.0e-3, 1.0e-3, np.array([0.3, 0, 0]), np.array([0, 5.0, 0]), 0.8, 1.0e-2),\n        (1.0, 1.0e-6, np.array([0.5, 0, 0]), np.array([0, 0.1, 0]), 0.1, 1.0e-3),\n    ]\n\n    results = []\n    gamma_eos = 4.0 / 3.0\n\n    for case in test_cases:\n        rho_true, p_true, v_true_vec, B_vec, v_init, p_init = case\n        \n        # 1. Compute target conserved variables from true primitives\n        D_tgt, S_tgt_vec, tau_tgt = _compute_conserved(rho_true, p_true, v_true_vec, B_vec, gamma_eos)\n        \n        # 2. Perform primitive variable recovery\n        final_E, converged = _recover_primitives(\n            D_tgt, S_tgt_vec, tau_tgt, B_vec, gamma_eos, v_init, p_init\n        )\n        results.extend([final_E, converged])\n\n    # Final print statement in the exact required format.\n    # The boolean values must be lowercase 'true' or 'false' for the final output string.\n    str_results = []\n    for item in results:\n        if isinstance(item, bool):\n            str_results.append(str(item).lower())\n        else:\n            str_results.append(str(item))\n\n    print(f\"[{','.join(str_results)}]\")\n\ndef _compute_conserved(rho, p, v_vec, B_vec, gamma_eos):\n    \"\"\"Computes conserved variables from primitives for the perp (v.B=0) case.\"\"\"\n    v_sq = np.dot(v_vec, v_vec)\n    if v_sq >= 1.0:\n        raise ValueError(\"Velocity magnitude must be less than 1.\")\n    lorentz_gamma = 1.0 / np.sqrt(1.0 - v_sq)\n    B_sq = np.dot(B_vec, B_vec)\n    \n    h = 1.0 + gamma_eos * p / ((gamma_eos - 1.0) * rho)\n    \n    # Conserved mass density\n    D = rho * lorentz_gamma\n    \n    # Conserved momentum density\n    S_factor = rho * h * lorentz_gamma**2 + B_sq\n    S_vec = S_factor * v_vec\n    \n    # Total energy density T^00\n    T00 = rho * h * lorentz_gamma**2 + B_sq - p - B_sq / (2.0 * lorentz_gamma**2)\n    \n    # Conserved energy density (excluding rest mass)\n    tau = T00 - D\n    \n    return D, S_vec, tau\n\ndef _recover_primitives(D_tgt, S_tgt_vec, tau_tgt, B_vec, gamma_eos, v_init, p_init):\n    \"\"\"\n    Recovers primitive variables (v, p) using a 2D Newton-Raphson scheme.\n    \"\"\"\n    # Constants\n    MAX_ITER = 50\n    TOL = 1.0e-10\n    DELTA = 1.0e-12\n    MIN_LAMBDA = 1.0e-8\n    \n    # Pre-compute target magnitudes\n    S_tgt = np.linalg.norm(S_tgt_vec)\n    B_sq = np.dot(B_vec, B_vec)\n    \n    # Initial state\n    v, p = v_init, p_init\n    \n    # Calculate initial error\n    current_E = _calculate_error(v, p, D_tgt, S_tgt, tau_tgt, B_sq, gamma_eos, DELTA)\n\n    for _ in range(MAX_ITER):\n        # Check for convergence\n        if current_E  TOL:\n            return current_E, True\n\n        # Calculate residuals and Jacobian\n        F = _calculate_residuals(v, p, D_tgt, S_tgt, tau_tgt, B_sq, gamma_eos)\n        J = _calculate_jacobian(v, p, D_tgt, B_sq, gamma_eos)\n\n        # Solve linear system J * dx = -F for dx = [dv, dp]\n        detJ = J[0, 0] * J[1, 1] - J[0, 1] * J[1, 0]\n        if abs(detJ)  1.0e-100:  # Jacobian is singular or near-singular\n            return current_E, False\n        \n        inv_detJ = 1.0 / detJ\n        dv = inv_detJ * (-F[0] * J[1, 1] + F[1] * J[0, 1])\n        dp = inv_detJ * ( F[0] * J[1, 0] - F[1] * J[0, 0])\n\n        # Backtracking line search\n        Lambda = 1.0\n        step_found = False\n        for _ in range(10):  # Limit backtracking steps\n            v_cand = v + Lambda * dv\n            p_cand = p + Lambda * dp\n\n            # Check physical constraints\n            if not (0.0 = v_cand  1.0 and p_cand > 0.0):\n                Lambda /= 2.0\n                continue\n            \n            # Check for error reduction\n            E_cand = _calculate_error(v_cand, p_cand, D_tgt, S_tgt, tau_tgt, B_sq, gamma_eos, DELTA)\n            if E_cand  current_E:\n                v, p = v_cand, p_cand\n                current_E = E_cand\n                step_found = True\n                break\n            \n            Lambda /= 2.0\n            if Lambda  MIN_LAMBDA:\n                break\n        \n        if not step_found:\n            return current_E, False  # Failed to find a better state\n\n    # Check convergence after max iterations\n    final_E = _calculate_error(v, p, D_tgt, S_tgt, tau_tgt, B_sq, gamma_eos, DELTA)\n    converged = final_E  TOL\n    return final_E, converged\n\ndef _calculate_error(v, p, D_tgt, S_tgt, tau_tgt, B_sq, gamma_eos, delta):\n    \"\"\"Calculates the normalized error estimator E.\"\"\"\n    if not (0.0 = v  1.0 and p > 0.0):\n        return np.inf\n\n    residuals = _calculate_residuals(v, p, D_tgt, S_tgt, tau_tgt, B_sq, gamma_eos)\n    S_err_norm = residuals[0] / (S_tgt + delta)\n    tau_err_norm = residuals[1] / (abs(tau_tgt) + delta)\n\n    return np.sqrt(S_err_norm**2 + tau_err_norm**2)\n\ndef _calculate_residuals(v, p, D_tgt, S_tgt, tau_tgt, B_sq, gamma_eos):\n    \"\"\"Calculates the residual vector F = [f1, f2].\"\"\"\n    v_sq = v**2\n    if v_sq >= 1.0: # Protect against domain errors\n        return np.array([np.inf, np.inf])\n    gamma_sq = 1.0 / (1.0 - v_sq)\n    gamma = np.sqrt(gamma_sq)\n    \n    gamma_eos_m1 = gamma_eos - 1.0\n    \n    # f1: Momentum equation residual\n    f1 = (D_tgt * gamma + gamma_eos * p * gamma_sq / gamma_eos_m1 + B_sq) * v - S_tgt\n    \n    # f2: Energy equation residual\n    f2 = (D_tgt * (gamma - 1.0) + p * (gamma_eos * gamma_sq / gamma_eos_m1 - 1.0)\n          + B_sq * (1.0 - 0.5 / gamma_sq) - tau_tgt)\n          \n    return np.array([f1, f2])\n    \ndef _calculate_jacobian(v, p, D_tgt, B_sq, gamma_eos):\n    \"\"\"Calculates the 2x2 Jacobian matrix J.\"\"\"\n    v_sq = v**2\n    if v_sq >= 1.0: # Protect against domain errors\n        return np.array([[1.0, 0.0], [0.0, 1.0]]) * np.inf\n        \n    gamma_sq = 1.0 / (1.0 - v_sq)\n    gamma = np.sqrt(gamma_sq)\n    gamma3 = gamma**3\n    gamma4 = gamma**4\n    \n    gamma_eos_m1 = gamma_eos - 1.0\n    \n    J = np.zeros((2, 2))\n    \n    # J[0, 0] = df1/dv\n    J[0, 0] = (D_tgt * gamma3 + gamma_eos * p / gamma_eos_m1 * gamma4 * (1.0 + v_sq) + B_sq)\n    \n    # J[0, 1] = df1/dp\n    J[0, 1] = gamma_eos * v * gamma_sq / gamma_eos_m1\n    \n    # J[1, 0] = df2/dv\n    J[1, 0] = v * (D_tgt * gamma3 + 2.0 * gamma_eos * p / gamma_eos_m1 * gamma4 + B_sq)\n    \n    # J[1, 1] = df2/dp\n    J[1, 1] = gamma_eos * gamma_sq / gamma_eos_m1 - 1.0\n    \n    return J\n\nif __name__ == '__main__':\n    # Simulating the environment where this code would be run\n    try:\n        solve()\n    except Exception as e:\n        print(e)\n```", "id": "3530471"}]}