{"hands_on_practices": [{"introduction": "蒙特卡洛辐射转移 (MCRT) 的核心在于高效地对光子与介质相互作用的物理过程进行抽样。逆变换采样法是其中的黄金标准，尤其是在累积分布函数 (CDF) 存在解析反函数的情况下。本练习将引导你为 Henyey-Greenstein 相函数推导逆变换采样公式，这是天体物理学中描述各向异性散射的基石，掌握其抽样方法是开发 MCRT 代码的一项基本功。[@problem_id:3522939]", "problem": "考虑使用 Henyey–Greenstein 相函数在辐射转移中模拟星际尘埃的光子散射。该相函数在计算天体物理学中被广泛用于描述各向异性散射。令 $\\mu=\\cos\\theta\\in[-1,1]$ 表示散射角的余弦。对于各向异性参数 $g\\in(-1,1)$，未归一化的概率密度函数由 $p(\\mu)\\propto \\dfrac{1-g^{2}}{\\left(1+g^{2}-2g\\mu\\right)^{3/2}}$ 给出。在蒙特卡罗（MC）辐射转移中，通过逆变换采样可以实现对 $\\mu$ 的高效采样：抽取一个均匀偏差量 $\\xi\\in(0,1)$，并将 $\\mu$ 设置为在 $\\xi$ 处求值的逆累积分布函数（CDF）。从概率密度函数（PDF）的基本定义、其在支撑集 $[-1,1]$ 上的归一化以及累积分布函数 $F(\\mu)=\\int_{-1}^{\\mu}p(\\mu')\\,d\\mu'$ 出发，推导出一个逆 CDF 映射 $\\xi\\mapsto\\mu(\\xi;g)$ 的闭式解析表达式，该映射生成的样本在 $\\mu\\in[-1,1]$ 上遵循归一化的 Henyey–Greenstein 定律。将最终结果表示为关于 $g$ 和 $\\xi$ 的单一符号表达式。无需进行数值近似或四舍五入。不要返回角度 $\\theta$；返回待采样的量 $\\mu=\\cos\\theta$。", "solution": "用户希望推导 Henyey–Greenstein 相函数的逆累积分布函数（CDF），这是蒙特卡罗采样的一个标准流程。\n\n### 步骤 1：问题验证\n\n**1.1. 提取已知条件：**\n-   **未归一化 PDF：** 概率密度函数 $p(\\mu)$ 与表达式 $\\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}}$ 成正比。\n-   **变量与定义域：** 变量为 $\\mu = \\cos\\theta$，位于闭区间 $[-1, 1]$ 上。\n-   **参数与定义域：** 各向异性参数 $g$ 位于开区间 $(-1, 1)$ 上。\n-   **方法：** 采样将使用逆变换采样法进行。从开区间 $(0, 1)$ 中抽取一个均匀偏差量 $\\xi$。\n-   **目标：** 通过对 CDF（其中 $F(\\mu) = \\int_{-1}^{\\mu} p(\\mu') \\, d\\mu'$）求逆，推导 $\\mu(\\xi; g)$ 的闭式表达式。\n\n**1.2. 验证：**\n-   **科学依据：** 该问题在计算天体物理学和统计力学中有坚实的基础。Henyey–Greenstein 相函数是辐射转移模拟中各向异性散射的典型模型。逆变换采样是一种基础的蒙特卡罗技术。该问题的所有方面在科学上都是合理的。\n-   **适定性：** 该问题是适定的。它要求从第一性原理推导一个解析公式。所涉及的函数在其指定定义域上是良态的。对于 $g \\in (-1, 1)$ 和 $\\mu \\in [-1, 1]$，分母项 $(1+g^2-2g\\mu)$ 严格为正，因为它在 $\\mu=1$ 时等于 $(1-g)^2  0$，在 $\\mu=-1$ 时等于 $(1+g)^2  0$，并且关于 $\\mu$ 是线性的。因此，PDF 是非奇异且非负的，这确保其积分（CDF）是单调递增的，从而保证了唯一逆的存在。\n-   **客观性：** 该问题以精确、客观的数学语言陈述，没有任何主观性或歧义。\n\n**1.3. 结论：**\n该问题是有效的。这是计算物理学中一个标准且非平凡的推导。\n\n### 步骤 2：解的推导\n\n推导过程分为三个主要步骤：概率密度函数（PDF）的归一化，累积分布函数（CDF）的计算，以及 CDF 的求逆。\n\n**2.1. PDF 的归一化**\n\n设未归一化的 PDF 为 $p_{un}(\\mu) = \\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}}$。归一化后的 PDF $p(\\mu)$ 必须满足条件 $\\int_{-1}^{1} p(\\mu) \\, d\\mu = 1$。令 $p(\\mu) = C \\cdot p_{un}(\\mu)$，其中 $C$ 是归一化常数。我们必须首先计算 $p_{un}(\\mu)$ 在其支撑集 $[-1, 1]$ 上的积分。\n\n$$\n\\int_{-1}^{1} p_{un}(\\mu) \\, d\\mu = \\int_{-1}^{1} \\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}} \\, d\\mu\n$$\n\n我们使用换元法，令 $u = 1+g^2-2g\\mu$，这意味着 $d\\mu = -\\frac{du}{2g}$。积分限从 $\\mu=-1$ 变为 $u=(1+g)^2$，从 $\\mu=1$ 变为 $u=(1-g)^2$。\n\n$$\n\\begin{aligned}\n\\int_{-1}^{1} p_{un}(\\mu) \\, d\\mu = (1-g^2) \\int_{(1+g)^2}^{(1-g)^2} u^{-3/2} \\left(-\\frac{du}{2g}\\right) \\\\\n= \\frac{1-g^2}{-2g} \\left[ \\frac{u^{-1/2}}{-1/2} \\right]_{(1+g)^2}^{(1-g)^2} \\\\\n= \\frac{1-g^2}{g} \\left[ u^{-1/2} \\right]_{(1+g)^2}^{(1-g)^2} \\\\\n= \\frac{1-g^2}{g} \\left( ((1-g)^2)^{-1/2} - ((1+g)^2)^{-1/2} \\right)\n\\end{aligned}\n$$\n\n由于 $g \\in (-1, 1)$，所以 $1-g$ 和 $1+g$ 均为正。因此，$\\sqrt{(1-g)^2} = 1-g$ 且 $\\sqrt{(1+g)^2} = 1+g$。\n\n$$\n\\begin{aligned}\n\\int_{-1}^{1} p_{un}(\\mu) \\, d\\mu = \\frac{1-g^2}{g} \\left( \\frac{1}{1-g} - \\frac{1}{1+g} \\right) \\\\\n= \\frac{(1-g)(1+g)}{g} \\left( \\frac{(1+g) - (1-g)}{(1-g)(1+g)} \\right) \\\\\n= \\frac{1}{g} (1+g-1+g) = \\frac{2g}{g} = 2\n\\end{aligned}\n$$\n\n给定表达式的积分为 $2$。因此，归一化常数为 $C = 1/2$。正确归一化的 PDF 是：\n\n$$\np(\\mu) = \\frac{1}{2} \\frac{1-g^2}{(1+g^2-2g\\mu)^{3/2}}\n$$\n\n**2.2. CDF 的计算**\n\nCDF，$F(\\mu)$，定义为 PDF 从支撑集的下界到 $\\mu$ 的积分。\n\n$$\nF(\\mu) = \\int_{-1}^{\\mu} p(\\mu') \\, d\\mu' = \\int_{-1}^{\\mu} \\frac{1}{2} \\frac{1-g^2}{(1+g^2-2g\\mu')^{3/2}} \\, d\\mu'\n$$\n\n我们使用与归一化步骤中相同的原函数。对于 $g \\neq 0$：\n\n$$\n\\begin{aligned}\nF(\\mu) = \\frac{1-g^2}{2} \\left[ \\frac{1}{g} (1+g^2-2g\\mu')^{-1/2} \\right]_{-1}^{\\mu} \\\\\n= \\frac{1-g^2}{2g} \\left[ (1+g^2-2g\\mu)^{-1/2} - (1+g^2-2g(-1))^{-1/2} \\right] \\\\\n= \\frac{1-g^2}{2g} \\left( \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{\\sqrt{(1+g)^2}} \\right) \\\\\n= \\frac{1-g^2}{2g} \\left( \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{1+g} \\right)\n\\end{aligned}\n$$\n\n我们可以验证 $F(-1)=0$ 和 $F(1)=1$，从而证实了 CDF 的正确性。\n\n**2.3. CDF 的求逆**\n\n为了找到反函数 $\\mu(\\xi) = F^{-1}(\\xi)$，我们令 $F(\\mu) = \\xi$ 并解出 $\\mu$。这对 $g \\neq 0$ 成立。\n\n$$\n\\xi = \\frac{1-g^2}{2g} \\left( \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{1+g} \\right)\n$$\n\n我们重新整理方程以分离出 $\\mu$：\n\n$$\n\\frac{2g\\xi}{1-g^2} = \\frac{1}{\\sqrt{1+g^2-2g\\mu}} - \\frac{1}{1+g}\n$$\n\n$$\n\\frac{1}{\\sqrt{1+g^2-2g\\mu}} = \\frac{2g\\xi}{1-g^2} + \\frac{1}{1+g} = \\frac{2g\\xi + (1-g)}{(1-g)(1+g)} = \\frac{1-g+2g\\xi}{1-g^2}\n$$\n\n两边取倒数得到：\n\n$$\n\\sqrt{1+g^2-2g\\mu} = \\frac{1-g^2}{1-g+2g\\xi}\n$$\n\n两边平方：\n\n$$\n1+g^2-2g\\mu = \\left( \\frac{1-g^2}{1-g+2g\\xi} \\right)^2\n$$\n\n最后，解出 $\\mu$：\n\n$$\n2g\\mu = 1+g^2 - \\left( \\frac{1-g^2}{1-g+2g\\xi} \\right)^2\n$$\n\n$$\n\\mu(\\xi; g) = \\frac{1}{2g} \\left[ 1+g^2 - \\left( \\frac{1-g^2}{1-g+2g\\xi} \\right)^2 \\right]\n$$\n\n这个表达式是 $g \\neq 0$ 时所需的逆 CDF。对于 $g=0$（各向同性散射）的特殊情况，PDF 变为均匀分布 $p(\\mu)=1/2$，CDF 为 $F(\\mu) = (\\mu+1)/2$。对其求逆得到 $\\mu = 2\\xi-1$。推导出的通用表达式 $\\mu(\\xi; g)$ 在 $g \\to 0$ 的极限下正确地得到了这个结果，这可以通过使用洛必达法则或泰勒展开来验证。因此，该表达式在整个定义域 $g \\in (-1, 1)$ 上是连续的。这就是逆 CDF 的单一符号表达式。", "answer": "$$\n\\boxed{\\frac{1}{2g} \\left[ 1+g^{2} - \\left( \\frac{1-g^{2}}{1-g+2g\\xi} \\right)^{2} \\right]}\n$$", "id": "3522939"}, {"introduction": "当散射相函数的累积分布函数难以解析反演时，逆变换采样法便不再适用，此时接受-拒绝采样法成为一种强大而灵活的替代方案。该方法的核心思想是从一个更简单的提议分布中抽取候选样本，然后根据特定概率接受或拒绝该样本，从而修正分布以匹配目标。本练习将通过为一个特定的各向异性相函数构建采样器，让你亲手实践这一通用技术，并深入理解其效率如何由提议分布的选择决定。[@problem_id:3523288]", "problem": "考虑蒙特卡洛辐射传输（MCRT）中的一个任务：对散射偏转角进行采样，其概率密度函数（PDF）在 $\\theta \\in [0,\\pi]$ 上正比于 $1+\\alpha \\cos^{2}\\theta$，其中 $\\alpha \\in [0,1]$ 控制各向异性。定义 $\\mu \\equiv \\cos \\theta$，因此 $\\mu \\in [-1,1]$，并将关于 $\\mu$ 的目标密度函数解释为正比于 $1+\\alpha \\mu^{2}$。目标是使用接受-拒绝采样法，并采用一个在 $\\mu$ 上均匀分布的包络函数，来构建一个以弧度为单位的 $\\theta$ 采样器，并刻画接受率作为 $\\alpha$ 的函数。\n\n从概率密度函数和接受-拒绝法的基本定义出发，完成以下任务：\n\n1. 推导目标密度 $f(\\mu) \\propto 1+\\alpha \\mu^{2}$ 在 $\\mu \\in [-1,1]$ 上相对于勒贝格测度 $d\\mu$ 的归一化常数 $Z(\\alpha)$。用闭式形式表示归一化后的目标密度 $f(\\mu)$。\n\n2. 使用一个在 $\\mu \\in [-1,1]$ 上均匀分布的包络密度 $g(\\mu)$（即 $g(\\mu)=\\frac{1}{2}$），求出最小包络尺度 $M(\\alpha)$，使得对所有 $\\mu \\in [-1,1]$ 均有 $f(\\mu) \\le M(\\alpha)\\,g(\\mu)$。从接受-拒绝法的基本原理出发，推导接受率 $R(\\alpha)$ 作为 $\\alpha$ 的函数的闭式表达式。\n\n3. 设计一个接受-拒绝采样器，该采样器：\n   - 从 $g(\\mu)$ 中提议 $\\mu$，\n   - 以根据你的 $M(\\alpha)$ 推导出的概率 $a(\\mu,\\alpha)$ 接受提议，\n   - 返回以弧度为单位的角度 $\\theta = \\arccos(\\mu)$。\n   你的实现必须对所有 $\\alpha \\in [0,1]$ 都有效。\n\n4. 测试套件和输出规范：\n   - 对于参数值 $\\alpha \\in \\{0, 0.25, 0.5, 1\\}$，计算你推导出的解析接受率 $R(\\alpha)$。\n   - 你的程序必须输出一行，其中包含这四个结果，形式为方括号括起来的逗号分隔列表，并按给定的 $\\alpha$ 值顺序排列。每个值必须四舍五入到 $6$ 位小数。\n   - 最终输出格式必须严格为：“[r0,r1,r2,r3]”，其中每个 $r_k$ 是一个有 $6$ 位小数的浮点数。采样器内部使用的角度必须以弧度为单位，但程序要求的输出是接受率列表，这些值是无量纲的。\n\n科学和数值要求：\n- 所有角度均以弧度为单位。\n- 接受-拒绝框架必须基于正确归一化的概率密度函数来构建。\n- 确保你的推导与从 $\\theta$ 到 $\\mu = \\cos \\theta$ 的变量变换下的概率密度函数定义一致。\n- 最终程序必须是自包含的，且不得读取输入。\n\n你的程序应生成一行输出，其中包含用方括号括起来的逗号分隔的结果列表，例如“[r0,r1,r2,r3]”。", "solution": "问题陈述已经过严格验证，并被认为是合理的。它在科学上基于辐射传输和蒙特卡洛方法的原理，是良定的，并且所有术语都有客观而精确的定义。将 $\\mu \\equiv \\cos\\theta$ 的目标密度解释为正比于 $1+\\alpha\\mu^2$，这与在三维空间中从一个正比于 $1+\\alpha\\cos^2\\theta$ 的物理散射相函数进行采样是一致的，其中立体角元 $d\\Omega = \\sin\\theta d\\theta d\\phi$ 导致 $\\theta$ 上的概率分布正比于 $(1+\\alpha\\cos^2\\theta)\\sin\\theta$。通过变量替换到 $\\mu$，可以正确地得到一个正比于 $1+\\alpha\\mu^2$ 的 $\\mu$ 的密度函数。因此，该问题是有效的，我们继续进行完整解答。\n\n解答分为三个部分：归一化概率密度函数（PDF）的推导，接受-拒绝参数的推导，以及最后算法的构建和所需值的计算。\n\n### 1. 推导归一化的目标 PDF\n问题指定了变量 $\\mu = \\cos\\theta$ 在区间 $\\mu \\in [-1, 1]$ 上的目标概率密度正比于 $1+\\alpha\\mu^2$。我们将其未归一化的密度表示为 $\\tilde{f}(\\mu)$。\n$$\n\\tilde{f}(\\mu) = 1 + \\alpha\\mu^2\n$$\n为了将其转换为一个真正的 PDF $f(\\mu)$，我们必须将其归一化，即除以它在定义域上的积分。这个积分就是归一化常数 $Z(\\alpha)$。\n$$\nZ(\\alpha) = \\int_{-1}^{1} \\tilde{f}(\\mu) \\, d\\mu = \\int_{-1}^{1} (1 + \\alpha\\mu^2) \\, d\\mu\n$$\n积分过程很简单：\n$$\nZ(\\alpha) = \\left[ \\mu + \\frac{\\alpha\\mu^3}{3} \\right]_{-1}^{1} = \\left(1 + \\frac{\\alpha(1)^3}{3}\\right) - \\left(-1 + \\frac{\\alpha(-1)^3}{3}\\right) = \\left(1 + \\frac{\\alpha}{3}\\right) - \\left(-1 - \\frac{\\alpha}{3}\\right)\n$$\n$$\nZ(\\alpha) = 1 + \\frac{\\alpha}{3} + 1 + \\frac{\\alpha}{3} = 2 + \\frac{2\\alpha}{3}\n$$\n因此，归一化后的 PDF $f(\\mu)$ 由下式给出：\n$$\nf(\\mu) = \\frac{\\tilde{f}(\\mu)}{Z(\\alpha)} = \\frac{1 + \\alpha\\mu^2}{2 + \\frac{2\\alpha}{3}}\n$$\n\n### 2. 包络尺度和接受率\n接受-拒绝法需要一个提议 PDF $g(\\mu)$ 和一个包络尺度常数 $M(\\alpha)$，使得在定义域内对所有 $\\mu$ 都有 $f(\\mu) \\le M(\\alpha)g(\\mu)$。问题指定了一个在 $\\mu \\in [-1, 1]$ 上的均匀提议 PDF。\n$$\ng(\\mu) = \\frac{1}{1 - (-1)} = \\frac{1}{2}\n$$\n最小包络尺度 $M(\\alpha)$ 是目标 PDF 与提议 PDF之比在定义域上的最大值。\n$$\nM(\\alpha) = \\max_{\\mu \\in [-1, 1]} \\frac{f(\\mu)}{g(\\mu)}\n$$\n代入 $f(\\mu)$ 和 $g(\\mu)$ 的表达式：\n$$\n\\frac{f(\\mu)}{g(\\mu)} = \\frac{\\frac{1 + \\alpha\\mu^2}{2 + 2\\alpha/3}}{\\frac{1}{2}} = \\frac{2(1 + \\alpha\\mu^2)}{2(1 + \\alpha/3)} = \\frac{1 + \\alpha\\mu^2}{1 + \\alpha/3} = \\frac{3(1 + \\alpha\\mu^2)}{3 + \\alpha}\n$$\n为了求该比率的最大值，我们考察其对 $\\mu$ 的依赖关系。令 $h(\\mu) = \\frac{3(1 + \\alpha\\mu^2)}{3 + \\alpha}$。其关于 $\\mu$ 的导数为 $h'(\\mu) = \\frac{6\\alpha\\mu}{3 + \\alpha}$。因为 $\\alpha \\in [0, 1]$，所以项 $6\\alpha/(3+\\alpha)$ 是非负的。\n- 如果 $\\alpha=0$，$h(\\mu)$ 是常数。\n- 如果 $\\alpha  0$，$h(\\mu)$ 是一个关于 $\\mu$ 的开口向上的抛物线，在 $\\mu=0$ 处取得最小值。因此，它在区间 $[-1, 1]$ 上的最大值必然出现在边界 $\\mu=-1$ 或 $\\mu=1$ 处。\n根据对称性（因为 $\\mu^2$），两个端点的值相同。我们在 $\\mu=1$ 处求值：\n$$\nM(\\alpha) = \\left. \\frac{3(1 + \\alpha\\mu^2)}{3 + \\alpha} \\right|_{\\mu=1} = \\frac{3(1 + \\alpha)}{3 + \\alpha}\n$$\n在接受-拒绝法中，如果 $f$ 和 $g$ 都是归一化的 PDF，则接受一个提议样本的总概率是包络尺度 $M(\\alpha)$ 的倒数。这就是接受率 $R(\\alpha)$。\n$$\nR(\\alpha) = \\frac{1}{M(\\alpha)} = \\frac{3 + \\alpha}{3(1 + \\alpha)}\n$$\n这就是接受率作为 $\\alpha$ 的函数的闭式表达式。\n\n### 3. 采样器设计与计算\n接受-拒绝采样器的操作如下：\n1.  从提议分布 $g(\\mu)$ 中抽取一个候选值 $\\mu_c$，即从 $[-1, 1]$ 上的均匀分布中采样 $\\mu_c$。\n2.  从 $[0, 1]$ 上的均匀分布中抽取一个随机数 $u$。\n3.  如果条件 $u \\le \\frac{f(\\mu_c)}{M(\\alpha)g(\\mu_c)}$ 满足，则接受 $\\mu_c$。对于给定的 $\\mu_c$，其接受概率 $a(\\mu_c, \\alpha)$ 可以很好地简化为：\n    $$\n    a(\\mu_c, \\alpha) = \\frac{f(\\mu_c)}{M(\\alpha)g(\\mu_c)} = \\frac{1}{M(\\alpha)} \\frac{f(\\mu_c)}{g(\\mu_c)} = \\frac{3 + \\alpha}{3(1 + \\alpha)} \\cdot \\frac{3(1 + \\alpha\\mu_c^2)}{3 + \\alpha} = \\frac{1 + \\alpha\\mu_c^2}{1 + \\alpha}\n    $$\n    所以，条件是 $u \\le \\frac{1 + \\alpha\\mu_c^2}{1 + \\alpha}$。\n4.  如果样本被接受，最终输出为散射角 $\\theta = \\arccos(\\mu_c)$（以弧度为单位）。如果被拒绝，则从步骤1开始重复该过程。\n\n问题要求计算 $\\alpha \\in \\{0, 0.25, 0.5, 1\\}$ 时的解析接受率 $R(\\alpha)$，这将在最终的程序中实现。\n$$\nR(\\alpha) = \\frac{3 + \\alpha}{3(1 + \\alpha)}\n$$\n- 对于 $\\alpha=0$：$R(0) = \\frac{3}{3(1)} = 1$。\n- 对于 $\\alpha=0.25$：$R(0.25) = \\frac{3.25}{3(1.25)} = \\frac{3.25}{3.75} = \\frac{13}{15} \\approx 0.866667$。\n- 对于 $\\alpha=0.5$：$R(0.5) = \\frac{3.5}{3(1.5)} = \\frac{3.5}{4.5} = \\frac{7}{9} \\approx 0.777778$。\n- 对于 $\\alpha=1$：$R(1) = \\frac{4}{3(2)} = \\frac{4}{6} = \\frac{2}{3} \\approx 0.666667$。\n程序将计算这些值并按要求格式化它们。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Calculates the analytic acceptance rate for a Monte Carlo sampler\n    based on the problem specification.\n    \"\"\"\n    # Define the test cases for the anisotropy parameter alpha.\n    test_cases = [0.0, 0.25, 0.5, 1.0]\n\n    results = []\n    for alpha in test_cases:\n        # The acceptance rate R(alpha) is derived from first principles as:\n        # R(alpha) = (3 + alpha) / (3 * (1 + alpha))\n        # This formula is valid for all alpha >= 0.\n        acceptance_rate = (3.0 + alpha) / (3.0 * (1.0 + alpha))\n        results.append(acceptance_rate)\n\n    # Format the results into a string with each value rounded to 6 decimal places,\n    # as required by the problem statement.\n    formatted_results = [f\"{r:.6f}\" for r in results]\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3523288"}, {"introduction": "在掌握了单个散射事件的抽样方法后，下一步是优化整个模拟的全局效率。实际的 MCRT 模拟总是在有限的计算预算下运行，因此如何智能地分配计算资源（即光子包）至关重要。本练习引入了一种强大的方差缩减技术，通过求解一个带约束的优化问题，你将学习如何根据不同空间单元的统计特性来最优地分配光子包数量，从而在固定的总计算成本下最小化全局估计量的统计误差。这个问题架起了从理论抽样到实用的大规模模拟设计的桥梁。[@problem_id:3523263]", "problem": "使用蒙特卡洛辐射传输模拟来估计一个全局的、体积加权的辐射度量，该度量可以写成空间单元上的一个线性泛函。将计算域划分为 $M$ 个不相交的单元，索引为 $i \\in \\{1,\\dots,M\\}$。在单元 $i$ 中，每个辐射包产生一个得分 $X_{i,k}$，$k \\in \\{1,\\dots,n_i\\}$，其中 $n_i$ 是分配给单元 $i$ 的辐射包数量。假设 $\\{X_{i,k}\\}_{k=1}^{n_i}$ 是独立同分布的，具有有限的均值 $\\mu_i$ 和方差 $\\sigma_i^2$，并且不同单元之间的抽样流是相互独立的。单元均值的估计量为 $\\hat{\\mu}_i = \\frac{1}{n_i} \\sum_{k=1}^{n_i} X_{i,k}$。我们感兴趣的全局量是\n$$\nQ \\equiv \\sum_{i=1}^{M} w_i \\,\\mu_i,\n$$\n其中 $w_i  0$ 是固定的单元权重，由得分泛函的物理意义决定（例如，单元体积乘以一个已知的响应因子）。你通过\n$$\n\\hat{Q} \\equiv \\sum_{i=1}^{M} w_i \\,\\hat{\\mu}_i.\n$$\n来估计 $Q$。\n给定来自初步引导性运行的各样本方差 $\\sigma_i^2$ 和一个固定的总辐射包预算 $N_{\\text{tot}}$，它通过 $\\sum_{i=1}^{M} n_i = N_{\\text{tot}}$ 约束了分配。在优化时，将 $n_i$ 视为正实数决策变量。\n\n仅从独立蒙特卡洛样本均值的基本性质以及独立随机变量之和的方差法则出发，推导出在预算约束下最小化 $\\mathrm{Var}(\\hat{Q})$ 的分配方案 $\\{n_i^\\star\\}_{i=1}^{M}$。将你的结果写成一个用 $\\{w_i\\}_{i=1}^M$、$\\{\\sigma_i^2\\}_{i=1}^M$ 和 $N_{\\text{tot}}$ 表示的闭式表达式。\n\n然后，对于 $M=4$ 的具体情况，在总预算 $N_{\\text{tot}} = 115000$ 下，计算你的表达式的值，具体参数为\n$$\nw_1 = 1,\\quad w_2 = 2,\\quad w_3 = \\tfrac{1}{2},\\quad w_4 = \\tfrac{3}{2},\n$$\n和引导性运行的各样本方差\n$\n\\sigma_1^2 = 4,\\quad \\sigma_2^2 = 1,\\quad \\sigma_3^2 = 9,\\quad \\sigma_4^2 = 16,\n$\n将最终的分配向量 $(n_1^\\star,n_2^\\star,n_3^\\star,n_4^\\star)$ 表示为精确的整数，无需四舍五入。你的最终答案必须是单个行向量表达式。", "solution": "该问题要求推导蒙特卡洛样本的最优分配 $\\{n_i^\\star\\}_{i=1}^{M}$，以在固定的总样本预算 $N_{\\text{tot}}$ 约束下，最小化全局估计量 $\\hat{Q}$ 的方差。推导过程必须从基本原理出发。\n\n首先，我们建立目标函数，即估计量 $\\hat{Q}$ 的方差，记为 $\\mathrm{Var}(\\hat{Q})$。估计量定义为：\n$$\n\\hat{Q} \\equiv \\sum_{i=1}^{M} w_i \\,\\hat{\\mu}_i\n$$\n其中 $\\hat{\\mu}_i$ 是单元 $i$ 的样本均值。问题陈述，不同单元之间的抽样流是独立的。这意味着对于 $i \\neq j$，随机变量 $\\hat{\\mu}_i$ 和 $\\hat{\\mu}_j$ 是独立的。对于独立随机变量之和，其和的方差等于方差之和。应用此规则以及方差的尺度性质 $\\mathrm{Var}(aX) = a^2 \\mathrm{Var}(X)$，我们有：\n$$\n\\mathrm{Var}(\\hat{Q}) = \\mathrm{Var}\\left(\\sum_{i=1}^{M} w_i \\hat{\\mu}_i\\right) = \\sum_{i=1}^{M} \\mathrm{Var}(w_i \\hat{\\mu}_i) = \\sum_{i=1}^{M} w_i^2 \\mathrm{Var}(\\hat{\\mu}_i)\n$$\n接下来，我们确定 $\\mathrm{Var}(\\hat{\\mu}_i)$。单元均值的估计量 $\\hat{\\mu}_i$ 是 $n_i$ 个独立同分布(i.i.d.)的得分 $X_{i,k}$ 的平均值，每个得分的方差为 $\\sigma_i^2$：\n$$\n\\hat{\\mu}_i = \\frac{1}{n_i} \\sum_{k=1}^{n_i} X_{i,k}\n$$\n这个样本均值的方差为：\n$$\n\\mathrm{Var}(\\hat{\\mu}_i) = \\mathrm{Var}\\left(\\frac{1}{n_i} \\sum_{k=1}^{n_i} X_{i,k}\\right) = \\frac{1}{n_i^2} \\mathrm{Var}\\left(\\sum_{k=1}^{n_i} X_{i,k}\\right)\n$$\n由于得分 $X_{i,k}$ 是独立同分布的，所以它们和的方差等于它们方差的和：\n$$\n\\mathrm{Var}(\\hat{\\mu}_i) = \\frac{1}{n_i^2} \\sum_{k=1}^{n_i} \\mathrm{Var}(X_{i,k}) = \\frac{1}{n_i^2} (n_i \\sigma_i^2) = \\frac{\\sigma_i^2}{n_i}\n$$\n将此结果代回到 $\\mathrm{Var}(\\hat{Q})$ 的表达式中，我们得到需要最小化的目标函数：\n$$\nV(n_1, \\dots, n_M) = \\mathrm{Var}(\\hat{Q}) = \\sum_{i=1}^{M} \\frac{w_i^2 \\sigma_i^2}{n_i}\n$$\n必须在预算约束下最小化此方差：\n$$\n\\sum_{i=1}^{M} n_i = N_{\\text{tot}}\n$$\n我们使用拉格朗日乘数法来解决这个约束优化问题。决策变量 $n_i$被视为正实数。拉格朗日函数 $\\mathcal{L}$ 为：\n$$\n\\mathcal{L}(n_1, \\dots, n_M, \\lambda) = \\sum_{i=1}^{M} \\frac{w_i^2 \\sigma_i^2}{n_i} - \\lambda \\left(\\sum_{i=1}^{M} n_i - N_{\\text{tot}}\\right)\n$$\n为了找到最小值，我们将 $\\mathcal{L}$ 关于每个 $n_j$ 的偏导数设为零：\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial n_j} = -\\frac{w_j^2 \\sigma_j^2}{n_j^2} - \\lambda = 0 \\quad \\text{for } j=1, \\dots, M\n$$\n这得到：\n$$\n\\frac{w_j^2 \\sigma_j^2}{n_j^2} = -\\lambda\n$$\n由于 $w_j^2  0$，$\\sigma_j^2 \\ge 0$ 且 $n_j^2  0$，等式右边先验地必须是非负的。我们定义一个新的正常数 $\\lambda' = -\\lambda$。取正平方根（因为 $n_j$ 和 $w_j$ 是正的，且 $\\sigma_j \\equiv \\sqrt{\\sigma_j^2} \\ge 0$）：\n$$\n\\frac{w_j \\sigma_j}{n_j} = \\sqrt{\\lambda'} \\implies n_j = \\frac{w_j \\sigma_j}{\\sqrt{\\lambda'}}\n$$\n为了确定 $\\sqrt{\\lambda'}$，我们将这个 $n_j$ 的表达式代入约束方程：\n$$\n\\sum_{j=1}^{M} n_j = \\sum_{j=1}^{M} \\frac{w_j \\sigma_j}{\\sqrt{\\lambda'}} = \\frac{1}{\\sqrt{\\lambda'}} \\sum_{j=1}^{M} w_j \\sigma_j = N_{\\text{tot}}\n$$\n解出 $\\sqrt{\\lambda'}$ 得到：\n$$\n\\sqrt{\\lambda'} = \\frac{\\sum_{j=1}^{M} w_j \\sigma_j}{N_{\\text{tot}}}\n$$\n最后，我们把这个结果代回到 $n_j$ 的表达式中，以求得最优分配 $n_j^\\star$：\n$$\nn_j^\\star = \\frac{w_j \\sigma_j}{\\left( \\frac{\\sum_{k=1}^{M} w_k \\sigma_k}{N_{\\text{tot}}} \\right)} = N_{\\text{tot}} \\frac{w_j \\sigma_j}{\\sum_{k=1}^{M} w_k \\sigma_k}\n$$\n这就是最优分配的闭式表达式。\n\n现在，我们针对给定的数值情况计算这个表达式：\n$M=4$, $N_{\\text{tot}} = 115000$。\n权重为 $w_1 = 1$, $w_2 = 2$, $w_3 = \\frac{1}{2}$, $w_4 = \\frac{3}{2}$。\n方差为 $\\sigma_1^2 = 4$, $\\sigma_2^2 = 1$, $\\sigma_3^2 = 9$, $\\sigma_4^2 = 16$。\n首先，计算标准差 $\\sigma_i = \\sqrt{\\sigma_i^2}$：\n$\\sigma_1 = \\sqrt{4} = 2$\n$\\sigma_2 = \\sqrt{1} = 1$\n$\\sigma_3 = \\sqrt{9} = 3$\n$\\sigma_4 = \\sqrt{16} = 4$\n\n接下来，计算乘积 $w_i \\sigma_i$：\n$w_1 \\sigma_1 = 1 \\times 2 = 2$\n$w_2 \\sigma_2 = 2 \\times 1 = 2$\n$w_3 \\sigma_3 = \\frac{1}{2} \\times 3 = \\frac{3}{2}$\n$w_4 \\sigma_4 = \\frac{3}{2} \\times 4 = 6$\n\n然后，计算分母中的和：\n$$\n\\sum_{k=1}^{4} w_k \\sigma_k = 2 + 2 + \\frac{3}{2} + 6 = 10 + \\frac{3}{2} = \\frac{23}{2}\n$$\n现在我们可以计算每个单元的最优分配：\n$$\nn_i^\\star = N_{\\text{tot}} \\frac{w_i \\sigma_i}{\\sum_{k=1}^{4} w_k \\sigma_k} = 115000 \\frac{w_i \\sigma_i}{23/2} = \\frac{2 \\times 115000}{23} (w_i \\sigma_i) = 10000 (w_i \\sigma_i)\n$$\n$n_1^\\star = 10000 \\times (w_1 \\sigma_1) = 10000 \\times 2 = 20000$\n$n_2^\\star = 10000 \\times (w_2 \\sigma_2) = 10000 \\times 2 = 20000$\n$n_3^\\star = 10000 \\times (w_3 \\sigma_3) = 10000 \\times \\frac{3}{2} = 15000$\n$n_4^\\star = 10000 \\times (w_4 \\sigma_4) = 10000 \\times 6 = 60000$\n\n得到的分配向量是 $(n_1^\\star, n_2^\\star, n_3^\\star, n_4^\\star) = (20000, 20000, 15000, 60000)$。\n我们来检查预算约束：$20000 + 20000 + 15000 + 60000 = 115000 = N_{\\text{tot}}$。约束条件得到满足，并且这些值是精确的整数。", "answer": "$$\n\\boxed{\\begin{pmatrix} 20000  20000  15000  60000 \\end{pmatrix}}\n$$", "id": "3523263"}]}