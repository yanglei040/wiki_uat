{"hands_on_practices": [{"introduction": "在我们运用傅里叶分析的强大功能之前，必须确保我们的数字数据能忠实地代表原始的模拟信号。本实践聚焦于关键的第一步：采样。我们将探讨“混叠”（aliasing）现象，即高于奈奎斯特频率的频率会折叠回我们的观测频带，产生谱线“伪影”。通过首先计算污染信号的混叠频率[@problem_id:3511698]，您将接着设计一个抗混叠滤波器，这是保全任何测量时间序列数据完整性的基本工具。", "problem": "从一个监测可变源的快速光学探测器中获取了一组天文光度时间序列。模拟前端将信号馈送给一个以 $f_{s} = 1\\,\\mathrm{kHz}$ 频率采样的模数转换器。在模拟域中，存在两条窄带污染谱线，频率分别为 $f_{0} = 700\\,\\mathrm{Hz}$ 和 $f_{1} = 800\\,\\mathrm{Hz}$。为了识别谱线特征和宽带噪声，将通过对长的连续数据段计算离散傅里叶变换（通过快速傅里叶变换(FFT)实现）来估计离散时间功率谱。假设感兴趣的天体物理信号被限制在 $[0,450]\\,\\mathrm{Hz}$ 范围内。\n\n从采样定理和离散傅里叶变换的定义出发，推导高于奈奎斯特频率的模拟正弦分量如何映射到基带 $[0,f_{N}]$ 内的离散时间频率上，其中 $f_{N} = f_{s}/2$。利用该映射关系，计算在离散时间功率谱中出现的 $f_{0}$ 和 $f_{1}$ 的混叠分量。\n\n为从源头上抑制这些混叠谱线，你计划设计一个模拟预采样抗混叠滤波器。选择一个低通 Butterworth 原型。施加以下设计约束：\n1. 在 $450\\,\\mathrm{Hz}$ 处的通带增益相对于直流增益不得低于 $-1\\,\\mathrm{dB}$。\n2. 在 $700\\,\\mathrm{Hz}$ 和 $800\\,\\mathrm{Hz}$ 处的幅度衰减（以分贝为单位，度量为 $20\\log_{10}(|H(f)|)$）必须至少为 $-60\\,\\mathrm{dB}$。\n\n假设采用单调 Butterworth 响应，其截止频率 $f_{c}$ 的设置恰好满足 $450\\,\\mathrm{Hz}$ 处的通带约束，请从第一性原理出发，确定能够同时保证 $700\\,\\mathrm{Hz}$ 和 $800\\,\\mathrm{Hz}$ 处阻带衰减约束的最小整数滤波器阶数 $n$。最终答案仅提供最小整数滤波器阶数。", "solution": "用户提出了一个分为两部分的问题。第一部分要求推导低于奈奎斯特率采样的正弦信号的混叠效应。第二部分涉及根据指定的性能标准设计一个 Butterworth 抗混叠滤波器。该问题在科学上是合理的且表述清晰。\n\n### 第1部分：正弦分量的混叠\n\n一个模拟正弦信号可以表示为 $x_a(t) = A \\cos(2\\pi f_a t + \\phi)$，其中 $f_a$ 是以 Hz 为单位的模拟频率。当此信号以频率 $f_s$ 采样时，通过在采样周期 $T_s = 1/f_s$ 的整数倍上对 $x_a(t)$ 求值，生成一个离散时间序列 $x[k]$。\n$$ x[k] = x_a(k T_s) = A \\cos(2\\pi f_a k T_s + \\phi) = A \\cos\\left(2\\pi \\frac{f_a}{f_s} k + \\phi\\right) $$\n项 $\\omega = 2\\pi (f_a/f_s)$ 是归一化离散时间角频率。\n\n混叠的核心原理源于余弦函数的周期性。如果余弦函数的参数移动 $2\\pi$ 的任意整数倍，函数值保持不变。因此，对于任意整数 $m$：\n$$ \\cos\\left(2\\pi \\frac{f_a}{f_s} k + \\phi\\right) = \\cos\\left(\\left(2\\pi \\frac{f_a}{f_s} + 2\\pi m\\right) k + \\phi\\right) = \\cos\\left(2\\pi \\frac{f_a + m f_s}{f_s} k + \\phi\\right) $$\n这个等式表明，一个模拟频率 $f_a$ 与任何频率 $f_a' = f_a + m f_s$ 产生完全相同的离散时间序列。离散傅里叶变换 (DFT) 对这个离散序列进行操作，无法区分这些频率。DFT 通常计算基带区间 $[0, f_s/2]$（也表示为 $[0, f_N]$，其中 $f_N = f_s/2$ 是奈奎斯特频率）内频率的系数。任何在此区间之外的模拟频率 $f_a$ 都将被“混叠”到此区间内的一个频率。\n\n一个模拟频率 $f_a \\ge 0$ 到其在 $[0, f_N]$ 中的混叠对应频率 $f_{\\text{al}}$ 的映射，可以形象地看作是频率轴围绕 $f_N$ 的整数倍进行“折叠”。\n对于整数 $k \\ge 0$，在范围 $[k f_N, (k+1)f_N]$ 内的频率 $f_a$ 将按如下方式混叠：\n- 如果 $k$ 是偶数（即 $k = 2m$），则 $f_a \\in [2m f_N, (2m+1) f_N] = [m f_s, m f_s + f_N]$。混叠频率为 $f_{\\text{al}} = f_a - m f_s$。\n- 如果 $k$ 是奇数（即 $k = 2m+1$），则 $f_a \\in [(2m+1) f_N, (2m+2) f_N] = [m f_s + f_N, (m+1) f_s]$。混叠频率为 $f_{\\text{al}} = (m+1) f_s - f_a$。\n\n给定数据：\n采样频率 $f_s = 1000\\,\\mathrm{Hz}$。\n奈奎斯特频率 $f_N = f_s/2 = 500\\,\\mathrm{Hz}$。\n污染谱线频率 $f_0 = 700\\,\\mathrm{Hz}$ 和 $f_1 = 800\\,\\mathrm{Hz}$。\n\n对于 $f_0 = 700\\,\\mathrm{Hz}$：\n此频率位于区间 $[500\\,\\mathrm{Hz}, 1000\\,\\mathrm{Hz}]$ 内，对应于 $[1 \\cdot f_N, 2 \\cdot f_N]$。这里，$k=1$，为奇数（其中 $m=0$）。混叠频率 $f_{\\text{al},0}$ 为：\n$$ f_{\\text{al},0} = (0+1) f_s - f_0 = f_s - f_0 = 1000 - 700 = 300\\,\\mathrm{Hz} $$\n\n对于 $f_1 = 800\\,\\mathrm{Hz}$：\n此频率也位于区间 $[500\\,\\mathrm{Hz}, 1000\\,\\mathrm{Hz}]$ 内，所以 $k=1$（奇数，其中 $m=0$）。混叠频率 $f_{\\text{al},1}$ 为：\n$$ f_{\\text{al},1} = (0+1) f_s - f_1 = f_s - f_1 = 1000 - 800 = 200\\,\\mathrm{Hz} $$\n混叠分量出现在 $200\\,\\mathrm{Hz}$ 和 $300\\,\\mathrm{Hz}$，两者都落在感兴趣的天体物理信号频带 $[0, 450]\\,\\mathrm{Hz}$ 内，从而污染了数据。\n\n### 第2部分：Butterworth 抗混叠滤波器设计\n\n一个具有截止频率 $f_c$ 的 $n$ 阶低通 Butterworth 滤波器的幅度平方响应由下式给出：\n$$ |H(f)|^2 = \\frac{1}{1 + \\left(\\frac{f}{f_c}\\right)^{2n}} $$\n以分贝 (dB) 为单位的衰减定义为 $A_{\\mathrm{dB}}(f) = 20 \\log_{10}(|H(f)|) = 10 \\log_{10}(|H(f)|^2)$。\n$$ A_{\\mathrm{dB}}(f) = 10 \\log_{10}\\left(\\frac{1}{1 + \\left(\\frac{f}{f_c}\\right)^{2n}}\\right) = -10 \\log_{10}\\left(1 + \\left(\\frac{f}{f_c}\\right)^{2n}\\right) $$\n\n设计约束为：\n1.  通带：在 $f_p = 450\\,\\mathrm{Hz}$ 处，增益不得低于 $-1\\,\\mathrm{dB}$。\n2.  阻带：在 $f_{s0} = 700\\,\\mathrm{Hz}$ 和 $f_{s1} = 800\\,\\mathrm{Hz}$ 处，增益不得高于 $-60\\,\\mathrm{dB}$。\n\n首先，我们根据通带约束确定 $f_c$ 和 $n$ 之间的关系。为了“恰好满足”此约束，我们将 $f_p$ 处的增益精确设置为 $-1\\,\\mathrm{dB}$。\n$$ -1 = -10 \\log_{10}\\left(1 + \\left(\\frac{f_p}{f_c}\\right)^{2n}\\right) $$\n$$ 0.1 = \\log_{10}\\left(1 + \\left(\\frac{f_p}{f_c}\\right)^{2n}\\right) $$\n$$ 10^{0.1} = 1 + \\left(\\frac{f_p}{f_c}\\right)^{2n} $$\n$$ \\left(\\frac{f_p}{f_c}\\right)^{2n} = 10^{0.1} - 1 \\quad (\\*)$$\n\n接下来，我们应用阻带约束。Butterworth 滤波器具有单调递减的幅度响应。因此，在较低频率（$f_{s0}=700\\,\\mathrm{Hz}$）处的约束是更严格的。如果它被满足，那么在 $f_{s1}=800\\,\\mathrm{Hz}$ 处的约束将自动被满足。我们在 $f_s=700\\,\\mathrm{Hz}$ 处设置约束：\n$$ A_{\\mathrm{dB}}(f_s) \\le -60\\,\\mathrm{dB} $$\n$$ -10 \\log_{10}\\left(1 + \\left(\\frac{f_s}{f_c}\\right)^{2n}\\right) \\le -60 $$\n$$ \\log_{10}\\left(1 + \\left(\\frac{f_s}{f_c}\\right)^{2n}\\right) \\ge 6 $$\n$$ 1 + \\left(\\frac{f_s}{f_c}\\right)^{2n} \\ge 10^6 $$\n$$ \\left(\\frac{f_s}{f_c}\\right)^{2n} \\ge 10^6 - 1 \\quad (\\*\\*)$$\n\n为了求解滤波器阶数 $n$，我们可以通过将阻带不等式 $(\\*\\*)$ 除以通带等式 $(\\*)$ 来消去未知的截止频率 $f_c$：\n$$ \\frac{\\left(\\frac{f_s}{f_c}\\right)^{2n}}{\\left(\\frac{f_p}{f_c}\\right)^{2n}} \\ge \\frac{10^6 - 1}{10^{0.1} - 1} $$\n$$ \\left(\\frac{f_s}{f_p}\\right)^{2n} \\ge \\frac{10^6 - 1}{10^{0.1} - 1} $$\n对两边取以 10 为底的对数：\n$$ 2n \\log_{10}\\left(\\frac{f_s}{f_p}\\right) \\ge \\log_{10}\\left(\\frac{10^6 - 1}{10^{0.1} - 1}\\right) $$\n由于 $f_s > f_p$，$\\log_{10}(f_s/f_p) > 0$，因此在求解 $n$ 时不等号方向保持不变：\n$$ n \\ge \\frac{\\log_{10}\\left(\\frac{10^6 - 1}{10^{0.1} - 1}\\right)}{2 \\log_{10}\\left(\\frac{f_s}{f_p}\\right)} $$\n现在，我们代入给定的频率值 $f_p=450\\,\\mathrm{Hz}$ 和 $f_s=700\\,\\mathrm{Hz}$：\n$$ n \\ge \\frac{\\log_{10}\\left(\\frac{10^6 - 1}{10^{0.1} - 1}\\right)}{2 \\log_{10}\\left(\\frac{700}{450}\\right)} = \\frac{\\log_{10}\\left(\\frac{999999}{10^{0.1} - 1}\\right)}{2 \\log_{10}\\left(\\frac{14}{9}\\right)} $$\n计算数值：\n$$ n \\ge \\frac{\\log_{10}\\left(\\frac{999999}{0.258925...}\\right)}{2 \\log_{10}(1.5555...)} \\approx \\frac{\\log_{10}(3862086.1)}{2 \\times 0.19183} \\approx \\frac{6.5868}{0.38367} \\approx 17.168 $$\n由于滤波器阶数 $n$ 必须是整数，我们必须选择满足此不等式的最小整数。\n$$ n_{\\min} = \\lceil 17.168 \\rceil = 18 $$\n所需的最小整数滤波器阶数为 $18$。", "answer": "$$\n\\boxed{18}\n$$", "id": "3511698"}, {"introduction": "功率谱不仅仅是一幅定性的图像，更是一种精确的定量工具。本练习深入探讨功率谱密度（Power Spectral Density, PSD）的基本属性，引导我们正确处理其物理单位以及定量分析所需的归一化。通过推导将实值信号的双边谱转换为单边谱所需的缩放因子[@problem_id:3511736]，您将学会如何确保您的功率谱估计能正确地划分和表示信号在单位频率上的方差。", "problem": "一个来自致密源的射电流量密度均匀采样时间序列 $x(t)$ 以采样间隔 $\\Delta t$（单位为 $\\mathrm{s}$）进行记录，在总持续时间 $T = N \\Delta t$ 内产生 $N$ 个样本。可观测量 $x(t)$ 以扬斯基 $\\mathrm{Jy}$ 为单位进行测量，其中 $\\mathrm{Jy}$ 表示一个流量密度单位，在本问题中应被视为量纲分析的基本单位符号。假设 $x(t)$ 是具有有限方差的实值宽义平稳过程。\n\n令 $X(f)$ 表示 $x(t)$ 的连续时间傅里叶变换，其约定为 $X(f) = \\int_{-\\infty}^{\\infty} x(t)\\,\\exp(-2\\pi i f t)\\,dt$，并令 $S_{x}(f)$ 表示关于时间频率 $f$（单位为 $\\mathrm{Hz}$）的功率谱密度 (PSD)，其被理解为单位频率方差密度，使得将 $S_{x}(f)$ 在一个频带上积分可以得到该频带对 $x(t)$ 方差的贡献。\n\n从第一性原理和经过充分检验的公式出发，并且不使用任何预先给定的功率谱密度快捷方式，完成以下任务：\n\n1. 使用量纲分析以及“将 $S_{x}(f)$ 对 $f$ 积分得到 $x(t)$ 的方差”这一定义，推导出 $S_{x}(f)$ 以 $\\mathrm{Jy}$ 和 $\\mathrm{s}$ 的幂表示的正确单位形式，注意不要将 $\\mathrm{Jy}$ 中隐含的电磁频率内容与傅里叶变换所使用的时间频率 $f$ 相混淆。\n\n2. 对于实值 $x(t)$，通过快速傅里叶变换 (FFT) 计算的离散傅里叶变换会产生一个双边谱，其在 $+f$ 和 $-f$ 处具有相等的功率。构建一个仅为 $f \\ge 0$ 定义的单边功率谱密度，使其在频率上积分时能保持总方差不变。论证应用于严格正频率箱的缩放因子，并解释对 $f = 0$（直流）分量以及（当 $N$ 为偶数时适用的）奈奎斯特频率 $f_{\\mathrm{N}} = \\frac{1}{2\\Delta t}$ 的处理方法。\n\n将你的最终结果表示为一个包含三个条目的行矩阵：单边缩放因子 $c$、使得功率谱密度单位为 $\\mathrm{Jy}^{a}$ 的指数 $a$，以及使得功率谱密度单位为 $\\mathrm{s}^{b}$ 的指数 $b$。你的最终答案必须是 $\\begin{pmatrix} c  a  b \\end{pmatrix}$ 的形式。不要四舍五入；要求是精确整数。", "solution": "所述问题具有科学依据、提法恰当、客观且自洽。它提出了一个天体物理背景下时间序列分析的标准任务，基于傅里叶分析的明确定义和基本原理。所有必要信息均已提供，不存在矛盾或歧义。因此，该问题被认定为有效，并将提供解答。\n\n该问题要求从功率谱密度 (PSD) 分析的原理中推导出三个量：描述功率谱密度 `$S_{x}(f)$` 单位的指数 `$a$` 和 `$b$`（形式为 `$\\mathrm{Jy}^{a}\\,\\mathrm{s}^{b}$`），以及用于从双边功率谱密度构建单边功率谱密度的缩放因子 `$c$`。\n\n首先，我们将确定功率谱密度 `$S_{x}(f)$` 的单位，这将得出指数 `$a$` 和 `$b$`。问题将 `$S_{x}(f)$` 定义为单位频率方差密度，其在频率上的积分等于时间序列 `$x(t)$` 的方差。这可以写成：\n$$\n\\mathrm{Var}(x(t)) = \\int_{-\\infty}^{\\infty} S_{x}(f) \\, df\n$$\n令 `$[Y]$` 表示量 `$Y$` 的物理单位。时间序列 `$x(t)$` 代表射电流量密度，其值以扬斯基 (`$\\mathrm{Jy}$`) 为单位测量。 `$x(t)$` 的方差，记为 `$\\mathrm{Var}(x(t))$`，是与均值偏差的平方的期望，即 `$\\mathrm{E}\\left[(x(t) - \\mu_x)^2\\right]$`。因此，其单位是 `$x(t)$` 单位的平方。\n$$\n[\\mathrm{Var}(x(t))] = [x(t)]^2 = \\mathrm{Jy}^2\n$$\n积分变量是时间频率 `$f$`，以赫兹 (`$\\mathrm{Hz}$`) 为单位测量。一赫兹是每秒一周期，所以其单位是秒的倒数，即 `$\\mathrm{s}^{-1}$`。因此，微分元 `$df$` 的单位与 `$f$` 相同。\n$$\n[df] = [f] = \\mathrm{Hz} = \\mathrm{s}^{-1}\n$$\n为了使积分方程在量纲上保持一致，等式左边的单位必须等于右边的单位。积分的单位是被积函数单位与积分变量单位的乘积。\n$$\n[\\mathrm{Var}(x(t))] = [S_{x}(f)] \\cdot [f]\n$$\n代入已知单位，我们有：\n$$\n\\mathrm{Jy}^2 = [S_{x}(f)] \\cdot \\mathrm{s}^{-1}\n$$\n解出 `$S_{x}(f)$` 的单位，我们得到：\n$$\n[S_{x}(f)] = \\frac{\\mathrm{Jy}^2}{\\mathrm{s}^{-1}} = \\mathrm{Jy}^2 \\cdot \\mathrm{s}^1\n$$\n问题指定的单位形式为 `$\\mathrm{Jy}^{a}\\,\\mathrm{s}^{b}$`。通过将此形式与我们推导出的结果进行比较，我们确定指数为：\n$$\na = 2\n$$\n$$\nb = 1\n$$\n\n接下来，我们推导为实值信号从双边功率谱密度构建单边功率谱密度所需的缩放因子 `$c$`。给定的时间序列 `$x(t)$` 是实值的。傅里叶变换的一个基本性质是，对于任何实函数，其变换 `$X(f)$` 表现出厄米对称性：`$X(-f) = X^*(f)$`，其中星号表示复共轭。双边功率谱密度 `$S_{x}(f)$` 与 `$\\left|X(f)\\right|^2$` 成正比。由厄米性质可知，`$\\left|X(-f)\\right|^2 = \\left|X^*(f)\\right|^2 = \\left|X(f)\\right|^2$`。这意味着实信号的双边功率谱密度是频率的偶函数：\n$$\nS_{x}(-f) = S_{x}(f)\n$$\n总方差 `$V$` 是 `$S_{x}(f)$` 在所有频率上的积分。我们可以将此积分分为负频率域和正频率域：\n$$\nV = \\int_{-\\infty}^{\\infty} S_{x}(f) \\, df = \\int_{-\\infty}^{0} S_{x}(f) \\, df + \\int_{0}^{\\infty} S_{x}(f) \\, df\n$$\n在第一个积分中，我们进行变量代换 `$u = -f$`，这意味着 `$du = -df$`。积分限从 `$(-\\infty, 0)$` 变为 `$(\\infty, 0)`。\n$$\n\\int_{-\\infty}^{0} S_{x}(f) \\, df = \\int_{\\infty}^{0} S_{x}(-u) \\, (-du) = \\int_{0}^{\\infty} S_{x}(-u) \\, du\n$$\n因为 `$S_{x}(f)$` 是偶函数，所以 `$S_{x}(-u) = S_{x}(u)$`。因此，负频率上的积分等于正频率上的积分。\n$$\n\\int_{-\\infty}^{0} S_{x}(f) \\, df = \\int_{0}^{\\infty} S_{x}(f) \\, df\n$$\n将此代回总方差的表达式中，得到：\n$$\nV = \\int_{0}^{\\infty} S_{x}(f) \\, df + \\int_{0}^{\\infty} S_{x}(f) \\, df = 2 \\int_{0}^{\\infty} S_{x}(f) \\, df\n$$\n这个结果，在连续积分中将点 `$f=0$` 视为零测度，表明正频率部分恰好包含总方差的一半。\n\n单边功率谱密度，我们称之为 `$S_{1s}(f)$`，仅为非负频率 (`$f \\ge 0$`) 定义，并被构造成使其在该域上的积分等于总方差 `$V$`。\n$$\nV = \\int_{0}^{\\infty} S_{1s}(f) \\, df\n$$\n通过令 `$V$` 的两个表达式相等，我们得到：\n$$\n\\int_{0}^{\\infty} S_{1s}(f) \\, df = 2 \\int_{0}^{\\infty} S_{x}(f) \\, df\n$$\n为了使这个等式成立，对于严格正频率 (`$f > 0$`)，被积函数之间的关系必须是：\n$$\nS_{1s}(f) = 2 S_{x}(f)\n$$\n这意味着，要从双边功率谱密度转换为单边功率谱密度同时保持总方差不变，严格正频率处的功率谱密度幅值必须乘以一个因子 `$2$`。问题将 `$c$` 定义为此缩放因子。因此：\n$$\nc = 2\n$$\n值得注意的是，对于通过 FFT 获得的离散谱，这个 `$2$` 的缩放因子适用于直流（`$f=0$`）和奈奎斯特频率 `$f_{\\mathrm{N}}$` 之间的频率箱。直流和奈奎斯特频率分量是唯一的（它们没有独特的负频率对应部分），因此不被这个因子缩放。问题明确要求的是“严格正频率箱”的因子，这明确地是 `$2$`。\n\n总结来说，确定的值为 `$c=2$`，`$a=2$`，和 `$b=1$`。", "answer": "$$\n\\boxed{\\begin{pmatrix} 2  2  1 \\end{pmatrix}}\n$$", "id": "3511736"}, {"introduction": "在拥有坚实的理论基础之后，是时候将我们的理解转化为一个可用的计算工具了。这个动手编码实践将指导您使用计算效率高的实数快速傅里叶变换（rFFT）来实现一个稳健的、方差守恒的PSD估计器[@problem_id:3511734]。您将处理标准FFT库输出的实际细节，包括对直流（DC）和奈奎斯特频率分量的特殊处理，从而构建一个其输出功率在积分后能正确匹配输入信号方差的函数。", "problem": "您的任务是使用实数快速傅里叶变换 (rFFT) 为一个均匀采样的实值光度时间序列实现一个方差守恒的单边功率谱密度估计器。设时间序列表示为 $x[n]$，其中 $n \\in \\{0,1,\\dots,N-1\\}$，采样间隔为常数 $\\Delta t  0$。您必须构建一个定义在非负离散傅里叶频率格点 $f_k$ 上的单边功率谱密度 (PSD) 估计 $\\widehat{S}(f_k)$，使得以下方差守恒条件在数值精度范围内成立：\n$$\n\\frac{1}{N} \\sum_{n=0}^{N-1} \\left(x[n] - \\overline{x}\\right)^2 \\approx \\sum_{k} \\widehat{S}(f_k)\\,\\Delta f,\n$$\n其中 $\\overline{x}$ 是 $x[n]$ 的样本均值，$\\Delta f = \\frac{1}{N \\Delta t}$ 是离散频率间隔。估计值 $\\widehat{S}(f_k)$ 必须使用实值快速傅里叶变换 (rFFT) 计算，其方式要能正确处理实数信号从双边谱到单边谱的映射，同时对于 $N$ 为偶数和奇数的情况都能保持总方差（即上述左侧项）不变。您必须从离散傅里叶变换的标准定义 $X[k] = \\sum_{n=0}^{N-1} x[n]\\,e^{-2\\pi i n k/N}$ 和离散 Parseval 关系 $\\sum_{n=0}^{N-1} |x[n]|^2 = \\frac{1}{N} \\sum_{k=0}^{N-1} |X[k]|^2$ 出发，推导出在 rFFT 返回的单边频率格点上表示的 $\\widehat{S}(f_k)$ 的缩放因子。您的实现必须在进行谱估计之前明确减去样本均值。三角函数中使用的角度必须以弧度为单位。\n\n您的程序必须在内部实现以下函数，并用它来评估下面的测试套件：\n- 基于 rFFT 的 PSD 估计器：给定输入数组 $x[n]$ 和采样间隔 $\\Delta t$，返回在单边频率格点上定义的数组 $(f_k, \\widehat{S}(f_k))$，使得上述方差守恒条件对任意实数输入 $x[n]$（包括存在和不存在奈奎斯特频率的情况）都成立。\n\n测试套件规范（使用指定的参数和为高斯分量声明的伪随机种子，确定性地生成每个合成时间序列）：\n- 所有信号均按 $x[n] = C + \\sum_j A_j \\cos\\!\\left(2\\pi f_j t_n + \\phi_j\\right) + \\eta[n]$ 生成，其中 $t_n = n \\Delta t$，$\\eta[n]$ 是一个零均值高斯过程，其标准差为 $\\sigma$，并根据以下情况应用固定的伪随机种子。除非另有说明，否则使用相位 $\\phi_j = 0$。最终的 PSD 计算必须在减去均值的序列 $x[n] - \\overline{x}$ 上执行。\n- 情况1（理想路径，偶数 $N$，频率仓中心的带噪声和偏移的正弦波）：$N = 4096$，$\\Delta t = 2.0$，一个频率为 $f_1 = \\frac{32}{N \\Delta t}$ 的正弦波，其振幅 $A_1 = 1.8$，高斯噪声标准差 $\\sigma = 0.7$，常数偏移 $C = 10.0$，伪随机种子 $123456$。\n- 情况2（奇数 $N$，多个非频率仓中心的正弦波，带噪声和偏移）：$N = 4095$，$\\Delta t = 1.0$，两个正弦波，参数分别为 $(A_1, f_1) = (0.9, 0.01)$ 和 $(A_2, f_2) = (0.5, 0.1234)$，高斯噪声标准差 $\\sigma = 0.3$，常数偏移 $C = 0.2$，伪随机种子 $789012$。\n- 情况3（偶数 $N$，纯奈奎斯特频率正弦波，无噪声）：$N = 2048$，$\\Delta t = 0.5$，一个频率为 $f_1 = \\frac{1}{2 \\Delta t}$ 的正弦波，其振幅 $A_1 = 2.0$，无高斯噪声 $\\sigma = 0$，且 $C = 0$。\n- 情况4（偶数 $N$，纯白噪声）：$N = 3000$，$\\Delta t = 1.0$，无正弦波，高斯噪声标准差 $\\sigma = 1.0$，$C = 0$，伪随机种子 $246810$。\n\n对于每种情况，计算相对方差误差\n$$\n\\epsilon = \\frac{\\left| \\frac{1}{N} \\sum_{n=0}^{N-1} \\left(x[n] - \\overline{x}\\right)^2 - \\sum_k \\widehat{S}(f_k)\\,\\Delta f \\right|}{\\frac{1}{N} \\sum_{n=0}^{N-1} \\left(x[n] - \\overline{x}\\right)^2},\n$$\n该误差是无量纲的。您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表，按情况1到4的顺序排列结果，即输出必须严格采用“[e1,e2,e3,e4]”的形式，其中 e1、e2、e3 和 e4 分别是四种情况下 $\\epsilon$ 的四个浮点数值。由于 $\\epsilon$ 是无量纲的，输出中不需要物理单位。结果将根据其在指定边缘情况（包括存在或不存在奈奎斯特频率以及 $N$ 的奇偶性）下的数值正确性和鲁棒性进行评估。", "solution": "用户问题是有效的，因为它科学上基于傅里叶分析的原理，问题适定，具有明确的目标和充足的数据，且语言客观。它提出了一个信号处理领域中与计算天体物理学相关的标准的、非平凡的问题，要求推导并实现一个方差守恒的功率谱密度估计器。\n\n核心任务是为在 $n \\in \\{0, 1, \\dots, N-1\\}$ 上以恒定采样间隔 $\\Delta t  0$ 采样的实值时间序列 $x[n]$ 推导其单边功率谱密度 (PSD) 估计 $\\widehat{S}(f_k)$ 的归一化方法。此归一化必须满足方差守恒条件：\n$$\n\\frac{1}{N} \\sum_{n=0}^{N-1} \\left(x[n] - \\overline{x}\\right)^2 \\approx \\sum_{k} \\widehat{S}(f_k)\\,\\Delta f\n$$\n其中 $\\overline{x}$ 是时间序列的样本均值，$\\Delta f = 1/(N \\Delta t)$ 是离散频率分辨率，对 $k$ 的求和遍历了单边谱的非负频率。\n\n我们的推导从减去均值的信号 $y[n] = x[n] - \\overline{x}$ 开始。守恒方程的左侧是 $x[n]$ 的样本方差，它等价于 $y[n]$ 的均方值：\n$$\n\\text{Var}(x) = \\frac{1}{N} \\sum_{n=0}^{N-1} y[n]^2 = \\frac{1}{N} \\sum_{n=0}^{N-1} |y[n]|^2\n$$\n问题将信号 $y[n]$ 的离散傅里叶变换 (DFT) 定义为 $Y[k] = \\sum_{n=0}^{N-1} y[n] e^{-2\\pi i n k / N}$，并提供了离散 Parseval 定理：\n$$\n\\sum_{n=0}^{N-1} |y[n]|^2 = \\frac{1}{N} \\sum_{k=0}^{N-1} |Y[k]|^2\n$$\n将 Parseval 定理代入方差的表达式，我们将时域方差与双边周期图 $|Y[k]|^2$ 联系起来：\n$$\n\\text{Var}(x) = \\frac{1}{N} \\left( \\frac{1}{N} \\sum_{k=0}^{N-1} |Y[k]|^2 \\right) = \\frac{1}{N^2} \\sum_{k=0}^{N-1} |Y[k]|^2\n$$\n这个求和遍历了整个双边谱，频率指数为 $k \\in \\{0, 1, \\dots, N-1\\}$。对于一个实值信号 $y[n]$，其 DFT $Y[k]$ 具有厄米共轭对称性，$Y[k] = Y^*[N-k]$，这意味着 $|Y[k]|^2 = |Y[N-k]|^2$。这个性质允许我们将双边谱“折叠”成单边谱。$k=0$ (直流频率) 的分量以及当 $N$ 为偶数时的 $k=N/2$ (奈奎斯特频率) 的分量是纯实数，没有独立的共轭对。\n\n我们可以通过只考虑来自非负频率的贡献来重写双边谱上的求和：\n- 如果 $N$ 是偶数，单边频率指数为 $k \\in \\{0, 1, \\dots, N/2\\}$。求和变为：\n$$\n\\sum_{k=0}^{N-1} |Y[k]|^2 = |Y[0]|^2 + 2\\sum_{k=1}^{N/2-1} |Y[k]|^2 + |Y[N/2]|^2\n$$\n- 如果 $N$ 是奇数，令 $M=(N-1)/2$。单边指数为 $k \\in \\{0, 1, \\dots, M\\}$。求和变为：\n$$\n\\sum_{k=0}^{N-1} |Y[k]|^2 = |Y[0]|^2 + 2\\sum_{k=1}^{M} |Y[k]|^2\n$$\n请注意，由于我们使用的是减去均值的信号 $y[n]$，其直流分量 $Y[0] = \\sum_{n=0}^{N-1} y[n]$根据定义为零，因此 $|Y[0]|^2 = 0$。\n\n单边 PSD $\\widehat{S}(f_k)$ 必须被定义为使得 $\\text{Var}(x) = \\sum_{k} \\widehat{S}(f_k) \\Delta f$。使用我们之前的结果，这意味着：\n$$\n\\sum_{k} \\widehat{S}(f_k) \\Delta f = \\frac{1}{N^2} \\sum_{k=0}^{N-1} |Y[k]|^2 \\implies \\sum_{k} \\widehat{S}(f_k) = \\frac{\\Delta t}{N} \\sum_{k=0}^{N-1} |Y[k]|^2\n$$\n通过将各项与折叠后的和进行匹配，我们得到了单边 PSD 的定义。设 $Y_r[k]$ 是由实数 FFT 算法返回的非负频率的 DFT 系数。\n$$\n\\widehat{S}(f_k) =\n\\begin{cases}\n    \\frac{\\Delta t}{N} |Y_r[k]|^2  \\text{对于 } k=0 \\text{ (直流) 以及当 } N \\text{ 为偶数时的 } k=N/2 \\text{ (奈奎斯特)} \\\\\n    2 \\frac{\\Delta t}{N} |Y_r[k]|^2  \\text{对于所有其他非负频率指数 } k\n\\end{cases}\n$$\n因子 $2$ 是为了补偿从谱的负频率侧折叠进来的功率。直流频率和奈奎斯特频率没有不同的负频率对应项，因此不进行加倍。这个定义确保了 PSD 在单边频域上的积分 $\\sum_k \\widehat{S}(f_k) \\Delta f$ 能够正确地恢复原始信号的总方差。\n\n算法流程如下：\n1. 给定时间序列 $x[n]$ 和采样间隔 $\\Delta t$，计算均值 $\\overline{x}$ 并形成减去均值的序列 $y[n] = x[n] - \\overline{x}$。\n2. 使用实数快速傅里叶变换 (rFFT) 算法计算 $y[n]$ 的单边 DFT $Y_r[k]$。\n3. 计算与 rFFT 输出相对应的单边频率格点 $f_k = k/(N \\Delta t)$。\n4. 计算原始功率值 $|Y_r[k]|^2$。\n5. 缩放这些功率值以获得最终的 PSD $\\widehat{S}(f_k)$：\n   a. 对所有功率值应用一个基本缩放因子 $\\Delta t/N$。\n   b. 对除了第一个值（直流，$k=0$）以及当 $N$ 为偶数时的最后一个值（奈奎斯特，$k=N/2$）之外的所有值，再乘以因子 $2$。\n得到的数组 $f_k$ 和 $\\widehat{S}(f_k)$ 构成了所需的方差守恒的单边 PSD 估计。", "answer": "```python\nimport numpy as np\n\ndef generate_signal(N, dt, C, sinusoids, sigma, seed):\n    \"\"\"\n    Generates a synthetic time series based on the problem specification.\n\n    Args:\n        N (int): Number of samples.\n        dt (float): Sampling interval.\n        C (float): Constant offset (DC component).\n        sinusoids (list): List of tuples (Amplitude, frequency, phase) for sinusoids.\n        sigma (float): Standard deviation of Gaussian noise.\n        seed (int or None): Seed for the pseudo-random number generator.\n\n    Returns:\n        np.ndarray: The generated time series x[n].\n    \"\"\"\n    if seed is not None:\n        rng = np.random.default_rng(seed)\n    \n    t = np.arange(N, dtype=np.float64) * dt\n    x = np.full(N, C, dtype=np.float64)\n    \n    for A, f, phi in sinusoids:\n        x += A * np.cos(2 * np.pi * f * t + phi)\n    \n    if sigma > 0:\n        noise = rng.normal(loc=0.0, scale=sigma, size=N)\n        x += noise\n        \n    return x\n\ndef compute_variance_conserving_psd(x, dt):\n    \"\"\"\n    Implements the rFFT-based variance-conserving one-sided PSD estimator.\n\n    Args:\n        x (np.ndarray): The input real-valued time series.\n        dt (float): The sampling interval.\n        \n    Returns:\n        tuple[np.ndarray, np.ndarray]: A tuple containing the frequency grid (f_k)\n        and the PSD estimate (S_hat_k).\n    \"\"\"\n    N = len(x)\n    # 1. Mean-subtract the signal as required by the variance conservation condition.\n    y = x - np.mean(x)\n    \n    # 2. Compute the one-sided DFT using the real FFT.\n    Y_r = np.fft.rfft(y)\n    \n    # 3. Compute the corresponding one-sided frequency grid.\n    f_k = np.fft.rfftfreq(N, d=dt)\n    \n    # 4. Calculate the raw power values from the DFT coefficients.\n    P_Y_r = np.abs(Y_r)**2\n    \n    # 5. Apply the derived scaling to get the one-sided PSD.\n    # The base scaling factor is dt/N.\n    S_hat_k = P_Y_r * (dt / N)\n    \n    # Apply a factor of 2 to account for folding power from negative frequencies,\n    # except for the DC (k=0) and Nyquist (k=N/2, if N is even) components.\n    if N % 2 == 0:\n        # For even N, rfft output is for k = 0, 1, ..., N/2.\n        # Frequencies at indices 1 to N/2 - 1 (exclusive of Nyquist) are doubled.\n        S_hat_k[1:-1] *= 2.0\n    else:\n        # For odd N, rfft output is for k = 0, 1, ..., (N-1)/2.\n        # There is no Nyquist frequency, so all non-DC frequencies are doubled.\n        S_hat_k[1:] *= 2.0\n        \n    return f_k, S_hat_k\n\ndef solve():\n    \"\"\"\n    Main solver function that defines the test suite, executes the PSD estimation\n    for each case, computes the relative variance error, and prints the result.\n    \"\"\"\n    test_cases = [\n        # Case 1: Even N, bin-centered sinusoid, noise, offset\n        {\n            \"N\": 4096, \"dt\": 2.0, \"C\": 10.0,\n            \"sinusoids\": [(1.8, 32.0 / (4096 * 2.0), 0.0)],\n            \"sigma\": 0.7, \"seed\": 123456\n        },\n        # Case 2: Odd N, multiple non-bin-centered sinusoids, noise, offset\n        {\n            \"N\": 4095, \"dt\": 1.0, \"C\": 0.2,\n            \"sinusoids\": [(0.9, 0.01, 0.0), (0.5, 0.1234, 0.0)],\n            \"sigma\": 0.3, \"seed\": 789012\n        },\n        # Case 3: Even N, pure Nyquist sinusoid, no noise\n        {\n            \"N\": 2048, \"dt\": 0.5, \"C\": 0.0,\n            \"sinusoids\": [(2.0, 1.0 / (2 * 0.5), 0.0)],\n            \"sigma\": 0.0, \"seed\": None\n        },\n        # Case 4: Even N, pure white noise\n        {\n            \"N\": 3000, \"dt\": 1.0, \"C\": 0.0,\n            \"sinusoids\": [],\n            \"sigma\": 1.0, \"seed\": 246810\n        },\n    ]\n\n    results = []\n    for params in test_cases:\n        # Generate the signal for the current test case\n        x = generate_signal(\n            N=params[\"N\"], dt=params[\"dt\"], C=params[\"C\"],\n            sinusoids=params[\"sinusoids\"], sigma=params[\"sigma\"], seed=params[\"seed\"]\n        )\n        \n        # Calculate time-series variance. np.var uses a divisor of N by default,\n        # which matches the problem's definition of variance.\n        variance_ts = np.var(x)\n        \n        # Compute the PSD and the corresponding frequency grid\n        f_k, S_hat_k = compute_variance_conserving_psd(x, params[\"dt\"])\n        \n        # Calculate the integrated power from the PSD\n        # df is the frequency spacing, which is constant.\n        if len(f_k) > 1:\n            df = f_k[1] - f_k[0]\n        else: # Handles edge case of N=1\n             df = 1.0 / (params[\"N\"] * params[\"dt\"]) if params[\"N\"] > 0 else 0.0\n\n        variance_psd = np.sum(S_hat_k) * df\n        \n        # Calculate the relative variance error, epsilon\n        if variance_ts == 0.0:\n            # If signal variance is zero, PSD integral must also be zero for zero error.\n            epsilon = 0.0 if np.isclose(variance_psd, 0.0) else np.inf\n        else:\n            epsilon = np.abs(variance_ts - variance_psd) / variance_ts\n            \n        results.append(epsilon)\n\n    # Print results in the exact required format\n    print(f\"[{','.join(f'{e:.15e}' for e in results)}]\")\n\nsolve()\n```", "id": "3511734"}]}