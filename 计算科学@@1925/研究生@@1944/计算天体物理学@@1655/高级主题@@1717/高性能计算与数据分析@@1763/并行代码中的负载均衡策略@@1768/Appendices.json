{"hands_on_practices": [{"introduction": "在优化并行代码的性能时，第一步是准确地量化负载不平衡及其对效率的影响。本练习提供了一个并行流体动力学求解器的具体场景，要求您计算关键的性能指标。通过这个实践，您将学会如何运用标准定义来评估不均匀的工作负载和通信开销如何共同决定最终的加速比和效率，这对于诊断性能瓶颈至关重要 [@problem_id:3516510]。", "problem": "一个均匀笛卡尔网格的流体力学求解器通过域分解在 $P=8$ 个处理器上推进一个显式Godunov时间步。每个处理器的本地更新计数（此时间步内执行的单元更新数）为\n$$\nw_1=1200,\\quad w_2=1150,\\quad w_3=1230,\\quad w_4=1070,\\quad w_5=1180,\\quad w_6=940,\\quad w_7=1110,\\quad w_8=1260.\n$$\n每次单元更新的时间为 $\\tau=1.0\\times 10^{-6}\\ \\mathrm{s}$。在时间步内，每个处理器执行两次最近邻的幽灵单元交换。对于处理器 $i$，每个幽灵单元交换消息包含 $m_i$ 千个标量，其中\n$$\nm_1=80,\\quad m_2=75,\\quad m_3=78,\\quad m_4=70,\\quad m_5=76,\\quad m_6=60,\\quad m_7=74,\\quad m_8=82.\n$$\n假设点对点消息时间模型为 $t_{\\mathrm{msg}}=\\alpha+\\beta n$，其中 $n$ 是消息中的标量数量，$\\alpha=1.2\\times 10^{-4}\\ \\mathrm{s}$，以及 $\\beta=2.5\\times 10^{-8}\\ \\mathrm{s}$ 每标量。时间步以一次二叉树全局归约结束，以计算Courant–Friedrichs–Lewy (CFL) 数，产生一个包含 $3$ 个阶段的屏障时间，每个阶段的成本为 $\\gamma=1.6\\times 10^{-4}\\ \\mathrm{s}$。假设计算与通信之间没有重叠，没有隐藏延迟，并且输入/输出和主机开销可忽略不计。\n\n使用并行性能分析的标准定义，完成以下任务：\n- 计算平均工作负载 $\\bar{w}$、标准差 $\\sigma$、变异系数 $CV=\\sigma/\\bar{w}$ 和不平衡因子 $I=w_{\\max}/\\bar{w}$。\n- 在上述假设下，预测该时间步的串行时间 $T_1$ 和并行时间 $T_P$。\n- 计算效率 $E$ 和加速比 $S$。\n\n将加速比 $S$ 四舍五入到四位有效数字。将您的最终答案表示为无单位的加速比。", "solution": "该问题是科学有效的，它基于并行计算性能分析的原理，问题设定良好，数据充分且一致，并以客观、正式的语言表述。因此，我们可以着手求解。\n\n该问题要求计算一个在 $P=8$ 个处理器上执行的并行流体力学求解器的几个性能指标。我们将系统地计算这些指标。\n\n首先，我们分析工作负载分布。每个处理器的本地更新计数（工作负载）如下：\n$w_1=1200$, $w_2=1150$, $w_3=1230$, $w_4=1070$, $w_5=1180$, $w_6=940$, $w_7=1110$, $w_8=1260$。\n\n总工作负载 $W$ 是各个处理器工作负载的总和：\n$$\nW = \\sum_{i=1}^{P} w_i = 1200 + 1150 + 1230 + 1070 + 1180 + 940 + 1110 + 1260 = 9140 \\text{ 单元更新}\n$$\n平均工作负载 $\\bar{w}$ 是：\n$$\n\\bar{w} = \\frac{W}{P} = \\frac{9140}{8} = 1142.5 \\text{ 单元更新}\n$$\n工作负载的总体标准差 $\\sigma$ 计算如下：\n$$\n\\sigma = \\sqrt{\\frac{1}{P} \\sum_{i=1}^{P} (w_i - \\bar{w})^2} = \\sqrt{\\frac{1}{8} \\left[ (57.5)^2 + (7.5)^2 + (87.5)^2 + (-72.5)^2 + (37.5)^2 + (-202.5)^2 + (-32.5)^2 + (117.5)^2 \\right]}\n$$\n$$\n\\sigma = \\sqrt{\\frac{73550}{8}} = \\sqrt{9193.75} \\approx 95.884\n$$\n变异系数 $CV$，用于衡量相对负载不平衡，为：\n$$\nCV = \\frac{\\sigma}{\\bar{w}} = \\frac{95.884}{1142.5} \\approx 0.08392\n$$\n最大工作负载为 $w_{\\max} = \\max_i(w_i) = 1260$。不平衡因子 $I$ 为：\n$$\nI = \\frac{w_{\\max}}{\\bar{w}} = \\frac{1260}{1142.5} \\approx 1.1028\n$$\n接下来，我们计算串行和并行执行时间。每次单元更新的时间为 $\\tau = 1.0 \\times 10^{-6}\\ \\mathrm{s}$。\n\n串行时间 $T_1$ 是在单个处理器上完成总工作负载所需的时间，没有通信开销：\n$$\nT_1 = W \\times \\tau = 9140 \\times (1.0 \\times 10^{-6}\\ \\mathrm{s}) = 9.14 \\times 10^{-3}\\ \\mathrm{s}\n$$\n并行时间 $T_P$ 由块同步模型（计算和通信之间没有重叠）中最慢的处理器决定。它是最大计算时间 $T_{\\text{comp}}$ 和总通信时间 $T_{\\text{comm}}$ 的和。\n$$\nT_P = T_{\\text{comp}} + T_{\\text{comm}}\n$$\n计算时间受具有最大工作负载 $w_{\\max}$ 的处理器限制：\n$$\nT_{\\text{comp}} = w_{\\max} \\times \\tau = 1260 \\times (1.0 \\times 10^{-6}\\ \\mathrm{s}) = 1.26 \\times 10^{-3}\\ \\mathrm{s}\n$$\n通信时间包括两个部分：幽灵单元交换时间 $T_{\\text{ghost}}$ 和全局归约时间 $T_{\\text{redux}}$。\n$$\nT_{\\text{comm}} = T_{\\text{ghost}} + T_{\\text{redux}}\n$$\n对于 $n$ 个标量的点对点消息，其时间为 $t_{\\mathrm{msg}} = \\alpha + \\beta n$，其中延迟 $\\alpha=1.2\\times 10^{-4}\\ \\mathrm{s}$，逆带宽 $\\beta=2.5\\times 10^{-8}\\ \\mathrm{s}/\\text{scalar}$。每个处理器执行两次幽灵单元交换。此阶段的时间由具有最大消息大小的处理器决定。消息大小以千个标量为单位，由 $m_i$ 给出。最大大小为 $m_{\\max} = 82$，对应于 $n_{\\max} = 82000$ 个标量。幽灵单元交换阶段的成本为：\n$$\nT_{\\text{ghost}} = 2 \\times (\\alpha + \\beta n_{\\max}) = 2 \\times \\left(1.2 \\times 10^{-4}\\ \\mathrm{s} + (2.5 \\times 10^{-8}\\ \\mathrm{s}/\\text{scalar}) \\times 82000\\ \\text{scalars}\\right)\n$$\n$$\nT_{\\text{ghost}} = 2 \\times (1.2 \\times 10^{-4}\\ \\mathrm{s} + 2.05 \\times 10^{-3}\\ \\mathrm{s}) = 2 \\times (2.17 \\times 10^{-3}\\ \\mathrm{s}) = 4.34 \\times 10^{-3}\\ \\mathrm{s}\n$$\n全局归约产生一个包含 $3$ 个阶段的屏障时间，每个阶段的成本为 $\\gamma = 1.6 \\times 10^{-4}\\ \\mathrm{s}$。\n$$\nT_{\\text{redux}} = 3 \\times \\gamma = 3 \\times (1.6 \\times 10^{-4}\\ \\mathrm{s}) = 4.8 \\times 10^{-4}\\ \\mathrm{s} = 0.48 \\times 10^{-3}\\ \\mathrm{s}\n$$\n总通信时间为：\n$$\nT_{\\text{comm}} = 4.34 \\times 10^{-3}\\ \\mathrm{s} + 0.48 \\times 10^{-3}\\ \\mathrm{s} = 4.82 \\times 10^{-3}\\ \\mathrm{s}\n$$\n该时间步的总并行时间为：\n$$\nT_P = T_{\\text{comp}} + T_{\\text{comm}} = 1.26 \\times 10^{-3}\\ \\mathrm{s} + 4.82 \\times 10^{-3}\\ \\mathrm{s} = 6.08 \\times 10^{-3}\\ \\mathrm{s}\n$$\n最后，我们计算加速比 $S$ 和效率 $E$。\n加速比是串行时间与并行时间之比：\n$$\nS = \\frac{T_1}{T_P} = \\frac{9.14 \\times 10^{-3}\\ \\mathrm{s}}{6.08 \\times 10^{-3}\\ \\mathrm{s}} = \\frac{9.14}{6.08} \\approx 1.503289...\n$$\n效率是每个处理器的加速比：\n$$\nE = \\frac{S}{P} = \\frac{1.503289...}{8} \\approx 0.1879\n$$\n问题要求将加速比 $S$ 四舍五入到四位有效数字。\n$$\nS \\approx 1.503\n$$", "answer": "$$\n\\boxed{1.503}\n$$", "id": "3516510"}, {"introduction": "有效的负载均衡策略始于对计算任务内在并行结构的深刻理解。本练习引导您将一个复杂的天体物理时间步，建模为一个有向无环图 (DAG)。您将应用工作-跨度 (work-span) 模型来计算总工作量 ($T_1$) 和关键路径长度 ($T_\\infty$)，它们共同定义了并行执行的理论性能边界。这种分析能够揭示算法固有的并行潜力和根本瓶颈，从而指导我们应该在何处集中精力进行负载均衡优化 [@problem_id:3516579]。", "problem": "考虑一个均匀笛卡尔网格天体物理求解器的单个显式时间步，该求解器结合了通过快速傅里叶变换 (FFT) 计算的自引力、可压缩流体动力学和辐射传输，并在一个沿 $x$ 方向分解为 $P=4$ 个子域的一维域分解上执行。并行执行过程被建模为一个加权有向无环图 (DAG)，其中节点表示带有执行时间的任务，边表示依赖关系；work-span 模型将总功 $T_1$ 定义为所有节点时间之和，将关键路径长度 $T_{\\infty}$ 定义为从 DAG 开始到结束的时间上最长路径的长度。所有任务都假定为不可抢占的，并且边的延迟可以忽略不计。时间步的各个阶段及其任务结构如下。\n\n引力阶段：一个全局三维基于 FFT 的泊松求解过程被抽象为三个串行任务：持续时间为 $t_{\\mathcal{F}}=24\\,\\mathrm{ms}$ 的正向变换 $\\mathcal{F}$，与格林函数 $\\mathcal{K}$ 的卷积（持续时间 $t_{\\mathcal{K}}=3\\,\\mathrm{ms}$），以及持续时间为 $t_{\\mathcal{F}^{-1}}=25\\,\\mathrm{ms}$ 的逆变换 $\\mathcal{F}^{-1}$。这些任务严格按 $\\mathcal{F} \\rightarrow \\mathcal{K} \\rightarrow \\mathcal{F}^{-1}$ 的顺序执行。\n\n流体动力学阶段：对于每个子域 $i \\in \\{1,2,3,4\\}$，流体动力学在引力阶段完成后开始。在子域 $i$ 内有三个任务：一对边界交换 $\\mathrm{H\\_exL}(i)$ 和 $\\mathrm{H\\_exR}(i)$，每个持续 $1\\,\\mathrm{ms}$，按顺序执行以表示网络接口的串行使用：$\\mathrm{H\\_exL}(i) \\rightarrow \\mathrm{H\\_exR}(i)$；一个持续 $6\\,\\mathrm{ms}$ 的内部更新 $\\mathrm{H\\_int}(i)$，它仅依赖于引力阶段且独立于交换；以及一个持续 $2\\,\\mathrm{ms}$ 的边界更新 $\\mathrm{H\\_bnd}(i)$，它依赖于 $\\mathrm{H\\_exR}(i)$ 的完成。在所有子域完成内部和边界更新之前，辐射传输无法开始；使用一个零时间屏障节点 $\\mathrm{H\\_bar}$ 来对此进行建模，该节点具有来自所有 $i$ 的 $\\mathrm{H\\_int}(i)$ 和 $\\mathrm{H\\_bnd}(i)$ 的入边。\n\n辐射传输阶段：有 $G=3$ 个角群，由 $g \\in \\{1,2,3\\}$ 索引，每个角群都执行一次跨越子域的从左到右的扫描。对于每个角群 $g$ 和子域索引 $j \\in \\{1,2,3,4\\}$，有一个持续时间为 $3\\,\\mathrm{ms}$ 的局部更新 $\\mathrm{R\\_upd}(g,j)$，然后是持续时间为 $1\\,\\mathrm{ms}$ 的发送出射通量 $\\mathrm{R\\_comm}(g,j)$。扫描流水线是：$\\mathrm{R\\_upd}(g,1)$ 依赖于 $\\mathrm{H\\_bar}$，$\\mathrm{R\\_comm}(g,1)$ 依赖于 $\\mathrm{R\\_upd}(g,1)$，然后对于 $j>1$，更新依赖于前一个子域的通信：$\\mathrm{R\\_upd}(g,j)$ 依赖于 $\\mathrm{R\\_comm}(g,j-1)$，并且 $\\mathrm{R\\_comm}(g,j)$ 依赖于 $\\mathrm{R\\_upd}(g,j)$。这三个角群是独立的，一旦到达 $\\mathrm{H\\_bar}$ 就可以并发执行。\n\n请根据以上描述，用节点和边来定义所隐含的 DAG，并计算整个时间步的关键路径长度 $T_{\\infty}$ 和总功 $T_1$。将 $T_{\\infty}$ 和 $T_1$ 都以毫秒为单位表示。无需四舍五入，请给出精确值。", "solution": "该问题是科学有效的，它在计算物理性能建模的背景下具有科学依据，其定义和约束条件完整且一致，问题阐述清晰，没有歧义或主观声明。因此，我们可以进行正式求解。\n\n目标是为代表并行时间步的给定有向无环图 (DAG) 计算两个指标：总功 $T_1$ 和关键路径长度 $T_{\\infty}$。所有值都将以毫秒 ($\\mathrm{ms}$) 表示。\n\n首先，我们计算总功 $T_1$，即 DAG 中所有任务执行时间的总和。我们可以通过将三个阶段的功相加来计算。\n\n1.  引力阶段的功 ($W_{\\text{gravity}}$)：\n    此阶段包含三个顺序任务。总功是它们持续时间的总和。\n    $W_{\\text{gravity}} = t_{\\mathcal{F}} + t_{\\mathcal{K}} + t_{\\mathcal{F}^{-1}} = 24\\,\\mathrm{ms} + 3\\,\\mathrm{ms} + 25\\,\\mathrm{ms} = 52\\,\\mathrm{ms}$。\n\n2.  流体动力学阶段的功 ($W_{\\text{hydro}}$)：\n    此阶段涉及在 $P=4$ 个子域中的每一个上执行的任务。对于每个子域 $i$，任务为 $\\mathrm{H\\_exL}(i)$、$\\mathrm{H\\_exR}(i)$、$\\mathrm{H\\_int}(i)$ 和 $\\mathrm{H\\_bnd}(i)$。屏障任务 $\\mathrm{H\\_bar}$ 的持续时间为 $0\\,\\mathrm{ms}$，对总功没有贡献。\n    每个子域的功是其任务持续时间的总和：\n    $W_{\\text{hydro, } i} = t_{\\mathrm{H\\_exL}} + t_{\\mathrm{H\\_exR}} + t_{\\mathrm{H\\_int}} + t_{\\mathrm{H\\_bnd}} = 1\\,\\mathrm{ms} + 1\\,\\mathrm{ms} + 6\\,\\mathrm{ms} + 2\\,\\mathrm{ms} = 10\\,\\mathrm{ms}$。\n    由于有 $P=4$ 个子域，流体动力学阶段的总功为：\n    $W_{\\text{hydro}} = P \\times W_{\\text{hydro, } i} = 4 \\times 10\\,\\mathrm{ms} = 40\\,\\mathrm{ms}$。\n\n3.  辐射传输阶段的功 ($W_{\\text{rad}}$)：\n    此阶段包括 $G=3$ 个角群在 $P=4$ 个子域上执行的任务。对于每个角群 $g$ 和子域 $j$，有一个局部更新任务 $\\mathrm{R\\_upd}(g,j)$ 和一个通信任务 $\\mathrm{R\\_comm}(g,j)$。\n    每个角群在每个子域上的功为：\n    $W_{\\text{rad, } g,j} = t_{\\mathrm{R\\_upd}} + t_{\\mathrm{R\\_comm}} = 3\\,\\mathrm{ms} + 1\\,\\mathrm{ms} = 4\\,\\mathrm{ms}$。\n    辐射阶段的总功是所有角群和子域的功之和：\n    $W_{\\text{rad}} = G \\times P \\times W_{\\text{rad, } g,j} = 3 \\times 4 \\times 4\\,\\mathrm{ms} = 48\\,\\mathrm{ms}$。\n\n整个时间步的总功 $T_1$ 是所有阶段功的总和：\n$T_1 = W_{\\text{gravity}} + W_{\\text{hydro}} + W_{\\text{rad}} = 52\\,\\mathrm{ms} + 40\\,\\mathrm{ms} + 48\\,\\mathrm{ms} = 140\\,\\mathrm{ms}$。\n\n接下来，我们计算关键路径长度 $T_{\\infty}$，即从 DAG 开始到结束的最长依赖任务路径的持续时间。设 $L(\\text{task})$ 表示任务的完成时间。整个过程的开始时间是 $t=0$。\n\n1.  引力阶段路径：\n    这些任务是严格串行的。\n    $L(\\mathcal{F}) = t_{\\mathcal{F}} = 24\\,\\mathrm{ms}$。\n    $L(\\mathcal{K}) = L(\\mathcal{F}) + t_{\\mathcal{K}} = 24\\,\\mathrm{ms} + 3\\,\\mathrm{ms} = 27\\,\\mathrm{ms}$。\n    $L(\\mathcal{F}^{-1}) = L(\\mathcal{K}) + t_{\\mathcal{F}^{-1}} = 27\\,\\mathrm{ms} + 25\\,\\mathrm{ms} = 52\\,\\mathrm{ms}$。\n    引力阶段在 $T_{\\text{gravity}} = 52\\,\\mathrm{ms}$ 时完成。\n\n2.  流体动力学阶段路径：\n    此阶段在引力阶段完成后开始，因此所有任务的开始时间不早于 $T_{\\text{gravity}}$。对于每个子域 $i$，在引力阶段之后有两个独立的执行分支。\n    -   分支 A (内部)：任务 $\\mathrm{H\\_int}(i)$ 仅依赖于引力阶段。其完成时间为：\n        $L(\\mathrm{H\\_int}(i)) = T_{\\text{gravity}} + t_{\\mathrm{H\\_int}} = 52\\,\\mathrm{ms} + 6\\,\\mathrm{ms} = 58\\,\\mathrm{ms}$。\n    -   分支 B (边界)：任务序列 $\\mathrm{H\\_exL}(i) \\rightarrow \\mathrm{H\\_exR}(i) \\rightarrow \\mathrm{H\\_bnd}(i)$。此链中最后一个任务的完成时间为：\n        $L(\\mathrm{H\\_bnd}(i)) = T_{\\text{gravity}} + t_{\\mathrm{H\\_exL}} + t_{\\mathrm{H\\_exR}} + t_{\\mathrm{H\\_bnd}} = 52\\,\\mathrm{ms} + 1\\,\\mathrm{ms} + 1\\,\\mathrm{ms} + 2\\,\\mathrm{ms} = 56\\,\\mathrm{ms}$。\n\n    同步屏障 $\\mathrm{H\\_bar}$ 只有在其所有依赖项，即所有 $i \\in \\{1,2,3,4\\}$ 的 $\\mathrm{H\\_int}(i)$ 和 $\\mathrm{H\\_bnd}(i)$ 都完成后才能通过。由于所有子域并行操作且相同，到达屏障的时间是单个子域完成时间的最大值。\n    $T_{\\text{hydro}} = L(\\mathrm{H\\_bar}) = \\max(L(\\mathrm{H\\_int}(i)), L(\\mathrm{H\\_bnd}(i))) = \\max(58\\,\\mathrm{ms}, 56\\,\\mathrm{ms}) = 58\\,\\mathrm{ms}$。\n    流体动力学阶段的关键路径由内部更新任务 $\\mathrm{H\\_int}$ 决定。\n\n3.  辐射传输阶段路径：\n    此阶段在 $T_{\\text{hydro}} = 58\\,\\mathrm{ms}$ 时流体动力学屏障清除后开始。有 $G=3$ 个独立的角群并发执行。由于它们是相同的，总的关键路径将是单个角群的路径。我们分析一个角群 $g$ 在 $P=4$ 个子域上从左到右的扫描。\n    -   子域 $j=1$：\n        $L(\\mathrm{R\\_upd}(g,1)) = T_{\\text{hydro}} + t_{\\mathrm{R\\_upd}} = 58\\,\\mathrm{ms} + 3\\,\\mathrm{ms} = 61\\,\\mathrm{ms}$。\n        $L(\\mathrm{R\\_comm}(g,1)) = L(\\mathrm{R\\_upd}(g,1)) + t_{\\mathrm{R\\_comm}} = 61\\,\\mathrm{ms} + 1\\,\\mathrm{ms} = 62\\,\\mathrm{ms}$。\n    -   子域 $j=2$：更新依赖于前一个子域的通信。\n        $L(\\mathrm{R\\_upd}(g,2)) = L(\\mathrm{R\\_comm}(g,1)) + t_{\\mathrm{R\\_upd}} = 62\\,\\mathrm{ms} + 3\\,\\mathrm{ms} = 65\\,\\mathrm{ms}$。\n        $L(\\mathrm{R\\_comm}(g,2)) = L(\\mathrm{R\\_upd}(g,2)) + t_{\\mathrm{R\\_comm}} = 65\\,\\mathrm{ms} + 1\\,\\mathrm{ms} = 66\\,\\mathrm{ms}$。\n    -   子域 $j=3$：\n        $L(\\mathrm{R\\_upd}(g,3)) = L(\\mathrm{R\\_comm}(g,2)) + t_{\\mathrm{R\\_upd}} = 66\\,\\mathrm{ms} + 3\\,\\mathrm{ms} = 69\\,\\mathrm{ms}$。\n        $L(\\mathrm{R\\_comm}(g,3)) = L(\\mathrm{R\\_upd}(g,3)) + t_{\\mathrm{R\\_comm}} = 69\\,\\mathrm{ms} + 1\\,\\mathrm{ms} = 70\\,\\mathrm{ms}$。\n    -   子域 $j=4$：\n        $L(\\mathrm{R\\_upd}(g,4)) = L(\\mathrm{R\\_comm}(g,3)) + t_{\\mathrm{R\\_upd}} = 70\\,\\mathrm{ms} + 3\\,\\mathrm{ms} = 73\\,\\mathrm{ms}$。\n        $L(\\mathrm{R\\_comm}(g,4)) = L(\\mathrm{R\\_upd}(g,4)) + t_{\\mathrm{R\\_comm}} = 73\\,\\mathrm{ms} + 1\\,\\mathrm{ms} = 74\\,\\mathrm{ms}$。\n\n关键路径长度 $T_{\\infty}$ 是 DAG 中最后一个任务的完成时间。由于所有辐射角群同时在 $74\\,\\mathrm{ms}$ 完成，这就是最终时间。\n$T_{\\infty} = L(\\mathrm{R\\_comm}(g,4)) = 74\\,\\mathrm{ms}$。\n\n关键路径由以下序列组成：\n$\\mathcal{F} \\rightarrow \\mathcal{K} \\rightarrow \\mathcal{F}^{-1} \\rightarrow \\mathrm{H\\_int}(i) \\rightarrow \\mathrm{H\\_bar} \\rightarrow \\mathrm{R\\_upd}(g,1) \\rightarrow \\mathrm{R\\_comm}(g,1) \\rightarrow \\mathrm{R\\_upd}(g,2) \\rightarrow \\mathrm{R\\_comm}(g,2) \\rightarrow \\mathrm{R\\_upd}(g,3) \\rightarrow \\mathrm{R\\_comm}(g,3) \\rightarrow \\mathrm{R\\_upd}(g,4) \\rightarrow \\mathrm{R\\_comm}(g,4)$。\n总长度为：\n$T_{\\infty} = (24+3+25) + 6 + 4 \\times (3+1) = 52 + 6 + 16 = 74\\,\\mathrm{ms}$。\n计算出的值为 $T_1 = 140\\,\\mathrm{ms}$ 和 $T_{\\infty} = 74\\,\\mathrm{ms}$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n74  140\n\\end{pmatrix}\n}\n$$", "id": "3516579"}, {"introduction": "在许多天体物理模拟中，例如宇宙学 $N$ 体模拟，计算负载是动态演化的，这要求负载均衡成为一个持续的过程。本练习探讨了一个核心的权衡问题：重新分区带来的通信开销与因负载不平衡增长而导致的性能损失之间的权衡。通过建立一个包含计算和通信的成本模型，您将推导出一个最优的重新分区频率，以最小化总运行时间。这个练习展示了如何从简单的性能测量，发展到为动态演化系统设计优化的自适应策略 [@problem_id:3516560]。", "problem": "考虑一个在分布式内存集群上使用消息传递接口 (MPI) 进行时间推进的宇宙学 $N$ 体模拟。该模拟采用基于空间填充曲线的动态域分解，以平衡 $P$ 个进程间的计算负载。引力聚类导致粒子分布不均匀，在没有立即重新分区的情况下，会产生日益增长的负载不平衡。设由负载不平衡引起的分数减速（fractional slowdown）由无量纲函数 $\\eta(t)$ 表示，其定义为瞬时有效运行速率乘以 $(1+\\eta(t))$，其中 $\\eta(t)\\ge 0$ 且 $\\eta(0)=0$。根据经验，在比动力学时间短的时间窗口内，假设 $\\eta(t)$ 在两次重新分区事件之间以速率 $\\dot{\\eta}>0$ 近似线性增长，并且一次重新分区事件会将 $\\eta(t)$ 重置为近似 $0$。\n\n每次重新分区事件都会触发粒子和元数据的迁移，其时钟时间成本建模为 $C_{m}=\\alpha\\, m+\\beta\\, b$，其中 $m$ 是该事件期间的消息数量， $b$ 是迁移的总字节数，$\\alpha$ 是每条消息的有效延迟时间，$\\beta$ 是每字节的有效传输时间。在长度为 $H>0$ 的给定时间窗口内，假设我们选择以频率 $f>0$（周期 $\\tau=1/f$）周期性地进行重新分区，并且在该窗口内每次重新分区的平均值 $m$ 和 $b$ 在所选分区器的增量策略下可被视为与 $f$ 无关。\n\n使用性能建模的第一性原理，推导出一个解析表达式，用于计算最优重新分区频率 $f^{\\star}$，该频率使得在长度为 $H$ 的时间窗口内的总运行时间 $T_{\\text{total}}$ 最小。其中，$T_{\\text{total}}$ 是无不平衡或重新分区时的基准运行时间、随时间积分的累积不平衡开销以及由重新分区事件引起的累积迁移成本的总和。假设除了附加的迁移成本 $C_{m}$ 外，重新分区事件是瞬时的，并且不平衡在事件之间呈线性增长。将您的最终答案表示为关于 $\\alpha$、$\\beta$、$m$、$b$ 和 $\\dot{\\eta}$ 的闭式解析表达式。无需进行数值计算。如果找到多个驻点，请确定使 $T_{\\text{total}}$ 最小化的那一个。", "solution": "在持续时间为 $H$ 的模拟窗口内，总运行时间 $T_{\\text{total}}$ 是三个组成部分的总和：基准运行时间、由负载不平衡引起的积分开销以及所有重新分区事件的总成本。我们试图将 $T_{\\text{total}}$ 表示为重新分区频率 $f$ 的函数。\n\n让我们对 $T_{\\text{total}}$ 的各组成部分进行建模。\n令 $t'$ 代表模拟时间，从 $0$ 推进到 $H$。\n根据问题陈述，瞬时有效运行速率乘以 $(1+\\eta(t'))$。这意味着一个小的模拟时间间隔 $dt'$ 会消耗 $dT_{wall} = (1+\\eta(t')) dt'$ 的时钟时间，假设基准速率下 1 单位的模拟时间消耗 1 单位的时钟时间。\n\n1.  **计算时间（基准 + 不平衡开销）**\n    用于计算的总时钟时间，包括由不平衡引起的减速，是瞬时运行时间在模拟窗口上的积分：\n    $$T_{\\text{comp}} = \\int_{0}^{H} (1 + \\eta(t')) dt'$$\n    模拟以周期 $\\tau = 1/f$ 进行重新分区。这意味着不平衡函数 $\\eta(t')$ 在时间 $t' = k\\tau$（$k$ 为整数）时重置为 $0$。在两次重新分区事件之间，$\\eta(t')$ 以速率 $\\dot{\\eta}$ 从 $0$ 开始线性增长。\n    在从时间 $t'_0$ 开始的长度为 $\\tau$ 的单个周期内，不平衡函数为 $\\eta(t') = \\dot{\\eta}(t' - t'_0)$，其中 $t' \\in [t'_0, t'_0+\\tau)$。该行为是周期性的。我们来分析一个这样的区间，从 $t'=0$ 到 $t'=\\tau$。不平衡为 $\\eta(t') = \\dot{\\eta}t'$，其中 $t' \\in [0, \\tau)$。\n\n    一个周期的计算时间是：\n    $$T_{\\text{period}} = \\int_{0}^{\\tau} (1 + \\dot{\\eta}t') dt' = \\left[ t' + \\frac{1}{2}\\dot{\\eta}{t'}^2 \\right]_{0}^{\\tau} = \\tau + \\frac{1}{2}\\dot{\\eta}\\tau^2$$\n    总模拟窗口长度为 $H$。此类周期的数量 $N_{\\text{periods}}$ 为 $H/\\tau$。\n    总计算时间 $T_{\\text{comp}}$ 是所有周期的总和：\n    $$T_{\\text{comp}} = N_{\\text{periods}} \\times T_{\\text{period}} = \\frac{H}{\\tau} \\left( \\tau + \\frac{1}{2}\\dot{\\eta}\\tau^2 \\right) = H + \\frac{1}{2}H\\dot{\\eta}\\tau$$\n    项 $H$ 代表没有任何不平衡时的基准运行时间。项 $\\frac{1}{2}H\\dot{\\eta}\\tau$ 是由负载不平衡引起的总积分开销。\n    代入 $\\tau = 1/f$：\n    $$T_{\\text{comp}}(f) = H + \\frac{H\\dot{\\eta}}{2f}$$\n\n2.  **累积迁移成本**\n    在每个周期 $\\tau$ 的末尾会发生一次重新分区事件。单个事件的成本给定为 $C_{m} = \\alpha m + \\beta b$。\n    在窗口 $H$ 内的重新分区事件数量为 $N_{\\text{rep}} = H/\\tau = Hf$。这假设我们在一个稳态下对系统建模，其中边缘效应可以忽略不计，这对于此类性能模型是合适的。\n    总迁移成本 $T_{\\text{mig}}$ 是事件数量乘以每个事件的成本：\n    $$T_{\\text{mig}}(f) = N_{\\text{rep}} \\times C_{m} = (Hf)(\\alpha m + \\beta b)$$\n\n3.  **总运行时间与优化**\n    总运行时间 $T_{\\text{total}}$ 是计算时间和迁移成本的总和：\n    $$T_{\\text{total}}(f) = T_{\\text{comp}}(f) + T_{\\text{mig}}(f) = \\left(H + \\frac{H\\dot{\\eta}}{2f}\\right) + Hf(\\alpha m + \\beta b)$$\n    为了找到最小化 $T_{\\text{total}}$ 的最优频率 $f^{\\star}$，我们必须求 $T_{\\text{total}}(f)$ 关于 $f$ 的导数，并将其设为零。\n    $$ \\frac{dT_{\\text{total}}}{df} = \\frac{d}{df} \\left( H + \\frac{H\\dot{\\eta}}{2}f^{-1} + H(\\alpha m + \\beta b)f \\right) $$\n    $$ \\frac{dT_{\\text{total}}}{df} = 0 - \\frac{H\\dot{\\eta}}{2}f^{-2} + H(\\alpha m + \\beta b) $$\n    将导数设为零以找到驻点：\n    $$ H(\\alpha m + \\beta b) - \\frac{H\\dot{\\eta}}{2f^2} = 0 $$\n    由于 $H>0$，我们可以除以 $H$：\n    $$ \\alpha m + \\beta b = \\frac{\\dot{\\eta}}{2f^2} $$\n    求解 $f^2$：\n    $$ f^2 = \\frac{\\dot{\\eta}}{2(\\alpha m + \\beta b)} $$\n    由于频率 $f$ 必须为正（$f>0$），我们取正平方根：\n    $$ f^{\\star} = \\sqrt{\\frac{\\dot{\\eta}}{2(\\alpha m + \\beta b)}} $$\n    为确认该驻点对应于最小值，我们计算 $T_{\\text{total}}(f)$ 的二阶导数：\n    $$ \\frac{d^2T_{\\text{total}}}{df^2} = \\frac{d}{df} \\left( H(\\alpha m + \\beta b) - \\frac{H\\dot{\\eta}}{2}f^{-2} \\right) = - \\frac{H\\dot{\\eta}}{2}(-2)f^{-3} = \\frac{H\\dot{\\eta}}{f^3} $$\n    鉴于 $H>0$，$\\dot{\\eta}>0$，并且我们考虑 $f>0$，二阶导数 $\\frac{d^2T_{\\text{total}}}{df^2}$ 总是正的。这证实了函数 $T_{\\text{total}}(f)$ 在 $f>0$ 时是凸函数，我们找到的值 $f^{\\star}$ 确实是最小化总运行时间的频率。", "answer": "$$\n\\boxed{\\sqrt{\\frac{\\dot{\\eta}}{2(\\alpha m + \\beta b)}}}\n$$", "id": "3516560"}]}