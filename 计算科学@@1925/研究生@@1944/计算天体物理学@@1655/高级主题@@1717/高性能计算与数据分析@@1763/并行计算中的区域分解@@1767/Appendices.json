{"hands_on_practices": [{"introduction": "在并行计算中，性能分析的第一步是精确量化通信开销。本练习将通过一个经典场景——在均匀结构化网格上进行“光晕交换”（halo exchange）——来指导你完成这一过程。通过解决这个问题 [@problem_id:3509238]，你将掌握计算最近邻通信模式下数据传输量的基本技能，这是评估任何基于网格的并行代码扩展性的基础。", "problem": "一个显式有限体积天体物理流体动力学求解器在一个大小为 $N^{3}$ 的均匀立方网格上推进一个单标量场。全局域使用大小相等的子域通过笛卡尔域分解被分解为 $4 \\times 4 \\times 4$ 个进程。假设 $N$ 可被 $4$ 整除，因此每个进程恰好持有 $(N/4) \\times (N/4) \\times (N/4)$ 个内部单元。更新使用一个 $7$ 点最近邻模板，并且在每个面上仅以宽度为 $w=1$ 个单元的光环进行光环交换（没有边或角的交换）。每个光环值用双精度表示（每个值 $8$ 字节）。在每个时间步中，所有进程与其现有的最近邻交换它们的面光环（外部物理边界没有相邻的进程，因此不涉及进程间的通信）。\n\n从笛卡尔域分解和 $7$ 点模板要求的定义出发，计算：\n- 每个进程在每个基本方向上的光环消息大小（即，在 $\\pm x$、$\\pm y$ 和 $\\pm z$ 方向上的一个面消息的大小，以字节为单位），作为 $N$ 的函数。\n- 所有进程在每个时间步中为面交换通信所发送的总字节数。\n\n将最终总数表示为关于 $N$ 的单个闭式表达式。最终数量以字节为单位。无需四舍五入。报告所有进程在每个时间步中发送的总字节数作为您的最终答案。", "solution": "问题陈述已经过验证，被认为是有效的。这是一个计算科学领域中定义明确、有科学依据的问题，具体涉及并行算法的性能分析。所有必要的参数都已提供，没有内部矛盾或歧义。\n\n该问题要求计算并行流体动力学求解器中光环交换的总通信量。给定以下参数：\n- 全局网格大小：$N \\times N \\times N$ 个单元。\n- 进程网格：$P_x \\times P_y \\times P_z = 4 \\times 4 \\times 4$。进程的总数为 $P = 4^3 = 64$。\n- 假设：$N$ 可被 $4$ 整除。\n- 每个进程的内部单元：每个进程管理一个大小为 $(N/4) \\times (N/4) \\times (N/4)$ 个单元的子域。设 $N_s = N/4$ 为子域的边长。子域的体积为 $N_s^3$。\n- 模板：$7$ 点最近邻模板，这意味着仅需要与六个面相邻的邻居进行通信。\n- 光环宽度：每个面 $w=1$ 个单元。\n- 数据精度：每个标量值是一个双精度浮点数，占用 $8$ 字节。设 $S_{val} = 8$ 字节。\n\n首先，我们计算从一个进程发送到相邻进程的单个消息的大小。此消息包含一个面的光环数据。子域的面是一个维度为 $N_s \\times N_s$ 的二维单元平面。要交换的光环区域厚度为 $w=1$。\n\n单个面光环区域中的数据值（单元）数量为：\n$$V_{face\\_halo} = w \\times N_s \\times N_s = 1 \\times \\left(\\frac{N}{4}\\right) \\times \\left(\\frac{N}{4}\\right) = \\frac{N^2}{16}$$\n\n一个面的消息大小（以字节为单位）是值的数量乘以每个值的大小：\n$$M_{face} = V_{face\\_halo} \\times S_{val} = \\frac{N^2}{16} \\times 8 = \\frac{N^2}{2} \\text{ bytes}$$\n这是每个进程在六个基本方向（$\\pm x$, $\\pm y$, $\\pm z$）中任一方向上的光环消息大小。\n\n接下来，我们必须确定在每个时间步中，整个模拟域发送的此类消息的总数。问题要求的是“所有进程在每个时间步中发送的总字节数”。这意味着我们必须计算从任何一个进程到相邻进程的每一次“发送”操作。通信仅发生在相邻进程之间的内部边界上。\n\n进程的网格是一个 $4 \\times 4 \\times 4$ 的立方体。我们可以计算进程之间的内部边界（接口）数量。\n- 沿 $x$ 方向，有 $P_x - 1 = 4 - 1 = 3$ 个接口平面。每个平面由 $P_y \\times P_z = 4 \\times 4 = 16$ 个接口组成。因此，垂直于 $x$ 轴的接口数量为 $N_{int,x} = (P_x - 1) P_y P_z = 3 \\times 4 \\times 4 = 48$。\n- 根据对称性，垂直于 $y$ 轴的接口数量为 $N_{int,y} = P_x (P_y - 1) P_z = 4 \\times 3 \\times 4 = 48$。\n- 同样，垂直于 $z$ 轴的接口数量为 $N_{int,z} = P_x P_y (P_z - 1) = 4 \\times 4 \\times 3 = 48$。\n\n整个域中内部接口的总数为：\n$$N_{int} = N_{int,x} + N_{int,y} + N_{int,z} = 48 + 48 + 48 = 144$$\n\n对于两个进程（比如进程 A 和进程 B）之间的每个内部接口，在每个时间步会发生两次通信事件：进程 A 将其光环发送给进程 B，进程 B 将其光环发送给进程 A。问题要求的是发送的*总*字节数。因此，对于 $N_{int}$ 个接口中的每一个，我们必须计算两次“发送”操作。\n\n每个时间步“发送”操作的总次数为：\n$$N_{send} = 2 \\times N_{int} = 2 \\times 144 = 288$$\n\n最后，每个时间步发送的总通信量（以字节为单位）$B_{total}$，是总发送操作次数与每个消息大小的乘积。\n$$B_{total} = N_{send} \\times M_{face}$$\n代入我们导出的表达式：\n$$B_{total} = 288 \\times \\frac{N^2}{2}$$\n$$B_{total} = 144 N^2$$\n\n所有进程在每个时间步发送的总字节数的最终表达式为 $144 N^2$。", "answer": "$$\\boxed{144 N^{2}}$$", "id": "3509238"}, {"introduction": "不同的数值算法需要不同的分解策略。本练习 [@problem_id:3509261] 探讨了一种更高级的“Pencil”分解方案，它在计算天体物理学中用于快速傅里叶变换（FFT）等谱方法。与最近邻通信不同，该方案引入了“全对全”（all-to-all）通信模式，其性能扩展特性迥异。通过推导其通信量，你将深入理解算法需求如何直接决定并行分解与通信模式的选择。", "problem": "在计算天体物理学中使用的三维谱方法求解器中，对立方数组执行快速傅里叶变换（FFT）操作需要通过转置步骤进行数据重排。考虑一个大小为 $N \\times N \\times N$ 的数组，它通过 pencil 分解分布在一个大小为 $p_x \\times p_y$ 的二维进程网格上。每个进程由一对坐标 $(i,j)$ 标识，其中 $0 \\le i  p_x$ 且 $0 \\le j  p_y$，并初始持有一个大小为 $\\frac{N}{p_x} \\times \\frac{N}{p_y} \\times N$ 的局部分数组（一个沿 $z$ 方向的 pencil）。转置期间的数据交换使用消息传递接口（MPI）执行。假设转置是作为一个沿某一网格维度的进程子组内的 all-to-all 交换来实现的：或是在一个大小为 $p_y$ 的列内进行，以将 pencil 从 $z$ 对齐重排为 $y$ 对齐；或是在一个大小为 $p_x$ 的行内进行，以将 pencil 从 $y$ 对齐重排为 $x$ 对齐。在每次 all-to-all 交换中，一个进程向其子组中的所有其他进程发送大小相等的消息，并且不发送给自己；“消息”定义为向一个不同的远程进程进行的点对点传输，“通信量”定义为在转置期间传输到进程外的数组元素总数。\n\n从 pencil 分解和 all-to-all 通信的核心定义出发，推导单次转置步骤中每个进程的通信量和每个进程的消息数量。报告两种情况下的答案：\n- 在 $p_y$ 个进程间的按列转置，以及\n- 在 $p_x$ 个进程间的按行转置。\n\n用 $N$、$p_x$ 和 $p_y$ 的解析表达式表示你的最终答案。不需要四舍五入，表达式中不应包含物理单位。你的最终输出应为每种情况下的两个量（通信量，消息数量）。", "solution": "问题要求在一个使用 pencil 分解的三维谱方法求解器中，为两个不同的转置步骤推导每个进程的通信量和每个进程的消息数量。我们将通过首先确定数据交换前后每个进程上的数据布局，然后根据指定的 all-to-all 交换模式量化通信，来分析每种转置情况。\n\n我们考虑一个大小为 $N \\times N \\times N$ 的全局立方数据数组。数据分布在一个 $p_x \\times p_y$ 的进程网格上。一个进程由其在此网格上的坐标 $(i, j)$ 唯一标识，其中 $0 \\le i  p_x$ 且 $0 \\le j  p_y$。令 $A(x,y,z)$ 表示全局数组中的一个元素，其中 $x, y, z \\in \\{0, 1, \\dots, N-1\\}$。\n\n初始时，数据以 $z$-pencil 分解的方式排列。每个进程 $P_{i,j}$ 持有一个大小为 $\\frac{N}{p_x} \\times \\frac{N}{p_y} \\times N$ 的局部分数组。进程 $P_{i,j}$ 上的数据元素的全局索引由下式给出：\n$$\nx \\in \\left[ i\\frac{N}{p_x}, (i+1)\\frac{N}{p_x} - 1 \\right], \\quad y \\in \\left[ j\\frac{N}{p_y}, (j+1)\\frac{N}{p_y} - 1 \\right], \\quad z \\in [0, N-1]\n$$\n每个进程上的元素总数为 $\\frac{N^3}{p_x p_y}$。\n\n**情况1：按列转置（z-pencils 到 y-pencils）**\n\n此转置操作将数据从 z-pencils 重组为 y-pencils，以方便沿 $y$ 方向进行快速傅里叶变换（FFT）。此步骤的通信发生在进程列内部。一个进程 $P_{i,j}$ 与所有其他进程 $P_{i,k}$ 通信，其中 $k \\in \\{0, 1, \\dots, p_y-1\\}$。此通信子组的大小为 $p_y$。\n\n$y$-pencil 分解的目标分布要求每个进程持有沿 $y$ 轴连续的数据。此次转置后，进程 $P_{i,j}$ 将持有一个大小为 $\\frac{N}{p_x} \\times N \\times \\frac{N}{p_y}$ 的局部分数组，对应全局索引为：\n$$\nx \\in \\left[ i\\frac{N}{p_x}, (i+1)\\frac{N}{p_x} - 1 \\right], \\quad y \\in [0, N-1], \\quad z \\in \\left[ j\\frac{N}{p_y}, (j+1)\\frac{N}{p_y} - 1 \\right]\n$$\n注意，进程网格索引 $j$ 现在映射到 $z$ 轴的一个分区。\n\n为实现这种重新分布，进程 $P_{i,j}$ 必须将其初始数据的特定部分发送给其列中的每一个其他进程 $P_{i,k}$。发往进程 $P_{i,k}$ 的数据是 $P_{i,j}$ 的本地数据中，其全局 $z$ 索引在 $P_{i,k}$ 最终布局所需范围内的子集，即 $z \\in [k\\frac{N}{p_y}, (k+1)\\frac{N}{p_y}-1]$。\n\n让我们计算进程 $P_{i,j}$ 发送给进程 $P_{i,k}$ 的数据块的大小。该数据块在全局数组中的维度由发送方持有的数据与接收方需要的数据的交集确定：\n- $x$ 维大小：$\\frac{N}{p_x}$（来自 $P_{i,j}$ 的初始块）\n- $y$ 维大小：$\\frac{N}{p_y}$（来自 $P_{i,j}$ 的初始块）\n- $z$ 维大小：$\\frac{N}{p_y}$（$P_{i,k}$ 需要的范围）\n\n这样一个消息的大小（以数组元素数量计）是 $\\frac{N}{p_x} \\times \\frac{N}{p_y} \\times \\frac{N}{p_y} = \\frac{N^3}{p_x p_y^2}$。\n\n问题定义 all-to-all 交换为一个进程向其子组中的所有其他进程发送消息，但不发送给自己。进程 $P_{i,j}$ 发送的消息数量是其子组大小减一。\n每个进程的消息数量 = $p_y - 1$。\n\n每个进程的通信量是发送到进程外的元素总数。这是发送的消息数量与每条消息大小的乘积。\n每个进程的通信量 = $(p_y - 1) \\times \\frac{N^3}{p_x p_y^2}$。\n\n**情况2：按行转置（y-pencils 到 x-pencils）**\n\n这个转置在前一个转置之后进行，为沿 $x$ 方向的 FFT 准备数据。此步骤的初始状态是上面描述的 $y$-pencil 分解。通信发生在进程行内部。一个进程 $P_{i,j}$ 与所有其他进程 $P_{k,j}$ 通信，其中 $k \\in \\{0, 1, \\dots, p_x-1\\}$。此通信子组的大小为 $p_x$。\n\n目标分布是 $x$-pencil 分解。此次转置后，进程 $P_{i,j}$ 将持有一个大小为 $N \\times \\frac{N}{p_x} \\times \\frac{N}{p_y}$ 的局部分数组。进程网格索引 $(i,j)$ 现在分别映射到 $y$ 轴和 $z$ 轴的分区。进程 $P_{i,j}$ 上的全局索引为：\n$$\nx \\in [0, N-1], \\quad y \\in \\left[ i\\frac{N}{p_x}, (i+1)\\frac{N}{p_x} - 1 \\right], \\quad z \\in \\left[ j\\frac{N}{p_y}, (j+1)\\frac{N}{p_y} - 1 \\right]\n$$\n进程 $P_{i,j}$ 必须向其行中的每一个其他进程 $P_{k,j}$ 发送数据。发往 $P_{k,j}$ 的数据是 $P_{i,j}$ 当前数据中，其全局 $y$ 索引与 $P_{k,j}$ 在最终布局中所需范围相匹配的子集，即 $y \\in [k\\frac{N}{p_x}, (k+1)\\frac{N}{p_x}-1]$。\n\n让我们计算从 $P_{i,j}$ 发送给 $P_{k,j}$ 的数据块的大小：\n- $x$ 维大小：$\\frac{N}{p_x}$（来自 $P_{i,j}$ 的当前块）\n- $y$ 维大小：$\\frac{N}{p_x}$（$P_{k,j}$ 需要的范围）\n- $z$ 维大小：$\\frac{N}{p_y}$（来自 $P_{i,j}$ 的当前块）\n\n这样一个消息的大小是 $\\frac{N}{p_x} \\times \\frac{N}{p_x} \\times \\frac{N}{p_y} = \\frac{N^3}{p_x^2 p_y}$。\n\n进程 $P_{i,j}$ 发送的消息数量是其行子组大小减一。\n每个进程的消息数量 = $p_x - 1$。\n\n每个进程的通信量是消息数量乘以消息大小。\n每个进程的通信量 = $(p_x - 1) \\times \\frac{N^3}{p_x^2 p_y}$。\n\n由此确定了所要求的四个量。我们将它们按以下顺序呈现在一个单行矩阵中：（按列通信量，按列消息数，按行通信量，按行消息数）。", "answer": "$$\n\\boxed{\n\\begin{pmatrix}\n(p_y - 1) \\frac{N^3}{p_x p_y^2}  p_y - 1  (p_x - 1) \\frac{N^3}{p_x^2 p_y}  p_x - 1\n\\end{pmatrix}\n}\n$$", "id": "3509261"}, {"introduction": "为了弥合理想化均匀网格与现代天体物理模拟中复杂的自适应网格（AMR）之间的差距，我们需要更复杂的分解技术。本练习 [@problem_id:3509227] 提出了一个实际的挑战：在单元计算权重不均的非均匀网格上，同时实现计算负载均衡和最小化通信。通过实现基于希尔伯特空间填充曲线的划分算法，你将亲身体验如何优雅地解决这一双重优化问题，并掌握评估分区质量的关键指标：负载均衡度和切割边数量。", "problem": "您的任务是为一种自适应二维网格实现一种确定性的、连续的、基于一维排序的域分解，该网格代表了计算天体物理学中的自适应网格细化（Adaptive Mesh Refinement, AMR）策略。该分解必须使用单元中心的 Hilbert 空间填充曲线排序，将网格划分到指定数量的处理单元上。然后，您将计算两个定量指标：一个负载均衡指标和网格对偶图中的切割边数量。\n\n请使用以下定义和规则。\n\n1. 域和单元。计算域为正方形 $[0,1]\\times[0,1]$。网格是一组轴对齐的矩形单元，每个单元由其闭合坐标范围 $[x_{\\min},x_{\\max}]\\times[y_{\\min},y_{\\max}]$ 表示，其中 $0 \\le x_{\\min}  x_{\\max} \\le 1$ 且 $0 \\le y_{\\min}  y_{\\max} \\le 1$。每个单元 $i$ 有一个中心 $(x_i,y_i)$，由 $x_i = (x_{\\min,i}+x_{\\max,i})/2$ 和 $y_i=(y_{\\min,i}+y_{\\max,i})/2$ 给出。每个单元 $i$ 还有一个正的计算权重 $w_i$。\n\n2. Hilbert 空间填充曲线排序。使用每个坐标 $b=16$ 比特将每个单元中心 $(x_i,y_i)$ 映射到一个整数网格，即，令 $n=2^{b}$ 并定义整数坐标\n$$\ni_x = \\min\\left(\\left\\lfloor x_i \\cdot n \\right\\rfloor, n-1\\right),\\quad\ni_y = \\min\\left(\\left\\lfloor y_i \\cdot n \\right\\rfloor, n-1\\right).\n$$\n使用标准的 $b$ 阶 Hilbert 曲线映射，从 $(i_x,i_y)\\in\\{0,1,\\dots,n-1\\}^2$ 到 $h\\in\\{0,1,\\dots,n^2-1\\}$，计算 Hilbert 索引 $h(i_x,i_y)$。按 $h$ 升序对单元进行排序；如果出现平局，则按 $i_x$ 升序、再按 $i_y$ 升序打破平局。这个已排序的序列就是一维排序。\n\n3. 通过加权中点区间分配进行连续分区。给定已排序的序列，通过以下规则将每个单元 $i$ 分配给 $P$ 个分区之一。令 $W_{\\mathrm{tot}}=\\sum_i w_i$ 为总权重，令 $c_i$ 为排序中严格位于单元 $i$ 之前的所有单元的权重累积和。那么单元 $i$ 的分区索引为\n$$\np_i = \\min\\left(\\left\\lfloor P \\cdot \\frac{c_i + \\tfrac{1}{2}w_i}{W_{\\mathrm{tot}}} \\right\\rfloor,\\, P-1\\right).\n$$\n这会沿着 Hilbert 排序产生 $P$ 个连续段。\n\n4. 负载均衡指标。对于 $p\\in\\{0,1,\\dots,P-1\\}$，令 $W_p=\\sum_{i:\\,p_i=p} w_i$ 为分区 $p$ 上的权重，令 $\\bar{W}=W_{\\mathrm{tot}}/P$ 为平均权重。负载均衡指标为\n$$\nL = \\frac{\\max_p W_p}{\\bar{W}}.\n$$\n您必须报告四舍五入到 6 位小数的 $L$。\n\n5. 对偶图中的切割边。定义一个无向对偶图，其顶点为单元。两个不同的单元 $i$ 和 $j$ 相邻，当且仅当它们的矩形共享一条长度非零的边界边。更准确地说，如果满足以下任一条件，则存在邻接关系：\n- $x_{\\max,i} = x_{\\min,j}$ 或 $x_{\\max,j} = x_{\\min,i}$ 且沿 $y$ 轴的重叠长度严格为正，即\n$$\n\\min(y_{\\max,i},y_{\\max,j}) - \\max(y_{\\min,i},y_{\\min,j})  0,\n$$\n或\n- $y_{\\max,i} = y_{\\min,j}$ 或 $y_{\\max,j} = y_{\\min,i}$ 且沿 $x$ 轴的重叠长度严格为正，即\n$$\n\\min(x_{\\max,i},x_{\\max,j}) - \\max(x_{\\min,i},x_{\\min,j})  0.\n$$\n每个无序相邻对只计数一次。切割边数 $E$ 是满足 $p_i \\ne p_j$ 的相邻对 $\\{i,j\\}$ 的数量。\n\n6. 测试套件。为以下四个测试用例实现上述内容。在所有用例中，域均为 $[0,1]\\times[0,1]$，且 Hilbert 映射使用 $b=16$。\n\n- 测试用例 A（均匀网格，均匀权重）：一个 $4 \\times 4$ 的均匀网格，形成 16 个大小为 $1/4 \\times 1/4$ 的相等单元，即，由 $(a,b)$ 索引的单元，其中 $a\\in\\{0,1,2,3\\}$ 和 $b\\in\\{0,1,2,3\\}$，坐标为\n$$\n[x_{\\min},x_{\\max}] = \\left[\\frac{a}{4}, \\frac{a+1}{4}\\right],\\quad\n[y_{\\min},y_{\\max}] = \\left[\\frac{b}{4}, \\frac{b+1}{4}\\right].\n$$\n所有权重均为 $w_i=1$。使用 $P=4$。\n\n- 测试用例 B（四叉树细化，均匀权重）：从一个 $2 \\times 2$ 的粗网格开始，其单元大小为 $1/2 \\times 1/2$，索引为 $(a,b)$，$a,b\\in\\{0,1\\}$：\n$$\n[x_{\\min},x_{\\max}] = \\left[\\frac{a}{2}, \\frac{a+1}{2}\\right],\\quad\n[y_{\\min},y_{\\max}] = \\left[\\frac{b}{2}, \\frac{b+1}{2}\\right].\n$$\n将右上角的粗单元 $(a,b)=(1,1)$ 细化为四个大小为 $1/4 \\times 1/4$ 的子单元，对齐在明显的子象限上。然后将这四个子单元中右上角的一个细化为四个大小为 $1/8 \\times 1/8$ 的孙单元。因此，最终的网格由 3 个粗单元、3 个四分之一单元（被细化的粗单元的子单元，除了被进一步细化的那个）和 4 个八分之一单元组成，总共有 10 个单元。所有权重均为 $w_i=1$。使用 $P=3$。\n\n- 测试用例 C（非协调界面，层级相关权重）：左半部分 $[0,1/2]\\times[0,1]$ 为一个粗单元，右半部分 $[1/2,1]\\times[0,1]$ 细分为一个 $2 \\times 2$ 的网格，包含四个大小为 $1/4 \\times 1/2$ 的相等单元。根据细化层级分配权重：粗单元的权重为 $w=1$，四个较细单元的权重各为 $w=2$。使用 $P=2$。\n\n- 测试用例 D（分区数多于单元数）：两个大小相等、垂直分割的单元，即 $[0,1/2]\\times[0,1]$ 和 $[1/2,1]\\times[0,1]$，两者的权重均为 $w=1$。使用 $P=3$。\n\n7. 输出规范。您的程序应产生单行输出，包含一个用方括号括起来的逗号分隔列表形式的结果，其中每个测试用例贡献一个包含两个元素的列表，分别是四舍五入到 6 位小数的负载均衡指标 $L$ 和整数切割边数 $E$。例如，所需的格式为\n$$\n\\big[ [L_A,E_A], [L_B,E_B], [L_C,E_C], [L_D,E_D] \\big],\n$$\n打印在单行上，无任何附加文本。\n\n所有计算纯粹是几何和组合性质的；不涉及物理单位。不涉及角度。本问题中使用的所有数字和符号必须按上文给出的标准数学符号进行解释。", "solution": "我们从并行计算中域分解的基本原理开始，这在采用自适应网格细化（AMR）的计算天体物理学中很常见。目标是将由带权重的网格单元表示的计算工作分配给 $P$ 个处理单元，以实现两个理想目标：负载均衡和局部性。一种被广泛接受的方法是使用空间填充曲线施加一个一维排序，然后将此排序划分为连续的段。我们将此方法具体化为 Hilbert 空间填充曲线。\n\n我们使用的基本依据是：保持空间局部性的空间填充曲线排序的定义，根据工作权重定义的负载均衡，以及由共享边界边定义的对偶图中的邻接关系。\n\n首先，考虑一组覆盖 $[0,1]\\times[0,1]$ 子集的轴对齐矩形单元。每个单元 $i$ 由 $[x_{\\min,i},x_{\\max,i}]\\times[y_{\\min,i},y_{\\max,i}]$ 给出，其中 $0\\le x_{\\min,i}  x_{\\max,i} \\le 1$ 且 $0\\le y_{\\min,i}  y_{\\max,i} \\le 1$。其中心为 $(x_i,y_i)$，其中\n$$\nx_i = \\frac{x_{\\min,i}+x_{\\max,i}}{2},\\qquad y_i=\\frac{y_{\\min,i}+y_{\\max,i}}{2}。\n$$\n我们为每个单元分配一个计算权重 $w_i > 0$，它反映了计算该单元更新的成本。在计算天体物理学中，权重可以与每步更新的状态数量成正比，在多层 AMR 设置中，由于时间上的子循环，更精细的层级可能会产生更高的有效成本；例如，如果精细层级需要两倍的子步数，那么对于层级 $\\ell$，一个简单的模型 $w\\propto 2^\\ell$ 是合理的。\n\n为在分区中实现良好的空间局部性，我们将 $(x_i,y_i)$ 映射到 $b$ 阶 Hilbert 曲线索引。令 $b=16$ 且 $n=2^{b}$。整数坐标为\n$$\ni_x = \\min\\left(\\left\\lfloor x_i \\cdot n \\right\\rfloor, n-1\\right),\\quad\ni_y = \\min\\left(\\left\\lfloor y_i \\cdot n \\right\\rfloor, n-1\\right).\n$$\n存在一个经过充分检验的双射映射 $h:\\{0,1,\\dots,n-1\\}^2\\to\\{0,1,\\dots,n^2-1\\}$，称为 Hilbert 索引，它可以通过在比特尺度减半时递归地旋转和反射象限来算法化地计算。操作上，一种标准方法是遍历比特尺度 $s\\in\\{n/2, n/4, \\dots, 1\\}$，提取相应的比特\n$$\nr_x = \\left\\lfloor \\frac{i_x \\bmod 2s}{s} \\right\\rfloor,\\qquad r_y = \\left\\lfloor \\frac{i_y \\bmod 2s}{s} \\right\\rfloor,\n$$\n将贡献 $s^2\\cdot\\big( (3r_x)\\oplus r_y\\big)$ 累加到 $h$ 中，并应用一个旋转 $\\mathrm{rot}(s,i_x,i_y,r_x,r_y)$，当 $r_y=0$ 且 $r_x=1$ 时反转并交换坐标，否则当 $r_y=0$ 时交换坐标。这个映射被广泛记录并保持局部性：平面中相近的点在一维排序中也倾向于相近。\n\n我们按 $h(i_x,i_y)$ 的升序对所有单元进行排序。在极少数情况下出现 Hilbert 索引相等时，我们按 $i_x$ 升序、再按 $i_y$ 升序打破平局，以确保一个确定性的全序。这将产生一个一维序列。\n\n给定这个序列，我们需要一个将其连续分解为 $P$ 个部分的方法，使得每个部分的权重近似相等。令 $W_{\\mathrm{tot}}=\\sum_i w_i$ 为总权重，$\\bar{W}=W_{\\mathrm{tot}}/P$ 为每个分区的目标权重。对于序列顺序中的每个单元 $i$，令 $c_i$ 为其前面所有单元的权重累积和。基本原则是将区间 $[c_i, c_i+w_i)$ 分配给一个分区索引，该索引由其中心点相对于 $[0,W_{\\mathrm{tot}})$ 的 $P$ 个相等子区间的位置决定。因此我们分配\n$$\np_i = \\min\\left(\\left\\lfloor P \\cdot \\frac{c_i + \\tfrac{1}{2}w_i}{W_{\\mathrm{tot}}} \\right\\rfloor,\\, P-1\\right).\n$$\n这是一种有原则的中点分配方法，它将权重区间的包含性中点放入 $P$ 个仓位之一，从而将序列划分为连续的段。使用中点是一种经过充分检验的方法，用于在离散化连续分区时最小化舍入误差。\n\n负载均衡指标源于负载不均衡的定义：如果 $W_p$ 是分配给分区 $p$ 的总权重，理想的均衡是所有 $p$ 的 $W_p=\\bar{W}$。一个标准的标量度量是\n$$\nL = \\frac{\\max_p W_p}{\\bar{W}},\n$$\n该值至少为 1，当所有部分的权重恰好等于目标权重时等于 1。这是一个无量纲量，与单位无关。\n\n切割边的数量在对偶图上计算，其中两个单元如果共享一条长度非零的边界边，则它们是相邻的。对于两个矩形 $[x_{\\min,i},x_{\\max,i}]\\times[y_{\\min,i},y_{\\max,i}]$ 和 $[x_{\\min,j},x_{\\max,j}]\\times[y_{\\min,j},y_{\\max,j}]$，如果 $x_{\\max,i}=x_{\\min,j}$ 或 $x_{\\max,j}=x_{\\min,i}$ 且沿 $y$ 轴的重叠长度\n$$\n\\delta_y = \\min(y_{\\max,i},y_{\\max,j}) - \\max(y_{\\min,i},y_{\\min,j}),\n$$\n严格为正，则存在沿垂直界面的邻接关系。如果 $y_{\\max,i}=y_{\\min,j}$ 或 $y_{\\max,j}=y_{\\min,i}$ 且沿 $x$ 轴的重叠长度\n$$\n\\delta_x = \\min(x_{\\max,i},x_{\\max,j}) - \\max(x_{\\min,i},x_{\\min,j}),\n$$\n严格为正，则存在沿水平界面的邻接关系。为了在使用二进制有理数坐标时具有数值鲁棒性，我们使用一个小的容差来实现相等性检查，但概念上要求的是精确相等。每个无序相邻对 $\\{i,j\\}$ 只计数一次，如果 $p_i\\ne p_j$，它就对切割计数 $E$ 有贡献。\n\n我们现在实例化这四个测试用例：\n\n- 测试用例 A 是一个均匀的 $4\\times 4$ 网格。16 个单元每个的权重都是 $w_i=1$，且 $P=4$。因为 Hilbert 排序保持了局部性且权重均匀，中点分配将产生四个总权重相等或接近相等的连续块，在这种情况下，如果排序能均匀划分，每个分区将恰好有 4 个单元。负载均衡指标 $L$ 是用 $\\bar{W}=16/4=4$ 和测得的 $W_p$ 计算的。切割边数 $E$ 取决于分区切割落在网格邻接关系中的位置。\n\n- 测试用例 B 是一个分层的四叉树细化：三个大小为 $1/2\\times 1/2$ 的粗单元，三个大小为 $1/4\\times 1/4$ 的四分之一单元（替换一个粗单元，除了那个被进一步细化的），以及四个大小为 $1/8\\times 1/8$ 的八分之一单元（替换被细化的四分之一单元）。所有权重均为 $w_i=1$ 且 $P=3$，因此 $\\bar{W}=10/3$。中点分配产生三个总权重接近 $10/3$ 的连续段。然后我们计算跨越非协调网格的切割边数。邻接规则正确地处理了大单元到小单元的界面，其中一个单元可以与多个较小的邻居共享一条边。\n\n- 测试用例 C 在 $x=1/2$ 处设置了一个非协调界面，左侧是一个粗单元，右侧是四个单元组成的 $2\\times 2$ 网格。权重取决于细化层级以模拟子循环：0 级（粗单元）的权重为 $w=1$，1 级（四个较细的单元）的权重为 $w=2$，所以 $W_{\\mathrm{tot}}=1+4\\cdot 2=9$，其中 $P=2$ 且 $\\bar{W}=9/2=4.5$。中点分配将 Hilbert 序列分为两个总权重接近相等的部分，切割边数取决于左右邻接关系是否跨越了分区索引。\n\n- 测试用例 D 只有两个垂直分割的单元，权重 $w_i=1$，且 $P=3$。这里 $W_{\\mathrm{tot}}=2$ 且 $\\bar{W}=2/3$。由于单元数少于分区数，至少会有一个分区的权重为零。负载均衡指标是 $L=\\max_p W_p / \\bar{W}$，在这种情况下，如果一个分区得到一个单元且最大值为 1，则等于 $1 / (2/3)=1.5$，或者如果两个单元最终在同一个分区上，则等于 $2 / (2/3)=3$；然而，Hilbert 排序上的中点规则会产生确定性的分配，我们将据此计算精确的 $L$。两个单元之间的唯一邻接关系是否为切割边，当且仅当它们最终被分到不同的分区。\n\n实现的算法步骤：\n\n1. 为每个测试用例生成指定的精确有理数坐标的矩形和权重列表。\n\n2. 对每个测试用例，为每个单元计算 $(x_i,y_i)$，用 $b=16$ 将其映射到整数 $(i_x,i_y)$，通过标准迭代旋转算法计算 Hilbert 索引 $h(i_x,i_y)$，并按 $(h,i_x,i_y)$ 排序。\n\n3. 遍历排序后的单元，维持一个累积和 $c_i$，并使用中点规则分配分区索引 $p_i$\n$$\np_i = \\min\\left(\\left\\lfloor P \\cdot \\frac{c_i + \\tfrac{1}{2}w_i}{W_{\\mathrm{tot}}} \\right\\rfloor,\\, P-1\\right).\n$$\n\n4. 计算 $W_p=\\sum_{i:\\,p_i=p} w_i$、$\\bar{W}=W_{\\mathrm{tot}}/P$ 和 $L = \\max_p W_p / \\bar{W}$，并将 $L$ 四舍五入到 6 位小数用于输出。\n\n5. 使用具有正长度重叠的共享边准则计算邻接集，并计算 $p_i\\ne p_j$ 的对数，得到 $E$。\n\n6. 在单行上输出列表 $\\big[ [L_A,E_A], [L_B,E_B], [L_C,E_C], [L_D,E_D] \\big]$。\n\n该设计集成了核心原则：通过 Hilbert 曲线保持空间局部性以减少分区间的通信，确定性的连续分区以实现可复现性，以及使用 $\\max_p W_p / \\bar{W}$ 进行有原则的负载均衡度量。通过共享边定义的邻接关系在天体物理模拟中常见的有限体积和有限差分法离散化中是标准的，确保了跨非协调界面的通信边计数的真实性。", "answer": "$$\\big[ [1.000000, 12], [1.111111, 10], [1.111111, 2], [1.500000, 1] \\big]$$", "id": "3509227"}]}