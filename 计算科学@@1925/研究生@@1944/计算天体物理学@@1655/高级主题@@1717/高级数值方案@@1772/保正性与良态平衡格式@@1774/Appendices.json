{"hands_on_practices": [{"introduction": "在模拟处于流体静力学平衡的天体物理系统（如恒星或行星大气）时，一个核心的数值挑战是精确地平衡巨大的压力梯度和引力。如果天真地对这两项进行离散化，产生的截断误差会表现为虚假的净力，从而在原本静态的介质中激发出非物理的流动。这项练习将引导你从第一性原理出发，为球坐标系下的等温大气推导出一个离散的引力源项，它能精确地抵消离散的压力梯度，从而构建一个“良好平衡”的格式。[@problem_id:3529805]", "problem": "考虑一个自引力气体的球对称可压缩欧拉方程，其引力势为 $\\Phi(r)$，声速为 $c_s$，并假设其状态方程 (EOS) 为等温的 $p = c_s^2 \\rho$。在球对称情况下，径向动量方程可以写成守恒形式：\n$$\n\\partial_t\\!\\left(\\rho u\\right) + \\frac{1}{r^2}\\,\\partial_r\\!\\left(r^2 p\\right) \\;=\\; -\\,\\rho\\,\\partial_r \\Phi,\n$$\n当乘以 $r^2$ 后，变为：\n$$\n\\partial_t\\!\\left(\\rho u\\right) r^2 + \\partial_r\\!\\left(r^2 p\\right) \\;=\\; -\\,\\rho\\,r^2\\,\\partial_r \\Phi.\n$$\n在流体静力平衡时，$u \\equiv 0$，该方程简化为：\n$$\n\\partial_r\\!\\left(r^2 p\\right) \\;=\\; -\\,\\rho\\,r^2\\,\\partial_r \\Phi.\n$$\n考虑在一个严格单调的非均匀径向网格上进行有限体积离散化，其中单元 $i$ 的范围是 $[r_{i-\\frac{1}{2}},\\,r_{i+\\frac{1}{2}}]$，单元体积为：\n$$\nV_i \\;=\\; \\int_{r_{i-\\frac{1}{2}}}^{r_{i+\\frac{1}{2}}} r^2 \\, dr \\;=\\; \\frac{1}{3}\\left(r_{i+\\frac{1}{2}}^3 - r_{i-\\frac{1}{2}}^3\\right).\n$$\n设单元 $i$ 中的离散通量贡献由界面压力计算得出，\n$$\n\\frac{1}{V_i}\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}\\right),\n$$\n并通过等温 EOS 隐含的焓关系，将每个单元中心的状态 $(\\rho_i, p_i)$ 映射到界面，来为界面压力定义一个流体静力重构（以确保正性）：\n$$\np_{i\\pm\\frac{1}{2}}^{\\mathrm{eq}} \\;=\\; c_s^2\\,\\rho_i\\,\\exp\\!\\left(-\\,\\frac{\\Phi_{i\\pm\\frac{1}{2}} - \\Phi_i}{c_s^2}\\right),\n$$\n这保证了对于任何实数势差，$p_{i\\pm\\frac{1}{2}}^{\\mathrm{eq}}  0$。在平衡状态下，整个区域内一致的单元中心状态在每个界面上产生相同的左、右重构值。有限体积更新中的引力源项为：\n$$\nS_i^{g} \\;=\\; -\\,\\frac{1}{V_i}\\int_{r_{i-\\frac{1}{2}}}^{r_{i+\\frac{1}{2}}} \\rho(r)\\,r^2\\,\\partial_r \\Phi(r) \\, dr,\n$$\n我们希望用一种基于边值的两点求积公式来替换它，形式如下：\n$$\nS_i^{g,\\mathrm{quad}} \\;=\\; -\\,\\frac{1}{V_i}\\,\\Big[w_{i-\\frac{1}{2}}\\,r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}} \\;+\\; w_{i+\\frac{1}{2}}\\,r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\Big],\n$$\n其中权重 $w_{i-\\frac{1}{2}}$ 和 $w_{i+\\frac{1}{2}}$ 是固定的，且与网格间距无关，使得对于任何非均匀网格，在流体静力平衡时，离散动量平衡都精确满足：\n$$\n\\frac{1}{V_i}\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) \\;+\\; S_i^{g,\\mathrm{quad}} \\;=\\; 0.\n$$\n推导这两个求积权重 $w_{i-\\frac{1}{2}}$ 和 $w_{i+\\frac{1}{2}}$ 的值，以确保当界面压力按指定方式进行流体静力重构时，上述离散的良好平衡（well-balance）能够精确成立。将你的最终答案表示为有序对 $\\left(w_{i-\\frac{1}{2}},\\,w_{i+\\frac{1}{2}}\\right)$ 的单一闭式解析表达式。无需四舍五入。", "solution": "用户希望为一个良好平衡的数值格式找到求积权重 $w_{i-\\frac{1}{2}}$ 和 $w_{i+\\frac{1}{2}}$。\n\n### 第1步：提取已知条件\n\n-   **离散平衡方程**：在流体静力平衡 ($u=0$) 时，单元 $i$ 中动量的有限体积更新必须为零。这表示为：\n    $$\n    \\frac{1}{V_i}\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) \\;+\\; S_i^{g,\\mathrm{quad}} \\;=\\; 0\n    $$\n-   **求积源项**：引力源项 $S_i^{g,\\mathrm{quad}}$ 使用单元界面上的两点求积来近似：\n    $$\n    S_i^{g,\\mathrm{quad}} \\;=\\; -\\,\\frac{1}{V_i}\\,\\Big[w_{i-\\frac{1}{2}}\\,r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}} \\;+\\; w_{i+\\frac{1}{2}}\\,r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\Big]\n    $$\n-   **流体静力界面压力**：单元界面上的压力 $p_{i\\pm\\frac{1}{2}}^{\\mathrm{eq}}$ 是根据基于等温状态方程的流体静力重构推导出来的。它们的具体形式已给出，但代数操作并不直接需要它，只需要知道它们是正的，并由平衡状态确定。\n-   **约束条件**：权重 $w_{i-\\frac{1}{2}}$ 和 $w_{i+\\frac{1}{2}}$ 必须是常数，与网格无关，以确保该平衡对于任何非均匀网格和任何有效的流体静力平衡状态都成立。\n\n### 第2步：使用提取的已知条件进行验证\n\n-   **科学基础（关键）**：该问题设置在计算天体物理学和双曲守恒律数值方法的既定框架内。它解决了一个基本问题：设计能够精确保持已知稳态解（良好平衡格式）的数值格式。所描述的方程和方法是该领域的标准。该问题在科学上是合理的。\n-   **适定性**：该问题提供了一个明确的目标（找到权重）和一个必须满足的特定代数条件。约束的数量与未知数的数量相匹配，表明存在唯一解。\n-   **客观性（关键）**：该问题以精确的数学语言表述，没有歧义或主观陈述。\n-   **其他缺陷**：该问题是自洽的、逻辑一致的，其设置对于手头的任务而言并非矛盾或不完整。这是一个标准的推导，并且并非微不足道。\n\n### 第3步：结论和行动\n\n该问题是**有效的**。我将继续推导解答。\n\n### 推导过程\n\n问题的核心是通过强制执行离散平衡条件来求解权重 $w_{i-\\frac{1}{2}}$ 和 $w_{i+\\frac{1}{2}}$。该条件指出，离散压力梯度项和离散引力源项之和必须为零。\n\n让我们从离散平衡方程开始：\n$$\n\\frac{1}{V_i}\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) \\;+\\; S_i^{g,\\mathrm{quad}} \\;=\\; 0\n$$\n现在，代入所给出的求积源项 $S_i^{g,\\mathrm{quad}}$ 的表达式：\n$$\n\\frac{1}{V_i}\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) - \\frac{1}{V_i}\\,\\Big[w_{i-\\frac{1}{2}}\\,r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}} \\;+\\; w_{i+\\frac{1}{2}}\\,r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\Big] \\;=\\; 0\n$$\n我们可以通过将方程两边同乘以单元体积 $V_i$ (恒不为零)来简化此方程：\n$$\n\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) - \\Big[w_{i-\\frac{1}{2}}\\,r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}} \\;+\\; w_{i+\\frac{1}{2}}\\,r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\Big] \\;=\\; 0\n$$\n为了求解权重，我们通过将与左侧界面 ($i-\\frac{1}{2}$) 和右侧界面 ($i+\\frac{1}{2}$) 相关的项进行分组来重新排列方程：\n$$\n\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}} - w_{i+\\frac{1}{2}}\\,r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\right) - \\left(r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}} + w_{i-\\frac{1}{2}}\\,r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) \\;=\\; 0\n$$\n提取公因式 $r_{i\\pm\\frac{1}{2}}^2\\,p_{i\\pm\\frac{1}{2}}^{\\mathrm{eq}}$：\n$$\n(1 - w_{i+\\frac{1}{2}})\\left(r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}\\right) - (1 + w_{i-\\frac{1}{2}})\\left(r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}\\right) \\;=\\; 0\n$$\n这个方程必须对*任何*非均匀网格（即任何有效的 $r_{i\\pm\\frac{1}{2}}$）和*任何*流体静力平衡配置（即与某个势 $\\Phi(r)$ 一致的任何一组有效的正压力 $p_{i\\pm\\frac{1}{2}}^{\\mathrm{eq}}$）都成立。项 $r_{i+\\frac{1}{2}}^2\\,p_{i+\\frac{1}{2}}^{\\mathrm{eq}}$ 和 $r_{i-\\frac{1}{2}}^2\\,p_{i-\\frac{1}{2}}^{\\mathrm{eq}}$ 通常不为零，并且不保证相等或具有固定比率。为了使这两个项的线性组合在所有这些条件下都为零，它们各自的系数必须恒等于零。\n\n这给了我们两个独立的方程：\n1.  右侧界面 ($i+\\frac{1}{2}$) 项的系数必须为零：\n    $$\n    1 - w_{i+\\frac{1}{2}} \\;=\\; 0\n    $$\n2.  左侧界面 ($i-\\frac{1}{2}$) 项的系数必须为零：\n    $$\n    1 + w_{i-\\frac{1}{2}} \\;=\\; 0\n    $$\n解这两个简单的关于权重的方程，得到：\n1.  从第一个方程：\n    $$\n    w_{i+\\frac{1}{2}} \\;=\\; 1\n    $$\n2.  从第二个方程：\n    $$\n    w_{i-\\frac{1}{2}} \\;=\\; -1\n    $$\n这些值是常数，满足了问题中它们必须与网格间距无关的约束条件。\n\n所求结果是有序对 $\\left(w_{i-\\frac{1}{2}},\\,w_{i+\\frac{1}{2}}\\right)$。\n推导出的值为 $w_{i-\\frac{1}{2}} = -1$ 和 $w_{i+\\frac{1}{2}} = 1$。\n因此，有序对是 $(-1, 1)$。", "answer": "$$\n\\boxed{\n\\begin{pmatrix} -1  1 \\end{pmatrix}\n}\n$$", "id": "3529805"}, {"introduction": "除了维持平衡态，保证物理量的正定性是设计稳健数值格式的另一大支柱。密度和压力等物理量本质上是正的，因此内部能量密度也必须保持非负。然而，对于辐射冷却等“刚性”源项，显式时间积分格式很容易违反这一物理约束，导致计算崩溃。这项实践将焦点转向正定性问题，要求你推导出在辐射冷却的显式更新中，为保证内部能量不出现负值所允许的最大时间步长。[@problem_id:3529793] 这个练习还促使我们思考，像冷却这样的物理过程是如何与流体静力学平衡的数值维持相互作用的。", "problem": "考虑一个计算天体物理流体动力学模拟中的单个单元格。该单元格内是自引力的光学薄等离子体，初始时处于离散静水平衡状态，引力加速度为$g$。气体遵循理想气体状态方程，绝热指数为$\\gamma$，平均分子量为$\\mu$（以质子质量为单位），氢质量分数为$X$，并具有固定的电离状态，使得电子数密度为$n_{e} = \\chi \\, n_{\\mathrm{H}}$，其中$\\chi$在冷却更新期间随时间保持恒定。该单元格的质量密度为$\\rho$，内能密度为$e$。辐射冷却在能量方程中作为一个刚性源项，其体积率为$q_{\\mathrm{cool}} = n_{e} \\, n_{\\mathrm{H}} \\, \\Lambda(T)$，其中$\\Lambda(T)$是仅取决于温度$T$的表格化冷却曲线。假设冷却源通过一个前向欧拉算子分裂步在子循环时间步$\\Delta t$上进行更新，其形式为$e^{n+1} = e^{n} - \\Delta t \\, q_{\\mathrm{cool}}(T(e^{n}))$，其中$T(e)$由理想气体定律得到，$e^{n}$是子步开始时的冷却前内能密度。\n\n仅从包含源项的能量守恒和理想气体定律出发，推导出一个显式的闭式表达式，用于表示最大允许冷却子步$\\Delta t_{\\max}$。该时间步需保证更新后的内能密度$e^{n+1} \\geq 0$的正性，并用$\\rho$、$e^{n}$、$\\gamma$、$\\mu$、$m_{p}$、$k_{B}$、$X$、$\\chi$以及在$T(e^{n})$处求值的$\\Lambda$来表示。您的最终表达式必须是完全符号化的闭式形式，且不包含任何未求值的极限或隐式定义。\n\n然后，简要解释在较大的流体动力学时间步$\\Delta t_{\\mathrm{hydro}}$内对冷却源项进行子循环，如何与在动量方程中维持引力的良好平衡离散化相互作用。具体说明在进行冷却子循环时，离散静水平衡是否以及在何种条件下可以被保持。未提供$\\Lambda(T)$的数值；将其视为一个通过查表得到的给定温度$T$的函数。最终答案必须仅为$\\Delta t_{\\max}$的单一解析表达式，且最终答案中不应出现任何讨论。如果您选择提供任何数值示例，请勿将其包含在最终答案中。如果需要任何近似，请陈述并证明其合理性，但最终需给出一个精确的符号表达式。如果出现任何中间角度量，请以弧度表示。最终答案无需四舍五入。", "solution": "该问题经评估是有效的，因为它科学地基于计算流体动力学的原理，问题设定良好，目标明确，且没有矛盾或含糊之处。它提出了一个关于刚性源项的数值处理及其与守恒律相互作用的标准而非平凡的问题。\n\n问题分为两部分。首先，我们必须为冷却源项的前向欧拉更新推导出一个最大允许时间步$\\Delta t_{\\max}$的显式表达式，该时间步保证更新后的内能密度具有正性。其次，我们必须解释这种冷却子循环与引力数值格式的良好平衡属性之间的相互作用。\n\n**第一部分：保持正性的时间步$\\Delta t_{\\max}$的推导**\n\n在辐射冷却作用下，内能密度$e$在一个子循环时间步$\\Delta t$内的更新规则由前向欧拉法给出：\n$$e^{n+1} = e^{n} - \\Delta t \\, q_{\\mathrm{cool}}(T(e^{n}))$$\n此处，$e^{n}$是子步开始时的内能密度，$e^{n+1}$是更新后的值，$q_{\\mathrm{cool}}$是体积冷却率，它是温度$T$的函数，而温度$T$本身又是$e^{n}$的函数。\n\n内能密度保持正性的条件是$e^{n+1} \\geq 0$。将更新规则代入此不等式，得到：\n$$e^{n} - \\Delta t \\, q_{\\mathrm{cool}}(T(e^{n})) \\geq 0$$\n假设在物理相关的场景中，冷却是活跃的（$q_{\\mathrm{cool}}  0$）且初始能量为正（$e^{n}  0$），我们可以重排不等式以求解$\\Delta t$：\n$$\\Delta t \\leq \\frac{e^{n}}{q_{\\mathrm{cool}}(T(e^{n}))}$$\n最大允许时间步$\\Delta t_{\\max}$是使此不等式饱和的时间步：\n$$\\Delta t_{\\max} = \\frac{e^{n}}{q_{\\mathrm{cool}}(T(e^{n}))}$$\n\n为获得显式表达式，我们必须用给定变量$\\rho$、$e^{n}$、$\\gamma$、$\\mu$、$m_{p}$、$k_{B}$、$X$和$\\chi$来表示$q_{\\mathrm{cool}}$及其自变量$T$。\n\n体积冷却率由$q_{\\mathrm{cool}} = n_{e} \\, n_{\\mathrm{H}} \\, \\Lambda(T)$给出，其中$n_{e}$是电子数密度，$n_{\\mathrm{H}}$是氢数密度，$\\Lambda(T)$是冷却函数。\n给定关系式$n_{e} = \\chi \\, n_{\\mathrm{H}}$。代入此式，我们得到：\n$$q_{\\mathrm{cool}} = \\chi \\, n_{\\mathrm{H}}^{2} \\, \\Lambda(T)$$\n氢数密度$n_{\\mathrm{H}}$与总质量密度$\\rho$和氢质量分数$X$有关。单位体积内的氢质量为$X \\rho$。数密度是该质量除以单个氢原子的质量，后者近似为质子质量$m_{p}$。\n$$n_{\\mathrm{H}} = \\frac{X \\rho}{m_{p}}$$\n将此代入$q_{\\mathrm{cool}}$的表达式中，得到：\n$$q_{\\mathrm{cool}} = \\chi \\left( \\frac{X \\rho}{m_{p}} \\right)^2 \\Lambda(T)$$\n\n接下来，我们将温度$T$与内能密度$e^{n}$联系起来。气体遵循理想气体状态方程。内能密度$e$通过以下方式与压强$P$相关：\n$$e = \\frac{P}{\\gamma - 1}$$\n其中$\\gamma$是绝热指数。压强由理想气体定律给出：\n$$P = n_{\\mathrm{tot}} k_{B} T$$\n其中$n_{\\mathrm{tot}}$是所有粒子（离子和电子）的总数密度，$k_{B}$是玻尔兹曼常数。\n总数密度$n_{\\mathrm{tot}}$可以用质量密度$\\rho$和平均分子量$\\mu$来表示。每个粒子的平均质量为$\\mu m_{p}$。因此：\n$$n_{\\mathrm{tot}} = \\frac{\\rho}{\\mu m_{p}}$$\n结合这些关系，我们可以用$T$来表示$e$：\n$$e = \\frac{1}{\\gamma - 1} \\left( \\frac{\\rho}{\\mu m_{p}} \\right) k_{B} T$$\n现在我们可以反转这个关系，以找到在子步开始时对应于内能密度$e^{n}$的温度$T$：\n$$T(e^{n}) = \\frac{(\\gamma - 1) \\mu m_{p} e^{n}}{\\rho k_{B}}$$\n\n现在我们拥有构建$\\Delta t_{\\max}$最终表达式所需的所有部分。我们将$q_{\\mathrm{cool}}$和$T(e^{n})$的表达式代入$\\Delta t_{\\max}$的公式中：\n$$\\Delta t_{\\max} = \\frac{e^{n}}{q_{\\mathrm{cool}}(T(e^{n}))} = \\frac{e^{n}}{\\chi \\left( \\frac{X \\rho}{m_{p}} \\right)^2 \\Lambda\\left(T(e^{n})\\right)}$$\n代入$T(e^{n})$的表达式：\n$$\\Delta t_{\\max} = \\frac{e^{n}}{\\chi \\left( \\frac{X \\rho}{m_{p}} \\right)^2 \\Lambda\\left(\\frac{(\\gamma - 1) \\mu m_{p} e^{n}}{\\rho k_{B}}\\right)}$$\n化简分母，得到最终的闭式表达式：\n$$\\Delta t_{\\max} = \\frac{e^{n} m_{p}^{2}}{\\chi X^{2} \\rho^{2} \\Lambda\\left(\\frac{(\\gamma - 1) \\mu m_{p} e^{n}}{\\rho k_{B}}\\right)}$$\n这是前向欧拉冷却更新的最大时间步，可保证更新后的内能密度$e^{n+1}$保持非负。\n\n**第二部分：冷却子循环与良好平衡属性的相互作用**\n\n一个用于处理带引力的流体动力学的数值格式被称为“良好平衡的”，如果它能以机器精度维持离散版本的静水平衡（HSE）。在一个连续的一维系统中，HSE是压强梯度力与引力完全抵消的状态：$\\frac{dP}{dz} = \\rho g$。一个良好平衡的格式确保对于满足此平衡离散模拟的初始条件，不会因数值截断误差而产生虚假的速度。\n\n问题描述了一种算子分裂方法，其中冷却源项与主流体动力学更新分开处理，可能在更小的时间步长上进行（“子循环”）。按其表述，冷却更新仅作用于能量方程：\n$$e \\to e' = e - \\Delta t_{\\mathrm{cool}} \\, q_{\\mathrm{cool}}$$\n在此步骤中，质量密度$\\rho$、动量$\\rho \\mathbf{v}$以及速度$\\mathbf{v}$保持不变。\n\n压强$P$通过$P = (\\gamma-1)e$与内能密度直接相关。因此，减少$e$的冷却步骤也会降低压强：\n$$P \\to P' = (\\gamma-1)e'  P$$\n假设初始状态处于离散HSE，这意味着动量方程中的压强梯度项被引力源项所平衡。在冷却步骤之后，质量密度$\\rho$不变，因此引力源项也保持不变。然而，整个区域内的压强$P$已经降低（在$q_{\\mathrm{cool}}  0$的任何地方）。这意味着压强梯度$\\nabla P$也会发生变化。\n\n原有的平衡被打破。具有较低压强的新状态不再处于静水平衡中。压强梯度力现在弱于引力。因此，在随后的流体动力学步骤中，会有一个净向下的力，良好平衡的格式将正确计算由此产生的加速度，导致气体收缩或坍塌。\n\n因此，对冷却源项进行子循环**不能**保持离散静水平衡。这不是一个数值上的失败，而是对物理过程的正确表示：辐射冷却从自引流体中移除了热压强支撑，从而引发引力不稳定性和坍塌。\n\nHSE能够被保持的唯一假设条件是，冷却以一种不改变压强梯度的方式改变压强，即$\\nabla P' = \\nabla P$。由于$P' = P - (\\gamma-1)\\Delta t_{\\mathrm{cool}} q_{\\mathrm{cool}}$，这将要求$\\nabla q_{\\mathrm{cool}} = 0$。在一个处于HSE中的分层大气中，密度$\\rho$和温度$T$通常都随位置变化，所以$q_{\\mathrm{cool}} = \\chi (\\frac{X \\rho}{m_p})^2 \\Lambda(T)$也会有非零梯度。因此，HSE从根本上被冷却过程打破了。\n\n在这种情况下，良好平衡格式的目的是确保初始平衡状态在*没有物理扰动*的情况下得以维持，并确保对像冷却这样的物理扰动的动力学响应能够被精确计算，而不会被由大项的不完美平衡所产生的虚假数值力所污染。", "answer": "$$\\boxed{\\frac{e^{n} m_{p}^{2}}{\\chi X^{2} \\rho^{2} \\Lambda\\left(\\frac{(\\gamma - 1) \\mu m_{p} e^{n}}{\\rho k_{B}}\\right)}}$$", "id": "3529793"}, {"introduction": "守恒性和正定性这两个原则在计算区域的边界处尤为关键，因为信息正是通过边界流入或流出模拟系统。不恰当的边界处理是数值模拟中最常见的误差来源之一。这项练习作为一个综合性的实践，将前面两个概念融会贯通，要求你为一个分层大气模型实现一个实用的边界条件。你需要处理流体的流入和流出两种情况，同时确保状态量的正定性，并维持离散的流体静力学平衡。[@problem_id:3529762] 这项任务将理论原则与具体的编码实践相结合，让你深入理解如何通过审慎地向“虚拟网格”中外插数据来构建稳定而精确的边界。", "problem": "您的任务是为带恒定垂直重力加速度的一维可压缩欧拉方程设计并实现一个保正且静力平衡的边界条件。考虑一个间距为 $\\Delta x$ 的均匀网格，将第一个内部单元标记为索引 $i=1$（中心位于 $z=\\Delta x/2$），并将左边界外的单个虚拟单元标记为索引 $i=0$（中心位于 $z=-\\Delta x/2$）。重力指向下方，大小为 $g0$。所有量均为无量纲化；无需物理单位。\n\n控制方程为带有重力源项的可压缩欧拉方程，并由理想气体状态方程 (EOS) 封闭：\n- 质量: $\\partial_t \\rho + \\partial_z (\\rho u) = 0$,\n- 动量: $\\partial_t (\\rho u) + \\partial_z (\\rho u^2 + p) = -\\rho g$,\n- 能量: $\\partial_t E + \\partial_z \\left((E+p)u\\right) = -\\rho g u$,\n- 状态方程 (EOS): $p = (\\gamma - 1)\\left(E - \\tfrac{1}{2}\\rho u^2\\right)$,\n\n其中 $\\rho$ 是密度，$u$ 是垂直速度，$p$ 是压力，$E$ 是总能量密度，$\\gamma1$ 是比热比。\n\n静力平衡由 $\\partial_z p = -\\rho g$ 定义。在小距离 $\\Delta x$ 上的局部等温静力延拓可以使用局部标高 $H = p/(\\rho g)$ 来表示，该标高在此距离上被视为局部常数。在此近似下，从单元 $i=1$ 中心位移 $\\pm \\Delta x$ 时，静力延拓满足 $p \\propto \\exp(-z/H)$ 和 $\\rho \\propto \\exp(-z/H)$，因此 $p$ 和 $\\rho$ 都按相同的指数因子变化。\n\n您必须构建一个满足以下条件的左边界条件：\n- 保正性：虚拟单元的状态满足 $\\rho_{0}  0$，$p_{0}  0$ 和 $E_{0}  0$；以及\n- 当内部和边界蓄流区静力一致时，在离散层面上是静力平衡的。\n\n该构建使用以下原则：\n- 流出情况（流体在左边界流出计算域）：如果内部速度为非负，$u_{1} \\ge 0$，则使用内部局部标高 $H_{1} = p_{1}/(\\rho_{1} g)$ 从单元 $i=1$ 向虚拟单元进行静力外推：\n  - $\\rho_{0} = \\rho_{1}\\,\\exp(\\Delta x/H_{1})$,\n  - $p_{0} = p_{1}\\,\\exp(\\Delta x/H_{1})$,\n  - $u_{0} = u_{1}$,\n  并设置 $E_{0} = p_{0}/(\\gamma-1) + \\tfrac{1}{2}\\rho_{0} u_{0}^2$。\n- 流入情况（流体在左边界进入计算域）：如果 $u_{1}  0$，则施加一个从在边界界面 $z=0$ 处指定的边界蓄流区状态进行的静力延拓。设 $(\\rho_{\\mathrm{ref}}, u_{\\mathrm{ref}}, p_{\\mathrm{ref}})$ 为 $z=0$ 处的蓄流区值，并定义 $H_{\\mathrm{ref}} = p_{\\mathrm{ref}}/(\\rho_{\\mathrm{ref}} g)$。虚拟单元的中心位于 $z=-\\Delta x/2$，因此设置\n  - $\\rho_{0} = \\rho_{\\mathrm{ref}}\\,\\exp(\\Delta x/(2 H_{\\mathrm{ref}}))$,\n  - $p_{0} = p_{\\mathrm{ref}}\\,\\exp(\\Delta x/(2 H_{\\mathrm{ref}}))$,\n  - $u_{0} = u_{\\mathrm{ref}}$,\n  和 $E_{0} = p_{0}/(\\gamma-1) + \\tfrac{1}{2}\\rho_{0} u_{0}^2$。\n\n为测试离散静力平衡，使用跨越单元 $i=0$ 和 $i=1$ 之间界面的压力梯度/源项平衡的对数平均离散化。将两个正数 $a$ 和 $b$ 的对数平均定义为\n$$\nL(a,b) = \\begin{cases} a,  a=b, \\\\ [4pt] \\dfrac{a-b}{\\ln a - \\ln b},  a \\ne b. \\end{cases}\n$$\n静力平衡的离散残差为\n$$\n\\mathcal{R} = (p_{1} - p_{0}) + g\\,\\Delta x\\,L(\\rho_{1}, \\rho_{0}).\n$$\n对于局部指数静力延拓（在 $\\Delta x$ 上 $H$ 为常数），在精确算术中，$\\mathcal{R}$ 精确等于 0。\n\n您的程序必须对下面列出的每个测试用例，使用上述规则构建 $(\\rho_{0}, u_{0}, p_{0}, E_{0})$，验证保正性，计算残差 $\\mathcal{R}$，并按以下顺序为每个测试输出两项：\n- 一个布尔值，指示 $\\rho_{0}$、$p_{0}$ 和 $E_{0}$ 是否都严格为正；以及\n- 绝对值 $|\\mathcal{R}|$，作为一个浮点数。\n\n所有测试的最终输出必须是单行，包含一个扁平列表，其条目顺序为 $[\\text{pos}_{1}, |\\mathcal{R}_{1}|, \\text{pos}_{2}, |\\mathcal{R}_{2}|, \\dots]$。\n\n使用以下测试套件。在每个测试中，输入数据为 $(\\gamma, g, \\Delta x, \\rho_{1}, u_{1}, p_{1}, \\rho_{\\mathrm{ref}}, u_{\\mathrm{ref}}, p_{\\mathrm{ref}})$；仅当 $u_{1}  0$ 时才使用蓄流区值。\n\n- 测试 1（流出，静力外推）：\n  - $\\gamma = 1.4$, $g = 0.5$, $\\Delta x = 0.1$,\n  - $\\rho_{1} = 2.0$, $u_{1} = 0.0$, $p_{1} = 1.0$,\n  - $\\rho_{\\mathrm{ref}} = 1.0$, $u_{\\mathrm{ref}} = 0.0$, $p_{\\mathrm{ref}} = 1.0$.\n- 测试 2（流入，蓄流区与内部静力状态一致）：\n  - $\\gamma = 1.4$, $g = 0.5$, $\\Delta x = 0.1$,\n  - $\\rho_{1} = 1.409119593$, $u_{1} = -0.2$, $p_{1} = 0.563647837$,\n  - $\\rho_{\\mathrm{ref}} = 1.5$, $u_{\\mathrm{ref}} = -0.1$, $p_{\\mathrm{ref}} = 0.6$.\n- 测试 3（流入，内部与蓄流区状态严重不匹配）：\n  - $\\gamma = 1.4$, $g = 1.0$, $\\Delta x = 0.2$,\n  - $\\rho_{1} = 1.0$, $u_{1} = -1.0$, $p_{1} = 1.0$,\n  - $\\rho_{\\mathrm{ref}} = 0.3$, $u_{\\mathrm{ref}} = -2.0$, $p_{\\mathrm{ref}} = 0.05$.\n- 测试 4（流出，小标高和极小的密度/压力）：\n  - $\\gamma = 1.4$, $g = 1000.0$, $\\Delta x = 0.05$,\n  - $\\rho_{1} = 1.0\\times 10^{-8}$, $u_{1} = 0.1$, $p_{1} = 1.0\\times 10^{-6}$,\n  - $\\rho_{\\mathrm{ref}} = 1.0\\times 10^{-8}$, $u_{\\mathrm{ref}} = 0.0$, $p_{\\mathrm{ref}} = 1.0\\times 10^{-6}$.\n\n您的程序应生成单行输出，其中包含结果，格式为用方括号括起的逗号分隔列表，顺序为 $[\\text{pos}_{1}, |\\mathcal{R}_{1}|, \\text{pos}_{2}, |\\mathcal{R}_{2}|, \\text{pos}_{3}, |\\mathcal{R}_{3}|, \\text{pos}_{4}, |\\mathcal{R}_{4}|]$。", "solution": "该问题要求为带恒定重力加速度的一维可压缩欧拉方程设计、实现并验证一个保正且静力平衡的边界条件。其背景是有限体积数值格式。我们将首先阐明指定边界条件算法背后的原理，然后将其应用于四个提供的测试用例以计算所需的输出。\n\n控制方程是用于描述恒定加速度 $g0$ 重力场中可压缩理想气体的欧拉方程。计算单元 $i$ 中的状态由密度 $\\rho_i$、垂直速度 $u_i$ 和压力 $p_i$ 等原始变量描述。相应的总能量密度由理想气体状态方程给出：$E_i = p_i/(\\gamma-1) + \\frac{1}{2}\\rho_i u_i^2$，其中 $\\gamma1$ 是比热比。边界条件的目的是基于第一个内部单元 $i=1$ 的状态来定义索引为 $i=0$ 的“虚拟”单元中的状态 $(\\rho_0, u_0, p_0, E_0)$。\n\n算法过程分为两种互斥情况，由边界处的流体流动方向决定，该方向由第一个内部单元中的速度 $u_1$ 的符号指示。\n\n情况 1：流出 ($u_1 \\ge 0$)\n这种情况模拟流体离开计算域。虚拟单元状态由内部单元 $i=1$ 的静力外推确定。这假设计算域外的状态是计算域内状态的连续静力延伸。假定在分隔单元 $i=1$ 和单元 $i=0$ 中心的距离 $\\Delta x$ 上为常数的局部标高，计算如下：\n$$ H_1 = \\frac{p_1}{\\rho_1 g} $$\n虚拟单元位于相对于单元 1 垂直距离为 $-\\Delta x$ 的位置，其密度和压力通过沿指数剖面向上（抵抗重力）移动得到：\n$$ \\rho_0 = \\rho_1 \\exp\\left(\\frac{\\Delta x}{H_1}\\right) $$\n$$ p_0 = p_1 \\exp\\left(\\frac{\\Delta x}{H_1}\\right) $$\n速度从内部复制而来，与开放或“零梯度”流出条件一致：$u_0 = u_1$。考虑到为具有物理意义，输入状态必须满足 $p_1  0$ 和 $\\rho_1  0$，并且指数函数始终为正，因此得到的 $\\rho_0$ 和 $p_0$ 也将严格为正。然后，虚拟单元的总能量通过状态方程的重新排列计算得出：\n$$ E_0 = \\frac{p_0}{\\gamma-1} + \\frac{1}{2}\\rho_0 u_0^2 $$\n由于 $\\gamma1$、$p_0  0$ 且 $\\rho_0  0$，可以保证 $E_0  0$。因此，这种构建方法是内在保正的。\n\n情况 2：流入 ($u_1  0$)\n这种情况模拟流体进入计算域。必须指定流入流体的状态。虚拟单元状态由在边界界面 $z=0$ 处定义的给定蓄流区状态 $(\\rho_{\\mathrm{ref}}, u_{\\mathrm{ref}}, p_{\\mathrm{ref}})$ 的静力延拓确定。蓄流区的静力标高为：\n$$ H_{\\mathrm{ref}} = \\frac{p_{\\mathrm{ref}}}{\\rho_{\\mathrm{ref}} g} $$\n虚拟单元的中心位于 $z_0 = -\\Delta x/2$。密度和压力从 $z=0$ 处的蓄流区外推到此位置：\n$$ \\rho_0 = \\rho_{\\mathrm{ref}} \\exp\\left(\\frac{-\\Delta z}{H_{\\mathrm{ref}}}\\right) = \\rho_{\\mathrm{ref}} \\exp\\left(\\frac{-(- \\Delta x / 2)}{H_{\\mathrm{ref}}}\\right) = \\rho_{\\mathrm{ref}} \\exp\\left(\\frac{\\Delta x}{2 H_{\\mathrm{ref}}}\\right) $$\n$$ p_0 = p_{\\mathrm{ref}} \\exp\\left(\\frac{\\Delta x}{2 H_{\\mathrm{ref}}}\\right) $$\n速度设置为指定的流入速度：$u_0 = u_{\\mathrm{ref}}$。然后像流出情况一样计算能量 $E_0$。如果指定的蓄流区状态满足 $\\rho_{\\mathrm{ref}}  0$ 和 $p_{\\mathrm{ref}}  0$，则可以保证 $(\\rho_0, p_0, E_0)$ 的正性。\n\n对于每个测试用例，在计算出 $(\\rho_0, u_0, p_0, E_0)$ 后，我们验证其正性并计算离散静力平衡残差 $\\mathcal{R}$。该残差是使用静力平衡方程 $\\partial_z p = -\\rho g$ 在单元 0 和 1 之间界面的特定空间离散化来定义的：\n$$ \\mathcal{R} = (p_1 - p_0) + g\\,\\Delta x\\,L(\\rho_1, \\rho_0) $$\n其中 $L(a,b)$ 是对数平均。一个“良好平衡”的数值格式是指能够精确维持控制方程已知稳态解的格式。在这里，我们测试边界条件的构建是否使得在存在静力状态时，离散压力梯度和重力源项能够完全相互抵消。这种使用对数平均的特定 $\\mathcal{R}$ 形式被设计为对于局部等温大气（这是静力外推中使用的假设）精确为零。\n\n我们现在将此过程应用于每个测试用例。\n\n测试 1：流出。给定 $\\gamma = 1.4$，$g = 0.5$，$\\Delta x = 0.1$，$\\rho_1 = 2.0$，$u_1 = 0.0$，$p_1 = 1.0$。\n由于 $u_1=0.0 \\ge 0$，我们使用流出规则。\n标高：$H_1 = p_1 / (\\rho_1 g) = 1.0 / (2.0 \\times 0.5) = 1.0$。\n虚拟单元状态：\n$\\rho_0 = 2.0 \\exp(0.1 / 1.0) \\approx 2.21034$。\n$p_0 = 1.0 \\exp(0.1 / 1.0) \\approx 1.10517$。\n$u_0 = u_1 = 0.0$。\n$E_0 = p_0/(1.4 - 1.0) + 0.5 \\rho_0 u_0^2 = p_0/0.4 \\approx 2.76293$。\n正性：$\\rho_0  0$，$p_0  0$，$E_0  0$。全部为真。\n残差：通过直接代入可以看出，通过指数公式从 $(\\rho_1, p_1)$ 构建 $(\\rho_0, p_0)$ 以及使用对数平均定义残差 $\\mathcal{R}$ 的方法，被设计为在这种情况下精确产生 $\\mathcal{R}=0$。\n\n测试 2：流入。给定 $u_1 = -0.2  0$，我们使用流入规则，蓄流区值为 $\\rho_{\\mathrm{ref}} = 1.5$，$u_{\\mathrm{ref}} = -0.1$，$p_{\\mathrm{ref}} = 0.6$。同时 $g=0.5$，$\\Delta x=0.1$。\n蓄流区标高：$H_{\\mathrm{ref}} = p_{\\mathrm{ref}} / (\\rho_{\\mathrm{ref}} g) = 0.6 / (1.5 \\times 0.5) = 0.8$。\n虚拟单元状态：\n$\\rho_0 = 1.5 \\exp(0.1 / (2 \\times 0.8)) = 1.5 \\exp(0.0625) \\approx 1.59604$。\n$p_0 = 0.6 \\exp(0.1 / (2 \\times 0.8)) = 0.6 \\exp(0.0625) \\approx 0.63842$。\n$u_0 = u_{\\mathrm{ref}} = -0.1$。\n$E_0 = p_0/0.4 + 0.5 \\rho_0 u_0^2 \\approx 0.63842/0.4 + 0.5 \\times 1.59604 \\times (-0.1)^2 \\approx 1.60403$。\n满足正性。内部状态 $(\\rho_1, p_1)$ 给出为 $(1.409119593, 0.563647837)$。这些值对应于与蓄流区一致的静力状态，因为 $p_{\\mathrm{ref}} \\exp(-\\Delta x / (2 H_{\\mathrm{ref}})) = 0.6 \\exp(-0.0625) \\approx 0.563647837 = p_1$，密度也类似。因此，单元 0 和单元 1 的状态位于同一指数静力剖面上。根据构造，残差 $\\mathcal{R}$ 必须为零。\n\n测试 3：流入。给定 $u_1 = -1.0  0$，我们使用流入规则。\n内部状态 $(\\rho_1=1.0, p_1=1.0)$ 与蓄流区状态 $(\\rho_{\\mathrm{ref}}=0.3, p_{\\mathrm{ref}}=0.05)$ 并非静力一致。我们预期会有一个非零残差 $\\mathcal{R}$，因为边界处的有限体积会受到一个净力。虚拟单元状态由蓄流区计算得出，由于蓄流区值为正，因此满足正性。\n\n测试 4：流出。给定 $u_1 = 0.1 > 0$，我们使用流出规则。大气参数更为极端，重力 $g=1000.0$ 很大，而压力很小，导致标高很小，$H_1 = 1.0\\times 10^{-6} / (1.0\\times 10^{-8} \\times 1000.0) = 0.1$。这表明这是一个强分层大气。\n$\\rho_0 = 10^{-8} \\exp(0.05 / 0.1) = 10^{-8} \\exp(0.5) \\approx 1.6487 \\times 10^{-8}$。\n$p_0 = 10^{-6} \\exp(0.5) \\approx 1.6487 \\times 10^{-6}$。\n$u_0 = 0.1$。\n$E_0$ 将为正。由于这是一个使用静力外推的流出情况，该构造保证了离散静力平衡得到满足，因此 $\\mathcal{R}$ 应为零（在机器精度范围内）。\n\n最终答案中的实现将遵循对每个测试用例的这些计算。", "answer": "```python\nimport numpy as np\n\ndef log_mean(a, b):\n    \"\"\"\n    Computes the logarithmic mean of two positive numbers a and b.\n    L(a,b) = (a - b) / (ln(a) - ln(b)) for a != b\n    L(a,a) = a\n    \"\"\"\n    # Use np.isclose for robust floating-point comparison to handle the a == b case.\n    if np.isclose(a, b):\n        return a\n    else:\n        return (a - b) / (np.log(a) - np.log(b))\n\ndef solve():\n    \"\"\"\n    Solves the problem for the given test cases.\n    \"\"\"\n    # Test cases as tuples:\n    # (gamma, g, dx, rho_1, u_1, p_1, rho_ref, u_ref, p_ref)\n    test_cases = [\n        (1.4, 0.5, 0.1, 2.0, 0.0, 1.0, 1.0, 0.0, 1.0),\n        (1.4, 0.5, 0.1, 1.409119593, -0.2, 0.563647837, 1.5, -0.1, 0.6),\n        (1.4, 1.0, 0.2, 1.0, -1.0, 1.0, 0.3, -2.0, 0.05),\n        (1.4, 1000.0, 0.05, 1.0e-8, 0.1, 1.0e-6, 1.0e-8, 0.0, 1.0e-6)\n    ]\n\n    results = []\n\n    for case in test_cases:\n        gamma, g, dx, rho_1, u_1, p_1, rho_ref, u_ref, p_ref = case\n        \n        rho_0, u_0, p_0, E_0 = 0.0, 0.0, 0.0, 0.0\n\n        if u_1 >= 0:  # Outflow case\n            # Hydrostatic extrapolation from cell i=1\n            H_1 = p_1 / (rho_1 * g)\n            exp_factor = np.exp(dx / H_1)\n            rho_0 = rho_1 * exp_factor\n            p_0 = p_1 * exp_factor\n            u_0 = u_1\n            \n        else:  # Inflow case (u_1  0)\n            # Hydrostatic continuation from reservoir state at z=0\n            H_ref = p_ref / (rho_ref * g)\n            exp_factor = np.exp(dx / (2.0 * H_ref))\n            rho_0 = rho_ref * exp_factor\n            p_0 = p_ref * exp_factor\n            u_0 = u_ref\n\n        # Calculate energy density for the ghost cell\n        E_0 = p_0 / (gamma - 1.0) + 0.5 * rho_0 * u_0**2\n\n        # 1. Verify positivity of the constructed ghost cell state\n        is_positive = rho_0 > 0 and p_0 > 0 and E_0 > 0\n        results.append(is_positive)\n\n        # 2. Compute the discrete hydrostatic balance residual\n        residual = (p_1 - p_0) + g * dx * log_mean(rho_1, rho_0)\n        results.append(abs(residual))\n\n    # Format the final output as a single string.\n    # str(True) becomes 'True', str(False) becomes 'False'.\n    # This matches the implicit format requirements.\n    print(f\"[{','.join(map(str, results))}]\")\n\nsolve()\n```", "id": "3529762"}]}