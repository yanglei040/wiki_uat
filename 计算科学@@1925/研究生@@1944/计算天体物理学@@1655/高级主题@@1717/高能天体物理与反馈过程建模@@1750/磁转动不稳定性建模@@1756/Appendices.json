{"hands_on_practices": [{"introduction": "任何可靠的数值模拟都必须尊重基本的物理守恒定律。这项练习旨在为剪切箱（shearing-box）模型构建一个守恒型有限体积格式，从而提供一个基础性的实践。练习的重点是正确地实现源项，并验证包括剪切所做的功在内的总能量是否能够达到机器精度的守恒，这是确保模拟物理真实性的关键第一步 [@problem_id:3521855]。", "problem": "您需要为一个吸积盘的局部剪切箱模型设计并实现一种用于可压缩理想磁流体动力学（MHD）的守恒有限体积离散化方法，以验证动能、磁能和热能分量之间的能量交换是平衡的，同时正确应用模拟磁转动不稳定性（MRI）物理的剪切源项。您的求解必须从第一性原理出发：沿径向坐标写出守恒形式的一维理想MHD方程组，从守恒律推导通量，并构建与剪切箱近似和能量计算相一致的源项。然后，在代码中实现最终的更新步骤，并对一个测试套件进行离散能量平衡的定量评估。\n\n从理想MHD的守恒形式和剪切箱方程开始。在一个以角速度$\\Omega$共转、剪切参数为$q$的局部坐标系中，将每个单元的守恒状态向量定义为$U = [\\rho, m_x, m_y, m_z, B_x, B_y, B_z, E]$，其中$\\rho$是质量密度，$\\boldsymbol{m} = \\rho \\boldsymbol{v}$是动量密度，$\\boldsymbol{B}$是磁场，$E$是总能量密度。热力学压力$p$通过理想气体关系$p = (\\gamma - 1) e_{\\mathrm{th}}$从内能密度$e_{\\mathrm{th}}$中求得，其中$\\gamma$是绝热指数。总能量密度为$E = e_{\\mathrm{th}} + \\tfrac{1}{2}\\rho |\\boldsymbol{v}|^2 + \\tfrac{1}{2}|\\boldsymbol{B}|^2$。方程在$x$（径向）方向上以有限体积的方式进行离散，采用周期性边界条件，没有外部边界。\n\n使用与守恒积分形式一致的局部黎曼求解器近似。一个稳健的选择是Lax–Friedrichs（Rusanov）通量，其中单元$i$和$i+1$之间的单元间数值通量$F_{i+\\tfrac{1}{2}}$是根据左、右状态$U_L$和$U_R$，使用物理MHD通量和超过所有特征波速的单个耗散速度$a_{\\max}$计算得出的。每个单元$i$在一个时间步长$\\Delta t$内的更新由一个守恒的通量散度项和具有物理动机的源项给出，\n$$\nU_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+\\tfrac{1}{2}}^n - F_{i-\\tfrac{1}{2}}^n\\right) + \\Delta t\\, S(U_i^n).\n$$\n\n模拟代表科里奥利效应和潮汐效应对动量的影响以及背景剪切对感应方程影响的剪切箱源项。在具有局部角速度$\\Omega$和剪切参数$q$的剪切箱近似中，动量源项为\n$$\nS_{m_x} = 2 \\rho \\Omega v_y,\\quad\nS_{m_y} = - (2 - q)\\rho \\Omega v_x,\\quad\nS_{m_z} = 0,\n$$\n代表背景剪切的感应源项为\n$$\nS_{B_y} = - q \\Omega B_x, \\quad S_{B_x} = 0,\\quad S_{B_z} = 0.\n$$\n通过在能量源项中包含相应的功项，确保总能量的一致性，\n$$\nS_E = \\boldsymbol{v}\\cdot \\boldsymbol{S}_m + \\boldsymbol{B}\\cdot \\boldsymbol{S}_B.\n$$\n请注意，科里奥利力不做功，即$\\boldsymbol{v}\\cdot(2\\boldsymbol{\\Omega}\\times\\boldsymbol{v}) = 0$，并且磁能的源项必须是$S_{E,\\mathrm{mag}} = \\boldsymbol{B}\\cdot \\boldsymbol{S}_B$，以捕捉背景剪切对磁场做的功。您必须从守恒律中推导出一维理想MHD沿$x$方向的物理通量，并在数值通量中使用它们。\n\n所有变量都已无量纲化并以代码单位表示，因此不需要进行物理单位转换。角度没有显式出现，因此不需要指定角度单位。\n\n使用一个具有$N$个单元的均匀网格、域长度$L$和周期性边界，在单个程序中实现该算法。使用一个全局时间步长$\\Delta t$，该步长满足基于最大估计快波信号速度的Courant条件，并且也足够小以稳定地积分源项。从初始条件执行一个显式时间步，以评估离散能量平衡。对于每个测试用例，计算定义的残余能量不平衡量\n$$\nR = \\left(\\sum_i E_i^{n+1}\\right) - \\left(\\sum_i E_i^{n}\\right) - \\Delta t \\left(\\sum_i S_{E,i}\\right),\n$$\n如果离散化平衡了动能、磁能和热能分量之间的能量交换，并且源项功被一致地应用，该值应近似为零。将残差表示为浮点数。\n\n测试套件：\n使用以下四个测试用例来探究离散化的不同方面。所有量都在无量纲代码单位中，并且所有情况都使用$L = 1$和周期性边界条件。在每种情况下，使用$N = 64$个单元，$\\gamma = \\tfrac{5}{3}$，并根据Courant因子$C = 0.3$和最大特征速度计算$\\Delta t$，同时还要受源项时间尺度的限制。\n\n- 案例1（理想情况，无剪切）：$\\Omega = 1$， $q = 0$。均匀初始状态，其中$\\rho = 1$, $p = 1$, $v_x = 0.3$, $v_y = 0.2$, $v_z = 0$, $B_x = 0$, $B_y = 0$, $B_z = 0$。\n- 案例2（有磁能功的剪切感应）：$\\Omega = 1$， $q = \\tfrac{3}{2}$。均匀初始状态，其中$\\rho = 1$, $p = 1$, $v_x = 0$, $v_y = 0$, $v_z = 0$, $B_x = 0.5$, $B_y = 0.3$, $B_z = 0$。\n- 案例3（压力功交换，流体动力学压缩流）：$\\Omega = 0$, $q = 0$。初始状态，其中$\\rho(x) = 1$, $p(x) = 1$, $B_x = 0$, $B_y = 0$, $B_z = 0$, $v_x(x) = 0.5\\sin(2\\pi x)$, $v_y(x) = 0$, $v_z(x) = 0$。\n- 案例4（磁张力交换）：$\\Omega = 0$, $q = 0$。初始状态，其中$\\rho(x) = 1$, $p(x) = 1$, $v_x(x) = 0$, $v_y(x) = 0.3\\cos(2\\pi x)$, $v_z(x) = 0$, $B_x = 0.5$, $B_y(x) = 0.2\\sin(2\\pi x)$, $B_z(x) = 0$。\n\n最终输出格式：\n您的程序应生成单行输出，其中包含四个测试用例的残余能量不平衡量，形式为方括号内以逗号分隔的列表，顺序与上面列出的案例一致。例如，输出必须如下所示\n$$\n[\\text{residual}_1,\\text{residual}_2,\\text{residual}_3,\\text{residual}_4].\n$$\n每个残差必须是一个浮点数。不应打印任何其他文本。", "solution": "该问题陈述清晰，具有科学依据，并提供了构建数值解所需的所有信息。它代表了包含剪切箱源项的磁流体动力学（MHD）代码的一个标准验证测试。任务是实现一个一维有限体积格式并验证其能量守恒性质。我们将首先从第一性原理推导必要的方程，然后概述实现算法。\n\n### 1. 理想MHD方程与剪切箱模型\n\n该问题在一个局部的、共转的笛卡尔坐标系$(x, y, z)$中定义，该坐标系分别对应于吸积盘中的径向、方位角向和垂直方向。理想MHD方程以守恒形式表示，$\\frac{\\partial U}{\\partial t} + \\frac{\\partial F}{\\partial x} = S$，其中$U$是守恒量向量，$F$是$x$方向的通量向量，$S$是源项向量。\n\n每单位体积的守恒量状态向量由下式给出：\n$$\nU = [\\rho, m_x, m_y, m_z, B_x, B_y, B_z, E]^T\n$$\n其中$\\rho$是质量密度，$\\boldsymbol{m} = \\rho\\boldsymbol{v}$是动量密度，$\\boldsymbol{B}$是磁场，$E$是总能量密度。\n\n原始变量$(\\rho, \\boldsymbol{v}, p, \\boldsymbol{B})$从守恒状态$U$中恢复如下：\n- 质量密度：$\\rho = U_1$\n- 速度：$\\boldsymbol{v} = (v_x, v_y, v_z) = (\\frac{m_x}{\\rho}, \\frac{m_y}{\\rho}, \\frac{m_z}{\\rho}) = (\\frac{U_2}{U_1}, \\frac{U_3}{U_1}, \\frac{U_4}{U_1})$\n- 磁场：$\\boldsymbol{B} = (B_x, B_y, B_z) = (U_5, U_6, U_7)$\n\n总能量密度$E$是内能（热能）、动能和磁能之和：\n$$\nE = e_{\\mathrm{th}} + \\frac{1}{2}\\rho|\\boldsymbol{v}|^2 + \\frac{1}{2}|\\boldsymbol{B}|^2 = e_{\\mathrm{th}} + \\frac{|\\boldsymbol{m}|^2}{2\\rho} + \\frac{|\\boldsymbol{B}|^2}{2}\n$$\n因此，内能密度$e_{\\mathrm{th}}$可以从$U$计算得出：\n$$\ne_{\\mathrm{th}} = E - \\frac{m_x^2 + m_y^2 + m_z^2}{2\\rho} - \\frac{B_x^2 + B_y^2 + B_z^2}{2}\n$$\n该系统通过理想气体状态方程封闭，该方程将热压力$p$与内能密度联系起来：\n$$\np = (\\gamma - 1)e_{\\mathrm{th}}\n$$\n其中$\\gamma$是绝热指数。总压力为$p_{\\mathrm{tot}} = p + \\frac{1}{2}|\\boldsymbol{B}|^2$。\n\n### 2. 物理通量和源项\n\n理想MHD方程在$x$方向上的物理通量向量$F(U)$是：\n$$\nF(U) = \\begin{pmatrix}\n\\rho v_x \\\\\n\\rho v_x^2 + p_{\\mathrm{tot}} - B_x^2 \\\\\n\\rho v_x v_y - B_x B_y \\\\\n\\rho v_x v_z - B_x B_z \\\\\n0 \\\\\nv_y B_x - v_x B_y \\\\\nv_z B_x - v_x B_z \\\\\n(E + p_{\\mathrm{tot}})v_x - (\\boldsymbol{v} \\cdot \\boldsymbol{B})B_x\n\\end{pmatrix}\n=\n\\begin{pmatrix}\nm_x \\\\\n\\frac{m_x^2}{\\rho} + p + \\frac{1}{2}(B_y^2 + B_z^2 - B_x^2) \\\\\n\\frac{m_x m_y}{\\rho} - B_x B_y \\\\\n\\frac{m_x m_z}{\\rho} - B_x B_z \\\\\n0 \\\\\n\\frac{m_y B_x - m_x B_y}{\\rho} \\\\\n\\frac{m_z B_x - m_x B_z}{\\rho} \\\\\n(E + p + \\frac{1}{2}|\\boldsymbol{B}|^2)\\frac{m_x}{\\rho} - \\frac{m_x B_x + m_y B_y + m_z B_z}{\\rho} B_x\n\\end{pmatrix}\n$$\n注意，对于沿$x$方向的一维流动，无散条件$\\nabla \\cdot \\boldsymbol{B} = 0$意味着$\\frac{\\partial B_x}{\\partial x} = 0$，使得$B_x$在空间上是均匀的。一维流动的感应方程$\\frac{\\partial B_x}{\\partial t} = 0$意味着相应的物理通量分量为零。\n\n剪切箱源项$S(U)$是为动量和感应给出的。我们必须推导能量源项$S_E$以确保守恒。\n指定的动量和磁场源项是：\n$$\nS_m = \\begin{pmatrix} S_{m_x} \\\\ S_{m_y} \\\\ S_{m_z} \\end{pmatrix} = \\begin{pmatrix} 2 \\rho \\Omega v_y \\\\ -(2-q)\\rho \\Omega v_x \\\\ 0 \\end{pmatrix}, \\quad\nS_B = \\begin{pmatrix} S_{B_x} \\\\ S_{B_y} \\\\ S_{B_z} \\end{pmatrix} = \\begin{pmatrix} 0 \\\\ -q \\Omega B_x \\\\ 0 \\end{pmatrix}\n$$\n其中$\\Omega$是局部轨道频率，$q$是剪切参数。\n总能量源项$S_E$是这些源项做功的速率：$S_E = \\boldsymbol{v} \\cdot S_m + \\boldsymbol{B} \\cdot S_B$。\n$$\nS_E = v_x (2 \\rho \\Omega v_y) + v_y (-(2-q)\\rho \\Omega v_x) + v_z(0) + B_x(0) + B_y(-q \\Omega B_x) + B_z(0)\n$$\n$$\nS_E = (2 - (2-q))\\rho\\Omega v_x v_y - q\\Omega B_x B_y = q\\rho\\Omega v_x v_y - q\\Omega B_x B_y\n$$\n用守恒变量表示：\n$$\nS_E = q\\Omega\\left(\\frac{m_x m_y}{\\rho} - B_x B_y\\right)\n$$\n完整的源向量是：\n$$\nS(U) = [0, S_{m_x}, S_{m_y}, 0, 0, S_{B_y}, 0, S_E]^T\n$$\n\n### 3. 数值离散化\n\n我们使用有限体积法在一个由$N$个宽度为$\\Delta x = L/N$的单元组成的均匀网格上。单元平均状态通过以下公式更新：\n$$\nU_i^{n+1} = U_i^n - \\frac{\\Delta t}{\\Delta x}\\left(F_{i+\\frac{1}{2}}^n - F_{i-\\frac{1}{2}}^n\\right) + \\Delta t S(U_i^n)\n$$\n在单元$i$和$i+1$之间的界面上的数值通量$F_{i+\\frac{1}{2}}$使用Lax-Friedrichs（Rusanov）公式近似：\n$$\nF_{i+\\frac{1}{2}} = \\frac{1}{2}\\left(F(U_L) + F(U_R)\\right) - \\frac{1}{2}a_{\\max}\\left(U_R - U_L\\right)\n$$\n这里，$U_L = U_i$和$U_R = U_{i+1}$是界面左侧和右侧的状态。$a_{\\max}$是对整个网格上最大信号速度的估计，以确保数值稳定性。它由所有单元上$|v_x| + c_{f,x}$的最大值给出，其中$c_{f,x}$是$x$方向的快磁声速：\n$$\nc_{f,x}^2 = \\frac{1}{2} \\left[ (c_s^2 + v_A^2) + \\sqrt{(c_s^2 + v_A^2)^2 - 4 c_s^2 v_{Ax}^2} \\right]\n$$\n其中声速$c_s^2 = \\frac{\\gamma p}{\\rho}$，总阿尔芬速度$v_A^2 = \\frac{|\\boldsymbol{B}|^2}{\\rho}$，$x$分量阿尔芬速度$v_{Ax}^2 = \\frac{B_x^2}{\\rho}$。\n\n时间步长$\\Delta t$受到双曲通量的Courant-Friedrichs-Lewy（CFL）条件和源项积分稳定性的双重约束：\n$$\n\\Delta t = C \\min\\left(\\frac{\\Delta x}{a_{\\max}}, \\tau_{\\text{source}}\\right)\n$$\n其中$C=0.3$是Courant因子。当$\\Omega \\neq 0$时，源项时间尺度的一个合理选择是$\\tau_{\\text{source}} = 1/|\\Omega|$。\n\n### 4. 能量平衡验证\n\n在周期性边界条件下，整个区域上的通量差之和对消为零：$\\sum_i (F_{i+\\frac{1}{2}} - F_{i-\\frac{1}{2}}) = 0$。将更新方程对所有单元$i$求和，得到：\n$$\n\\sum_i U_i^{n+1} = \\sum_i U_i^n + \\Delta t \\sum_i S(U_i^n)\n$$\n关注能量分量（$U$的最后一个元素），这意味着：\n$$\n\\sum_i E_i^{n+1} = \\sum_i E_i^n + \\Delta t \\sum_i S_{E,i}\n$$\n问题要求计算残余能量不平衡量，定义为：\n$$\nR = \\left(\\sum_i E_i^{n+1}\\right) - \\left(\\sum_i E_i^{n}\\right) - \\Delta t \\left(\\sum_i S_{E,i}\\right)\n$$\n基于离散守恒性质，这个残差$R$应该在浮点精度范围内为零。这个计算是对代码正确性的严格测试，特别是对能量源项的一致性实现的测试。\n\n### 5. 算法总结\n\n对于每个测试用例：\n1.  在域$L=1$上初始化一个包含$N=64$个单元的均匀网格。\n2.  根据给定的原始变量在每个单元中设置初始状态向量$U^n$。\n3.  计算初始总能量$\\mathcal{E}^n = \\sum_i E_i^n$。\n4.  为所有单元计算原始变量和波速。确定全局最大信号速度$a_{\\max}$。\n5.  使用CFL和源项约束计算时间步长$\\Delta t$。\n6.  为所有单元计算源向量$S(U_i^n)$和总能量源贡献$\\Delta t \\sum_i S_{E,i}$。\n7.  对于每个界面$i+\\frac{1}{2}$（从$i=0$到$N-1$，带周期性环绕），计算Rusanov通量$F_{i+\\frac{1}{2}}$。\n8.  使用守恒有限体积公式将每个单元的状态更新为$U^{n+1}$。\n9.  计算最终总能量$\\mathcal{E}^{n+1} = \\sum_i E_i^{n+1}$。\n10. 计算残差$R = \\mathcal{E}^{n+1} - \\mathcal{E}^n - \\Delta t \\sum_i S_{E,i}$。\n\n该过程将应用于所有四个指定的测试用例。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\n\n# Note: scipy is permitted but not required for this problem.\n\n# Global constant for adiabatic index\nGAMMA = 5.0 / 3.0\n\ndef cons_to_prim(U):\n    \"\"\"\n    Convert an array of conservative state vectors to primitive variables.\n    U: (N, 8) array of [rho, mx, my, mz, Bx, By, Bz, E]\n    Returns: rho, v, B, p - each as a numpy array.\n    \"\"\"\n    rho = U[:, 0]\n    # Ensure density is positive to avoid division by zero\n    rho_inv = 1.0 / np.maximum(rho, 1e-100)\n    \n    vx = U[:, 1] * rho_inv\n    vy = U[:, 2] * rho_inv\n    vz = U[:, 3] * rho_inv\n    v = np.stack((vx, vy, vz), axis=-1)\n    \n    Bx = U[:, 4]\n    By = U[:, 5]\n    Bz = U[:, 6]\n    B = np.stack((Bx, By, Bz), axis=-1)\n    \n    v_sq = np.sum(v**2, axis=1)\n    B_sq = np.sum(B**2, axis=1)\n    \n    e_th = U[:, 7] - 0.5 * rho * v_sq - 0.5 * B_sq\n    p = (GAMMA - 1.0) * e_th\n    \n    return rho, v, B, p\n\ndef get_physical_flux(U, prim_vars):\n    \"\"\"\n    Calculate the physical MHD flux vector in the x-direction.\n    U: (N, 8) array of conservative variables.\n    prim_vars: tuple of (rho, v, B, p) arrays.\n    Returns: F, an (N, 8) array of physical fluxes.\n    \"\"\"\n    rho, v, B, p = prim_vars\n    vx, vy, vz = v[:, 0], v[:, 1], v[:, 2]\n    Bx, By, Bz = B[:, 0], B[:, 1], B[:, 2]\n    \n    B_sq = np.sum(B**2, axis=1)\n    p_tot = p + 0.5 * B_sq\n    \n    F = np.zeros_like(U)\n    F[:, 0] = rho * vx\n    F[:, 1] = rho * vx**2 + p_tot - Bx**2\n    F[:, 2] = rho * vx * vy - Bx * By\n    F[:, 3] = rho * vx * vz - Bx * Bz\n    F[:, 4] = 0.0\n    F[:, 5] = vy * Bx - vx * By\n    F[:, 6] = vz * Bx - vx * Bz\n    \n    v_dot_B = np.sum(v * B, axis=1)\n    F[:, 7] = (U[:, 7] + p_tot) * vx - v_dot_B * Bx\n    \n    return F\n\ndef get_source_terms(U, prim_vars, q, Omega):\n    \"\"\"\n    Calculate the shearing-box source terms.\n    U: (N, 8) array of conservative variables.\n    prim_vars: tuple of (rho, v, B, p) arrays.\n    q, Omega: shear parameter and angular velocity.\n    Returns: S, an (N, 8) array of source terms.\n    \"\"\"\n    if Omega == 0.0:\n        return np.zeros_like(U)\n\n    rho, v, B, _ = prim_vars\n    vx, vy = v[:, 0], v[:, 1]\n    Bx, By = B[:, 0], B[:, 1]\n    \n    S = np.zeros_like(U)\n    \n    # Momentum sources\n    S[:, 1] = 2.0 * rho * Omega * vy\n    S[:, 2] = -(2.0 - q) * rho * Omega * vx\n    \n    # Induction sources\n    S[:, 5] = -q * Omega * Bx\n    \n    # Energy source (work done by other sources)\n    # S_E = q * rho * Omega * vx * vy - q * Omega * Bx * By\n    S[:, 7] = q * Omega * (U[:, 1] * U[:, 2] / rho - U[:, 4] * U[:, 5])\n\n    return S\n\ndef get_max_wave_speed(prim_vars):\n    \"\"\"\n    Calculate the maximum characteristic wave speed over the grid.\n    prim_vars: tuple of (rho, v, B, p) arrays.\n    Returns: a_max, a scalar float.\n    \"\"\"\n    rho, v, B, p = prim_vars\n    # Ensure positivity for stability\n    rho_safe = np.maximum(rho, 1e-100)\n    p_safe = np.maximum(p, 1e-100)\n\n    # Note: Normalization is B^2/2 for magnetic energy, so vA^2 = B^2/rho\n    c_s_sq = GAMMA * p_safe / rho_safe\n    v_A_sq = np.sum(B**2, axis=1) / rho_safe\n    v_Ax_sq = B[:, 0]**2 / rho_safe\n    \n    radicand = (c_s_sq + v_A_sq)**2 - 4.0 * c_s_sq * v_Ax_sq\n    radicand = np.maximum(radicand, 0.0) # Ensure non-negative\n    \n    c_f_sq = 0.5 * (c_s_sq + v_A_sq + np.sqrt(radicand))\n    c_f = np.sqrt(c_f_sq)\n    \n    signal_speeds = np.abs(v[:, 0]) + c_f\n    return np.max(signal_speeds)\n\ndef run_simulation_step(N, L, q, Omega, C, initial_conditions_func):\n    \"\"\"\n    Performs a single time step for a given test case and computes the energy residual.\n    \"\"\"\n    dx = L / N\n    x = (np.arange(N) + 0.5) * dx\n    \n    # 1. Set up initial conditions\n    rho, v, B, p = initial_conditions_func(x)\n    \n    U = np.zeros((N, 8))\n    U[:, 0] = rho\n    U[:, 1:4] = rho[:, np.newaxis] * v\n    U[:, 4:7] = B\n    e_th = p / (GAMMA - 1.0)\n    U[:, 7] = e_th + 0.5 * rho * np.sum(v**2, axis=1) + 0.5 * np.sum(B**2, axis=1)\n    \n    # 2. Compute total initial energy and primitives\n    total_energy_initial = np.sum(U[:, 7])\n    prim_vars = cons_to_prim(U)\n    \n    # 3. Compute time step\n    a_max = get_max_wave_speed(prim_vars)\n    dt_cfl = dx / a_max\n    \n    if Omega != 0.0:\n        dt_source = 1.0 / np.abs(Omega)\n        dt = C * min(dt_cfl, dt_source)\n    else:\n        dt = C * dt_cfl\n        \n    # 4. Compute source terms and total energy source work\n    S = get_source_terms(U, prim_vars, q, Omega)\n    total_energy_source_work = dt * np.sum(S[:, 7])\n    \n    # 5. Compute numerical fluxes (Rusanov)\n    F_physical = get_physical_flux(U, prim_vars)\n    F_hat = np.zeros((N, 8))\n    \n    for i in range(N):\n        i_right = (i + 1) % N\n        U_L, U_R = U[i, :], U[i_right, :]\n        F_L, F_R = F_physical[i, :], F_physical[i_right, :]\n        \n        F_hat[i, :] = 0.5 * (F_L + F_R) - 0.5 * a_max * (U_R - U_L)\n        \n    # 6. Update conservative state vector\n    U_new = np.copy(U)\n    for i in range(N):\n        i_left_flux = (i - 1 + N) % N\n        flux_divergence = (F_hat[i, :] - F_hat[i_left_flux, :]) / dx\n        U_new[i, :] = U[i, :] - dt * flux_divergence + dt * S[i, :]\n        \n    # 7. Compute final total energy\n    total_energy_final = np.sum(U_new[:, 7])\n    \n    # 8. Compute and return residual\n    residual = total_energy_final - total_energy_initial - total_energy_source_work\n    return residual\n\ndef solve():\n    N = 64\n    L = 1.0\n    C = 0.3\n    \n    # Test case definitions\n    test_cases_params = [\n        {'q': 0.0, 'Omega': 1.0},\n        {'q': 1.5, 'Omega': 1.0},\n        {'q': 0.0, 'Omega': 0.0},\n        {'q': 0.0, 'Omega': 0.0},\n    ]\n\n    def ic_case1(x):\n        N_pts = len(x)\n        rho = np.full(N_pts, 1.0)\n        p = np.full(N_pts, 1.0)\n        v = np.zeros((N_pts, 3))\n        v[:, 0] = 0.3\n        v[:, 1] = 0.2\n        B = np.zeros((N_pts, 3))\n        return rho, v, B, p\n\n    def ic_case2(x):\n        N_pts = len(x)\n        rho = np.full(N_pts, 1.0)\n        p = np.full(N_pts, 1.0)\n        v = np.zeros((N_pts, 3))\n        B = np.zeros((N_pts, 3))\n        B[:, 0] = 0.5\n        B[:, 1] = 0.3\n        return rho, v, B, p\n\n    def ic_case3(x):\n        N_pts = len(x)\n        rho = np.full(N_pts, 1.0)\n        p = np.full(N_pts, 1.0)\n        v = np.zeros((N_pts, 3))\n        v[:, 0] = 0.5 * np.sin(2.0 * np.pi * x)\n        B = np.zeros((N_pts, 3))\n        return rho, v, B, p\n\n    def ic_case4(x):\n        N_pts = len(x)\n        rho = np.full(N_pts, 1.0)\n        p = np.full(N_pts, 1.0)\n        v = np.zeros((N_pts, 3))\n        v[:, 1] = 0.3 * np.cos(2.0 * np.pi * x)\n        B = np.zeros((N_pts, 3))\n        B[:, 0] = 0.5\n        B[:, 1] = 0.2 * np.sin(2.0 * np.pi * x)\n        return rho, v, B, p\n\n    initial_conditions_funcs = [ic_case1, ic_case2, ic_case3, ic_case4]\n    \n    results = []\n    for i in range(len(test_cases_params)):\n        params = test_cases_params[i]\n        ic_func = initial_conditions_funcs[i]\n        \n        residual = run_simulation_step(\n            N=N, L=L, q=params['q'], Omega=params['Omega'], C=C,\n            initial_conditions_func=ic_func\n        )\n        results.append(residual)\n\n    # Final print statement in the exact required format.\n    print(f\"[{','.join(map(str, results))}]\")\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3521855"}, {"introduction": "所有数值格式都不可避免地会引入内在的、非物理的耗散，即“数值耗散”。这项练习将演示一种强大的技术，通过测量线性磁流体动力学（MHD）波的衰减率来量化格式的数值电阻率和粘性。这是理解磁转动不稳定性（MRI）模拟结果是真实地解析了物理过程，还是被数值效应所主导的关键一步 [@problem_id:3521904]。", "problem": "您的任务是设计并实现一个程序，通过测量小振幅线性波的衰减率，来推断在磁流体动力学（MHD）中由给定离散化方法引入的有效数值磁扩散率（电阻率）和运动粘度。这与模拟磁转动不稳定性（MRI）直接相关，在MRI中，数值磁普朗特数控制着线性增长和饱和。您的程序必须基于线性粘性电阻MHD的第一性原理，而不是基于经验猜测的公式，并且必须从基本方程进行逻辑推导。\n\n考虑一个均匀、导电、可压缩的流体，其质量密度为常数 $\\rho_0$，均匀背景磁场强度为 $B_0$。设 $\\mu_0$ 表示真空磁导率，$c_s$ 表示等温声速。守恒型MHD格式的数值离散化可以建模为在线性化方程中增加具有常系数的有效拉普拉斯项：一个作用于速度场的有效运动粘度 $\\nu_{\\mathrm{num}}$，以及一个作用于磁场的有效电阻率 $\\eta_{\\mathrm{num}}$。对于波数为 $k$、角频率为 $\\omega$ 的小振幅平面波，波幅 $A(t)$ 随时间指数衰减，$A(t) \\propto \\exp(-\\gamma t)$，其中 $\\gamma$ 是衰减率。目标是从第一性原理出发，推导出对于以下两种特定几何构型，将 $\\gamma$ 与 $\\nu_{\\mathrm{num}}$ 和 $\\eta_{\\mathrm{num}}$ 联系起来的显式公式：\n\n1.  一个沿背景磁场方向传播的横向阿尔芬波（$\\boldsymbol{k} \\parallel \\boldsymbol{B}_0$）。该模式是不可压缩的，其理想相速度为 $v_A = B_0/\\sqrt{\\mu_0 \\rho_0}$。\n\n2.  一个垂直于背景磁场方向传播的快磁声压缩波（$\\boldsymbol{k} \\perp \\boldsymbol{B}_0$）。该模式的理想相速度为 $c_f = \\sqrt{c_s^2 + v_A^2}$。\n\n从基本的粘性电阻MHD方程出发，围绕均匀背景进行线性化，并使用平面波拟设来推导对于上述两种波的几何构型，连接衰减率 $\\gamma$ 与 $\\nu_{\\mathrm{num}}$ 和 $\\eta_{\\mathrm{num}}$ 的关系。您的推导必须仅基于守恒律和线性模能量学；您不得使用任何预先记下的快捷公式。您的结果应将每种波类型的 $\\gamma$ 表示为 $k$、$\\nu_{\\mathrm{num}}$、$\\eta_{\\mathrm{num}}$、$c_s$ 和 $v_A$ 的函数。然后，您将构建一个算法，在给定相同 $k$ 和相同背景状态 $(\\rho_0, B_0, c_s)$ 下两种波类型的测量衰减率 $\\gamma$ 值时，求解 $\\nu_{\\mathrm{num}}$ 和 $\\eta_{\\mathrm{num}}$，并报告数值磁普朗特数，定义为 $\\mathrm{Pm}_{\\mathrm{num}} = \\nu_{\\mathrm{num}} / \\eta_{\\mathrm{num}}$。\n\n单位与约定：\n- 使用国际单位制（SI）。所有输入必须解释为SI单位量。您必须在内部以 $\\mathrm{m}^2/\\mathrm{s}$ 计算并报告 $\\nu_{\\mathrm{num}}$ 和 $\\eta_{\\mathrm{num}}$，并将最终的 $\\mathrm{Pm}_{\\mathrm{num}}$ 报告为无量纲浮点数。\n- 角度（如有）必须以弧度为单位。在此问题中，您将对阿尔芬波使用 $\\theta = 0$，对快磁声波使用 $\\theta = \\pi/2$。\n\n测试套件：\n您必须将您的算法应用于以下五个测试用例。在每个用例中，都提供了背景参数 $(\\rho_0, B_0, c_s)$、波数 $k$ 以及测量的衰减率 $(\\gamma_A, \\gamma_F)$。阿尔芬波衰减率 $\\gamma_A$ 对应于 $\\boldsymbol{k} \\parallel \\boldsymbol{B}_0$ 的横向阿尔芬波，快磁声波衰减率 $\\gamma_F$ 对应于 $\\boldsymbol{k} \\perp \\boldsymbol{B}_0$ 的压缩快模。所有量均采用SI单位；衰减率单位为 $\\mathrm{s}^{-1}$，波数单位为 $\\mathrm{m}^{-1}$，$B_0$ 单位为 $\\mathrm{T}$，$\\rho_0$ 单位为 $\\mathrm{kg}/\\mathrm{m}^3$，$c_s$ 单位为 $\\mathrm{m}/\\mathrm{s}$。\n\n- 用例1（气体压力主导）：\n  $\\rho_0 = 1.0 \\times 10^{-6}$, $B_0 = 1.0 \\times 10^{-3}$, $c_s = 1.0 \\times 10^{4}$, $k = 1.0 \\times 10^{-6}$,\n  测得 $\\gamma_A = 3.500000 \\times 10^{-12}$, 测得 $\\gamma_F = 2.507943 \\times 10^{-12}$。\n\n- 用例2（磁场主导）：\n  $\\rho_0 = 1.0 \\times 10^{-8}$, $B_0 = 3.0 \\times 10^{-3}$, $c_s = 2.0 \\times 10^{3}$, $k = 5.0 \\times 10^{-7}$,\n  测得 $\\gamma_A = 1.375000 \\times 10^{-12}$, 测得 $\\gamma_F = 1.368375 \\times 10^{-12}$。\n\n- 用例3（接近平衡 $v_A \\sim c_s$）：\n  $\\rho_0 = 5.0 \\times 10^{-7}$, $B_0 = 2.0 \\times 10^{-3}$, $c_s = 3.0 \\times 10^{3}$, $k = 2.0 \\times 10^{-6}$,\n  测得 $\\gamma_A = 9.000000 \\times 10^{-12}$, 测得 $\\gamma_F = 5.484375 \\times 10^{-12}$。\n\n- 用例4（极度气体压力主导）：\n  $\\rho_0 = 2.0 \\times 10^{-6}$, $B_0 = 5.0 \\times 10^{-4}$, $c_s = 2.0 \\times 10^{4}$, $k = 1.5 \\times 10^{-6}$,\n  测得 $\\gamma_A = 2.812500 \\times 10^{-12}$, 测得 $\\gamma_F = 2.250140 \\times 10^{-12}$。\n\n- 用例5（极度磁场主导）：\n  $\\rho_0 = 1.0 \\times 10^{-9}$, $B_0 = 5.0 \\times 10^{-3}$, $c_s = 1.0 \\times 10^{3}$, $k = 8.0 \\times 10^{-7}$,\n  测得 $\\gamma_A = 3.360000 \\times 10^{-13}$, 测得 $\\gamma_F = 3.359946 \\times 10^{-13}$。\n\n算法要求：\n- 从第一性原理出发，推导出两种衰减率的公式，以及由此得到的用测量的 $\\gamma_A$ 和 $\\gamma_F$ 及已知的 $(k, c_s, v_A)$ 表示 $\\nu_{\\mathrm{num}}$ 和 $\\eta_{\\mathrm{num}}$ 的反演表达式。\n- 实现一个稳健的求解器，对每个测试用例，计算 $v_A = B_0/\\sqrt{\\mu_0 \\rho_0}$，反演测量的衰减率以估计 $\\nu_{\\mathrm{num}}$ 和 $\\eta_{\\mathrm{num}}$，并计算 $\\mathrm{Pm}_{\\mathrm{num}}$。\n- 如果由于 $1 - v_A^2/(c_s^2 + v_A^2)$ 极小而导致代数反演变得病态，只要分母严格为正，您仍必须基于双精度算术返回一个有限浮点数。如果分母非正，则将该情况视为无效，并返回编码为浮点数NaN的非数值。\n\n最终输出规范：\n您的程序应生成单行输出，其中包含一个用方括号括起来的逗号分隔列表形式的结果，其中每个条目是对应测试用例的无量纲数值磁普朗特数，四舍五入到六位小数。例如，输出格式必须类似于“[x1,x2,x3,x4,x5]”，其中每个xi是小数点后有六位数字的十进制浮点数，顺序与上述测试套件相同。", "solution": "问题陈述在科学上是合理的、自洽的且定义明确的。它描述了计算天体物理学中一种用于量化数值耗散的标准方法。我将基于第一性原理进行求解。\n\n出发点是关于静态均匀背景（密度为 $\\rho_0$，磁场为 $\\boldsymbol{B}_0$，等温声速为 $c_s$）的一组线性化、可压缩、有电阻、有粘性的磁流体动力学（MHD）方程。数值格式的耗散效应通过有效运动粘度 $\\nu_{\\mathrm{num}}$ 和有效磁阻率 $\\eta_{\\mathrm{num}}$ 来建模。这些方程是：\n\n1.  连续性方程：$\\frac{\\partial \\rho_1}{\\partial t} + \\rho_0 \\nabla \\cdot \\boldsymbol{v}_1 = 0$\n2.  动量方程：$\\rho_0 \\frac{\\partial \\boldsymbol{v}_1}{\\partial t} = -c_s^2 \\nabla \\rho_1 + \\frac{1}{\\mu_0} (\\nabla \\times \\boldsymbol{b}_1) \\times \\boldsymbol{B}_0 + \\rho_0 \\nu_{\\mathrm{num}} \\nabla^2 \\boldsymbol{v}_1$\n3.  感应方程：$\\frac{\\partial \\boldsymbol{b}_1}{\\partial t} = \\nabla \\times (\\boldsymbol{v}_1 \\times \\boldsymbol{B}_0) + \\eta_{\\mathrm{num}} \\nabla^2 \\boldsymbol{b}_1$\n\n此处，$\\rho_1$、$\\boldsymbol{v}_1$ 和 $\\boldsymbol{b}_1$ 分别是密度、速度和磁场的小振幅扰动。$\\mu_0$ 是真空磁导率。我们对所有扰动量采用平面波拟设，形式为 $f_1 \\propto \\exp[i(\\boldsymbol{k} \\cdot \\boldsymbol{r} - \\omega t)]$，其中 $\\boldsymbol{k}$ 是波矢，$\\omega$ 是复角频率。此代换将微分算子转换为 $\\frac{\\partial}{\\partial t} \\rightarrow -i\\omega$ 和 $\\nabla \\rightarrow i\\boldsymbol{k}$。具有负虚部 $\\omega_i  0$ 的复频率 $\\omega = \\omega_r + i\\omega_i$ 对应于时间衰减 $e^{\\omega_i t}$。问题将衰减率定义为 $\\gamma = -\\omega_i > 0$。\n\n### 情况1：横向阿尔芬波（$\\boldsymbol{k} \\parallel \\boldsymbol{B}_0$）\n对于此几何构型，我们可以调整坐标系使得 $\\boldsymbol{B}_0 = B_0 \\hat{\\boldsymbol{z}}$ 和 $\\boldsymbol{k} = k \\hat{\\boldsymbol{z}}$。该波模是不可压缩的，意味着 $\\nabla \\cdot \\boldsymbol{v}_1 = 0$，这也就意味着 $\\boldsymbol{k} \\cdot \\boldsymbol{v}_1 = 0$。从连续性方程可知，这也意味着 $\\rho_1 = 0$（对于非零频率 $\\omega$）。因此，动量方程失去了压力梯度项。线性化方程变为：\n$$ -i\\omega \\rho_0 \\boldsymbol{v}_1 = \\frac{1}{\\mu_0} (i\\boldsymbol{k} \\times \\boldsymbol{b}_1) \\times \\boldsymbol{B}_0 - \\rho_0 \\nu_{\\mathrm{num}} k^2 \\boldsymbol{v}_1 $$\n$$ -i\\omega \\boldsymbol{b}_1 = i\\boldsymbol{k} \\times (\\boldsymbol{v}_1 \\times \\boldsymbol{B}_0) - \\eta_{\\mathrm{num}} k^2 \\boldsymbol{b}_1 $$\n利用三重叉积的矢量恒等式以及条件 $\\boldsymbol{k} \\parallel \\boldsymbol{B}_0$ 和 $\\boldsymbol{k} \\cdot \\boldsymbol{v}_1 = 0$，这些方程简化为关于横向扰动 $\\boldsymbol{v}_1$ 和 $\\boldsymbol{b}_1$ 的耦合系统：\n$$ (-i\\omega + \\nu_{\\mathrm{num}} k^2) \\rho_0 \\boldsymbol{v}_1 = \\frac{i}{\\mu_0} (\\boldsymbol{k} \\cdot \\boldsymbol{B}_0) \\boldsymbol{b}_1 $$\n$$ (-i\\omega + \\eta_{\\mathrm{num}} k^2) \\boldsymbol{b}_1 = i (\\boldsymbol{k} \\cdot \\boldsymbol{B}_0) \\boldsymbol{v}_1 $$\n为使非平凡解存在，系数矩阵的行列式必须为零。这得到色散关系：\n$$ (-i\\omega + \\nu_{\\mathrm{num}} k^2) (-i\\omega + \\eta_{\\mathrm{num}} k^2) = \\frac{(\\boldsymbol{k} \\cdot \\boldsymbol{B}_0)^2}{\\mu_0 \\rho_0} = k^2 v_A^2 $$\n其中 $v_A = B_0 / \\sqrt{\\mu_0 \\rho_0}$ 是理想阿尔芬速度。为了求得衰减率，我们假设耗散是弱的，所以频率是对理想频率 $\\omega_0 = k v_A$ 的一个小扰动。设 $\\omega = \\omega_0 - i\\gamma_A = k v_A - i\\gamma_A$，其中 $\\gamma_A$ 很小。将此代入色散关系并只保留 $\\nu_{\\mathrm{num}}$、$\\eta_{\\mathrm{num}}$ 和 $\\gamma_A$ 的一阶项：\n$$ (-i(k v_A - i\\gamma_A) + \\nu_{\\mathrm{num}} k^2) (-i(k v_A - i\\gamma_A) + \\eta_{\\mathrm{num}} k^2) \\approx -k^2 v_A^2 $$\n$$ (-\\gamma_A - ik v_A + \\nu_{\\mathrm{num}} k^2) (-\\gamma_A - ik v_A + \\eta_{\\mathrm{num}} k^2) \\approx -k^2 v_A^2 $$\n展开并线性化得到：\n$$ (-ik v_A)^2 - ik v_A(\\nu_{\\mathrm{num}}k^2 - \\gamma_A) - ik v_A(\\eta_{\\mathrm{num}}k^2 - \\gamma_A) \\approx -k^2 v_A^2 $$\n$$ -k^2 v_A^2 - ik^3 v_A (\\nu_{\\mathrm{num}} + \\eta_{\\mathrm{num}}) + 2i k v_A \\gamma_A \\approx -k^2 v_A^2 $$\n$$ 2 \\gamma_A = k^2 (\\nu_{\\mathrm{num}} + \\eta_{\\mathrm{num}}) $$\n这给出了我们关于阿尔芬波衰减率的第一个关系式：\n$$ \\gamma_A = \\frac{1}{2} k^2 (\\nu_{\\mathrm{num}} + \\eta_{\\mathrm{num}}) $$\n\n### 情况2：快磁声波（$\\boldsymbol{k} \\perp \\boldsymbol{B}_0$）\n对于这种情况，我们选择 $\\boldsymbol{B}_0 = B_0 \\hat{\\boldsymbol{z}}$ 和 $\\boldsymbol{k} = k \\hat{\\boldsymbol{x}}$，所以 $\\boldsymbol{k} \\cdot \\boldsymbol{B}_0 = 0$。该波是可压缩的，所以 $\\rho_1 \\ne 0$。线性化方程变为：\n$$ \\omega \\rho_1 = \\rho_0 (k v_{1x}) $$\n$$ (-i\\omega + \\nu_{\\mathrm{num}} k^2) \\rho_0 \\boldsymbol{v}_1 = -i c_s^2 \\boldsymbol{k} \\rho_1 - \\frac{i}{\\mu_0} (\\boldsymbol{b}_1 \\cdot \\boldsymbol{B}_0) \\boldsymbol{k} $$\n$$ (-i\\omega + \\eta_{\\mathrm{num}} k^2) \\boldsymbol{b}_1 = -i (\\boldsymbol{k} \\cdot \\boldsymbol{v}_1) \\boldsymbol{B}_0 $$\n感应方程表明磁扰动 $\\boldsymbol{b}_1$ 平行于 $\\boldsymbol{B}_0$。动量方程的力项都沿着 $\\boldsymbol{k}$ 方向，所以速度扰动是纵向的，$\\boldsymbol{v}_1 = v_{1x} \\hat{\\boldsymbol{x}}$。将这些结合起来得到色散关系：\n$$ (-i\\omega + \\nu_{\\mathrm{num}} k^2) = \\frac{c_s^2 k^2}{-i\\omega} + \\frac{v_A^2 k^2}{-i\\omega + \\eta_{\\mathrm{num}} k^2} $$\n同样，我们在理想解附近进行扰动，理想解的频率 $\\omega_0$ 满足 $\\omega_0^2 = (c_s^2 + v_A^2)k^2 = c_f^2 k^2$。设 $\\omega = \\omega_0 - i\\gamma_F$。代入并线性化得到：\n$$ \\gamma_F = \\frac{1}{2} k^2 \\left( \\nu_{\\mathrm{num}} + \\eta_{\\mathrm{num}} \\frac{v_A^2}{c_s^2 + v_A^2} \\right) $$\n\n### $\\nu_{\\mathrm{num}}$ 和 $\\eta_{\\mathrm{num}}$ 的反演\n现在我们得到了一个关于两个未知数 $\\nu_{\\mathrm{num}}$ 和 $\\eta_{\\mathrm{num}}$ 的线性方程组，它基于测量的衰减率 $\\gamma_A$ 和 $\\gamma_F$：\n1. $2\\gamma_A / k^2 = \\nu_{\\mathrm{num}} + \\eta_{\\mathrm{num}}$\n2. $2\\gamma_F / k^2 = \\nu_{\\mathrm{num}} + \\eta_{\\mathrm{num}} \\frac{v_A^2}{c_s^2 + v_A^2}$\n\n令 $\\Gamma_A = 2\\gamma_A/k^2$ 和 $\\Gamma_F = 2\\gamma_F/k^2$。令 $f = v_A^2 / (c_s^2 + v_A^2)$。\n将第二个方程从第一个方程中减去，得到：\n$\\Gamma_A - \\Gamma_F = \\eta_{\\mathrm{num}}(1-f)$\n注意到 $1-f = 1 - \\frac{v_A^2}{c_s^2+v_A^2} = \\frac{c_s^2}{c_s^2+v_A^2}$，我们解出 $\\eta_{\\mathrm{num}}$：\n$$ \\eta_{\\mathrm{num}} = \\frac{\\Gamma_A - \\Gamma_F}{1 - f} = \\frac{2(\\gamma_A - \\gamma_F)}{k^2} \\left( \\frac{c_s^2 + v_A^2}{c_s^2} \\right) $$\n然后我们可以从第一个方程求出 $\\nu_{\\mathrm{num}}$：$\\nu_{\\mathrm{num}} = \\Gamma_A - \\eta_{\\mathrm{num}}$。这可以表示为：\n$$ \\nu_{\\mathrm{num}} = \\frac{\\Gamma_F - f \\Gamma_A}{1 - f} = \\frac{2}{k^2 c_s^2} \\left[ \\gamma_F(c_s^2+v_A^2) - \\gamma_A v_A^2 \\right] $$\n数值磁普朗特数为 $\\mathrm{Pm}_{\\mathrm{num}} = \\nu_{\\mathrm{num}} / \\eta_{\\mathrm{num}}$。将 $\\nu_{\\mathrm{num}}$ 和 $\\eta_{\\mathrm{num}}$ 的表达式相除：\n$$ \\mathrm{Pm}_{\\mathrm{num}} = \\frac{\\nu_{\\mathrm{num}}}{\\eta_{\\mathrm{num}}} = \\frac{\\gamma_F(c_s^2+v_A^2) - \\gamma_A v_A^2}{(\\gamma_A - \\gamma_F)(c_s^2+v_A^2)} $$\n这是程序中实现的最终表达式。", "answer": "```python\n# The complete and runnable Python 3 code goes here.\n# Imports must adhere to the specified execution environment.\nimport numpy as np\nfrom scipy import constants\n\ndef solve():\n    \"\"\"\n    Infers effective numerical magnetic diffusivity and kinematic viscosity\n    by measuring decay rates of small-amplitude linear MHD waves. It then\n    calculates the numerical magnetic Prandtl number.\n    \"\"\"\n    \n    # Use the precise value of mu_0 from scipy.constants as required for the\n    # test cases, which are designed around this standard value.\n    mu_0 = constants.mu_0\n\n    # Define the test cases from the problem statement.\n    # Each tuple contains: (rho_0, B_0, c_s, k, gamma_A, gamma_F)\n    # All values are in SI units.\n    test_cases = [\n        # Case 1 (gas-pressure-dominated)\n        (1.0e-6, 1.0e-3, 1.0e4, 1.0e-6, 3.5e-12, 2.507943e-12),\n        # Case 2 (magnetically dominated)\n        (1.0e-8, 3.0e-3, 2.0e3, 5.0e-7, 1.375e-12, 1.368375e-12),\n        # Case 3 (near balance v_A ~ c_s)\n        (5.0e-7, 2.0e-3, 3.0e3, 2.0e-6, 9.0e-12, 5.484375e-12),\n        # Case 4 (very gas-pressure-dominated)\n        (2.0e-6, 5.0e-4, 2.0e4, 1.5e-6, 2.8125e-12, 2.250140e-12),\n        # Case 5 (extremely magnetically dominated)\n        (1.0e-9, 5.0e-3, 1.0e3, 8.0e-7, 3.36e-13, 3.359946e-13),\n    ]\n\n    results = []\n    for case in test_cases:\n        rho_0, B_0, c_s, k, gamma_A, gamma_F = case\n\n        # Calculate squared speeds: Alfvén, sound, and fast magnetosonic\n        v_A_sq = B_0**2 / (mu_0 * rho_0)\n        c_s_sq = c_s**2\n        c_f_sq = c_s_sq + v_A_sq\n\n        # The term c_s^2 is the denominator in the inversion for nu_num and eta_num.\n        # The problem asks to return NaN if a denominator is non-positive.\n        if c_s_sq = 0:\n            results.append(np.nan)\n            continue\n        \n        # Calculate the numerical magnetic Prandtl number, Pm_num = nu_num / eta_num,\n        # using the derived formula:\n        # Pm_num = (gamma_F * c_f^2 - gamma_A * v_A^2) / ((gamma_A - gamma_F) * c_f^2)\n        # This form is robust when implemented with double-precision floats.\n        numerator = gamma_F * c_f_sq - gamma_A * v_A_sq\n        denominator = (gamma_A - gamma_F) * c_f_sq\n        \n        # Avoid division by zero, which physically corresponds to eta_num = 0,\n        # leading to an infinite Prandtl number.\n        if abs(denominator)  1e-40:\n             pm_num = np.inf\n        else:\n             pm_num = numerator / denominator\n        \n        results.append(pm_num)\n\n    # Format the results as a list of strings with 6 decimal places.\n    formatted_results = [f\"{res:.6f}\" for res in results]\n    \n    # Final print statement in the exact required format.\n    print(f\"[{','.join(formatted_results)}]\")\n\nsolve()\n```", "id": "3521904"}, {"introduction": "在计算天体物理学中，数值方法的选择可以直接影响模拟的物理结果。这项实践利用一个简化但功能强大的常微分方程模型，来研究不同的磁场无散度约束策略（如约束输运与双曲清理）如何改变磁转动不稳定性的非线性饱和水平。这个练习将抽象的数值方法与关键的物理可观测量——饱和应力联系起来，揭示了算法选择与天体物理学解释之间的深刻联系 [@problem_id:3521863]。", "problem": "要求您设计并实现一个最小化的、自洽的计算实验，用于比较在磁旋转不稳定性（MRI）的局域剪切盒模型中，控制磁场散度的两种策略：约束输运（CT）与双曲清理（HC）。目标是通过无量纲应力参数 $\\alpha$ 来量化其对饱和振幅的影响，$\\alpha$ 定义为 $\\alpha = \\langle T_{xy} \\rangle / \\langle P \\rangle$，其中 $T_{xy}$ 是麦克斯韦应力和雷诺应力之和，而 $P$ 是热压力。您的程序必须生成单行输出，其中包含一个用方括号括起来的、以逗号分隔的列表，列表内容是针对指定测试用例的 $\\alpha$ 值，并四舍五入到六位小数。由于 $\\alpha$ 是无量纲的，输出不需要单位。\n\n从理想磁流体力学（MHD）的基本定律出发，在一个具有旋转速率 $\\Omega$ 和剪切参数 $q$ 的局域剪切盒中，考虑科里奥利和潮汐源项，以及磁场的感应方程。考虑均匀密度 $\\rho$ 和强度为 $B_0$ 的均匀垂直背景磁场，这定义了阿尔芬速度 $v_A = B_0 / \\sqrt{\\mu_0 \\rho}$，其中 $\\mu_0$ 是自由空间的磁导率。在这种设置下，一个具有垂直波数 $k$ 的单轴对称通道模扰动，可以通过一个简化的常微分方程（ODE）系统来建模。该系统描述了速度扰动分量 $u_x(t)$、$u_y(t)$ 和磁场扰动分量 $b_x(t)$、$b_y(t)$，其中磁场扰动以阿尔芬单位度量，$b_i = \\delta B_i / \\sqrt{\\mu_0 \\rho}$，从而使得磁场扰动和速度扰动具有相同的单位。简化的、不可压缩的、线性化的 MRI 系统为\n$$\n\\frac{d u_x}{d t} - 2 \\Omega u_y = k v_A b_x, \\quad\n\\frac{d u_y}{d t} + (2 - q) \\Omega u_x = k v_A b_y,\n$$\n$$\n\\frac{d b_x}{d t} = k v_A u_x, \\quad\n\\frac{d b_y}{d t} - q \\Omega b_x = k v_A u_y.\n$$\n为了在饱和状态下保持科学上的真实性，并模拟数值和微观物理耗散，需在上述方程中加入显式的运动粘性 $\\nu$ 和电阻率 $\\eta$，以及一个简单的、依赖于能量的寄生耗散项，该项模拟了次级不稳定性在大幅度时从通道模中消耗能量的过程。设 $E = u_x^2 + u_y^2 + b_x^2 + b_y^2$。需要积分的完整 ODE 系统是\n$$\n\\frac{d u_x}{d t} = 2 \\Omega u_y + k v_A b_x - \\nu k^2 u_x - \\kappa E u_x,\n$$\n$$\n\\frac{d u_y}{d t} = - (2 - q) \\Omega u_x + k v_A b_y - \\nu k^2 u_y - \\kappa E u_y,\n$$\n$$\n\\frac{d b_x}{d t} = k v_A u_x - \\eta k^2 b_x - \\kappa E b_x - \\gamma_{\\mathrm{H}} b_x,\n$$\n$$\n\\frac{d b_y}{d t} = q \\Omega b_x + k v_A u_y - \\eta k^2 b_y - \\kappa E b_y - \\gamma_{\\mathrm{H}} b_y.\n$$\n参数 $\\kappa  0$ 设定了寄生耗散的强度。参数 $\\gamma_{\\mathrm{H}}$ 模拟了散度清理对磁场扰动的影响：\n- 对于约束输运（CT），设置 $\\gamma_{\\mathrm{H}} = 0$，这反映了在离散演化中螺线管约束 $\\nabla \\cdot \\mathbf{B} = 0$ 的精确维持。\n- 对于双曲清理（HC），通过对磁场扰动施加线性阻尼来近似散度清理波的能量影响，阻尼率为\n$$\n\\gamma_{\\mathrm{H}} = \\sigma \\frac{c_h^2}{c_p^2},\n$$\n其中 $c_h$ 是清理波速，$c_p$ 是抛物线型阻尼控制速度，$\\sigma \\in [0,1]$ 是一个有效的数值耦合系数，它参数化了离散格式中螺线管磁场分量和非螺线管磁场分量之间无意的耦合。这个唯象闭合旨在在一个简化模型中捕捉双曲清理对 MRI 饱和的主要影响。\n\n将瞬时总应力定义为\n$$\nT_{xy}(t) = \\rho \\left(u_x u_y - b_x b_y\\right),\n$$\n它是雷诺应力 $\\rho u_x u_y$ 和麦克斯韦应力 $- \\rho b_x b_y$ 的和（因为 $b_i$ 是阿尔芬单位）。将饱和度量定义为\n$$\n\\alpha = \\frac{1}{P} \\frac{1}{t_2 - t_1} \\int_{t_1}^{t_2} T_{xy}(t) \\, dt,\n$$\n其中 $P$ 是热压力，$t_1 = \\frac{2}{3} T$ 是平均窗口的开始时间，$t_2 = T$ 是总持续时间为 $T$ 的模拟结束时间。\n\n算法要求：\n- 实现上述 ODE 系统，并使用固定步长的显式四阶 Runge–Kutta 方法进行积分。\n- 使用初始条件 $u_x(0) = u_y(0) = b_x(0) = b_y(0) = 10^{-6}$。\n- 使用均匀的时间步长 $\\Delta t$ 进行模拟，总时间为 $T$。\n- 计算 $\\alpha$，即 $T_{xy}(t)/P$ 在 $t \\in [t_1, t_2]$ 上的时间平均值。\n- 对于 CT 运行，使用 $\\gamma_{\\mathrm{H}} = 0$。对于 HC 运行，根据指定的 $c_h$、$c_p$ 和 $\\sigma$ 计算 $\\gamma_{\\mathrm{H}}$。\n\n测试套件：\n按指定顺序为以下三个参数集提供结果，每个参数集都使用 CT 和 HC 进行测试。所有下文未明确提及的常量在所有测试中共享，定义如下：$\\Omega = 1$，$q = \\frac{3}{2}$，$\\rho = 1$，$\\mu_0 = 1$，$P = 1$，$\\nu = 10^{-3}$，$\\eta = 10^{-3}$，$\\kappa = 2 \\times 10^{-2}$，$T = 150$，$\\Delta t = 10^{-2}$。阿尔芬速度 $v_A$ 和波数 $k$ 按情况给出。\n- 案例 1（MRI 不稳定基线）：$v_A = 10^{-1}$，$k = 5$。对于 HC，使用 $c_h = 1$，$c_p = 1$，$\\sigma = 2 \\times 10^{-1}$。\n- 案例 2（MRI 稳定边界）：$v_A = 10^{-1}$，$k = 40$。对于 HC，使用 $c_h = 1$，$c_p = 1$，$\\sigma = 2 \\times 10^{-1}$。该案例中 $k v_A  \\sqrt{2 q} \\, \\Omega$，因此预期不会出现线性 MRI 增长。\n- 案例 3（HC 近似 CT）：$v_A = 10^{-1}$，$k = 5$。对于 HC，使用 $c_h = 4$，$c_p = 2$，$\\sigma = 5 \\times 10^{-3}$。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个用方括号括起来的、以逗号分隔的六个结果列表，顺序如下：$\\left[\\alpha_{\\mathrm{CT,1}}, \\alpha_{\\mathrm{HC,1}}, \\alpha_{\\mathrm{CT,2}}, \\alpha_{\\mathrm{HC,2}}, \\alpha_{\\mathrm{CT,3}}, \\alpha_{\\mathrm{HC,3}}\\right]$，其中下标表示方法和案例索引。\n- 每个值必须四舍五入到六位小数。\n- 不应打印任何其他文本。\n\n在此设置中，所有量都是无量纲的，因此无需报告物理单位。角度没有明确出现；如果引入任何三角函数，其参数必须假定为弧度。输出是如上所述的纯浮点数。", "solution": "问题陈述经评估有效。它在科学上基于磁流体力学（MHD）的原理，特别是使用局域剪切盒近似法研究磁旋转不稳定性（MRI）。该问题是适定的，提供了完整的非线性常微分方程（ODE）组、所有必要的参数、初始条件以及清晰的数值求解方法。目标是通过量化两种数值策略对不稳定性饱和水平的影响，来比较它们在维持磁场螺线管约束（$\\nabla \\cdot \\mathbf{B} = 0$）方面的表现，这两种策略即约束输运（CT）和双曲清理（HC）。这是通过求解一个简化的唯象模型并计算无量纲应力参数 $\\alpha$ 来完成的。该问题在计算上是可行的，其组成部分均已明确定义。\n\n分析过程是通过求解指定的 ODE 系统来获得 MRI 的简化通道模模型中速度扰动（$u_x, u_y$）和磁场扰动（$b_x, b_y$）的演化。系统的状态向量为 $\\mathbf{y}(t) = [u_x(t), u_y(t), b_x(t), b_y(t)]^T$。控制方程如下：\n$$\n\\frac{d u_x}{d t} = 2 \\Omega u_y + k v_A b_x - \\nu k^2 u_x - \\kappa E u_x\n$$\n$$\n\\frac{d u_y}{d t} = - (2 - q) \\Omega u_x + k v_A b_y - \\nu k^2 u_y - \\kappa E u_y\n$$\n$$\n\\frac{d b_x}{d t} = k v_A u_x - \\eta k^2 b_x - \\kappa E b_x - \\gamma_{\\mathrm{H}} b_x\n$$\n$$\n\\frac{d b_y}{d t} = q \\Omega b_x + k v_A u_y - \\eta k^2 b_y - \\kappa E b_y - \\gamma_{\\mathrm{H}} b_y\n$$\n在此，$\\Omega$ 是角速度，$q$ 是剪切参数，$v_A$ 是阿尔芬速度，$k$ 是垂直波数。耗散效应由运动粘性 $\\nu$ 和电阻率 $\\eta$ 建模。饱和通过一个强度为 $\\kappa$ 的寄生耗散项实现，其中能量 $E$ 由 $E = u_x^2 + u_y^2 + b_x^2 + b_y^2$ 给出。\n\n参数 $\\gamma_{\\mathrm{H}}$ 封装了散度控制方案的效果。对于约束输运（CT）方法，该方法通过设计可将 $\\nabla \\cdot \\mathbf{B} = 0$ 维持在机器精度，我们设置 $\\gamma_{\\mathrm{H}} = 0$。对于双曲清理（HC）方法，该方法抑制散度误差，我们使用一个唯象阻尼项，其速率为 $\\gamma_{\\mathrm{H}} = \\sigma \\frac{c_h^2}{c_p^2}$，其中 $\\sigma$、$c_h$ 和 $c_p$ 是为 HC 案例指定的模型参数。\n\n该 ODE 系统是一个初值问题，我们使用固定时间步长 $\\Delta t$ 的显式四阶 Runge-Kutta (RK4) 方法进行数值求解。对于一个通用的 ODE 系统 $\\frac{d\\mathbf{y}}{dt} = f(t, \\mathbf{y})$，在时间 $t_{n+1}$ 的状态 $\\mathbf{y}_{n+1}$ 是通过在时间 $t_n$ 的状态 $\\mathbf{y}_n$ 计算得出的：\n$$\n\\mathbf{k}_1 = \\Delta t \\cdot f(t_n, \\mathbf{y}_n)\n$$\n$$\n\\mathbf{k}_2 = \\Delta t \\cdot f(t_n + \\frac{\\Delta t}{2}, \\mathbf{y}_n + \\frac{\\mathbf{k}_1}{2})\n$$\n$$\n\\mathbf{k}_3 = \\Delta t \\cdot f(t_n + \\frac{\\Delta t}{2}, \\mathbf{y}_n + \\frac{\\mathbf{k}_2}{2})\n$$\n$$\n\\mathbf{k}_4 = \\Delta t \\cdot f(t_n + \\Delta t, \\mathbf{y}_n + \\mathbf{k}_3)\n$$\n$$\n\\mathbf{y}_{n+1} = \\mathbf{y}_n + \\frac{1}{6}(\\mathbf{k}_1 + 2\\mathbf{k}_2 + 2\\mathbf{k}_3 + \\mathbf{k}_4)\n$$\n该系统从 $t=0$ 积分到 $t=T$，初始条件为 $u_x(0) = u_y(0) = b_x(0) = b_y(0) = 10^{-6}$。\n\n在获得状态变量的时间序列后，我们计算饱和应力参数 $\\alpha$。首先，计算瞬时应力 $T_{xy}(t)$。由于磁场扰动 $b_i$ 以阿尔芬单位表示，应力（雷诺应力和麦克斯韦应力之和）由下式给出：\n$$\nT_{xy}(t) = \\rho (u_x(t) u_y(t) - b_x(t) b_y(t))\n$$\n无量纲饱和参数 $\\alpha$ 是应力（由热压力 $P$ 归一化）在模拟时间的最后三分之一（从 $t_1 = \\frac{2}{3}T$ 到 $t_2 = T$）内的时间平均值：\n$$\n\\alpha = \\frac{\\langle T_{xy} \\rangle}{P} = \\frac{1}{P} \\left( \\frac{1}{t_2 - t_1} \\int_{t_1}^{t_2} T_{xy}(t) \\, dt \\right)\n$$\n在数值上，这被计算为在平均窗口 $[t_1, t_2]$ 内的每个时间步 $t_i$ 计算出的离散 $T_{xy}(t_i)$ 值的算术平均值。\n\n实现将包括一个定义 ODE 系统右侧的函数、一个实现 RK4 步骤的函数以及一个主控函数。该主函数将遍历指定的测试用例，为 CT 和 HC 方法设置参数，运行模拟，计算 $\\alpha$，并将四舍五入后的结果附加到列表中。最后，包含六个 $\\alpha$ 值的列表将以指定格式打印。所有模拟的参数为：$\\Omega = 1$，$q = 3/2$，$\\rho = 1$，$\\mu_0 = 1$，$P = 1$，$\\nu = 10^{-3}$，$\\eta = 10^{-3}$，$\\kappa = 2 \\times 10^{-2}$，$T = 150$，$\\Delta t = 10^{-2}$。特定于案例的参数 $v_A$、$k$ 以及 HC 参数将按照测试套件中的定义应用。", "answer": "```python\nimport numpy as np\n\ndef solve():\n    \"\"\"\n    Main function to run the computational experiment and print the results.\n    \"\"\"\n\n    # Shared parameters across all test cases\n    shared_params = {\n        'Omega': 1.0,\n        'q': 1.5,\n        'rho': 1.0,\n        'P': 1.0,\n        'nu': 1e-3,\n        'eta': 1e-3,\n        'kappa': 2e-2,\n        'T': 150.0,\n        'dt': 1e-2,\n    }\n\n    # Test case definitions\n    test_cases = [\n        {   # Case 1: MRI-unstable baseline\n            'v_A': 1e-1,\n            'k': 5.0,\n            'hc_params': {'c_h': 1.0, 'c_p': 1.0, 'sigma': 2e-1}\n        },\n        {   # Case 2: MRI-stable boundary\n            'v_A': 1e-1,\n            'k': 40.0,\n            'hc_params': {'c_h': 1.0, 'c_p': 1.0, 'sigma': 2e-1}\n        },\n        {   # Case 3: HC approximating CT\n            'v_A': 1e-1,\n            'k': 5.0,\n            'hc_params': {'c_h': 4.0, 'c_p': 2.0, 'sigma': 5e-3}\n        }\n    ]\n\n    results = []\n    for case in test_cases:\n        # Run 1: Constrained Transport (CT)\n        params_ct = {**shared_params, **case, 'gamma_H': 0.0}\n        alpha_ct = run_simulation(params_ct)\n        results.append(round(alpha_ct, 6))\n\n        # Run 2: Hyperbolic Cleaning (HC)\n        hc = case['hc_params']\n        gamma_H_hc = hc['sigma'] * (hc['c_h']**2 / hc['c_p']**2)\n        params_hc = {**shared_params, **case, 'gamma_H': gamma_H_hc}\n        alpha_hc = run_simulation(params_hc)\n        results.append(round(alpha_hc, 6))\n\n    # Format and print the final output\n    print(f\"[{','.join(map(str, results))}]\")\n\ndef ode_rhs(y, params):\n    \"\"\"\n    Computes the right-hand side of the MRI ODE system.\n    y: state vector [ux, uy, bx, by]\n    params: dictionary of physical and numerical parameters\n    \"\"\"\n    ux, uy, bx, by = y\n    \n    # Unpack parameters\n    Omega = params['Omega']\n    q = params['q']\n    k = params['k']\n    v_A = params['v_A']\n    nu = params['nu']\n    eta = params['eta']\n    kappa = params['kappa']\n    gamma_H = params['gamma_H']\n\n    # Energy in the perturbations\n    E = ux**2 + uy**2 + bx**2 + by**2\n\n    # Physical dissipation terms\n    visc_diss = nu * k**2\n    res_diss = eta * k**2\n    \n    # Derivatives\n    dux_dt = 2.0 * Omega * uy + k * v_A * bx - visc_diss * ux - kappa * E * ux\n    duy_dt = -(2.0 - q) * Omega * ux + k * v_A * by - visc_diss * uy - kappa * E * uy\n    dbx_dt = k * v_A * ux - res_diss * bx - kappa * E * bx - gamma_H * bx\n    dby_dt = q * Omega * bx + k * v_A * uy - res_diss * by - kappa * E * by - gamma_H * by\n    \n    return np.array([dux_dt, duy_dt, dbx_dt, dby_dt])\n\ndef rk4_step(func, y, dt, params):\n    \"\"\"\n    Performs a single step of the 4th-order Runge-Kutta method.\n    \"\"\"\n    k1 = dt * func(y, params)\n    k2 = dt * func(y + 0.5 * k1, params)\n    k3 = dt * func(y + 0.5 * k2, params)\n    k4 = dt * func(y + k3, params)\n    \n    return y + (k1 + 2.0 * k2 + 2.0 * k3 + k4) / 6.0\n\ndef run_simulation(params):\n    \"\"\"\n    Integrates the ODE system and computes the alpha parameter.\n    \"\"\"\n    # Unpack parameters\n    T = params['T']\n    dt = params['dt']\n    rho = params['rho']\n    P = params['P']\n\n    # Time setup\n    n_steps = int(T / dt)\n    t_start_avg_idx = int((2.0/3.0 * T) / dt)\n\n    # Initial conditions\n    y = np.array([1e-6, 1e-6, 1e-6, 1e-6])\n    \n    stress_values = []\n    \n    # Main integration loop\n    for i in range(n_steps):\n        y = rk4_step(ode_rhs, y, dt, params)\n        \n        # Collect stress values in the averaging window\n        if i >= t_start_avg_idx:\n            ux, uy, bx, by = y\n            T_xy = rho * (ux * uy - bx * by)\n            stress_values.append(T_xy)\n            \n    # Compute alpha\n    avg_T_xy = np.mean(stress_values) if stress_values else 0.0\n    alpha = avg_T_xy / P\n    \n    return alpha\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3521863"}]}