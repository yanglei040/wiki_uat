{"hands_on_practices": [{"introduction": "在应用一种数值修正方法之前，首先必须定量地理解其要解决的问题。本练习将通过分析标准有限元单元的刚度矩阵，揭示体积锁定的数学本质。通过推导单元刚度矩阵的条件数，并将其表示为材料体积模量与剪切模量之比（$\\kappa/G$）的函数，你将能够精确地观察到当材料趋于不可压缩时，数值病态性是如何产生的，这正是体积锁死的根源 `[@problem_id:3502468]`。", "problem": "考虑一个各向同性、均匀、线弹性、平面应变、四节点双线性四边形单元(Q4)，该单元占据一个边长为 $h$、单位厚度的方形区域。该单元采用 $2 \\times 2$ Gauss 法则进行积分。设材料的体积模量为 $\\kappa$，剪切模量为 $G$，Lamé 参数定义为 $\\mu = G$ 和 $\\lambda = \\kappa - \\frac{2}{3}G$。单元刚度由基本有限元法则 $K_{e} = \\int_{\\Omega_{e}} B^{\\top} D B \\,\\mathrm{d}\\Omega$ 定义，其中 $B$ 是协调的应变-位移矩阵，$D$ 是对应于平面应变的 Voigt 记法下的材料刚度，作用于应变向量 $[\\varepsilon_{xx}, \\varepsilon_{yy}, \\gamma_{xy}]^{\\top}$，其中工程剪应变 $\\gamma_{xy} = 2 \\varepsilon_{xy}$。\n\n刚体运动使得完整的单元刚度矩阵奇异。为了定义一个有意义的条件数，将 $K_{e}$ 的作用限制在双线性 Q4 单元能够精确再现的协调常应变子空间上，即均匀的 $\\varepsilon_{xx}$、均匀的 $\\varepsilon_{yy}$ 和均匀的 $\\gamma_{xy}$。在此子空间中，$K_{e}$ 的能量贡献仅由材料刚度 $D$ 决定，并乘以一个正的单元面积缩放因子。\n\n从第一性原理出发，推导单元刚度在此常应变子空间中的条件数（最大特征值与最小特征值之比），并将其表示为关于无量纲比值 $\\kappa/G$ 的闭式解析表达式。然后，简要解释此条件数相对于 $\\kappa/G$ 的增长率，以此作为标准全积分 Q4 单元中体积锁死的定量证据。你的最终答案必须是条件数作为 $\\kappa/G$ 函数的精确解析表达式；无需四舍五入，且答案是无量纲的。", "solution": "问题要求在平面应变条件下，推导四节点双线性四边形单元 (Q4) 刚度矩阵在常应变子空间上的条件数。该条件数需要用体积模量 $\\kappa$ 与剪切模量 $G$ 的比值来表示。\n\n问题指出，对于常应变状态，单元的能量响应由材料刚度矩阵 $D$ 决定，并按单元面积进行缩放。单元刚度矩阵由 $K_{e} = \\int_{\\Omega_{e}} B^{\\top} D B \\,\\mathrm{d}\\Omega$ 给出。对于常应变场 $\\boldsymbol{\\varepsilon}$，应变-位移矩阵 $B$ 成为一个将节点位移与此应变状态联系起来的常数矩阵，积分结果就是单元面积 $A_e = h^2$（对于单位厚度）。应变能为 $U_e = \\frac{1}{2} A_e \\boldsymbol{\\varepsilon}^{\\top} D \\boldsymbol{\\varepsilon}$。因此，该子空间中的刚度特性与材料矩阵 $D$ 成正比。此子空间中刚度算子的条件数与矩阵 $D$ 的条件数相同，因为任何标量前置因子（如面积 $A_e$）在特征值的比值中都会被抵消。对称正定矩阵的条件数是其最大特征值与最小特征值之比，即 $\\text{cond}(D) = \\lambda_{\\max}(D) / \\lambda_{\\min}(D)$。因此，我们的任务简化为求解平面应变材料刚度矩阵 $D$ 的特征值。\n\n对于各向同性线弹性材料，平面应变情况下的 Voigt 记法本构关系通过 $\\boldsymbol{\\sigma} = D \\boldsymbol{\\varepsilon}$ 将应力向量 $\\boldsymbol{\\sigma} = [\\sigma_{xx}, \\sigma_{yy}, \\sigma_{xy}]^{\\top}$ 与工程应变向量 $\\boldsymbol{\\varepsilon} = [\\varepsilon_{xx}, \\varepsilon_{yy}, \\gamma_{xy}]^{\\top}$ 联系起来。矩阵 $D$ 由下式给出：\n$$\nD = \\begin{pmatrix} \\lambda + 2\\mu  \\lambda  0 \\\\ \\lambda  \\lambda + 2\\mu  0 \\\\ 0  0  \\mu \\end{pmatrix}\n$$\n问题给出了以体积模量 $\\kappa$ 和剪切模量 $G$ 表示的 Lamé 参数：\n$$ \\mu = G $$\n$$ \\lambda = \\kappa - \\frac{2}{3}G $$\n将这些参数代入矩阵 $D$：\n$$ \\lambda + 2\\mu = \\left(\\kappa - \\frac{2}{3}G\\right) + 2G = \\kappa + \\frac{4}{3}G $$\n因此，材料刚度矩阵变为：\n$$\nD = \\begin{pmatrix} \\kappa + \\frac{4}{3}G  \\kappa - \\frac{2}{3}G  0 \\\\ \\kappa - \\frac{2}{3}G  \\kappa + \\frac{4}{3}G  0 \\\\ 0  0  G \\end{pmatrix}\n$$\n为了求 $D$ 的特征值，我们可以利用其块对角结构。从右下角的 $1 \\times 1$ 块可以立即看出一个特征值：\n$$ \\lambda_1 = G $$\n该特征值对应于与 $\\gamma_{xy}$ 相关的纯剪切变形模式。\n\n另外两个特征值可以从左上角的 $2 \\times 2$ 子矩阵中求得，我们将其记为 $D_{sub}$：\n$$\nD_{sub} = \\begin{pmatrix} \\kappa + \\frac{4}{3}G  \\kappa - \\frac{2}{3}G \\\\ \\kappa - \\frac{2}{3}G  \\kappa + \\frac{4}{3}G \\end{pmatrix}\n$$\n$D_{sub}$ 的特征值 $\\eta$ 是特征方程 $\\det(D_{sub} - \\eta I) = 0$ 的根：\n$$\n\\det \\begin{pmatrix} \\kappa + \\frac{4}{3}G - \\eta  \\kappa - \\frac{2}{3}G \\\\ \\kappa - \\frac{2}{3}G  \\kappa + \\frac{4}{3}G - \\eta \\end{pmatrix} = 0\n$$\n$$\n\\left(\\kappa + \\frac{4}{3}G - \\eta\\right)^2 - \\left(\\kappa - \\frac{2}{3}G\\right)^2 = 0\n$$\n这给出了两种可能性：\n$1.$ $\\kappa + \\frac{4}{3}G - \\eta = \\kappa - \\frac{2}{3}G$\n$$ \\eta = \\left(\\kappa + \\frac{4}{3}G\\right) - \\left(\\kappa - \\frac{2}{3}G\\right) = \\frac{4}{3}G + \\frac{2}{3}G = 2G $$\n令此为 $\\lambda_2 = 2G$。该特征值对应于偏应变（体积保持）状态，具体来说是 $\\varepsilon_{xx} = -\\varepsilon_{yy}$ 的情况。\n\n$2.$ $\\kappa + \\frac{4}{3}G - \\eta = -\\left(\\kappa - \\frac{2}{3}G\\right)$\n$$ \\eta = \\left(\\kappa + \\frac{4}{3}G\\right) + \\left(\\kappa - \\frac{2}{3}G\\right) = 2\\kappa + \\frac{2}{3}G $$\n令此为 $\\lambda_3 = 2\\kappa + \\frac{2}{3}G$。该特征值对应于纯体积应变状态，即 $\\varepsilon_{xx} = \\varepsilon_{yy}$ 的情况。\n\n因此，材料矩阵 $D$ 的三个特征值为：\n$$ \\{ \\lambda_1, \\lambda_2, \\lambda_3 \\} = \\left\\{ G, 2G, 2\\kappa + \\frac{2}{3}G \\right\\} $$\n对于物理上稳定的材料，$\\kappa$ 和 $G$ 均为正值。因此，所有三个特征值都是正的。\n\n条件数是最大特征值与最小特征值之比：\n$$ \\text{cond}(D) = \\frac{\\lambda_{\\max}}{\\lambda_{\\min}} $$\n最小特征值显然是 $\\lambda_{\\min} = G$。\n最大特征值是 $\\lambda_{\\max} = \\max\\left(2G, 2\\kappa + \\frac{2}{3}G\\right)$。\n\n体积锁死现象发生在近乎不可压缩的极限情况下，此时泊松比 $\\nu \\to 0.5$。这个极限对应于体积模量远大于剪切模量，即 $\\kappa/G \\to \\infty$。对于任何 $\\nu > 0$ 的材料，我们有 $\\kappa > \\frac{2}{3}G$，这意味着 $2\\kappa + \\frac{2}{3}G > 2\\kappa > \\frac{4}{3}G$。我们必须将 $2\\kappa + \\frac{2}{3}G$ 与 $2G$ 进行比较。不等式 $2\\kappa + \\frac{2}{3}G > 2G$ 可简化为 $2\\kappa > \\frac{4}{3}G$，或 $\\kappa/G > 2/3$。这对于任何具有正泊松比的材料都是成立的。由于上下文是关于体积锁死的，我们关心的是这个区间。因此，最大特征值是：\n$$ \\lambda_{\\max} = 2\\kappa + \\frac{2}{3}G $$\n那么条件数为：\n$$ \\text{cond}(D) = \\frac{2\\kappa + \\frac{2}{3}G}{G} = 2\\frac{\\kappa}{G} + \\frac{2}{3} $$\n这就是所求的闭式表达式。\n\n为了进行解释，我们分析此条件数相对于比值 $R = \\kappa/G$ 的增长率。条件数为 $\\text{cond}(D) = 2R + 2/3$。其增长率为 $\\frac{\\mathrm{d}}{\\mathrm{d}R}(\\text{cond}(D)) = 2$。这种线性增长表明，当材料接近不可压缩性时（$\\kappa/G \\to \\infty$），矩阵 $D$（以及常应变模式下的单元刚度）的病态程度越来越严重。体积锁死是一种数值伪影，其中单元对体积变形表现出过度刚性的响应。条件数将这种差异量化：单元在体积模式下的刚度（与 $2\\kappa + \\frac{2}{3}G$ 成正比）相对于其在剪切模式下的刚度（与 $G$ 和 $2G$ 成正比）无界增长。特征值之间的巨大差异导致了较差的数值性能和全局系统的人为刚化，这正是体积锁死的标志。线性增长率提供了一个精确的定量度量，说明这种数值病态如何随着材料的不可压缩性而恶化。", "answer": "$$\n\\boxed{2\\frac{\\kappa}{G} + \\frac{2}{3}}\n$$", "id": "3502468"}, {"introduction": "确诊了体积锁定的问题之后，我们转向推导B-bar方法的核心构件。此练习要求你为经典的四节点四边形单元推导其单元平均的体积应变算子 $\\bar{b}_v$ `[@problem_id:3502521]`。这个常数向量是B-bar方法的关键，它使得我们能够用一个在单元上更稳定的平均值来替代有问题的逐点计算的体积应变。", "problem": "考虑一个在小应变、二维设置下的四节点双线性四边形单元 (Q4)，该单元用于计算岩土力学中的有限元法 (FEM)。该单元占据一个边长为 $L_x$ 和 $L_y$ 的矩形物理域 $\\Omega_e$，与笛卡尔坐标轴对齐，节点从左下角开始逆时针编号。令从自然坐标 $(\\xi, \\eta) \\in [-1,1] \\times [-1,1]$ 到物理坐标 $(x,y)$ 的等参映射为仿射映射，由 $x = x_c + \\frac{L_x}{2}\\,\\xi$ 和 $y = y_c + \\frac{L_y}{2}\\,\\eta$ 给出，其中 $(x_c,y_c)$ 是矩形的中心。双线性形函数为\n$$\nN_1(\\xi,\\eta) = \\frac{1}{4}(1-\\xi)(1-\\eta),\\quad\nN_2(\\xi,\\eta) = \\frac{1}{4}(1+\\xi)(1-\\eta),\\quad\nN_3(\\xi,\\eta) = \\frac{1}{4}(1+\\xi)(1+\\eta),\\quad\nN_4(\\xi,\\eta) = \\frac{1}{4}(1-\\xi)(1+\\eta).\n$$\n令节点位移向量为 $d = [u_1, v_1, u_2, v_2, u_3, v_3, u_4, v_4]^{\\top}$，插值位移场为 $u(x,y) = \\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,u_i$， $v(x,y) = \\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,v_i$。在小应变运动学下，体积应变定义为 $\\epsilon_v(x,y) = \\frac{\\partial u}{\\partial x} + \\frac{\\partial v}{\\partial y}$。\n\n所谓的 $B$-bar 方法（也写作 $\\,\\bar{B}\\,$ 方法）通过将体积应变替换为其单元常数投影来减轻近不可压缩材料中的体积锁定，该方法使用常体积投影向量 $\\bar{b}_v$，使得投影体积应变为 $\\bar{\\epsilon}_v = \\bar{b}_v\\,d$，其中\n$$\n\\bar{b}_v = \\frac{1}{\\Omega_e}\\int_{\\Omega_e} b_v(\\mathbf{x})\\,d\\Omega,\\quad \\Omega_e = L_x L_y,\n$$\n其中 $b_v(\\mathbf{x})$ 是满足 $\\epsilon_v(\\mathbf{x}) = b_v(\\mathbf{x})\\,d$ 的体积应变-位移算子。\n\n从小应变运动学和上述等参插值出发，推导此矩形 Q4 单元的常体积投影向量 $\\bar{b}_v$ 的显式闭式表达式，该表达式仅用 $L_x$ 和 $L_y$ 表示，并按 $[u_1, v_1, u_2, v_2, u_3, v_3, u_4, v_4]$ 的顺序列出。然后，将投影体积应变写成 $\\bar{\\epsilon}_v = \\bar{b}_v\\,d$ 的形式。你的最终答案必须是 $\\bar{b}_v$ 的单个闭式解析表达式。不需要数值近似，并且最终方框内的表达式不应包含单位。", "solution": "用户希望找到一个矩形四节点双线性四边形单元的常体积投影向量 $\\bar{b}_v$。\n\n### 步骤 1：提取已知条件\n-   **单元类型**：四节点双线性四边形 (Q4)。\n-   **域**：边长为 $L_x$ 和 $L_y$ 的矩形物理域 $\\Omega_e$。\n-   **等参映射**：对于 $(\\xi, \\eta) \\in [-1,1] \\times [-1,1]$，$x = x_c + \\frac{L_x}{2}\\,\\xi$ 和 $y = y_c + \\frac{L_y}{2}\\,\\eta$。此映射是仿射的。\n-   **形函数**：\n    $N_1(\\xi,\\eta) = \\frac{1}{4}(1-\\xi)(1-\\eta)$\n    $N_2(\\xi,\\eta) = \\frac{1}{4}(1+\\xi)(1-\\eta)$\n    $N_3(\\xi,\\eta) = \\frac{1}{4}(1+\\xi)(1+\\eta)$\n    $N_4(\\xi,\\eta) = \\frac{1}{4}(1-\\xi)(1+\\eta)$\n-   **节点位移**：$d = [u_1, v_1, u_2, v_2, u_3, v_3, u_4, v_4]^{\\top}$。\n-   **插值位移场**：$u(x,y) = \\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,u_i$，$v(x,y) = \\sum_{i=1}^{4} N_i(\\xi,\\eta)\\,v_i$。\n-   **体积应变 (小应变)**：$\\epsilon_v(x,y) = \\frac{\\partial u}{\\partial x} + \\frac{\\partial v}{\\partial y}$。\n-   **应变-位移算子**：$\\epsilon_v(\\mathbf{x}) = b_v(\\mathbf{x})\\,d$。\n-   **常体积投影向量定义**：$\\bar{b}_v = \\frac{1}{\\Omega_e}\\int_{\\Omega_e} b_v(\\mathbf{x})\\,d\\Omega$，其中单元面积 $\\Omega_e = L_x L_y$。\n\n### 步骤 2：使用提取的已知条件进行验证\n-   **科学依据**：该问题是有限元法 (FEM) 背景下的一个标准推导，特别是用于实现 $\\bar{B}$ 方法以解决体积锁定问题。所有概念，包括等参映射、形函数、应变定义和投影方法，都是计算力学中公认的原理，并且在数学上是合理的。\n-   **良态的**：该问题要求基于一组清晰完整的定义和方程推导一个特定量 $\\bar{b}_v$。输入足以确定一个唯一的解析解。\n-   **客观性**：该问题使用精确的数学语言和标准的 FEM 术语进行陈述，没有任何主观或模棱两可的说法。\n\n### 步骤 3：结论和行动\n该问题是有效的。这是一个来自计算力学的良态的、有科学依据的问题。我现在将进行完整的推导。\n\n目标是计算常体积投影向量 $\\bar{b}_v$，其定义为：\n$$\n\\bar{b}_v = \\frac{1}{\\Omega_e}\\int_{\\Omega_e} b_v(\\mathbf{x})\\,d\\Omega\n$$\n首先，我们必须确定体积应变-位移算子 $b_v(\\mathbf{x})$。体积应变由 $\\epsilon_v = \\frac{\\partial u}{\\partial x} + \\frac{\\partial v}{\\partial y}$ 给出。代入插值位移场：\n$$\n\\epsilon_v = \\frac{\\partial}{\\partial x}\\left(\\sum_{i=1}^{4} N_i u_i\\right) + \\frac{\\partial}{\\partial y}\\left(\\sum_{i=1}^{4} N_i v_i\\right) = \\sum_{i=1}^{4} \\left(\\frac{\\partial N_i}{\\partial x} u_i + \\frac{\\partial N_i}{\\partial y} v_i\\right)\n$$\n这可以写成矩阵形式 $\\epsilon_v = b_v d$，其中 $d$ 是节点位移向量，$b_v$ 是一个行向量算子：\n$$\nb_v = \\begin{bmatrix} \\frac{\\partial N_1}{\\partial x}  \\frac{\\partial N_1}{\\partial y}  \\frac{\\partial N_2}{\\partial x}  \\frac{\\partial N_2}{\\partial y}  \\frac{\\partial N_3}{\\partial x}  \\frac{\\partial N_3}{\\partial y}  \\frac{\\partial N_4}{\\partial x}  \\frac{\\partial N_4}{\\partial y} \\end{bmatrix}\n$$\n为了找到形函数的空间导数，我们使用等参映射的链式法则：\n$$\n\\begin{Bmatrix} \\frac{\\partial N_i}{\\partial \\xi} \\\\ \\frac{\\partial N_i}{\\partial \\eta} \\end{Bmatrix} = \\begin{bmatrix} \\frac{\\partial x}{\\partial \\xi}  \\frac{\\partial y}{\\partial \\xi} \\\\ \\frac{\\partial x}{\\partial \\eta}  \\frac{\\partial y}{\\partial \\eta} \\end{bmatrix} \\begin{Bmatrix} \\frac{\\partial N_i}{\\partial x} \\\\ \\frac{\\partial N_i}{\\partial y} \\end{Bmatrix} = J \\begin{Bmatrix} \\frac{\\partial N_i}{\\partial x} \\\\ \\frac{\\partial N_i}{\\partial y} \\end{Bmatrix}\n$$\n其中 $J$ 是变换的雅可比矩阵。从给定的仿射映射 $x = x_c + \\frac{L_x}{2}\\xi$ 和 $y = y_c + \\frac{L_y}{2}\\eta$ 可得，雅可比矩阵的分量为：\n$$\n\\frac{\\partial x}{\\partial \\xi} = \\frac{L_x}{2}, \\quad \\frac{\\partial y}{\\partial \\xi} = 0\n$$\n$$\n\\frac{\\partial x}{\\partial \\eta} = 0, \\quad \\frac{\\partial y}{\\partial \\eta} = \\frac{L_y}{2}\n$$\n因此，对于矩形单元，雅可比矩阵是常数：\n$$\nJ = \\begin{bmatrix} \\frac{L_x}{2}  0 \\\\ 0  \\frac{L_y}{2} \\end{bmatrix}\n$$\n$N_i$ 的空间导数可以通过反转此关系找到：\n$$\n\\begin{Bmatrix} \\frac{\\partial N_i}{\\partial x} \\\\ \\frac{\\partial N_i}{\\partial y} \\end{Bmatrix} = J^{-1} \\begin{Bmatrix} \\frac{\\partial N_i}{\\partial \\xi} \\\\ \\frac{\\partial N_i}{\\partial \\eta} \\end{Bmatrix} = \\begin{bmatrix} \\frac{2}{L_x}  0 \\\\ 0  \\frac{2}{L_y} \\end{bmatrix} \\begin{Bmatrix} \\frac{\\partial N_i}{\\partial \\xi} \\\\ \\frac{\\partial N_i}{\\partial \\eta} \\end{Bmatrix}\n$$\n所以，$\\frac{\\partial N_i}{\\partial x} = \\frac{2}{L_x} \\frac{\\partial N_i}{\\partial \\xi}$ 和 $\\frac{\\partial N_i}{\\partial y} = \\frac{2}{L_y} \\frac{\\partial N_i}{\\partial \\eta}$。\n\n接下来，我们计算形函数关于自然坐标 $(\\xi, \\eta)$ 的导数：\n$$\n\\frac{\\partial N_1}{\\partial \\xi} = -\\frac{1}{4}(1-\\eta), \\quad \\frac{\\partial N_1}{\\partial \\eta} = -\\frac{1}{4}(1-\\xi)\n$$\n$$\n\\frac{\\partial N_2}{\\partial \\xi} = \\frac{1}{4}(1-\\eta), \\quad \\frac{\\partial N_2}{\\partial \\eta} = -\\frac{1}{4}(1+\\xi)\n$$\n$$\n\\frac{\\partial N_3}{\\partial \\xi} = \\frac{1}{4}(1+\\eta), \\quad \\frac{\\partial N_3}{\\partial \\eta} = \\frac{1}{4}(1+\\xi)\n$$\n$$\n\\frac{\\partial N_4}{\\partial \\xi} = -\\frac{1}{4}(1+\\eta), \\quad \\frac{\\partial N_4}{\\partial \\eta} = \\frac{1}{4}(1-\\xi)\n$$\n现在我们可以用 $\\xi$ 和 $\\eta$ 来表示 $b_v$ 的分量：\n-   对于节点 1：$\\frac{\\partial N_1}{\\partial x} = -\\frac{1}{2 L_x}(1-\\eta)$，$\\frac{\\partial N_1}{\\partial y} = -\\frac{1}{2 L_y}(1-\\xi)$\n-   对于节点 2：$\\frac{\\partial N_2}{\\partial x} = \\frac{1}{2 L_x}(1-\\eta)$，$\\frac{\\partial N_2}{\\partial y} = -\\frac{1}{2 L_y}(1+\\xi)$\n-   对于节点 3：$\\frac{\\partial N_3}{\\partial x} = \\frac{1}{2 L_x}(1+\\eta)$，$\\frac{\\partial N_3}{\\partial y} = \\frac{1}{2 L_y}(1+\\xi)$\n-   对于节点 4：$\\frac{\\partial N_4}{\\partial x} = -\\frac{1}{2 L_x}(1+\\eta)$，$\\frac{\\partial N_4}{\\partial y} = \\frac{1}{2 L_y}(1-\\xi)$\n\n向量 $\\bar{b}_v$ 是 $b_v$ 的单元平均值。在物理域 $\\Omega_e$ 上的积分被转换为在母域 $[-1,1] \\times [-1,1]$ 上的积分：\n$$\n\\bar{b}_v = \\frac{1}{\\Omega_e} \\int_{-1}^1 \\int_{-1}^1 b_v(\\xi, \\eta) |J| \\,d\\xi d\\eta\n$$\n雅可比行列式是 $|J| = (\\frac{L_x}{2})(\\frac{L_y}{2}) = \\frac{L_x L_y}{4} = \\frac{\\Omega_e}{4}$。\n将 $|J|$ 代入积分表达式：\n$$\n\\bar{b}_v = \\frac{1}{\\Omega_e} \\int_{-1}^1 \\int_{-1}^1 b_v(\\xi, \\eta) \\frac{\\Omega_e}{4} \\,d\\xi d\\eta = \\frac{1}{4} \\int_{-1}^1 \\int_{-1}^1 b_v(\\xi, \\eta) \\,d\\xi d\\eta\n$$\n我们需要对 $b_v(\\xi, \\eta)$ 的每个分量进行积分。由于每个分量都是 $\\xi$ 和 $\\eta$ 的线性函数，形式为 $a+b\\xi+c\\eta$，其在对称域 $[-1,1] \\times [-1,1]$ 上的积分为：\n$$\n\\frac{1}{4}\\int_{-1}^1\\int_{-1}^1 (a+b\\xi+c\\eta)\\,d\\xi d\\eta = \\frac{1}{4} (a \\cdot 4 + b \\cdot 0 + c \\cdot 0) = a\n$$\n这意味着我们只需要找到 $b_v$ 每个分量的常数项。\n-   $\\frac{\\partial N_1}{\\partial x} = -\\frac{1}{2L_x} + \\frac{\\eta}{2L_x} \\implies \\text{平均值} = -\\frac{1}{2L_x}$\n-   $\\frac{\\partial N_1}{\\partial y} = -\\frac{1}{2L_y} + \\frac{\\xi}{2L_y} \\implies \\text{平均值} = -\\frac{1}{2L_y}$\n-   $\\frac{\\partial N_2}{\\partial x} = \\frac{1}{2L_x} - \\frac{\\eta}{2L_x} \\implies \\text{平均值} = \\frac{1}{2L_x}$\n-   $\\frac{\\partial N_2}{\\partial y} = -\\frac{1}{2L_y} - \\frac{\\xi}{2L_y} \\implies \\text{平均值} = -\\frac{1}{2L_y}$\n-   $\\frac{\\partial N_3}{\\partial x} = \\frac{1}{2L_x} + \\frac{\\eta}{2L_x} \\implies \\text{平均值} = \\frac{1}{2L_x}$\n-   $\\frac{\\partial N_3}{\\partial y} = \\frac{1}{2L_y} + \\frac{\\xi}{2L_y} \\implies \\text{平均值} = \\frac{1}{2L_y}$\n-   $\\frac{\\partial N_4}{\\partial x} = -\\frac{1}{2L_x} - \\frac{\\eta}{2L_x} \\implies \\text{平均值} = -\\frac{1}{2L_x}$\n-   $\\frac{\\partial N_4}{\\partial y} = \\frac{1}{2L_y} - \\frac{\\xi}{2L_y} \\implies \\text{平均值} = \\frac{1}{2L_y}$\n\n根据节点位移顺序 $[u_1, v_1, u_2, v_2, u_3, v_3, u_4, v_4]$ 将这些平均值组合成向量 $\\bar{b}_v$：\n$$\n\\bar{b}_v = \\begin{bmatrix} -\\frac{1}{2L_x}  -\\frac{1}{2L_y}  \\frac{1}{2L_x}  -\\frac{1}{2L_y}  \\frac{1}{2L_x}  \\frac{1}{2L_y}  -\\frac{1}{2L_x}  \\frac{1}{2L_y} \\end{bmatrix}\n$$\n通过提取公因式 $\\frac{1}{2L_x L_y}$，可以使该表达式更加紧凑：\n$$\n\\bar{b}_v = \\frac{1}{2L_x L_y} \\begin{bmatrix} -L_y  -L_x  L_y  -L_x  L_y  L_x  -L_y  L_x \\end{bmatrix}\n$$\n因此，投影体积应变可以写为 $\\bar{\\epsilon}_v = \\bar{b}_v d$，它代表了常数的、单元平均的体积应变。\n$$\n\\bar{\\epsilon}_v = \\frac{1}{2L_x}(-u_1+u_2+u_3-u_4) + \\frac{1}{2L_y}(-v_1-v_2+v_3+v_4)\n$$\n这证实了推导出的向量的分量。最终答案是向量 $\\bar{b}_v$。", "answer": "$$\n\\boxed{\\frac{1}{2L_x L_y} \\begin{bmatrix} -L_y  -L_x  L_y  -L_x  L_y  L_x  -L_y  L_x \\end{bmatrix}}\n$$", "id": "3502521"}, {"introduction": "一个有效的数值方法不仅需要解决特定问题，还必须保证其自身的稳定性。本练习通过编程实践，验证B-bar修正是否会引入非物理的“伪零能模式”（spurious zero-energy modes）。通过对标准刚度矩阵和B-bar修正后的刚度矩阵进行特征值分析 `[@problem_id:3502461]`，你将从计算上确认B-bar单元的稳健性和可靠性，确保其在解决锁定问题的同时不会牺牲结构的稳定性。", "problem": "您需要分析B-bar（记为 $\\bar{B}$）修正是否会在平面应变、小应变线性弹性条件下的四节点双线性四边形单元（Quadrilateral four-node (Q4)）中引入任何伪零能模式。您的分析必须从第一性原理出发，并编写一个程序来构建单元刚度矩阵，执行特征分析，并定量比较标准公式和$\\bar{B}$修正公式的零空间属性。\n\n基本和建模假设：\n- 运动学：小应变，因此对称无穷小应变张量$\\boldsymbol{\\varepsilon}$定义为 $\\varepsilon_{ij} = \\tfrac{1}{2}\\left(u_{i,j} + u_{j,i}\\right)$。\n- 离散化：在凸四边形上使用双线性形函数的等参Q4单元。位移场通过插值得到 $\\mathbf{u}(\\mathbf{x}) = \\sum_{a=1}^{4} N_a(\\xi,\\eta)\\,\\mathbf{u}_a$，其中 $(\\xi,\\eta)\\in[-1,1]^2$ 是自然坐标。\n- 数值积分：使用 $2\\times 2$ 点的标准高斯积分。\n- 材料：均匀、各向同性、平面应变线性弹性材料，杨氏模量为 $E$（单位：帕斯卡），泊松比为 $\\nu$。设拉梅参数为 $\\lambda = \\dfrac{E\\nu}{(1+\\nu)(1-2\\nu)}$ 和 $\\mu = \\dfrac{E}{2(1+\\nu)}$。在 $(\\sigma_{xx},\\sigma_{yy},\\tau_{xy})$–$(\\varepsilon_{xx},\\varepsilon_{yy},\\gamma_{xy})$ 表示法中，本构矩阵为\n$$\n\\mathbf{D} \\;=\\;\n\\begin{bmatrix}\n\\lambda + 2\\mu   \\lambda   0 \\\\\n\\lambda   \\lambda + 2\\mu   0 \\\\\n0   0   \\mu\n\\end{bmatrix}.\n$$\n- 标准单元刚度：对于每个权重为 $w_i$、雅可比行列式为 $J_i$ 的高斯点 $i$，组集 $\\mathbf{K} = \\sum_i w_i\\, J_i\\, \\mathbf{B}_i^\\mathsf{T}\\,\\mathbf{D}\\,\\mathbf{B}_i$，其中 $\\mathbf{B}_i$ 将节点位移映射到应变 $\\boldsymbol{\\varepsilon}_i = \\mathbf{B}_i \\mathbf{u}_e$（使用工程剪切应变 $\\gamma_{xy}$）。\n- $\\bar{B}$修正单元刚度：使用平面内膨胀 $e_{\\mathrm{vol}} = \\varepsilon_{xx} + \\varepsilon_{yy}$ 将平面内应变分解为体积部分和偏量部分。将任意高斯点处的逐点 $e_{\\mathrm{vol}}$ 替换为其单元面积平均值 $\\bar{e}_{\\mathrm{vol}}$（即在单元上投影到常数空间上的$L^2$投影），同时保持偏应变部分不变。然后使用修正后的应变-位移算子组集刚度矩阵。\n\n您的程序必须：\n1. 为三个独立的测试用例构建标准Q4单元刚度矩阵 $\\mathbf{K}$。\n2. 通过将平面内体积应变 $e_{\\mathrm{vol}} = \\varepsilon_{xx} + \\varepsilon_{yy}$ 投影到其单元平均值，为相同的三个测试用例构建$\\bar{B}$修正的单元刚度矩阵 $\\mathbf{K}_{\\bar{B}}$。\n3. 对每个矩阵进行特征分析并确定：\n   - 数值上接近零的特征值的数量（解释为零能模式）。使用如下定义的相对阈值：设 $\\lambda_{\\max}$ 为最大特征值；如果任何特征值 $\\lambda$ 满足 $\\lambda \\le \\max\\left(10^{-8}\\,\\lambda_{\\max},\\,10^{-12}\\right)$，则将其归类为接近零。\n   - 由最小的三个特征值对应的特征向量所张成的子空间与由两个平移和一个平面内旋转生成的刚体子空间之间的最大主角（以弧度为单位）。刚体子空间的基向量根据节点坐标 $(x_a,y_a)$ 构建如下：\n     - $x$方向的刚性平移：$\\mathbf{r}_1 = [1,0,1,0,1,0,1,0]^\\mathsf{T}$，\n     - $y$方向的刚性平移：$\\mathbf{r}_2 = [0,1,0,1,0,1,0,1]^\\mathsf{T}$，\n     - 绕原点的单位旋转的刚性旋转：$\\mathbf{r}_3 = [-y_1,x_1,-y_2,x_2,-y_3,x_3,-y_4,x_4]^\\mathsf{T}$。\n   计算 $\\{\\mathbf{r}_1,\\mathbf{r}_2,\\mathbf{r}_3\\}$ 的生成空间与三个最小特征值对应的特征向量的生成空间之间的最大主角，使用标准欧几里得内积。将此角度表示为浮点数，单位为弧度。\n\n测试套件：\n为以下三个测试用例提供结果。在所有情况下，均使用平面应变，且$E$的单位为帕斯卡。\n- 情况A（标称可压缩，无畸变）：节点坐标（单位：米）\n  $$\n  (x_1,y_1)=(0,0),\\quad (x_2,y_2)=(1,0),\\quad (x_3,y_3)=(1,1),\\quad (x_4,y_4)=(0,1),\n  $$\n  其中 $E = 3.0\\times 10^{7}$ 且 $\\nu = 0.25$。\n- 情况B（近不可压缩，无畸变）：坐标与情况A相同，其中 $E = 3.0\\times 10^{7}$ 且 $\\nu = 0.499999$。\n- 情况C（可压缩，畸变凸四边形）：节点坐标（单位：米）\n  $$\n  (x_1,y_1)=(0.0,0.0),\\;\n  (x_2,y_2)=(2.0,0.2),\\;\n  (x_3,y_3)=(1.8,1.2),\\;\n  (x_4,y_4)=(-0.1,1.0),\n  $$\n  其中 $E = 3.0\\times 10^{7}$ 且 $\\nu = 0.25$。\n\n对于每种情况，您的程序必须输出一个包含四个条目的列表：\n- 标准公式的近零特征值的整数数量，\n- $\\bar{B}$公式的近零特征值的整数数量，\n- 标准公式的最大主角（以弧度为单位的浮点数），\n- $\\bar{B}$公式的最大主角（以弧度为单位的浮点数）。\n\n最终输出格式：\n- 您的程序应生成单行输出，其中包含一个由三个列表（每个用例一个）组成的逗号分隔列表，并用方括号括起来。每个内部列表必须具有 $[n_{\\mathrm{std}},n_{\\bar{B}},\\theta_{\\mathrm{std}},\\theta_{\\bar{B}}]$ 的形式，其中 $n_{\\mathrm{std}}$ 和 $n_{\\bar{B}}$ 是整数，$\\theta_{\\mathrm{std}}$ 和 $\\theta_{\\bar{B}}$ 是以弧度为单位的浮点数，每个都以小数点后六位的科学记数法格式化（例如，$1.234567\\mathrm{e}{-08}$）。例如：\n  $[[3,3,1.000000\\mathrm{e}{-12},1.000000\\mathrm{e}{-12}],[\\dots],[\\dots]]$。\n\n科学真实性与预期：\n- 标准Q4刚度矩阵是半正定对称矩阵，在二维空间中恰好有三个刚体模态，因此对于单个无约束单元，其秩预期为$5$。$\\bar{B}$修正不应引入额外的伪零能模式。您的数值证据应证实标准刚度矩阵和$\\bar{B}$修正刚度矩阵都具有相同数量的近零特征值，并且最小三个特征值对应的特征向量子空间与刚体子空间对齐（即最大主角很小）。", "solution": "该问题要求分析B-bar（$\\bar{B}$）方法对平面应变线性弹性条件下四节点双线性四边形（Q4）单元稳定性的影响。具体来说，我们必须确定此修正是否会引入非物理的或“伪”零能模式。该分析涉及构建标准刚度矩阵$\\mathbf{K}$和$\\bar{B}$修正刚度矩阵$\\mathbf{K}_{\\bar{B}}$，对两者进行特征值分析，并将其零空间与刚体运动子空间进行比较。\n\n### 1. 等参Q4单元公式\n\n分析的基础是等参Q4单元。单元内的几何形状和位移场使用同一组双线性形函数 $N_a(\\xi, \\eta)$ 从节点值插值得到，其中 $(\\xi, \\eta)$ 是参考方形域 $[-1,1]^2$ 中的自然坐标。\n\n单元内一点 $(x,y)$ 处的位移场 $\\mathbf{u}$ 由下式给出：\n$$ \\mathbf{u}(x,y) = \\sum_{a=1}^{4} N_a(\\xi,\\eta) \\mathbf{u}_a $$\n其中 $\\mathbf{u}_a = \\{u_{xa}, u_{ya}\\}^T$ 是节点 $a$ 处的位移向量。所有8个节点自由度的向量记为 $\\mathbf{u}_e$。\n\n在小应变假设下，工程应变向量 $\\boldsymbol{\\varepsilon} = \\{\\varepsilon_{xx}, \\varepsilon_{yy}, \\gamma_{xy}\\}^T$ 通过应变-位移矩阵 $\\mathbf{B}$ 与节点位移相关联：\n$$ \\boldsymbol{\\varepsilon} = \\mathbf{B} \\mathbf{u}_e $$\n矩阵 $\\mathbf{B}$ 由节点块 $\\mathbf{B}_a$ 组成：\n$$ \\mathbf{B} = [\\mathbf{B}_1, \\mathbf{B}_2, \\mathbf{B}_3, \\mathbf{B}_4], \\quad \\text{with} \\quad \\mathbf{B}_a = \\begin{bmatrix} \\frac{\\partial N_a}{\\partial x}  0 \\\\ 0  \\frac{\\partial N_a}{\\partial y} \\\\ \\frac{\\partial N_a}{\\partial y}  \\frac{\\partial N_a}{\\partial x} \\end{bmatrix} $$\n形函数对物理坐标 $(x,y)$ 的导数是通过雅可比矩阵 $\\mathbf{J}$ 的逆矩阵从其对自然坐标 $(\\xi, \\eta)$ 的导数获得的。\n\n### 2. 标准单元刚度矩阵 $\\mathbf{K}$\n\n单元刚度矩阵 $\\mathbf{K}$ 关联了节点力与节点位移。它由单元的应变能导出，并通过在单元面积 $A$ 上积分计算得出：\n$$ \\mathbf{K} = \\int_A \\mathbf{B}^T \\mathbf{D} \\mathbf{B} \\, dA $$\n此处，$\\mathbf{D}$ 是平面应变的本构矩阵，它关联了应力与应变：$\\boldsymbol{\\sigma} = \\mathbf{D}\\boldsymbol{\\varepsilon}$。问题给出了各向同性材料的矩阵：\n$$ \\mathbf{D} = \\begin{bmatrix} \\lambda + 2\\mu  \\lambda  0 \\\\ \\lambda  \\lambda + 2\\mu  0 \\\\ 0  0  \\mu \\end{bmatrix} $$\n其中 $\\lambda$ 和 $\\mu$ 是拉梅参数。该积分使用 $2 \\times 2$ 高斯积分进行数值计算：\n$$ \\mathbf{K} \\approx \\sum_{i=1}^{4} w_i \\mathbf{B}_i^T \\mathbf{D} \\mathbf{B}_i \\det(\\mathbf{J}_i) $$\n其中索引 $i$ 遍历四个高斯点，$w_i=1$ 是权重，$\\mathbf{B}_i$ 和 $\\det(\\mathbf{J}_i)$ 是在第 $i$ 个高斯点处计算的B矩阵和雅可比行列式。\n\n### 3. 用于处理体积锁定的$\\bar{B}$方法\n\n使用完全（$2 \\times 2$）积分的标准Q4单元在模拟近不可压缩材料（即泊松比 $\\nu \\to 0.5$）时会表现出“体积锁定”现象。双线性近似的有限运动模式无法在每个点都满足恒定体积约束，从而导致伪刚度响应。\n\n$\\bar{B}$方法通过修改体积应变部分的计算方式来缓解此问题。应变张量被分解为偏量（形状改变）部分和体积（体积改变）部分。在二维中，体积应变或平面内膨胀为 $e_{\\mathrm{vol}} = \\varepsilon_{xx} + \\varepsilon_{yy}$。\n\n其核心思想是施加一个较弱的、平均化的体积约束。它不要求在每个高斯点都精确表示体积应变，而是使用其单元平均值 $\\bar{e}_{\\mathrm{vol}}$：\n$$ \\bar{e}_{\\mathrm{vol}} = \\frac{1}{A} \\int_A e_{\\mathrm{vol}} \\, dA $$\n将体积应变投影到单元上的常数函数空间，足以捕捉主要的体积行为而不会过度约束单元。这导致了修正的应变-位移关系，并因此产生了修正的刚度矩阵 $\\mathbf{K}_{\\bar{B}}$。\n\n一种计算上高效的构建 $\\mathbf{K}_{\\bar{B}}$ 的方法是将本构矩阵 $\\mathbf{D}$ 分解为体积部分和偏量部分，$\\mathbf{D} = \\mathbf{D}_{\\mathrm{vol}} + \\mathbf{D}_{\\mathrm{dev}}$。对于平面应变，体积模量为 $K = \\lambda+\\mu$。分解如下：\n$$ \\mathbf{D}_{\\mathrm{vol}} = K \\begin{bmatrix} 1  1  0 \\\\ 1  1  0 \\\\ 0  0  0 \\end{bmatrix}, \\quad \\mathbf{D}_{\\mathrm{dev}} = \\mu \\begin{bmatrix} 1  -1  0 \\\\ -1  1  0 \\\\ 0  0  1 \\end{bmatrix} $$\n刚度矩阵的偏量部分使用完全积分计算：\n$$ \\mathbf{K}_{\\mathrm{dev}} = \\int_A \\mathbf{B}^T \\mathbf{D}_{\\mathrm{dev}} \\mathbf{B} \\, dA \\approx \\sum_{i=1}^{4} w_i \\mathbf{B}_i^T \\mathbf{D}_{\\mathrm{dev}} \\mathbf{B}_i \\det(\\mathbf{J}_i) $$\n体积部分基于平均运动学。设 $\\mathbf{m} = \\{1, 1, 0\\}^T$。平均体积应变算子是一个列向量 $\\bar{\\mathbf{b}}$：\n$$ \\bar{\\mathbf{b}} = \\frac{1}{A} \\int_A \\mathbf{B}^T \\mathbf{m} \\, dA \\approx \\frac{1}{\\sum_j w_j \\det(\\mathbf{J}_j)} \\sum_i w_i (\\mathbf{B}_i^T \\mathbf{m}) \\det(\\mathbf{J}_i) $$\n然后，体积刚度构建为：\n$$ \\mathbf{K}_{\\bar{\\mathrm{vol}}} = A \\, K \\, \\bar{\\mathbf{b}} \\bar{\\mathbf{b}}^T $$\n总的修正刚度矩阵是这两个分量的和：\n$$ \\mathbf{K}_{\\bar{B}} = \\mathbf{K}_{\\mathrm{dev}} + \\mathbf{K}_{\\bar{\\mathrm{vol}}} $$\n此公式能正确处理近不可压缩情况，同时保留对可压缩材料的正确行为。\n\n### 4. 稳定性分析：零能模式\n\n单元公式的稳定性通过检查其刚度矩阵的特征值来评估。具有零特征值的特征向量对应于“零能模式”——即不产生应变能的节点位移模式。对于二维中的任何无约束单元，必须恰好有三个这样的模式，对应于刚体运动（两个平移和一个平面内旋转）。\n\n若存在超过三个零能模式，则表明单元不稳定，因为它可以在无阻力的情况下变形，这种现象称为“伪模式”或“机构”。对于任何新公式（如$\\bar{B}$方法），一个关键的测试是验证它是否会引入此类伪模式。我们通过计算 $\\mathbf{K}$ 和 $\\mathbf{K}_{\\bar{B}}$ 的特征值并统计有多少个在数值上接近于零来进行此测试。\n\n### 5. 通过主角进行子空间比较\n\n为确认计算出的零能模式确实是正确的刚体模态（RBM），我们将与最小三个特征值对应的特征空间与解析定义的RBM子空间进行比较。两个子空间之间的主角提供了它们对齐程度的度量。如果最大主角接近于零，则两个子空间几乎相同。\n\nRBM子空间由x-平移（$\\mathbf{r}_1$）、y-平移（$\\mathbf{r}_2$）和绕原点旋转（$\\mathbf{r}_3$）的向量张成。我们为此子空间构建一个标准正交基 $\\mathbf{Q}_R$。与刚度矩阵的三个最小特征值相对应的特征向量构成另一个标准正交基 $\\mathbf{Q}_U$。主角的余弦是矩阵乘积 $\\mathbf{Q}_R^T \\mathbf{Q}_U$ 的奇异值。最大主角是最小奇异值的反余弦。该角度值很小，则证实单元的零空间正确地代表了刚体运动。\n\n以下程序实现了整个过程，以提供有关$\\bar{B}$公式稳定性的定量证据。预计标准单元和修正单元都将具有恰好三个零能模式，这些模式对应于RBM。", "answer": "```python\nimport numpy as np\nfrom scipy.linalg import eigh, svd, qr\n\ndef solve():\n    \"\"\"\n    Main function to run the analysis for all test cases.\n    \"\"\"\n    \n    # Test Cases: (node_coords, E, nu)\n    test_cases = [\n        # Case A: Square, compressible\n        (np.array([[0.0, 0.0], [1.0, 0.0], [1.0, 1.0], [0.0, 1.0]]), \n         3.0e7, 0.25),\n        # Case B: Square, nearly incompressible\n        (np.array([[0.0, 0.0], [1.0, 0.0], [1.0, 1.0], [0.0, 1.0]]), \n         3.0e7, 0.499999),\n        # Case C: Distorted, compressible\n        (np.array([[0.0, 0.0], [2.0, 0.2], [1.8, 1.2], [-0.1, 1.0]]), \n         3.0e7, 0.25)\n    ]\n\n    results = []\n    for nodes, E, nu in test_cases:\n        case_results = []\n        \n        # Standard formulation\n        n_std, theta_std = analyze_element(nodes, E, nu, use_b_bar=False)\n        \n        # B-bar formulation\n        n_bbar, theta_bbar = analyze_element(nodes, E, nu, use_b_bar=True)\n        \n        case_results.extend([n_std, n_bbar, theta_std, theta_bbar])\n        results.append(case_results)\n\n    # Format output\n    output_str = \"[\"\n    for i, res in enumerate(results):\n        n_s, n_b, t_s, t_b = res\n        output_str += f\"[{n_s},{n_b},{t_s:.6e},{t_b:.6e}]\"\n        if i  len(results) - 1:\n            output_str += \",\"\n    output_str += \"]\"\n    \n    print(output_str)\n\ndef analyze_element(nodes, E, nu, use_b_bar):\n    \"\"\"\n    Analyzes a single element configuration.\n    \n    Args:\n        nodes: Nodal coordinates (4x2 array).\n        E: Young's modulus.\n        nu: Poisson's ratio.\n        use_b_bar: Boolean flag to use the B-bar method.\n        \n    Returns:\n        A tuple containing:\n        - The number of near-zero eigenvalues.\n        - The largest principal angle with the RBM subspace in radians.\n    \"\"\"\n    K = build_stiffness_matrix(nodes, E, nu, use_b_bar)\n    \n    # Eigenanalysis\n    evals, evecs = eigh(K)\n    \n    # Count near-zero eigenvalues\n    lambda_max = evals[-1]\n    threshold = max(1e-8 * lambda_max, 1e-12)\n    num_zero_modes = np.sum(evals = threshold)\n    \n    # Principal angle calculation\n    # Subspace from 3 smallest eigenvalues\n    Q_U = evecs[:, :3]\n    \n    # Rigid Body Mode (RBM) subspace\n    r1 = np.array([1, 0, 1, 0, 1, 0, 1, 0], dtype=float)\n    r2 = np.array([0, 1, 0, 1, 0, 1, 0, 1], dtype=float)\n    x, y = nodes.flatten(order='C')[::2], nodes.flatten(order='C')[1::2]\n    r3 = np.ravel(np.vstack([-y, x]).T)\n    \n    RBM_matrix = np.vstack([r1, r2, r3]).T\n    Q_R, _ = qr(RBM_matrix) # Orthonormal basis for RBM subspace\n    \n    # Singular values of the correlation matrix\n    M = Q_U.T @ Q_R\n    s = svd(M, compute_uv=False)\n    \n    # Smallest singular value corresponds to the largest principal angle\n    s_min = s[-1]\n    # np.clip for numerical stability with arccos\n    largest_principal_angle = np.arccos(np.clip(s_min, -1.0, 1.0))\n    \n    return num_zero_modes, largest_principal_angle\n\ndef get_shape_functions_and_derivs(xi, eta):\n    \"\"\"Returns shape functions and their derivatives w.r.t. natural coords.\"\"\"\n    N = 0.25 * np.array([(1-xi)*(1-eta), (1+xi)*(1-eta), (1+xi)*(1+eta), (1-xi)*(1+eta)])\n    \n    dN_dxi = 0.25 * np.array([-(1-eta), (1-eta), (1+eta), -(1+eta)])\n    dN_deta = 0.25 * np.array([-(1-xi), -(1+xi), (1+xi), (1-xi)])\n    \n    return N, np.vstack([dN_dxi, dN_deta])\n\ndef build_stiffness_matrix(nodes, E, nu, use_b_bar):\n    \"\"\"\n    Constructs the 8x8 element stiffness matrix for a Q4 element.\n    \"\"\"\n    # Material properties for plane strain\n    lame_lambda = (E * nu) / ((1 + nu) * (1 - 2 * nu))\n    lame_mu = E / (2 * (1 + nu))\n    \n    if not use_b_bar:\n        D = np.array([\n            [lame_lambda + 2 * lame_mu, lame_lambda, 0],\n            [lame_lambda, lame_lambda + 2 * lame_mu, 0],\n            [0, 0, lame_mu]\n        ])\n    else:\n        # For B-bar, we need D_dev and bulk modulus K\n        K_bulk = lame_lambda + lame_mu\n        D_dev = lame_mu * np.array([[1, -1, 0], [-1, 1, 0], [0, 0, 1]])\n\n    # 2x2 Gauss quadrature\n    gauss_points = 1.0 / np.sqrt(3) * np.array([[-1, -1], [1, -1], [1, 1], [-1, 1]])\n    gauss_weights = np.array([1, 1, 1, 1])\n\n    K = np.zeros((8, 8))\n    \n    # Pre-compute B matrices and Jacobians at all Gauss points\n    B_matrices = []\n    J_dets = []\n    for xi, eta in gauss_points:\n        _, dN_dnat = get_shape_functions_and_derivs(xi, eta)\n        \n        J = dN_dnat @ nodes\n        det_J = np.linalg.det(J)\n        if det_J = 0:\n            raise ValueError(\"Jacobian is non-positive. Element may be distorted or incorrectly numbered.\")\n        \n        J_inv = np.linalg.inv(J)\n        dN_dxy = J_inv @ dN_dnat\n        \n        B = np.zeros((3, 8))\n        for i in range(4):\n            B[0, 2*i] = dN_dxy[0, i]\n            B[1, 2*i+1] = dN_dxy[1, i]\n            B[2, 2*i] = dN_dxy[1, i]\n            B[2, 2*i+1] = dN_dxy[0, i]\n        \n        B_matrices.append(B)\n        J_dets.append(det_J)\n\n    if not use_b_bar:\n        # Standard formulation\n        for B_i, det_J_i, w_i in zip(B_matrices, J_dets, gauss_weights):\n            K += B_i.T @ D @ B_i * det_J_i * w_i\n    else:\n        # B-bar formulation\n        # K_bbar = K_dev + K_vol_bar\n        # K_dev = sum(w_i * J_i * B_i.T @ D_dev @ B_i)\n        K_dev = np.zeros((8, 8))\n        for B_i, det_J_i, w_i in zip(B_matrices, J_dets, gauss_weights):\n            K_dev += B_i.T @ D_dev @ B_i * det_J_i * w_i\n        \n        # K_vol_bar = A * K * b_bar @ b_bar.T\n        m = np.array([1, 1, 0])\n        element_area = sum(w * J for w, J in zip(gauss_weights, J_dets))\n        \n        b_bar_sum = np.zeros(8)\n        for B_i, det_J_i, w_i in zip(B_matrices, J_dets, gauss_weights):\n            b_bar_sum += m @ B_i * det_J_i * w_i\n        \n        b_bar = (1.0 / element_area) * b_bar_sum\n        \n        K_vol_bar = element_area * K_bulk * np.outer(b_bar, b_bar)\n        \n        K = K_dev + K_vol_bar\n\n    return K\n\nif __name__ == '__main__':\n    solve()\n```", "id": "3502461"}]}