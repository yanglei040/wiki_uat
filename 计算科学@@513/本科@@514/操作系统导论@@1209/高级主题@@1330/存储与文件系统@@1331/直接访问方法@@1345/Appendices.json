{"hands_on_practices": [{"introduction": "直接访问方法依赖于内存中的数据结构来将逻辑地址映射到物理位置。这个练习探讨了存储分配粒度与映射表所需 RAM 之间的基本设计权衡。通过完成此计算，您将对系统参数如何限制大规模存储系统中的设计选择有一个实践性的理解 [@problem_id:3634057]。", "problem": "一个操作系统通过存储在随机存取存储器（RAM）中的映射表，对固定大小的分配单元进行索引，从而为大型块设备实现直接（随机）存取方法。根据直接存取的定义，每个分配单元都恰好有一个映射表条目，用于将该分配单元的逻辑索引映射到其物理位置。该设备的总大小为 $S$ 字节，分配粒度为 $g$ 字节，每个映射表条目在对齐后的大小为固定的 $e$ 字节。除了实际分配单元的条目外，系统还维护了一部分额外的备用条目，其数量为实际条目数的分数 $r$，以及一个大小为 $H$ 字节的固定头部。整个内存中的映射结构（头部加上所有条目，包括备用部分）必须不超过给定的 RAM 预算 $R_{\\max}$。\n\n考虑以下遵循直接存取方法约束的设计实例：\n- 设备容量为 $S = 18$ 太字节 (TiB)，其中 $1$ TiB $= 2^{40}$ 字节。\n- 每个分配单元由一个条目索引，该条目的原始字段包括：一个 $48$ 位的物理地址，一个 $12$ 位的长度（以 $g$ 为单位），一个 $4$ 位的标志字段，以及一个 $32$ 位的校验和。该条目在 RAM 中被填充到下一个 $8$ 字节的倍数。\n- 备用分数为 $r = 0.08$（一个十进制小数）。\n- 固定的映射表头部大小为 $H = 1$ 兆字节 (MiB)，其中 $1$ MiB $= 2^{20}$ 字节。\n- RAM 预算为 $R_{\\max} = 24$ 吉字节 (GiB)，其中 $1$ GiB $= 2^{30}$ 字节。\n- 分配粒度 $g$ 必须是 $4$ 千字节 (KiB) 的整数倍，其中 $1$ KiB $= 2^{10}$ 字节。\n\n仅使用上述基本定义（即，直接存取要求每个分配单元有一个条目，并且总条目数等于分配单元数乘以备用因子），确定能确保整个内存映射结构不超过 RAM 预算的最小可接受的 $g$。以字节为单位，给出所选 $g$ 的最终答案。不要提供中间值。无需按有效数字进行四舍五入；您必须严格遵守“$4$ KiB 的倍数”这一约束。", "solution": "问题陈述经评估有效。它内容自洽，科学上基于操作系统设计的原理，并且在数学上是适定的。我们可以继续进行求解。\n\n问题要求我们确定在多个约束条件下，以字节为单位的最小可接受分配粒度 $g$。主要约束是内存中映射结构的总大小不得超过给定的 RAM 预算 $R_{\\max}$。\n\n首先，我们将给定参数之间的关系形式化。块设备的总大小为 $S$。设备被划分为大小为 $g$ 的分配单元。因此，分配单元的数量 $N_a$ 是设备总大小除以分配粒度：\n$$N_a = \\frac{S}{g}$$\n\n问题指出，映射表为每个分配单元包含一个条目，外加一部分备用条目，其数量为实际条目数的一个分数 $r$。总条目数 $N_e$ 为：\n$$N_e = N_a + r \\cdot N_a = N_a(1+r)$$\n代入 $N_a$ 的表达式，我们得到：\n$$N_e = \\frac{S(1+r)}{g}$$\n\n接下来，我们必须计算单个映射表条目的大小 $e$。该条目由几个字段组成。这些字段的原始比特大小之和为：\n$$e_{\\text{raw\\_bits}} = 48 \\,(\\text{地址}) + 12 \\,(\\text{长度}) + 4 \\,(\\text{标志}) + 32 \\,(\\text{校验和}) = 96 \\text{ 位}$$\n因为 1 字节有 8 位，所以原始大小（以字节为单位）为：\n$$e_{\\text{raw\\_bytes}} = \\frac{96}{8} = 12 \\text{ 字节}$$\n问题指定该条目被填充到下一个 8 字节的倍数。大于或等于 12 的第一个 8 的倍数是 16。因此，一个条目在内存中对齐后的大小是：\n$$e = 16 \\text{ 字节}$$\n\n内存中映射结构的总大小，我们记为 $R_{\\text{total}}$，是固定头部大小 $H$ 与所有映射表条目总大小之和。\n$$R_{\\text{total}} = H + N_e \\cdot e$$\n代入我们关于 $N_e$ 的表达式：\n$$R_{\\text{total}} = H + \\frac{S(1+r)e}{g}$$\n\n这个总内存使用量必须小于或等于最大允许的 RAM 预算 $R_{\\max}$：\n$$H + \\frac{S(1+r)e}{g} \\le R_{\\max}$$\n\n我们的目标是找到 $g$ 的最小可能值。为此，我们重排不等式以求解 $g$。\n$$\\frac{S(1+r)e}{g} \\le R_{\\max} - H$$\n由于 $g$ 必须为正，我们可以将不等式两边同时乘以 $g$ 并除以 $(R_{\\max} - H)$（该值为正），而不会改变不等号的方向：\n$$g \\ge \\frac{S(1+r)e}{R_{\\max} - H}$$\n这个不等式确立了 $g$ 的最小可能值。\n\n现在，我们将指定的数值代入此表达式。我们必须注意使用一致的单位（字节）和正确的二进制前缀（$1$ KiB = $2^{10}$ 字节, $1$ MiB = $2^{20}$ 字节, $1$ GiB = $2^{30}$ 字节, $1$ TiB = $2^{40}$ 字节）。\n- $S = 18 \\text{ TiB} = 18 \\times 2^{40}$ 字节\n- $r = 0.08$，这意味着 $1+r = 1.08$\n- $e = 16 \\text{ 字节} = 2^4$ 字节\n- $H = 1 \\text{ MiB} = 2^{20}$ 字节\n- $R_{\\max} = 24 \\text{ GiB} = 24 \\times 2^{30}$ 字节\n\n我们先计算分母：\n$$R_{\\max} - H = (24 \\times 2^{30}) - 2^{20} = (24 \\times 2^{10} \\times 2^{20}) - (1 \\times 2^{20}) = (24 \\times 1024 - 1) \\times 2^{20} = (24576 - 1) \\times 2^{20} = 24575 \\times 2^{20} \\text{ 字节}$$\n现在计算分子：\n$$S(1+r)e = (18 \\times 2^{40}) \\cdot (1.08) \\cdot (16) = (18 \\times 1.08 \\times 16) \\times 2^{40} = 311.04 \\times 2^{40} \\text{ 字节}^2$$\n将这些代入关于 $g$ 最小值的不等式中：\n$$g \\ge \\frac{311.04 \\times 2^{40}}{24575 \\times 2^{20}} = \\frac{311.04}{24575} \\times 2^{20} \\text{ 字节}$$\n我们来计算这个表达式：\n$$g \\ge \\frac{311.04}{24575} \\times 1048576 \\approx 13271.04 \\text{ 字节}$$\n\n最后的约束是 $g$ 必须是 $4$ KiB 的整数倍。这个基本单位的大小是：\n$$g_{\\text{quantum}} = 4 \\text{ KiB} = 4 \\times 2^{10} \\text{ 字节} = 4096 \\text{ 字节}$$\n所以，$g$ 必须是 $k \\cdot 4096$ 的形式，其中 $k$ 是某个正整数。我们必须找到满足此条件和内存约束的最小整数 $k$：\n$$k \\cdot 4096 \\ge 13271.04$$\n$$k \\ge \\frac{13271.04}{4096} \\approx 3.23999$$\n由于 $k$ 必须是整数，所以 $k$ 的最小可能值为 $4$。\n\n因此，分配粒度 $g$ 的最小可接受值为：\n$$g = 4 \\times 4096 = 16384 \\text{ 字节}$$", "answer": "$$\\boxed{16384}$$", "id": "3634057"}, {"introduction": "存储系统的效率不仅取决于设备速度，还取决于文件系统的逻辑结构与设备物理布局之间的协调性。本实践问题探讨了未对齐造成的性能损失，即逻辑块的写入不必要地触及多个物理块，导致写放大。理解并解决这个问题是优化存储性能的一项关键技能 [@problem_id:3634097]。", "problem": "一个存储设备实现了直接（随机）访问方法，这意味着任何物理块都可以被独立寻址和更新。该设备的最小物理写入粒度是一个大小为 $b$ 字节的块。操作系统的文件系统发出随机的逻辑写入，这些写入与大小为 $B$ 字节的逻辑块对齐，其中每个逻辑块写入都精确覆盖从文件系统地址空间中 $B$ 的倍数开始的连续 $B$ 个字节。由于设备必须更新完整的物理块，任何跨越多个物理块部分的逻辑写入都会导致多次物理块更新，并且对于部分块的修改，还会对每个受影响的物理块进行“读取-修改-写入”操作。考虑到文件系统分区的起始位置相对于设备物理块边界有一个固定的偏移量，并且随机逻辑块的选择是在由对 $(B,b)$ 引起的模模式上进行均匀采样。仅使用块粒度的核心定义和块起始位置模 $b$ 的均匀随机采样，并且不假设任何特殊的设备缓存或合并行为，哪个选项正确地描述了单个随机逻辑块写入所触及的物理块的期望数量，并提出了一种可证明能最小化因未对齐而触及的额外块的对齐策略？\n\nA. 触及的物理块的期望数量等于 $\\left\\lfloor \\dfrac{B}{b} \\right\\rfloor + 1 + \\dfrac{B \\bmod b}{b}$，这反映了一个基准值 $\\left\\lfloor \\dfrac{B}{b} \\right\\rfloor + 1$ 个块，外加当起始位置过于靠近物理边界时，有 $\\dfrac{B \\bmod b}{b}$ 的概率会触及一个额外的块。为了最小化这种代价，选择 $B = k\\,b$（其中 $k$ 为某个整数）并将文件系统的起始位置与 $b$ 边界对齐，这将使得每次逻辑写入恰好触及 $\\dfrac{B}{b}$ 个物理块，没有因未对齐而导致的额外块。\n\nB. 无论是否对齐，触及的物理块的期望数量都等于 $\\dfrac{B}{b}$，因为随机访问使得起始位置无关紧要。为了最小化代价，增加队列深度以便设备可以重排写入操作。\n\nC. 由于第一个部分块加上剩余部分的比例项，触及的物理块的期望数量等于 $1 + \\dfrac{B}{b}$。为了最小化代价，跨 $n$ 个磁盘进行条带化，以便未对齐效应可以被平均掉。\n\nD. 如果 $B  b$，未对齐不会产生代价，因为逻辑写入不可能跨越物理边界；因此，除了默认分区外，不需要任何对齐策略。\n\nE. 无论是否对齊，触及的物理块的期望数量都等于 $\\left\\lceil \\dfrac{B}{b} \\right\\rceil$。为了最小化代价，只需将文件系统的起始位置与最大公约数边界 $\\gcd(B,b)$ 对齐，这样起始位置会以 $\\gcd(B,b)$ 为周期重复。", "solution": "## 问题验证\n\n### 步骤 1：提取已知条件\n- 存储设备使用直接（随机）访问方法。\n- 任何物理块都可以被独立寻址和更新。\n- 最小物理写入粒度是一个大小为 $b$ 字节的块。\n- 操作系统的文件系统发出随机的逻辑写入。\n- 逻辑写入与大小为 $B$ 字节的逻辑块对齐。\n- 每个逻辑写入精确覆盖从 $B$ 的倍数开始的连续 $B$ 个字节。\n- 任何跨越多个物理块部分的逻辑写入都会导致多次物理块更新。\n- 部分块的修改会对每个受影响的物理块进行“读取-修改-写入”操作。\n- 文件系统分区相对于设备物理块边界有一个固定的偏移量。\n- 随机逻辑块的选择被建模为写入起始位置模 $b$ 的均匀采样。\n- 不假设任何特殊的设备缓存或合并行为。\n- 问题要求单个随机逻辑块写入所触及的物理块的期望数量，以及可证明能最小化所触及的额外块的对齊策略。\n\n### 步骤 2：使用提取的已知条件进行验证\n问题陈述描述了计算机存储系统中一个经典且根本性的问题：由于逻辑块和物理块边界未对齐而导致的写放大。\n\n- **科学依据（关键）：** 该问题牢固地植根于操作系统和计算机体系结构的原理。逻辑块寻址、物理块粒度、“读取-修改-写入”周期和写放大等概念在该领域是标准且被充分理解的。这个设定是对一个真实世界性能问题的形式化描述。\n\n- **定义良好：** 这个问题是定义良好的。它定义了必要的变量（$B$ 和 $b$）、操作的性质（大小为 $B$ 的写入）以及随机元素（写入相对于物理块边界的起始位置是一个均匀分布的随机变量）。问题要求一个具体、可计算的量（一个期望值）和一个最优策略，其明确答案可以从前提中推导出来。“在模模式上进行均匀采样”是假设起始偏移量模 $b$ 是均匀分布的标准术语。\n\n- **客观性（关键）：** 该问题以精确、客观和技术性的语言陈述。它没有歧义、主观性或观点。\n\n该问题不违反任何无效性标准。它是一个科学上合理、定义良好且客观的问题，可以通过严谨的数学推导来解决。\n\n### 步骤 3：结论与行动\n问题陈述是**有效的**。现在将进行解答过程。\n\n## 推导\n\n设 $B$ 为逻辑块写入的大小，$b$ 为物理存储块的大小。我们需要求出单个大小为 $B$ 的逻辑写入所触及的物理块的期望数量 $E[N]$。\n\n问题指出写入的起始位置是随机的，我们将其建模为写入的起始地址在物理块内有一个偏移量 $x$，其中 $x$ 是在区间 $[0, b)$ 上均匀分布的随机变量。即 $x \\sim U(0, b)$。\n\n从第一个物理块内偏移量为 $x$ 的位置开始的长度为 $B$ 的写入，将从该物理块的开头算起，跨越总长度为 $x+B$ 的空间。覆盖此范围所需的大小为 $b$ 的物理块数量为 $N(x) = \\lceil \\frac{x+B}{b} \\rceil$。\n\n让我们用 $b$ 来表示 $B$。设 $L = \\lfloor B/b \\rfloor$ 和 $R = B \\pmod b$，因此 $B = Lb + R$，其中 $L$ 是一个非负整数且 $0 \\le R  b$。\n\n触及的块数 $N(x)$可以写作：\n$$N(x) = \\left\\lceil \\frac{x + Lb + R}{b} \\right\\rceil = \\left\\lceil L + \\frac{x+R}{b} \\right\\rceil = L + \\left\\lceil \\frac{x+R}{b} \\right\\rceil$$\n\n我们分析当 $x \\in [0, b)$ 时 $N(x)$ 的值：\n1.  当 $x$ 在 $0  x+R \\le b$ 的范围内时，我们有 $0  \\frac{x+R}{b} \\le 1$，所以 $\\lceil \\frac{x+R}{b} \\rceil = 1$。这个条件在 $x \\le b-R$ 时成立。$x$ 的范围是 $[0, b-R]$。这个区间的长度是 $b-R$。在此范围内，$N(x) = L+1$。\n    注意：如果 $R=0$，这个范围是 $[0, b]$。然而，下一种情况将处理 $x=0$ 处的不连续性。\n2.  当 $x$ 在 $b  x+R  2b$ 的范围内时，我们有 $1  \\frac{x+R}{b}  2$，所以 $\\lceil \\frac{x+R}{b} \\rceil = 2$。这个条件在 $x > b-R$ 时成立。$x$ 的范围是 $(b-R, b)$。这个区间的长度是 $b - (b-R) = R$。在此范围内，$N(x) = L+2$。\n\n触及的块的期望数量 $E[N]$ 是 $N(x)$ 在 $x$ 于 $[0, b)$ 上均匀分布的平均值：\n$$E[N] = \\int_0^b N(x) f(x) dx = \\int_0^b N(x) \\frac{1}{b} dx$$\n我们可以根据对 $N(x)$ 的分析来拆分积分：\n$$E[N] = \\frac{1}{b} \\left[ \\int_0^{b-R} (L+1) dx + \\int_{b-R}^b (L+2) dx \\right]$$\n这假设了 $R>0$。如果 $R=0$，第二个积分的范围为空。\n让我们先对 $R>0$ 的情况进行求值：\n$$E[N] = \\frac{1}{b} \\left[ (L+1)(b-R) + (L+2)R \\right]$$\n$$E[N] = \\frac{1}{b} \\left[ Lb - LR + b - R + LR + 2R \\right]$$\n$$E[N] = \\frac{1}{b} \\left[ Lb + b + R \\right] = L + 1 + \\frac{R}{b}$$\n代入 $L = \\lfloor B/b \\rfloor$ 和 $R = B \\pmod b$：\n$$E[N] = \\left\\lfloor \\frac{B}{b} \\right\\rfloor + 1 + \\frac{B \\pmod b}{b}$$\n如果 $R=0$，则 $B=Lb$。块的数量为 $N(x) = L + \\lceil x/b \\rceil$。对于 $x=0$，$N(0)=L$。对于 $x \\in (0, b)$，$N(x)=L+1$。对于连续均匀分布，$x=0$ 的概率为零。因此，我们认为 $N(x)=L+1$ 几乎处处成立。\n$E[N] = \\int_0^b (L+1) \\frac{1}{b} dx = L+1$。\n我们的公式对于 $R=0$ 的情况给出：$E[N] = \\lfloor B/b \\rfloor + 1 + 0/b = L+1$。\n推导出的公式对 $R \\ge 0$ 是通用的。\n该公式也可以简化为：\n$E[N] = \\lfloor B/b \\rfloor + 1 + \\frac{B - \\lfloor B/b \\rfloor b}{b} = \\lfloor B/b \\rfloor + 1 + \\frac{B}{b} - \\lfloor B/b \\rfloor = 1 + \\frac{B}{b}$。\n\n现在，我们考虑最小化所触及的额外块的策略。“额外块”是指超出理论最小值所触及的任何块。一次大小为 $B$ 的写入必须覆盖 $B$ 字节的数据范围，这至少需要触及 $\\lceil B/b \\rceil$ 个物理块。只有当逻辑写入的起始位置与物理块边界完美对齐（即 $x=0$）时，才能达到这个最小值。\n为了保证*所有*逻辑写入的 $x=0$，必须满足两个条件：\n1.  逻辑块大小 $B$ 必须是物理块大小 $b$ 的整数倍。设 $B = k b$，其中整数 $k \\ge 1$。如果这个条件成立，则 $\\lceil B/b \\rceil = B/b = k$。\n2.  文件系统分区的起始位置必须与物理块边界对齐。也就是说，它距离设备起始点的偏移量 $\\delta$ 必須是 $b$ 的倍数。设 $\\delta = m b$。\n\n如果这些条件都满足，任何对块 $j$ 的逻辑写入（从逻辑地址 $jB$ 开始）都始于物理地址 $\\delta + jB = mb + j(kb) = (m+jk)b$。偏移量模 $b$ 为 $( (m+jk)b ) \\pmod b = 0$。因此，所有写入的 $x=0$。\n在这种情况下，触及的物理块数量总是 $B/b$，这是绝对最小值。这个策略消除了所有因未对齐而产生的“额外”块。\n\n## 逐项分析\n\n**A. 触及的物理块的期望数量等于 $\\left\\lfloor \\dfrac{B}{b} \\right\\rfloor + 1 + \\dfrac{B \\bmod b}{b}$，这反映了一个基准值 $\\left\\lfloor \\dfrac{B}{b} \\right\\rfloor + 1$ 个块，外加当起始位置过于靠近物理边界时，有 $\\dfrac{B \\bmod b}{b}$ 的概率会触及一个额外的块。为了最小化这种代价，选择 $B = k\\,b$（其中 $k$ 为某个整数）并将文件系统的起始位置与 $b$ 边界对齐，这将使得每次逻辑写入恰好触及 $\\dfrac{B}{b}$ 个物理块，没有因未对齐而导致的额外块。**\n\n- **期望数量：** 公式 $E[N] = \\left\\lfloor \\frac{B}{b} \\right\\rfloor + 1 + \\frac{B \\pmod b}{b}$ 与我们的推导相符。\n- **解释：** 解释也是正确的。触及的块数为 $L+1$ 的概率是 $(b-R)/b$，为 $L+2$ 的概率是 $R/b$。期望值是 $(L+1) + 1 \\cdot (R/b) = L+1+R/b$。所以基准是 $L+1$，并且有 $R/b$ 的概率触及一个额外的块。这是一种正确且富有洞察力的方式来描述结果。\n- **最小化策略：** 提出的设置 $B=kb$ 并将分区与 $b$ 边界对齐的策略，正是我们推导出的保证所有写入都完美对齐（$x=0$）的策略。\n- **策略结果：** 声称该策略恰好产生 $B/b$ 个物理块是正确的。\n- **结论：** 正确。\n\n**B. 无论是否对齐，触及的物理块的期望数量都等于 $\\dfrac{B}{b}$，因为随机访问使得起始位置无关紧要。为了最小化代价，增加队列深度以便设备可以重排写入操作。**\n\n- **期望数量：** 公式 $E[N]=B/b$ 是不正确的。这通常不是一个整数，而且我们的推导表明期望值是 $1+B/b$。起始位置至关重要。\n- **最小化策略：** 增加队列深度是一种性能优化技术（提高吞吐量），但它不能解决未对齐导致的写放大的根本问题。问题明确排除了这类设备行为。\n- **结论：** 不正确。\n\n**C. 由于第一个部分块加上剩余部分的比例项，触及的物理块的期望数量等于 $1 + \\dfrac{B}{b}$。为了最小化代价，跨 $n$ 个磁盘进行条带化，以便未对齐效应可以被平均掉。**\n\n- **期望数量：** 公式 $E[N]=1+B/b$ 在代数上等价于选项A中的公式和我们的推导。所提供的推理很模糊，但公式是正确的。\n- **最小化策略：** 条带化数据（RAID-0）并不能解决对齐问题。未对齐的代价会发生在写入条带中每个磁盘的数据块上，可能会加重整体 I/O 负载。它并不能“平均掉”这种效应。正确的解决方案是修复对齐本身。\n- **结论：** 不正确。最小化策略有缺陷。\n\n**D. 如果 $B  b$，未对齐不会产生代价，因为逻辑写入不可能跨越物理边界；因此，除了默认分区外，不需要任何对齐策略。**\n\n- **前提：** “如果 $B  b$”这一前提是错误的。即使逻辑写入比物理块小，如果它的起始位置靠近物理块的末尾，它仍然可以跨越两个物理块的边界。\n- **结论：** 不正确。\n\n**E. 无论是否对齐，触及的物理块的期望数量都等于 $\\left\\lceil \\dfrac{B}{b} \\right\\rceil$。为了最小化代价，只需将文件系统的起始位置与最大公约数边界 $\\gcd(B,b)$ 对齐，这样起始位置会以 $\\gcd(B,b)$ 为周期重复。**\n\n- **期望数量：** 公式 $\\lceil B/b \\rceil$ 是完美对齐情况下的块数，而不是未对齐情况下的期望值。\n- **最小化策略：** 与 $\\gcd(B,b)$ 对齐可以减少未对齐模式的数量，但除非 $\\gcd(B,b)=b$，否则它不能保证完美的对齐。因此，这不是最优策略。\n- **结论：** 不正确。\n\n最终，选项A提供了正确的公式、正确的解释和正确的最小化策略。", "answer": "$$\\boxed{A}$$", "id": "3634097"}, {"introduction": "像固态硬盘（SSD）这样的现代存储设备提供了巨大的并行性，但要充分发挥其潜力，仅仅一次发送一个请求是远远不够的。本练习应用排队论中的一个基本原理——利特尔法则（Little's Law），来确定使设备达到饱和状态所需的最优 I/O 队列深度。这个实践将向您展示如何使用理论模型来指导高吞吐量系统中的实际性能调优 [@problem_id:3634045]。", "problem": "一位操作系统存储工程师正在为一个由固态硬盘上大小为 $4$ KiB 的固定块的均匀随机读取组成的直接（随机）访问工作负载调整异步输入/输出 (I/O) 子系统。目标是选择一个主机端异步 I/O 队列深度，记为 $q$，该深度恰好足以在稳态操作下保持设备饱和而不会导致其利用率不足。该工程师采用以下测量协议来区分测量的两个作用：通过低负载特性分析来估计设备的每请求服务时间，以及通过高负载特性分析来估计可持续的吞吐量平台期。\n\n低负载特性分析：在队列深度为 $1$ 且请求之间有足够的思考时间以避免排队的情况下，测得的平均每请求延迟为 $0.096$ 毫秒。\n\n高负载特性分析：在预热后使用非常大的队列深度，测得的持续吞吐量稳定在接近 $3.49 \\times 10^{5}$ 次 I/O 操作每秒 (IOPS)。\n\n为了提供用于验证的实验背景，我们进行了一次后续扫描测试，报告了实现的吞吐量 $X$（单位：IOPS）作为队列深度 $q$ 的函数：\n- $q = 1 \\rightarrow X \\approx 1.02 \\times 10^{4}$\n- $q = 8 \\rightarrow X \\approx 8.2 \\times 10^{4}$\n- $q = 16 \\rightarrow X \\approx 1.60 \\times 10^{5}$\n- $q = 24 \\rightarrow X \\approx 2.30 \\times 10^{5}$\n- $q = 32 \\rightarrow X \\approx 3.10 \\times 10^{5}$\n- $q = 36 \\rightarrow X \\approx 3.33 \\times 10^{5}$\n- $q = 40 \\rightarrow X \\approx 3.44 \\times 10^{5}$\n- $q = 48 \\rightarrow X \\approx 3.49 \\times 10^{5}$\n- $q = 64 \\rightarrow X \\approx 3.49 \\times 10^{5}$\n- $q = 128 \\rightarrow X \\approx 3.49 \\times 10^{5}$\n\n任务：仅从操作系统的稳态流量守恒和基础排队论（不使用其他任何预打包公式）出发，推导出一个连接平均未完成请求数 $q$、实现的吞吐量 $X$（单位：请求/秒）和平均每请求延迟 $L$（单位：秒）的关系。使用该关系式，得出一个为达到等于所测平台期吞吐量的目标吞吐量所需的最小队列深度的实值表达式。然后，使用低负载平均延迟 $L = 0.096$ 毫秒和平台期吞吐量 $X = 3.49 \\times 10^{5}$ IOPS 对此表达式进行数值计算，并应用数学向上取整运算，得出应能使设备饱和的最小整数队列深度，记为 $q_{\\text{pred}}$。报告 $q_{\\text{pred}}$ 的整数值，不带单位。你可以定性地使用上面的扫描数据来验证你预测的深度接近饱和的起点，但你提交的答案必须仅为整数 $q_{\\text{pred}}$。", "solution": "首先对问题陈述进行验证。\n\n**步骤 1：提取已知条件**\n- 工作负载：直接（随机）访问，均匀随机读取。\n- 块大小：$4$ KiB。\n- 目标：找到使设备饱和的最小整数主机端异步 I/O 队列深度 $q$。\n- 低负载特性分析（$q=1$，无排队）：平均每请求延迟为 $0.096$ 毫秒。\n- 高负载特性分析（大 $q$）：持续吞吐量平台期接近 $X_{\\text{max}} = 3.49 \\times 10^{5}$ 次 I/O 操作每秒 (IOPS)。\n- 用于计算的特定输入：\n    - 目标吞吐量 $X = 3.49 \\times 10^{5}$ IOPS。\n    - 模型中使用的延迟：$L = 0.096$ 毫秒。\n- 任务要求：\n    1. 从稳态流量守恒出发，推导一个连接平均未完成请求数 $q$、实现的吞吐量 $X$ 和平均每请求延迟 $L$ 的关系。\n    2. 使用此关系获得达到目标吞吐量所需的最小队列深度的实值表达式。\n    3. 对表达式进行数值计算。\n    4. 应用向上取整函数找到最小整数队列深度 $q_{\\text{pred}}$。\n- 用于定性验证的扫描数据：一组包含 10 个数据点的数据，显示了队列深度 $q$ 从 $1$ 到 $128$ 时对应的吞吐量 $X$。\n\n**步骤 2：使用提取的已知条件进行验证**\n该问题具有科学依据，提法明确，且客观。\n- **科学依据：** 该问题是排队论在计算机系统性能分析，特别是I/O子系统中的一个经典应用。队列深度、延迟、吞吐量和设备饱和等概念都是基础性的，并且应用正确。给定的延迟（$0.096$ 毫秒）和吞吐量（$3.49 \\times 10^5$ IOPS）数值对于现代固态硬盘（SSD）来说是符合实际的。\n- **提法明确性：** 问题提供了明确的目标和所有必需的数据。它要求推导利特尔法则（排队论中的一个基本定理）并将其应用于特定场景。所要求的计算定义明确。\n- **客观性：** 语言技术性强，精确，没有偏见或主观性陈述。\n\n该问题不包含科学矛盾，对于要求的任务没有信息缺失，也没有歧义。它要求推导的关系是该领域的核心。提供的实验扫描数据为验证提供了背景，快速检查显示其内部一致性。例如，在 $q=1$ 时，数据显示 $X \\approx 1.02 \\times 10^4$ IOPS，问题陈述的延迟为 $0.096$ 毫秒。使用利特尔法则，$q = X \\times L = (1.02 \\times 10^4 \\text{ s}^{-1}) \\times (0.096 \\times 10^{-3} \\text{ s}) \\approx 0.979$，这与给定的队列深度 $q=1$ 一致。问题有效。\n\n**步骤 3：结论与行动**\n问题有效。将提供完整解答。\n\n**推导与求解**\n问题要求从流量守恒的第一性原理推导未完成请求数、吞吐量和延迟之间的关系。这个关系通常被称为利特尔法则。\n\n考虑一个处于稳态的稳定系统。设 $q$ 表示系统中存在的平均请求数（即，在队列中等待或正在被主动服务）。设 $X$ 为请求进入系统的平均速率，在稳态下，该速率必须等于它们离开系统的平均速率。这个速率 $X$ 就是吞吐量，以单位时间内的请求数来衡量。设 $L$ 为一个请求在系统中花费的平均时间，从到达系统到离开系统。这个时间就是延迟。\n\n我们可以在一个很长的时间间隔 $T$ 内分析该系统。在此间隔内到达（和离开）的总请求数为：\n$$N = X \\cdot T$$\n这 $N$ 个请求中的每一个平均在系统中花费时间 $L$。因此，在时间间隔 $T$ 内通过系统的所有请求累计的总时间可以通过请求数与每个请求的平均时间的乘积来近似：\n$$\\text{总请求时间} = N \\cdot L = (X \\cdot T) \\cdot L$$\n或者，我们可以通过考虑任何时刻驻留在系统中的平均请求数 $q$ 来表达累计的总请求时间。在时间间隔 $T$ 内，这个平均占用量贡献的总时间为：\n$$\\text{总请求时间} = q \\cdot T$$\n通过令这两个总累计请求时间的表达式相等，我们得到守恒定律：\n$$q \\cdot T = X \\cdot L \\cdot T$$\n假设观察间隔 $T$ 大于零（$T > 0$），我们可以将两边同时除以 $T$，得到基本关系：\n$$q = X \\cdot L$$\n这就是利特尔法则。它指出，在一个稳定的排队系统中，平均请求数是平均吞吐量和平均延迟的乘积。\n\n问题要求的是完全饱和I/O设备所需的最小队列深度 $q$。饱和是指设备达到其最大可能吞吐量的工作点，该吞吐量由平台期吞吐量给出，$X_{\\text{max}} = 3.49 \\times 10^{5}$ IOPS。为达到此吞吐量，我们必须维持一定数量的“在途”请求，以确保设备的内部处理单元永远不会空闲。这个在途请求的数量就是队列深度 $q$。\n\n乘积 $X \\cdot L$ 可以被解释为一种带宽时延积。这里，$X$ 是系统的“带宽”（吞吐量），$L$ 是“时延”（延迟）。该乘积给出了为保持管道满载所必须在管道中的总请求数。要找到使设备饱和的最小队列深度，我们必须使用最大吞吐量 $X_{\\text{max}}$ 和相应的每请求延迟。问题指示我们使用低负载延迟 $L_{\\text{low-load}} = 0.096$ 毫秒进行此计算。这是一个标准的工程近似，因为低负载延迟代表了在没有排队延迟时请求的最佳情况下的内在服务时间。为了使设备的并行架构在其峰值速率 $X_{\\text{max}}$ 下得到充分利用，我们必须有足够的未完成请求来覆盖每个工作流的延迟 $L_{\\text{low-load}}$。\n\n所需的实值队列深度，我们记为 $q_{\\text{real}}$，因此是：\n$$q_{\\text{real}} = X_{\\text{max}} \\cdot L_{\\text{low-load}}$$\n给定：\n- $X_{\\text{max}} = 3.49 \\times 10^{5}$ 请求/秒\n- $L_{\\text{low-load}} = 0.096$ 毫秒 $= 0.096 \\times 10^{-3}$ 秒\n\n将这些值代入表达式：\n$$q_{\\text{real}} = (3.49 \\times 10^{5} \\text{ s}^{-1}) \\cdot (0.096 \\times 10^{-3} \\text{ s})$$\n$$q_{\\text{real}} = 3.49 \\times 0.096 \\times 10^{5-3}$$\n$$q_{\\text{real}} = 0.33504 \\times 10^{2}$$\n$$q_{\\text{real}} = 33.504$$\n这个值表示达到吞吐量平台期所需的平均并发请求数。由于I/O队列深度 $q$ 必须是一个整数，我们必须选择大于或等于这个理论最小值的最小整数。这需要应用向上取整函数。\n预测的最小整数队列深度 $q_{\\text{pred}}$ 为：\n$$q_{\\text{pred}} = \\lceil q_{\\text{real}} \\rceil = \\lceil 33.504 \\rceil = 34$$\n对所提供的扫描数据进行定性检查，证实了此结果是合理的。在 $q=32$ 时，吞吐量为 $3.10 \\times 10^{5}$ IOPS，仍低于饱和状态。在 $q=36$ 时，吞吐量为 $3.33 \\times 10^{5}$ IOPS，非常接近平台期。我们计算出的值 $q_{\\text{pred}} = 34$ 正好落在这个区域内，代表了饱和的大致起点。", "answer": "$$\\boxed{34}$$", "id": "3634045"}]}