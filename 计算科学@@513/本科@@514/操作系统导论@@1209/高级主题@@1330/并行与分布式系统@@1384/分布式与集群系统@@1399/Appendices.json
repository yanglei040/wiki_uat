{"hands_on_practices": [{"introduction": "在分布式系统中，网络延迟是不可预测且动态变化的。设置一个固定的超时时间是脆弱的，可能导致过早的重试或过长的等待。本练习将带你实践一种构建可靠远程过程调用（RPC）的关键技术：使用指数加权移动平均（EWMA）来动态估算网络往返时间（RTT），并设置自适应的超时阈值，从而在系统响应性和避免不必要的网络负载之间取得平衡。[@problem_id:3636314]", "problem": "分布式集群中的一项服务使用远程过程调用 (RPC) 来协调任务。如果响应未在超时前到达，系统将重新传输请求。为避免不必要的重试和过长的等待，系统会根据当前对网络往返时间 (RTT) 的估计自适应地设置超时。系统使用指数加权移动平均 (EWMA) 来估计 RTT 的均值和变异性，并将瞬时 RTT 建模为由排队、序列化和传播引起的许多独立延迟分量的总和。根据中心极限定理，瞬时 RTT 被建模为近似正态分布。\n\n在离散时间 $t$，设观测到的 RTT 样本为 $r_t$。EWMA 均值估计 $\\hat{r}_t$ 由核心递归平滑规则定义\n$$\n\\hat{r}_t = (1-\\alpha)\\,\\hat{r}_{t-1} + \\alpha\\, r_t,\n$$\n其中 $\\alpha \\in (0,1)$ 是平滑参数。为估计离散程度，定义平方偏差的 EWMA $v_t$ 为\n$$\nv_t = (1-\\alpha)\\,v_{t-1} + \\alpha\\,\\big(r_t - \\hat{r}_{t-1}\\big)^{2},\n$$\n并将估计的标准差取为 $\\hat{\\sigma}_t = \\sqrt{v_t}$。\n\n假设在时间 $t=0$ 时，系统的初始均值估计为 $\\hat{r}_0 = 18\\,\\mathrm{ms}$，初始方差估计为 $v_0 = 9\\,\\mathrm{ms}^{2}$，并使用平滑参数 $\\alpha = 0.3$。在接下来的四次 RPC 中，它观测到 RTT 样本\n$$\nr_1 = 21\\,\\mathrm{ms},\\quad r_2 = 15\\,\\mathrm{ms},\\quad r_3 = 24\\,\\mathrm{ms},\\quad r_4 = 18\\,\\mathrm{ms}.\n$$\n\n集群操作员要求，在使用当前 EWMA 估计值作为参数的正态模型下，单个 RTT 样本仅因随机波动而超过超时的概率（“错误超时”）每次尝试必须为 $\\beta = 0.01$。超时被设置为满足当前时间 $t=4$ 此要求的最小值。\n\n仅使用这些基础，计算在 $t=4$ 时的超时数值。以毫秒为单位表示最终答案，并将结果四舍五入到四位有效数字。", "solution": "该问题要求基于对网络往返时间 (RTT) 的统计估计，计算远程过程调用 (RPC) 的自适应超时。该问题提法明确，具有科学依据，并包含得出唯一解所需的所有信息。我们将首先迭代计算 RTT 均值和方差的指数加权移动平均 (EWMA)，然后使用这些估计值来确定满足指定错误超时概率的超时值。\n\n在时间 $t=0$ 时的给定初始条件是：\n- 初始均值估计：$\\hat{r}_0 = 18\\,\\mathrm{ms}$\n- 初始方差估计：$v_0 = 9\\,\\mathrm{ms}^{2}$\n- 平滑参数：$\\alpha = 0.3$\n\n在时间 $t$ 更新估计值的递归规则是：\n- 均值估计：$\\hat{r}_t = (1-\\alpha)\\,\\hat{r}_{t-1} + \\alpha\\, r_t$\n- 方差估计：$v_t = (1-\\alpha)\\,v_{t-1} + \\alpha\\,\\big(r_t - \\hat{r}_{t-1}\\big)^{2}$\n- 标准差估计：$\\hat{\\sigma}_t = \\sqrt{v_t}$\n\n观测到的 RTT 样本为 $r_1 = 21\\,\\mathrm{ms}$，$r_2 = 15\\,\\mathrm{ms}$，$r_3 = 24\\,\\mathrm{ms}$ 和 $r_4 = 18\\,\\mathrm{ms}$。我们计算 $t=1, 2, 3, 4$ 时的估计值。为清晰起见，我们注意到 $1-\\alpha = 1 - 0.3 = 0.7$。所有时间单位均为毫秒 ($\\mathrm{ms}$)，方差单位为 $\\mathrm{ms}^2$。\n\n**第一步：计算 $t=1$ 时的估计值**\n使用样本 $r_1 = 21$：\n$$\n\\hat{r}_1 = (1-\\alpha)\\hat{r}_0 + \\alpha r_1 = (0.7)(18) + (0.3)(21) = 12.6 + 6.3 = 18.9\n$$\n$$\nv_1 = (1-\\alpha)v_0 + \\alpha(r_1 - \\hat{r}_0)^2 = (0.7)(9) + (0.3)(21 - 18)^2 = 6.3 + 0.3(3^2) = 6.3 + 2.7 = 9.0\n$$\n\n**第二步：计算 $t=2$ 时的估计值**\n使用样本 $r_2 = 15$ 和 $t=1$ 时的估计值：\n$$\n\\hat{r}_2 = (1-\\alpha)\\hat{r}_1 + \\alpha r_2 = (0.7)(18.9) + (0.3)(15) = 13.23 + 4.5 = 17.73\n$$\n$$\nv_2 = (1-\\alpha)v_1 + \\alpha(r_2 - \\hat{r}_1)^2 = (0.7)(9.0) + (0.3)(15 - 18.9)^2 = 6.3 + 0.3(-3.9)^2 = 6.3 + 0.3(15.21) = 6.3 + 4.563 = 10.863\n$$\n\n**第三步：计算 $t=3$ 时的估计值**\n使用样本 $r_3 = 24$ 和 $t=2$ 时的估计值：\n$$\n\\hat{r}_3 = (1-\\alpha)\\hat{r}_2 + \\alpha r_3 = (0.7)(17.73) + (0.3)(24) = 12.411 + 7.2 = 19.611\n$$\n$$\nv_3 = (1-\\alpha)v_2 + \\alpha(r_3 - \\hat{r}_2)^2 = (0.7)(10.863) + (0.3)(24 - 17.73)^2 = 7.6041 + 0.3(6.27)^2 = 7.6041 + 0.3(39.3129) \\approx 7.6041 + 11.7939 = 19.398\n$$\n为了更高的精度，我们保留更多位数：$v_3 = 7.6041 + 11.79387 = 19.39797$。\n\n**第四步：计算 $t=4$ 时的估计值**\n使用样本 $r_4 = 18$ 和 $t=3$ 时的估计值：\n$$\n\\hat{r}_4 = (1-\\alpha)\\hat{r}_3 + \\alpha r_4 = (0.7)(19.611) + (0.3)(18) = 13.7277 + 5.4 = 19.1277\n$$\n$$\nv_4 = (1-\\alpha)v_3 + \\alpha(r_4 - \\hat{r}_3)^2 = (0.7)(19.39797) + (0.3)(18 - 19.611)^2 = 13.578579 + 0.3(-1.611)^2 = 13.578579 + 0.3(2.595321) \\approx 13.578579 + 0.778596 = 14.357175\n$$\n在时间 $t=4$，最终估计的均值和方差为：\n$$\n\\hat{r}_4 = 19.1277\\,\\mathrm{ms}\n$$\n$$\nv_4 = 14.357175\\,\\mathrm{ms}^2\n$$\n相应的标准差是：\n$$\n\\hat{\\sigma}_4 = \\sqrt{v_4} = \\sqrt{14.357175} \\approx 3.789086\\,\\mathrm{ms}\n$$\n\n**第五步：计算超时**\n瞬时 RTT，我们称之为随机变量 $R$，被建模为以 $t=4$ 时估计的参数为参数的正态分布。因此，$R \\sim \\mathcal{N}(\\mu, \\sigma^2)$，其中 $\\mu = \\hat{r}_4$ 且 $\\sigma = \\hat{\\sigma}_4$。\n超时 $T_o$ 的设置必须使错误超时的概率为 $\\beta = 0.01$。这意味着观测到的 RTT $R$ 超过 $T_o$ 的概率为 $0.01$：\n$$\nP(R > T_o) = \\beta = 0.01\n$$\n为求得 $T_o$，我们对变量 $R$ 进行标准化。令 $Z = \\frac{R-\\mu}{\\sigma}$ 为一个标准正态随机变量，$Z \\sim \\mathcal{N}(0, 1)$。\n$$\nP\\left(\\frac{R-\\mu}{\\sigma} > \\frac{T_o-\\mu}{\\sigma}\\right) = P\\left(Z > \\frac{T_o-\\mu}{\\sigma}\\right) = 0.01\n$$\n我们需要从标准正态分布中找到临界值 $z_{0.01}$，使得 $P(Z > z_{0.01}) = 0.01$。该值对应于分布的第 $99$ 百分位数，因为 $P(Z \\le z_{0.01}) = 1 - 0.01 = 0.99$。查阅标准正态分布表或使用计算工具，我们得到：\n$$\nz_{0.01} \\approx 2.3263\n$$\n超时 $T_o$ 由以下方程确定：\n$$\n\\frac{T_o - \\mu}{\\sigma} = z_{0.01}\n$$\n$$\nT_o = \\mu + z_{0.01} \\sigma = \\hat{r}_4 + z_{0.01} \\hat{\\sigma}_4\n$$\n代入计算出的 $\\hat{r}_4$ 和 $\\hat{\\sigma}_4$ 的值：\n$$\nT_o = 19.1277 + (2.3263) \\times (\\sqrt{14.357175})\n$$\n$$\nT_o \\approx 19.1277 + (2.3263) \\times (3.789086)\n$$\n$$\nT_o \\approx 19.1277 + 8.8150\n$$\n$$\nT_o \\approx 27.9427\\,\\mathrm{ms}\n$$\n问题要求将结果四舍五入到四位有效数字。数值 $27.9427$ 四舍五入到四位有效数字是 $27.94$。", "answer": "$$\\boxed{27.94}$$", "id": "3636314"}, {"introduction": "当可靠和高效的通信机制就位后，我们的关注点可以上升到更高层次的系统属性：数据一致性。为了提高可用性和性能，数据常常被复制到多个节点，但这引入了保持副本同步的挑战。本练习通过分析一个经典的分布式共享内存场景，让你深入比较两种核心缓存一致性策略（写失效与写更新）的网络负载，并推导出选择最优策略的条件。[@problem_id:3636329]", "problem": "考虑一个实现分布式共享内存（DSM）的集群，其中DSM是一个通过复制或迁移内存块并维护一致性来跨多个节点提供统一内存抽象的系统。该集群有 $S$ 个节点和一个被同时访问的单一共享内存块。一个节点作为专用写入者，并以每秒 $w$ 次更新的速率对该块执行写入操作，而其他 $S-1$ 个节点中的每一个都作为读取者，并以每秒 $r$ 次读取的速率对同一块发出读取请求。每个节点都有一个用于共享块的缓存。写入者的出站网络接口卡（NIC）链路的带宽为每秒 $B$ 字节。\n\n考虑两种一致性策略：\n\n- 写-无效：每次写入时，写入者向所有其他共享者发送一条大小为 $i$ 字节的无效消息，导致它们的缓存副本失效。每次无效化之后，每个读取者的下一次读取都必须获取完整的块。无效消息的大小为 $i$ 字节，读取未命中获取操作会传输 $s$ 字节（缓存块的大小）。\n- 写-更新：每次写入时，写入者发送一条更新消息，将新数据传播给所有其他共享者。假设更新操作将大小为 $s$ 字节的完整块传输给每个读取者，并且读取者随后的读取不会引起网络流量，因为它们的副本保持有效且最新。\n\n假设写入者单独向每个读取者发送消息（无硬件多播压缩），并测量写入者出站NIC链路上的每秒字节负载。使用以下核心事实作为您推导的基础：\n- 一致性语义：写-无效使其他缓存失效；写-更新将更新后的数据分发到其他缓存。\n- 吞吐量核算：每秒出站字节负载等于事件速率乘以有效载荷大小，并在所有接收者上进行聚合。\n- 在写-无效策略下，对于一个由1个写入者以速率 $w$ 访问、每个读取者以速率 $r$ 访问的单一共享块，每个读取者的稳态读取未命中率等于 $\\min(r,w)$，因为每次写入最多导致每个读取者随后的一个读取未命中，如果写入速度超过读取速度，那么每个读取者的读取都会未命中，而如果读取速度超过写入速度，那么每次写入会为每个读取者触发一次未命中。\n\n下列哪个陈述正确地描述了出站NIC负载、以及写-更新策略比写-无效策略产生更低负载并避免写入者链路饱和的条件？\n\nA. 在写-更新策略下，写入者的出站链路负载为 $(S-1)\\,s\\,w$，避免饱和需要 $(S-1)\\,s\\,w  B$。\n\nB. 在写-无效策略下，写入者的出站链路负载为 $(S-1)\\,\\big(i\\,w + s\\,\\min(r,w)\\big)$，避免饱和需要 $(S-1)\\,\\big(i\\,w + s\\,\\min(r,w)\\big)  B$。\n\nC. 当且仅当 $r \\ge w$ 或当 $r  w$ 时 $r > \\left(1 - \\frac{i}{s}\\right)\\,w$，写-更新策略比写-无效策略产生的出站链路负载更低。\n\nD. 当且仅当对于所有的 $r$ 都有 $r  \\frac{i}{s}\\,w$ 时，写-更新策略比写-无效策略产生的负载更低；消息大小比率 $\\frac{i}{s}$ 单独决定了阈值，而与 $w$ 无关。\n\nE. 在写-更新策略下，读取者的读取请求仍然导致每次写入有一次获取，因此必须将读取流量项 $s\\,\\min(r,w)$ 加到 $(S-1)\\,s\\,w$ 上以获得写入者的出站负载。", "solution": "用户提供了一个关于分布式共享内存（DSM）系统中两种一致性策略（写-无效和写-更新）性能分析的问题。任务是验证问题陈述，推导每种策略下写入者网络接口卡（NIC）上的出站网络负载，并评估一种策略优于另一种策略的条件。\n\n### 第1步：提取已知条件\n\n- $S$：集群中的节点总数。\n- $1$：写入者节点的数量。\n- $S-1$：读取者节点的数量。\n- $w$：写入者节点的写入速率（更新次数/秒）。\n- $r$：每个读取者节点的读取速率（读取次数/秒）。\n- $B$：写入者出站NIC链路的带宽（字节/秒）。\n- $i$：无效消息的大小（字节）。\n- $s$：共享内存块的大小，也是读取未命中或更新时数据传输的大小（字节）。\n- 协议1（写-无效）：每次写入时，写入者向所有 $S-1$ 个读取者发送一个大小为 $i$ 的无效消息。读取者随后的读取会引发读取未命中，需要获取大小为 $s$ 的数据块。\n- 协议2（写-更新）：每次写入时，写入者向所有 $S-1$ 个读取者发送大小为 $s$ 的完整数据块。随后的读取是本地命中，不产生网络流量。\n- 通信模型：写入者单独向每个读取者发送消息。\n- 关键建模假设：在写-无效策略下，每个读取者的稳态读取未命中率为 $\\min(r, w)$。\n\n### 第2步：使用提取的已知条件进行验证\n\n问题陈述是科学的、适定的和客观的。\n- **科学基础**：问题描述了两种基本缓存一致性协议（写-无效和写-更新）之间的经典性能权衡分析。网络负载、带宽、消息大小和事件速率（读/写）等概念在计算机系统和性能建模中是标准概念。提供的读取未命中率模型 $\\min(r, w)$，是针对单生产者、多消费者场景的一个公认且逻辑合理的简化。如果读取者读取速度快于写入者写入速度（$r  w$），则每次写入将精确地导致每个读取者随后发生一次未命中，从而产生 $w$ 的未命中率。如果读取者读取速度慢于写入者写入速度（$r  w$），则每次读取尝试都可能发现一个无效的块，使得每次读取都成为一次未命中，从而产生 $r$ 的未命中率。\n- **适定性**：问题提供了构建网络负载数学表达式所需的所有必要变量和行为规则。所提出的问题基于所提供的数据具有唯一的、可推导的答案。\n- **客观性**：问题使用精确、定量和无偏见的术语进行陈述。\n\n问题没有表现出任何科学上不健全、不完整、矛盾或模糊等缺陷。该设置是操作系统和分布式系统课程中用于教学和分析目的的标准（尽管是简化的）模型。\n\n### 第3步：结论和行动\n\n问题陈述是**有效的**。解决方案将继续推导所需的表达式并评估给定的选项。\n\n### 网络负载的推导与比较\n\n设 $L_{\\text{update}}$ 为写-更新策略下写入者的出站NIC负载， $L_{\\text{invalidate}}$ 为写-无效策略下的负载。负载的单位是字节/秒。\n\n**1. 写-更新策略下写入者的NIC负载 ($L_{\\text{update}}$)**\n\n在写-更新协议下，对于每秒 $w$ 次的写入，写入者必须将大小为 $s$ 的整个数据块发送给 $S-1$ 个读取者中的每一个。\n- 消息生成速率：$w$ 次写入/秒。\n- 每次写入的接收者数量：$S-1$。\n- 每条消息的大小：$s$ 字节。\n总负载是这三个量的乘积：\n$$L_{\\text{update}} = w \\times (S-1) \\times s = (S-1)sw$$\n为使写入者的链路不饱和，此负载必须小于可用带宽 $B$：\n$$(S-1)sw  B$$\n\n**2. 写-无效策略下写入者的NIC负载 ($L_{\\text{invalidate}}$)**\n\n写-无效策略下的负载有两个组成部分：发送无效消息的流量和处理由此产生的读取未命中的流量。\n\n- **无效流量**：对于每秒 $w$ 次的写入，写入者向 $S-1$ 个读取者中的每一个发送一个大小为 $i$ 的无效消息。\n  - 无效操作产生的负载 = $w \\times (S-1) \\times i = (S-1)iw$。\n- **读取未命中流量**：问题陈述指出，每个读取者的读取未命中率为 $\\min(r, w)$。每次未命中都需要从写入者节点获取大小为 $s$ 的数据块。共有 $S-1$ 个读取者。\n  - 读取未命中产生的负载 = $(\\text{未命中率}) \\times (\\text{数据大小}) \\times (\\text{读取者数量})$\n  - 读取未命中产生的负载 = $\\min(r, w) \\times s \\times (S-1) = (S-1)s\\min(r, w)$。\n\n总负载 $L_{\\text{invalidate}}$ 是这两个组成部分的总和：\n$$L_{\\text{invalidate}} = (S-1)iw + (S-1)s\\min(r, w) = (S-1)\\big(iw + s\\min(r, w)\\big)$$\n为使写入者的链路不饱和，此负载必须小于可用带宽 $B$：\n$$(S-1)\\big(iw + s\\min(r, w)\\big)  B$$\n\n**3. 比较：$L_{\\text{update}}  L_{\\text{invalidate}}$**\n\n我们希望找到写-更新策略产生比写-无效策略更少流量的条件。\n$$L_{\\text{update}}  L_{\\text{invalidate}}$$\n$$(S-1)sw  (S-1)\\big(iw + s\\min(r, w)\\big)$$\n由于 $S$ 是集群中的节点数，所以 $S  1$，这意味着 $S-1  0$。我们可以将两边同时除以 $S-1$：\n$$sw  iw + s\\min(r, w)$$\n现在我们通过考虑 $\\min(r, w)$ 的两种情况来分析这个不等式。\n\n- **情况1：$r \\ge w$**\n在这种情况下，$\\min(r, w) = w$。不等式变为：\n$$sw  iw + sw$$\n$$0  iw$$\n由于消息大小 $i$ 和写入速率 $w$ 是正的物理量（$i  0, w  0$），这个不等式总是成立。因此，如果 $r \\ge w$，写-更新策略的负载总是更低。\n\n- **情况2：$r  w$**\n在这种情况下，$\\min(r, w) = r$。不等式变为：\n$$sw  iw + sr$$\n我们可以重新排列以求解 $r$：\n$$sw - sr  iw$$\n$$s(w - r)  iw$$\n$$w - r  \\frac{i}{s}w$$\n$$-r  \\frac{i}{s}w - w$$\n$$-r  w\\left(\\frac{i}{s} - 1\\right)$$\n两边乘以 $-1$ 会反转不等号：\n$$r > -w\\left(\\frac{i}{s} - 1\\right)$$\n$$r > w\\left(1 - \\frac{i}{s}\\right)$$\n所以，在 $r  w$ 的情况下，当且仅当 $r > w\\left(1 - \\frac{i}{s}\\right)$ 时，写-更新策略的负载更低。\n\n结合这两种情况，当且仅当（$r \\ge w$）或（$r  w$ 且 $r > w\\left(1 - \\frac{i}{s}\\right)$）时，写-更新策略比写-无效策略产生的负载更低。\n\n### 逐项分析\n\n**A. 在写-更新策略下，写入者的出站链路负载为 $(S-1)\\,s\\,w$，避免饱和需要 $(S-1)\\,s\\,w  B$。**\n我们对写-更新策略下负载的推导是 $L_{\\text{update}} = (S-1)sw$。避免饱和的条件是此负载必须小于链路带宽 $B$。该陈述与我们的推导完全一致。\n**结论：正确**\n\n**B. 在写-无效策略下，写入者的出站链路负载为 $(S-1)\\,\\big(i\\,w + s\\,\\min(r,w)\\big)$，避免饱和需要 $(S-1)\\,\\big(i\\,w + s\\,\\min(r,w)\\big)  B$。**\n我们对写-无效策略下负载的推导是 $L_{\\text{invalidate}} = (S-1)\\big(iw + s\\min(r, w)\\big)$。避免饱和的条件是此负载必须小于链路带宽 $B$。该陈述与我们的推导完全一致。\n**结论：正确**\n\n**C. 当且仅当 $r \\ge w$ 或当 $r  w$ 时 $r > \\left(1 - \\frac{i}{s}\\right)\\,w$，写-更新策略比写-无效策略产生的出站链路负载更低。**\n我们的比较得出了完全相同的复合条件：如果 $r \\ge w$（这种情况下条件总是满足），或者如果 $r  w$ 且 $r > w\\left(1 - \\frac{i}{s}\\right)$，则写-更新策略更好。该陈述是我们研究结果的精确总结。\n**结论：正确**\n\n**D. 当且仅当对于所有的 $r$ 都有 $r  \\frac{i}{s}\\,w$ 时，写-更新策略比写-无效策略产生的负载更低；消息大小比率 $\\frac{i}{s}$ 单独决定了阈值，而与 $w$ 无关。**\n这个陈述提出了一个替代条件，$r  \\frac{i}{s}\\,w$。让我们用我们推导出的条件来检验它。我们的条件是 $sw  iw + s\\min(r, w)$，可以简化为 $w\\left(1-\\frac{i}{s}\\right)  \\min(r,w)$。选项 D 中的条件并不等价。例如，如果 $r  w$，我们的条件总是满足，但如果 $r$ 仅略大于 $w$ 且比率 $\\frac{i}{s}$ 很大（虽然物理上不现实，但数学上是可能的），则条件 $r  \\frac{i}{s}w$ 可能不满足。更清楚地说，考虑 $r  w$ 的情况。我们的条件是 $r > w\\left(1 - \\frac{i}{s}\\right)$。D 中的条件是 $r > \\frac{i}{s}w$。这是两个不同的表达式。对于 $i \\ll s$ 的典型情况，$1 - \\frac{i}{s}$ 接近于 $1$，而 $\\frac{i}{s}$ 接近于 $0$。这两个条件根本不同。此外，声称阈值“与 $w$ 无关”是错误的，因为 $r$ 的阈值是 $\\frac{i}{s}w$，它明确依赖于 $w$。\n**结论：错误**\n\n**E. 在写-更新策略下，读取者的读取请求仍然导致每次写入有一次获取，因此必须将读取流量项 $s\\,\\min(r,w)$ 加到 $(S-1)\\,s\\,w$ 上以获得写入者的出站负载。**\n该陈述与问题对写-更新协议的定义相矛盾，该定义明确指出：“读取者随后的读取不会引起网络流量，因为它们的副本保持有效且最新。” 因此，写-更新策略没有读取未命中流量项。\n**结论：错误**", "answer": "$$\\boxed{ABC}$$", "id": "3636329"}]}