{"hands_on_practices": [{"introduction": "操作系统理论与现实世界系统分析之间通常存在差距。本练习通过分析时间序列数据，教你如何推断底层调度策略，从而弥合这一差距。通过考察一个核心的负载如何影响另一个核心，你将学会识别推送迁移和拉取迁移在真实系统跟踪中的因果特征。", "problem": "一个对称双核调度器维护着在离散时间 $t \\in \\{0,1,2,3,4,5,6,7,8\\}$（采样间隔 $\\Delta t = 1$）采样的每个核心的可运行队列长度 $q_1(t)$ 和 $q_2(t)$。假设外源任务的到达在核心间平均是均衡的，并且每个核心的服务时间片在各个采样点上近似恒定。考虑两种典型的迁移策略：推送迁移（一个过载的核心主动将任务转移到其他核心）和拉取迁移（一个欠载的核心主动从其他核心获取任务）。\n\n给定一个队列长度的追踪数据：\n- $t=0,1,\\dots,8$ 时的 $q_1(t)$：$[\\,3,4,5,5,4,3,2,2,2\\,]$，\n- $t=0,1,\\dots,8$ 时的 $q_2(t)$：$[\\,1,1,1,2,3,3,3,2,2\\,]$。\n\n对于 $t \\ge 1$，设离散时间导数由前向差分定义为 $\\dot q_j(t) \\approx q_j(t)-q_j(t-1)$。考虑在滞后为 $\\tau$ 时的样本互相关，对于两个定义在其共同支撑集上的零均值序列 $x(t)$ 和 $y(t)$，其定义为\n$$\n\\rho_{xy}(\\tau) \\;=\\; \\frac{\\sum_t \\big(x(t-\\tau)-\\bar x\\big)\\big(y(t)-\\bar y\\big)}{\\sqrt{\\sum_t \\big(x(t-\\tau)-\\bar x\\big)^2}\\,\\sqrt{\\sum_t \\big(y(t)-\\bar y\\big)^2}},\n$$\n其中 $\\bar x$ 和 $\\bar y$ 是样本均值。将 $\\tau>0$ 解释为 $x$ 领先于 $y$。\n\n使用给定的追踪数据，构建 $t=1,\\dots,8$ 时的 $\\dot q_2(t)$，并根据推送迁移和拉取迁移的定义，结合互相关的定义，通过分析 $\\mathrm{corr}\\big(q_1,\\dot q_2\\big)$ 的显著峰值的符号和滞后，判断哪种迁移策略与数据更一致。选择唯一最佳选项：\n\nA. 系统使用推送迁移：$q_1$ 领先于 $\\dot q_2$；$\\mathrm{corr}\\big(q_1,\\dot q_2\\big)$ 在一个小的正滞后 $\\tau>0$ 处有一个强的正峰值。\n\nB. 系统使用拉取迁移：$q_2$ 在欠载时发起转移；$\\mathrm{corr}\\big(q_1,\\dot q_2\\big)$ 在一个负滞后 $\\tau  0$ 处达到峰值，或者对于 $\\tau0$ 时相关性很弱。\n\nC. 系统使用拉取迁移，但 $q_1$ 仍然以一个强的正峰值在 $\\tau0$ 处领先于 $\\dot q_2$。\n\nD. 两种策略都无法推断：对于小的 $|\\tau|$，$\\mathrm{corr}\\big(q_1,\\dot q_2\\big)$ 近似为零。", "solution": "用户希望我验证问题陈述，如果有效，则提供详细的解决方案。\n\n### 步骤1：问题验证\n\n我将首先提取给定条件，然后基于科学原理和适定性来验证问题陈述。\n\n**提取的已知条件：**\n*   **系统：** 一个对称双核调度器。\n*   **可观测量：** 每个核心的可运行队列长度，$q_1(t)$ 和 $q_2(t)$。\n*   **时间离散化：** 数据在离散时间 $t \\in \\{0, 1, 2, 3, 4, 5, 6, 7, 8\\}$ 进行采样，采样间隔为 $\\Delta t = 1$。\n*   **数据追踪：**\n    *   $q_1(t): [\\,3, 4, 5, 5, 4, 3, 2, 2, 2\\,]$\n    *   $q_2(t): [\\,1, 1, 1, 2, 3, 3, 3, 2, 2\\,]$\n*   **系统假设：** 外源任务的到达平均是均衡的，服务时间片近似恒定。\n*   **迁移策略：**\n    *   **推送迁移：** 一个过载的核心主动将任务转移到其他核心。\n    *   **拉取迁移：** 一个欠载的核心主动从其他核心获取任务。\n*   **数学定义：**\n    *   离散时间导数：对于 $t \\ge 1$，$\\dot q_j(t) \\approx q_j(t)-q_j(t-1)$。\n    *   滞后为 $\\tau$ 时的样本互相关：$\\rho_{xy}(\\tau) \\;=\\; \\frac{\\sum_t \\big(x(t-\\tau)-\\bar x\\big)\\big(y(t)-\\bar y\\big)}{\\sqrt{\\sum_t \\big(x(t-\\tau)-\\bar x\\big)^2}\\,\\sqrt{\\sum_t \\big(y(t)-\\bar y\\big)^2}}$。序列 $x(t)$ 和 $y(t)$ 在其共同支撑集上是零均值的，样本均值为 $\\bar x$ 和 $\\bar y$。\n    *   滞后解释：$\\tau  0$ 意味着 $x$ 领先于 $y$。\n*   **任务：** 分析 $\\mathrm{corr}\\big(q_1, \\dot q_2\\big)$ 以确定哪种迁移策略与所提供的追踪数据更一致。\n\n**验证结论：**\n问题是**有效的**。\n1.  **科学上成立：** 推送和拉取迁移、CPU调度器队列长度以及通过时间序列相关性进行分析的概念是操作系统和性能工程中的标准课题。该设置是一个简化但具有物理意义的模型。\n2.  **适定的：** 所有必要的数据（$q_1(t)$，$q_2(t)$）和数学定义（$\\dot q_j(t)$，$\\rho_{xy}(\\tau)$）都已提供。问题是具体的，可以通过将给定的工具应用于给定的数据来回答。\n3.  **客观和完整：** 问题陈述是客观和定量的。它包含了进行分析所需的所有信息。没有矛盾之处。\n\n### 步骤2：求解推导\n\n问题要求我们通过分析核心1的队列长度 $q_1(t)$ 与核心2队列长度的变化率 $\\dot q_2(t)$ 之间的互相关来确定迁移策略。\n\n**每种策略的理论预期：**\n\n1.  **推送迁移：**\n    *   该策略的触发条件是一个核心变得过载。在我们的双核系统中，如果核心1过载，其队列长度 $q_1(t)$ 将会很高。\n    *   作为一种主动措施，核心1将“推送”一个任务到核心2以平衡负载。\n    *   这个被推送的任务到达核心2将导致其队列长度 $q_2$ 增加。这对应于队列长度变化的一个正值，即 $\\dot q_2  0$。\n    *   这里存在一个因果关系：在时间 $t$ 的高 $q_1$ 会导致在稍后的时间 $t+\\tau$ 出现一个正的 $\\dot q_2$，其中 $\\tau  0$ 是包含了决策和传输时间的滞后。\n    *   这意味着时间序列 $q_1(t)$ 和 $\\dot q_2(t)$ 之间存在正相关。由于原因（$q_1$）先于结果（$\\dot q_2$），我们预期互相关函数 $\\rho_{q_1 \\dot q_2}(\\tau)$ 会在一个小的正滞后 $\\tau  0$ 处表现出一个显著的正峰值。\n\n2.  **拉取迁移：**\n    *   该策略的触发条件是一个核心变得欠载。如果核心2欠载，其队列长度 $q_2(t)$ 将会很低。\n    *   核心2将从另一个核心（在此情况下必须是核心1）“拉取”一个任务。这只有在核心1有任务可给的情况下才会发生，因此 $q_1(t)$ 必须足够大。\n    *   一次成功拉取的结果是 $q_2$ 的增加，意味着 $\\dot q_2  0$。\n    *   直接触发因素是核心2的状态（低 $q_2$），而不是核心1。$q_1$ 的状态是一个必要的前提条件，但不是迁移事件的直接原因。\n    *   因此，仅 $q_1$ 与变化 $\\dot q_2$ 之间的因果联系没有推送迁移中那么直接。我们可能预期对于 $\\tau  0$，相关性 $\\rho_{q_1 \\dot q_2}(\\tau)$ 会较弱，或者关系会更复杂，可能还涉及到 $q_2$ 的状态。在 $\\tau  0$ 处出现强正峰值的特征不是拉取迁移的主要预期。\n\n**数据分析：**\n\n让我们根据给定的追踪数据计算相关量。\n\n*   $t=0, \\dots, 8$ 时，$q_1(t) = [\\,3, 4, 5, 5, 4, 3, 2, 2, 2\\,]$。\n*   $t=0, \\dots, 8$ 时，$q_2(t) = [\\,1, 1, 1, 2, 3, 3, 3, 2, 2\\,]$。\n\n首先，我们计算 $t=1, \\dots, 8$ 时 $\\dot q_2(t) = q_2(t) - q_2(t-1)$ 的序列：\n*   $\\dot q_2(1) = 1-1=0$\n*   $\\dot q_2(2) = 1-1=0$\n*   $\\dot q_2(3) = 2-1=1$\n*   $\\dot q_2(4) = 3-2=1$\n*   $\\dot q_2(5) = 3-3=0$\n*   $\\dot q_2(6) = 3-3=0$\n*   $\\dot q_2(7) = 2-3=-1$\n*   $\\dot q_2(8) = 2-2=0$\n\n因此，要进行相关的序列是 $x(t) = q_1(t)$ 和 $y(t) = \\dot q_2(t) = [\\,0, 0, 1, 1, 0, 0, -1, 0\\,]$（对于 $t=1, \\dots, 8$）。我们需要找到 $\\rho_{xy}(\\tau) = \\mathrm{corr}\\big(q_1, \\dot q_2\\big)(\\tau)$ 的显著峰值的滞后 $\\tau$。\n\n我们将为小的整数滞后 $|\\tau|$ 计算互相关的分子，即样本协方差。协方差的峰值对应于相关性的峰值。协方差的公式是 $C_{xy}(\\tau) = \\sum_t (x(t-\\tau) - \\bar{x})(y(t) - \\bar{y})$，其中求和是在共同的时间支撑集上进行的，均值是在该支撑集上的序列计算的。\n\n**情况 $\\tau = 1$（$q_1$ 领先于 $\\dot q_2$）：**\n求和范围是 $t \\in [1, 8]$。\n*   序列 $x(t-1)$ 是 $q_1(0...7) = [\\,3, 4, 5, 5, 4, 3, 2, 2\\,]$。其均值为 $\\bar x = (3+4+5+5+4+3+2+2)/8 = 28/8 = 3.5$。\n*   序列 $y(t)$ 是 $\\dot q_2(1...8) = [\\,0, 0, 1, 1, 0, 0, -1, 0\\,]$。其均值为 $\\bar y = (0+0+1+1+0+0-1+0)/8 = 1/8 = 0.125$。\n*   未中心化的交叉乘积和是 $\\sum_{t=1}^8 q_1(t-1) \\dot q_2(t) = 5\\cdot1 + 5\\cdot1 + 2\\cdot(-1) = 8$。\n*   协方差是 $C_{xy}(1) = \\sum x y - N \\bar x \\bar y = 8 - 8 \\cdot (3.5) \\cdot (0.125) = 8 - 3.5 = 4.5$。\n\n**情况 $\\tau = 0$（零滞后）：**\n求和范围是 $t \\in [1, 8]$。\n*   序列 $x(t)$ 是 $q_1(1...8) = [\\,4, 5, 5, 4, 3, 2, 2, 2\\,]$。其均值为 $\\bar x = (4+5+5+4+3+2+2+2)/8 = 27/8 = 3.375$。\n*   序列 $y(t)$ 与之前相同，$\\bar y = 0.125$。\n*   未中心化的交叉乘积和是 $\\sum_{t=1}^8 q_1(t) \\dot q_2(t) = 5\\cdot1 + 4\\cdot1 + 2\\cdot(-1) = 7$。\n*   协方差是 $C_{xy}(0) = \\sum x y - N \\bar x \\bar y = 7 - 8 \\cdot (3.375) \\cdot (0.125) = 7 - 3.375 = 3.625$。\n\n**情况 $\\tau = 2$（$q_1$ 领先于 $\\dot q_2$）：**\n求和范围是 $t \\in [2, 8]$。\n*   序列 $x(t-2)$ 是 $q_1(0...6) = [\\,3, 4, 5, 5, 4, 3, 2\\,]$。其均值为 $\\bar x = (3+4+5+5+4+3+2)/7 = 26/7 \\approx 3.714$。\n*   序列 $y(t)$ 是 $\\dot q_2(2...8) = [\\,0, 1, 1, 0, 0, -1, 0\\,]$。其均值为 $\\bar y = (0+1+1+0+0-1+0)/7 = 1/7 \\approx 0.143$。\n*   未中心化的交叉乘积和是 $\\sum_{t=2}^8 q_1(t-2) \\dot q_2(t) = 4\\cdot1 + 5\\cdot1 + 3\\cdot(-1) = 6$。\n*   协方差是 $C_{xy}(2) = \\sum x y - N \\bar x \\bar y = 6 - 7 \\cdot (26/7) \\cdot (1/7) = 6 - 26/7 = (42-26)/7 = 16/7 \\approx 2.286$。\n\n协方差值为 $C(1)=4.5$，$C(0)=3.625$，$C(2)\\approx 2.286$。协方差显然是正的，并在滞后 $\\tau=1$ 处有一个显著的峰值。为了确认相关的强度，我们可以计算 $\\rho(1)$。\n*   $\\rho(1)$ 的分母：$\\sqrt{\\sum (x-\\bar x)^2} \\sqrt{\\sum (y-\\bar y)^2}$。\n*   对于 $x(t-1)$，中心化序列是 $[ -0.5, 0.5, 1.5, 1.5, 0.5, -0.5, -1.5, -1.5 ]$。平方和是 $10$。\n*   对于 $y(t)$，中心化序列是 $[ -0.125, -0.125, 0.875, 0.875, -0.125, -0.125, -1.125, -0.125 ]$。平方和是 $184/64 = 2.875$。\n*   $\\rho(1) = \\frac{4.5}{\\sqrt{10} \\sqrt{2.875}} \\approx \\frac{4.5}{3.162 \\times 1.696} \\approx \\frac{4.5}{5.362} \\approx 0.839$。\n\n这是一个非常强的正相关。数据显示，核心1上的高队列长度是核心2在一个时间步长后队列长度增加的强预测因子。这一观察是推送迁移的经典特征。\n\n### 步骤3：逐项分析\n\n**A. 系统使用推送迁移：$q_1$ 领先于 $\\dot q_2$；$\\mathrm{corr}\\big(q_1,\\dot q_2\\big)$ 在一个小的正滞后 $\\tau0$ 处有一个强的正峰值。**\n该陈述与我们对推送迁移的理论推理和对所提供数据的分析完全一致。我们在正滞后 $\\tau = 1$ 处发现了一个强的正相关系数 ($\\rho \\approx 0.839$)。在 $\\tau=1$ 处的峰值意味着 $q_1$ 领先于 $\\dot q_2$。\n**结论：正确。**\n\n**B. 系统使用拉取迁移：$q_2$ 在欠载时发起转移；$\\mathrm{corr}\\big(q_1,\\dot q_2\\big)$ 在一个负滞后 $\\tau  0$ 处达到峰值，或者对于 $\\tau0$ 时相关性很弱。**\n该陈述声称对于拉取迁移，对于 $\\tau  0$ 时相关性较弱，或峰值出现在 $\\tau  0$。我们的数据分析发现在 $\\tau=1  0$ 处存在*强*相关性，这与这两种可能性都相矛盾。因此，数据与为拉取迁移描述的特征不一致。\n**结论：不正确。**\n\n**C. 系统使用拉取迁移，但 $q_1$ 仍然以一个强的正峰值在 $\\tau0$ 处领先于 $\\dot q_2$。**\n该选项表明系统正在使用拉取迁移，但巧合地表现出推送迁移的特征。虽然复杂的系统动态有时会产生误导性的相关性，但奥卡姆剃刀原则建议我们应选择最简单的解释。观察到的特征是推送迁移的典型预期。在这一证据面前断言策略是拉取迁移需要一个独立的、有说服力的理由，而这里并未提供。从数据得出的最直接结论是该策略为推送迁移。\n**结论：不正确。**\n\n**D. 两种策略都无法推断：对于小的 $|\\tau|$，$\\mathrm{corr}\\big(q_1,\\dot q_2\\big)$ 近似为零。**\n该陈述声称相关性可以忽略不计。我们的计算表明，在 $\\tau=1$ 处相关性是强的正相关，$\\rho(1) \\approx 0.839$，这远非零。因此，该陈述在事实上是不正确的。\n**结论：不正确。**\n\n数据分析为推送迁移策略提供了强有力的证据，因为其特征信号在 $q_1$ 和 $\\dot q_2$ 之间的相关性中清晰可见。", "answer": "$$\\boxed{A}$$", "id": "3674334"}, {"introduction": "任务迁移并非没有代价，理解其开销是优化系统性能的关键。此练习深入探讨了一个主要的开销来源：管理翻译后备缓冲器 (TLB) 的成本。通过构建一个量化模型，你将分析迁移开销如何随应用程序的内存占用而变化，并确定何时迁移的成本会超过其带来的收益。", "problem": "一个多核操作系统采用两种负载均衡策略：推送迁移，即繁忙的核心主动将一个可运行线程移动到另一个核心；以及拉取迁移，即空闲的核心在检测到不平衡时拉取一个线程。考虑线程在核心之间迁移所导致的内存翻译开销。底层架构提供了一个缓存页翻译的转译后备缓冲器 (TLB)。一个迁移线程的地址空间由地址空间标识符 (ASID) 标识，但假设在该平台上，操作系统通过向源核心发送处理器间中断 (IPI) 来执行每页的 TLB 刷出 (shootdown)，以使迁移地址空间可能陈旧的翻译无效，并且目的核心在首次接触线程工作集中的每个不同页面时必须承担 TLB 补充 (refill) 的开销。\n\n使用以下符合上下文的基础和假设：\n- 转译后备缓冲器 (TLB) 的容量为 $E$ 个条目，每个条目缓存一页的翻译。\n- 线程的工作集涵盖 $n$ 个不同的页面。\n- 在源核心上，每次每页 TLB 无效化（例如类似于 invalidate page 的指令）的成本为每个无效条目 $t_{\\text{invlpg}}$ 秒，而分派和处理处理器间中断 (IPI) 的成本为每次刷出事件 $t_{\\text{ipi}}$ 秒的固定开销。\n- 在目的核心上，每次首次访问工作集中尚未在 TLB 中的不同页面都会导致一次 TLB 未命中，在 TLB 为该地址空间预热之前，每次访问不同页面的成本为 $t_{\\text{miss}}$ 秒。\n- 在单次迁移中，超出 TLB 容量的页面不会产生超过 $E$ 个的额外无效化或未命中，因为 TLB 一次最多只能驻留 $E$ 个不同的翻译。\n\n任务：\n1. 从以上定义出发，推导一个闭式表达式 $S(n)$，表示由于两个核心上的 TLB 刷出和 TLB 补充所导致的总迁移开销时间。该表达式用 $n$、$E$、$t_{\\text{ipi}}$、$t_{\\text{invlpg}}$ 和 $t_{\\text{miss}}$ 表示。您的表达式必须对小型和大型地址空间都有效，并应基于 TLB 容量证明任何饱和行为的合理性。\n2. 对于“小型”地址空间（$n_{s} = 32$ 页）和“大型”地址空间（$n_{\\ell} = 4096$ 页），在给定 $E = 512$，$t_{\\text{ipi}} = 3.0 \\times 10^{-6}$ 秒，$t_{\\text{invlpg}} = 8.0 \\times 10^{-8}$ 秒，以及 $t_{\\text{miss}} = 4.0 \\times 10^{-8}$ 秒的情况下，计算 $S(n)$ 的值。将两个结果都用微秒表示，并四舍五入到四位有效数字。\n3. 设推送迁移的主动收益（例如，减少的运行队列等待时间）为每次迁移 $G$ 秒。推导一个单一的闭式解析表达式，表示阈值页数 $n^{\\star}$（作为 $E$、$t_{\\text{ipi}}$、$t_{\\text{invlpg}}$、$t_{\\text{miss}}$ 和 $G$ 的函数），当页数超过该阈值时，推送迁移会产生反效果，即 $S(n)  G$。\n\n将您的最终结果以行向量 $\\big[ S(n_{s})\\text{ (单位 }\\mu\\text{s}),\\ S(n_{\\ell})\\text{ (单位 }\\mu\\text{s}),\\ n^{\\star} \\big]$ 的形式提供，并注意数值条目必须四舍五入到四位有效数字。在加框的最终答案中不要包含单位，但在您的中间工作中明确说明单位为微秒。", "solution": "首先对问题陈述进行严格的验证过程。\n\n### 步骤 1：提取已知条件\n- **TLB 容量：** $E$ 个条目。\n- **线程工作集：** $n$ 个不同页面。\n- **IPI 开销：** $t_{\\text{ipi}}$ 秒，每次刷出事件的固定成本。\n- **每页无效化成本：** $t_{\\text{invlpg}}$ 秒，源核心上每个无效条目的成本。\n- **TLB 未命中成本：** $t_{\\text{miss}}$ 秒，目的核心上每个不同页面的成本。\n- **饱和约束：** “在单次迁移中，超出 TLB 容量的页面不会产生超过 $E$ 个的额外无效化或未命中，因为 TLB 一次最多只能驻留 $E$ 个不同的翻译。”\n- **任务 1：** 推导总迁移开销时间 $S(n)$。\n- **任务 2：** 给定以下参数，计算 $n_{s} = 32$ 和 $n_{\\ell} = 4096$ 时的 $S(n)$ 值：\n  - $E = 512$\n  - $t_{\\text{ipi}} = 3.0 \\times 10^{-6}$ 秒\n  - $t_{\\text{invlpg}} = 8.0 \\times 10^{-8}$ 秒\n  - $t_{\\text{miss}} = 4.0 \\times 10^{-8}$ 秒\n- **任务 3：** 推导阈值页数 $n^{\\star}$，使得 $S(n)  G$，其中 $G$ 是推送迁移的主动收益。\n- **最终答案格式：** 一个行向量 $\\big[ S(n_{s})\\text{ (单位 }\\mu\\text{s}),\\ S(n_{\\ell})\\text{ (单位 }\\mu\\text{s}),\\ n^{\\star} \\big]$，数值四舍五入到四位有效数字。\n\n### 步骤 2：使用提取的已知条件进行验证\n- **科学性：** 该问题基于操作系统和计算机体系结构中的既定概念，包括线程迁移、转译后备缓冲器 (TLB)、TLB 刷出 (TLB shootdown) 和处理器间中断 (IPI)。成本模型是对现实世界开销的有效简化。该问题在科学上是合理的。\n- **适定性：** 所有必要的变量和约束都已定义。任务具体，可以推导出唯一且有意义的解。基于 TLB 容量 $E$ 的明确饱和约束消除了歧义。\n- **客观性：** 问题以精确的技术语言陈述，不含主观性或个人意见。\n- **缺陷检查：** 该问题没有违反任何基本原则，不完整或矛盾，使用了合理的物理参数，并且不是不适定或琐碎的。饱和条件增加了一个非凡的建模挑战。\n\n### 步骤 3：结论与行动\n该问题被判定为**有效**。将提供完整解答。\n\n### 解答推导\n\n总迁移开销 $S(n)$ 是源核心上的开销（TLB 刷出）和目的核心上的开销（TLB 补充）之和。\n\n$S(n) = T_{\\text{shootdown}} + T_{\\text{refill}}$\n\n**1. 开销表达式 $S(n)$ 的推导**\n\n源核心上的 TLB 刷出过程包括一次用于启动无效化过程的处理器间中断 (IPI)，以及无效化每个相关 TLB 条目的成本。一个工作集为 $n$ 页的线程在 TLB 中最多可以有 $n$ 个条目。然而，TLB 的容量限制为 $E$ 个条目。因此，该线程在源核心的 TLB 中可能存在的条目数是 $n$ 和 $E$ 中的较小值。问题陈述证实了这种饱和行为。因此，刷出开销为：\n$$T_{\\text{shootdown}} = t_{\\text{ipi}} + \\min(n, E) \\cdot t_{\\text{invlpg}}$$\n这里，$t_{\\text{ipi}}$ 是刷出事件的一次性成本，而 $\\min(n, E) \\cdot t_{\\text{invlpg}}$ 是取决于要无效化的页数的变动成本。\n\nTLB 补充过程发生在目的核心上。当线程开始执行时，其工作集中的 $n$ 个页面不在新核心的 TLB 中。每次首次访问这 $n$ 个不同页面中的一个都会导致一次 TLB 未命中，产生 $t_{\\text{miss}}$ 的成本。与刷出成本类似，问题明确指出未命中的次数上限为 TLB 容量 $E$。因此，需要计算的未命中次数为 $\\min(n, E)$。补充开销为：\n$$T_{\\text{refill}} = \\min(n, E) \\cdot t_{\\text{miss}}$$\n\n将这两个部分相加，得到总迁移开销 $S(n)$：\n$$S(n) = \\left( t_{\\text{ipi}} + \\min(n, E) \\cdot t_{\\text{invlpg}} \\right) + \\left( \\min(n, E) \\cdot t_{\\text{miss}} \\right)$$\n提取公因式 $\\min(n, E)$，我们得到总开销的最终闭式表达式：\n$$S(n) = t_{\\text{ipi}} + \\min(n, E) \\cdot (t_{\\text{invlpg}} + t_{\\text{miss}})$$\n该表达式正确地模拟了当工作集小于 TLB 容量时（$n \\le E$，此时 $\\min(n, E) = n$），开销呈线性增长；当工作集大于 TLB 容量时（$n  E$，此时 $\\min(n, E) = E$），开销达到饱和。\n\n**2. 计算 $S(n_{s})$ 和 $S(n_{\\ell})$**\n\n给定以下数值：\n- $E = 512$\n- $t_{\\text{ipi}} = 3.0 \\times 10^{-6}$ s\n- $t_{\\text{invlpg}} = 8.0 \\times 10^{-8}$ s\n- $t_{\\text{miss}} = 4.0 \\times 10^{-8}$ s\n\n首先，我们预先计算每页的组合成本：\n$$t_{\\text{invlpg}} + t_{\\text{miss}} = 8.0 \\times 10^{-8} \\, \\text{s} + 4.0 \\times 10^{-8} \\, \\text{s} = 12.0 \\times 10^{-8} \\, \\text{s} = 1.2 \\times 10^{-7} \\, \\text{s}$$\n\n对于“小型”地址空间，$n_{s} = 32$。由于 $n_{s}  E$ ($32  512$)，我们有 $\\min(n_{s}, E) = 32$。\n$$S(32) = t_{\\text{ipi}} + 32 \\cdot (t_{\\text{invlpg}} + t_{\\text{miss}})$$\n$$S(32) = 3.0 \\times 10^{-6} + 32 \\cdot (1.2 \\times 10^{-7})$$\n$$S(32) = 3.0 \\times 10^{-6} + 3.84 \\times 10^{-6} = 6.84 \\times 10^{-6} \\, \\text{s}$$\n换算成微秒，即为 $6.84 \\, \\mu\\text{s}$。保留四位有效数字，即为 $6.840 \\, \\mu\\text{s}$。\n\n对于“大型”地址空间，$n_{\\ell} = 4096$。由于 $n_{\\ell}  E$ ($4096  512$)，我们有 $\\min(n_{\\ell}, E) = E = 512$。\n$$S(4096) = t_{\\text{ipi}} + E \\cdot (t_{\\text{invlpg}} + t_{\\text{miss}})$$\n$$S(4096) = 3.0 \\times 10^{-6} + 512 \\cdot (1.2 \\times 10^{-7})$$\n$$S(4096) = 3.0 \\times 10^{-6} + 61.44 \\times 10^{-6} = 64.44 \\times 10^{-6} \\, \\text{s}$$\n换算成微秒，即为 $64.44 \\, \\mu\\text{s}$。该值已有四位有效数字。\n\n**3. 阈值页数 $n^{\\star}$ 的推导**\n\n当迁移开销 $S(n)$ 超过收益 $G$ 时，推送迁移会产生反效果。阈值 $n^{\\star}$ 是开销等于收益时的页数，即 $S(n^{\\star}) = G$。\n$$t_{\\text{ipi}} + \\min(n^{\\star}, E) \\cdot (t_{\\text{invlpg}} + t_{\\text{miss}}) = G$$\n只有在开销未饱和的情况下，才能解出 $n^{\\star}$。从有益到产生反效果的临界点必须出现在成本函数的线性区域，即 $n^{\\star} \\le E$。如果收益 $G$ 大于最大可能开销 $S(E) = t_{\\text{ipi}} + E (t_{\\text{invlpg}} + t_{\\text{miss}})$，那么迁移永远不会产生反效果，也就不存在有限的阈值 $n^{\\star}$。假设这样的阈值确实存在（即 $G$ 不会过大），我们可以在线性区域（$\\min(n^{\\star}, E) = n^{\\star}$）求解 $n^{\\star}$：\n$$t_{\\text{ipi}} + n^{\\star} \\cdot (t_{\\text{invlpg}} + t_{\\text{miss}}) = G$$\n求解 $n^{\\star}$：\n$$n^{\\star} \\cdot (t_{\\text{invlpg}} + t_{\\text{miss}}) = G - t_{\\text{ipi}}$$\n$$n^{\\star} = \\frac{G - t_{\\text{ipi}}}{t_{\\text{invlpg}} + t_{\\text{miss}}}$$\n如果 $G  t_{\\text{ipi}}$，该表达式对于页数阈值具有物理意义，此时 $n^{\\star}  0$。如果 $G \\le t_{\\text{ipi}}$，则对于任何工作集大小（$n  0$），任何迁移都会产生反效果，使得有效阈值为 $0$。在阈值存在于线性成本域（$0 \\le n^{\\star} \\le E$）的条件下，推导出的表达式是阈值 $n^{\\star}$ 的通用解析解。", "answer": "$$\n\\boxed{\n\\left[ 6.840, \\ 64.44, \\ \\frac{G - t_{\\text{ipi}}}{t_{\\text{invlpg}} + t_{\\text{miss}}} \\right]\n}\n$$", "id": "3674362"}]}