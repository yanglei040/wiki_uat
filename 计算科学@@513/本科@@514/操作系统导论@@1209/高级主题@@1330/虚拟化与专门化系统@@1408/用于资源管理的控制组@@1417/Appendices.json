{"hands_on_practices": [{"introduction": "掌握控制组 (cgroups) 的第一步是理解其核心的资源分配机制。这个练习将带你深入了解 `cpu.weight` 参数如何直接转化为 CPU 时间的比例分配，为你提供一个量化验证完全公平调度器 (Completely Fair Scheduler, CFS) 基本原则的实践机会。通过计算预期值并与假设的观测数据进行比较，你将学会如何评估和诊断调度器的公平性。", "problem": "一个 Linux 系统使用控制组 (cgroups) 版本 2，通过参数 $cpu.weight$ 来限制并在组间按比例共享中央处理器 (CPU)。考虑两个控制组 A 和 B，其权重配置为 $w_{A}=100$ 和 $w_{B}=400$。有一个被完全利用的 CPU 核心，并且在整个测量区间内，每个 cgroup 都有且仅有一个持续可运行的任务被固定到此核心上。假设在此区间内没有其他可运行的实体竞争 CPU。调度器是 Linux 完全公平调度器 (Completely Fair Scheduler, CFS)，在稳态竞争条件下，它会尝试均衡各个实体按其权重缩放后的虚拟运行时间。\n\n您在一个长度为 $T=12 \\text{ s}$ 的固定区间内进行测量，获得 cgroup A 和 B 的观测 CPU 运行时间分别为 $T_{A}^{\\text{obs}}=2.6 \\text{ s}$ 和 $T_{B}^{\\text{obs}}=9.4 \\text{ s}$。\n\n从 CFS 旨在均衡各可运行实体加权虚拟运行时间的核心公平性原则出发，推导出该区间内预期的按比例分配的 CPU 时间 $T_{A}^{\\text{exp}}$ 和 $T_{B}^{\\text{exp}}$，然后使用均方根相对误差来量化观测分配与预期分配之间的差异：\n$$\nE \\;=\\; \\sqrt{\\frac{1}{2}\\left(\\frac{\\left(T_{A}^{\\text{obs}}-T_{A}^{\\text{exp}}\\right)^{2}}{\\left(T_{A}^{\\text{exp}}\\right)^{2}} \\;+\\; \\frac{\\left(T_{B}^{\\text{obs}}-T_{B}^{\\text{exp}}\\right)^{2}}{\\left(T_{B}^{\\text{exp}}\\right)^{2}}\\right)}.\n$$\n仅报告 $E$ 的值，形式为无单位的小数。将您的答案四舍五入到四位有效数字。", "solution": "该问题要求计算由 Linux 完全公平调度器 (CFS) 管理的两个控制组 A 和 B 的观测 CPU 时间分配与预期 CPU 时间分配之间的差异。\n\n首先，我们必须确定预期的 CPU 时间分配，$T_{A}^{\\text{exp}}$ 和 $T_{B}^{\\text{exp}}$。问题指出，CFS 调度器在竞争条件下，会根据各实体的 `cpu.weight` 值按比例共享 CPU。给定的控制组 A 和控制组 B 的权重分别为 $w_{A}=100$ 和 $w_{B}=400$。\n\n竞争实体的总权重是各个权重的总和：\n$$\nW = w_{A} + w_{B} = 100 + 400 = 500\n$$\n每个 cgroup 的预期 CPU 时间比例是其权重与总权重的比值。\n对于 cgroup A，预期比例 $p_{A}$ 是：\n$$\np_{A} = \\frac{w_{A}}{W} = \\frac{100}{500} = \\frac{1}{5} = 0.2\n$$\n对于 cgroup B，预期比例 $p_{B}$ 是：\n$$\np_{B} = \\frac{w_{B}}{W} = \\frac{400}{500} = \\frac{4}{5} = 0.8\n$$\n总测量区间给定为 $T=12 \\text{ s}$。预期的 CPU 运行时间是通过将总区间乘以各自的比例来计算的。\ncgroup A 的预期运行时间是：\n$$\nT_{A}^{\\text{exp}} = p_{A} \\times T = 0.2 \\times 12 \\text{ s} = 2.4 \\text{ s}\n$$\ncgroup B 的预期运行时间是：\n$$\nT_{B}^{\\text{exp}} = p_{B} \\times T = 0.8 \\times 12 \\text{ s} = 9.6 \\text{ s}\n$$\n作为检验，预期运行时间的总和必须等于总区间：$T_{A}^{\\text{exp}} + T_{B}^{\\text{exp}} = 2.4 \\text{ s} + 9.6 \\text{ s} = 12 \\text{ s}$，这与题设一致。\n\n接下来，我们使用提供的均方根相对误差公式 $E$ 来量化观测分配与预期分配之间的差异：\n$$\nE = \\sqrt{\\frac{1}{2}\\left(\\frac{\\left(T_{A}^{\\text{obs}}-T_{A}^{\\text{exp}}\\right)^{2}}{\\left(T_{A}^{\\text{exp}}\\right)^{2}} + \\frac{\\left(T_{B}^{\\text{obs}}-T_{B}^{\\text{exp}}\\right)^{2}}{\\left(T_{B}^{\\text{exp}}\\right)^{2}}\\right)}\n$$\n问题提供了观测运行时间：$T_{A}^{\\text{obs}}=2.6 \\text{ s}$ 和 $T_{B}^{\\text{obs}}=9.4 \\text{ s}$。现在我们可以将观测值和预期值代入 $E$ 的公式中。\n\n首先，我们计算各个相对误差项。对于 cgroup A：\n$$\n\\frac{T_{A}^{\\text{obs}}-T_{A}^{\\text{exp}}}{T_{A}^{\\text{exp}}} = \\frac{2.6 - 2.4}{2.4} = \\frac{0.2}{2.4} = \\frac{1}{12}\n$$\n对于 cgroup B：\n$$\n\\frac{T_{B}^{\\text{obs}}-T_{B}^{\\text{exp}}}{T_{B}^{\\text{exp}}} = \\frac{9.4 - 9.6}{9.6} = \\frac{-0.2}{9.6} = -\\frac{1}{48}\n$$\n现在我们将这些代入 $E$ 的公式中：\n$$\nE = \\sqrt{\\frac{1}{2}\\left(\\left(\\frac{1}{12}\\right)^{2} + \\left(-\\frac{1}{48}\\right)^{2}\\right)}\n$$\n$$\nE = \\sqrt{\\frac{1}{2}\\left(\\frac{1}{144} + \\frac{1}{2304}\\right)}\n$$\n为了对分数求和，我们找到一个公分母，即 $2304$。注意 $144 \\times 16 = 2304$。\n$$\nE = \\sqrt{\\frac{1}{2}\\left(\\frac{16}{2304} + \\frac{1}{2304}\\right)}\n$$\n$$\nE = \\sqrt{\\frac{1}{2}\\left(\\frac{17}{2304}\\right)}\n$$\n$$\nE = \\sqrt{\\frac{17}{4608}}\n$$\n最后，我们计算数值，并按要求四舍五入到四位有效数字。\n$$\nE \\approx \\sqrt{0.003689236...} \\approx 0.06073908...\n$$\n四舍五入到四位有效数字，我们得到：\n$$\nE \\approx 0.06074\n$$", "answer": "$$\n\\boxed{0.06074}\n$$", "id": "3628647"}, {"introduction": "在真实世界的系统中，资源控制往往不是扁平化的，而是通过嵌套的层级结构来组织。这个练习建立在前一个练习的基础之上，将比例共享原则应用到一个更复杂的层级结构中，并将资源从 CPU 扩展到 I/O 带宽。通过这个实践，你将理解 cgroup 策略如何组合使用，以实现对复杂应用架构的精细化资源管理 [@problem_id:3628646]。", "problem": "一个系统使用控制组 (cgroups) 来管理单个块设备的输入/输出 (I/O) 带宽，该设备的可持续吞吐量为 $B$ 兆字节/秒 (MiB/s)。块 I/O 控制器采用线性比例共享策略：在任何调度器级别，可用带宽都将根据已配置的权重，按比例在同级 cgroup 之间分配。\n\n考虑以下以设备控制器为根的层级结构。在根级别，正好有两个同级 cgroup：\n- 父组 $\\mathcal{P}$，其配置权重为 $blkio.weight = 500$。\n- 同级组 $\\mathcal{S}$，其配置权重为 $blkio.weight = 500$。\n\n在 $\\mathcal{P}$ 内部，正好有两个叶 cgroup，它们都持续发出大块 I/O 请求，从而完全利用任何授予的带宽：\n- 子组 $\\mathcal{C}_1$，其配置权重为 $100$。\n- 子组 $\\mathcal{C}_2$，其配置权重为 $400$。\n\n同级组 $\\mathcal{S}$ 包含一个叶 cgroup，它也持续发出 I/O 请求，因此设备被三个活动的叶 cgroup（$\\mathcal{C}_1$、$\\mathcal{C}_2$ 和 $\\mathcal{S}$ 内的叶 cgroup）完全饱和。\n\n假设层级结构的每一级都存在理想的线性比例共享，并且所有三个叶 cgroup 都具有相同的 I/O 请求特性，请计算 $\\mathcal{C}_1$ 和 $\\mathcal{C}_2$ 的归一化吞吐量份额，结果表示为总设备吞吐量 $B$ 的精确分数。将您的答案以一个二元行矩阵 $(\\mathcal{C}_1, \\mathcal{C}_2)$ 的形式报告。无需四舍五入；将最终值表示为无单位的精确分数。", "solution": "基本原理是线性比例共享原则：在任何调度器级别，共享资源的同级实体集会根据其配置的权重按比例获得分配。在控制组 (cgroups) 和块 I/O 控制器的背景下，这意味着在层级结构的每一级，分配给子组的带宽份额与其权重占其所有同级组权重总和的比例成正比，并且一个叶 cgroup 的长期份额等于其从根节点到自身路径上所有比例份额的乘积。\n\n设总设备吞吐量为 $B$ MiB/s。在根级别，两个同级 cgroup $\\mathcal{P}$ 和 $\\mathcal{S}$ 的权重分别为 $500$ 和 $500$。在比例共享下，分配给 $\\mathcal{P}$ 的 $B$ 的份额为\n$$\n\\frac{500}{500 + 500} = \\frac{500}{1000} = \\frac{1}{2},\n$$\n因此 $\\mathcal{P}$ 获得 $\\frac{1}{2} B$。类似地，$\\mathcal{S}$ 获得 $\\frac{1}{2} B$。\n\n在 $\\mathcal{P}$ 内部，两个叶 cgroup $\\mathcal{C}_1$ 和 $\\mathcal{C}_2$ 的权重分别为 $100$ 和 $400$。它们在 $\\mathcal{P}$ 的分配中所占的份额由该级别的同级组之间的比例共享决定。分配给 $\\mathcal{C}_1$ 的 $\\mathcal{P}$ 的带宽份额为\n$$\n\\frac{100}{100 + 400} = \\frac{100}{500} = \\frac{1}{5},\n$$\n分配给 $\\mathcal{C}_2$ 的份额为\n$$\n\\frac{400}{100 + 400} = \\frac{400}{500} = \\frac{4}{5}.\n$$\n\n乘以 $\\mathcal{P}$ 从根级别获得的分配，相对于总设备吞吐量 $B$ 的绝对份额为：\n- 对于 $\\mathcal{C}_1$：\n$$\n\\left(\\frac{1}{2}\\right) \\times \\left(\\frac{1}{5}\\right) \\times B = \\frac{1}{10} B,\n$$\n对应于 $B$ 的归一化分数 $\\frac{1}{10}$。\n- 对于 $\\mathcal{C}_2$：\n$$\n\\left(\\frac{1}{2}\\right) \\times \\left(\\frac{4}{5}\\right) \\times B = \\frac{4}{10} B = \\frac{2}{5} B,\n$$\n对应于 $B$ 的归一化分数 $\\frac{2}{5}$。\n\n因此，$\\mathcal{C}_1$ 和 $\\mathcal{C}_2$ 的归一化吞吐量份额作为总设备吞吐量的分数分别为 $\\frac{1}{10}$ 和 $\\frac{2}{5}$。以二元行矩阵 $(\\mathcal{C}_1, \\mathcal{C}_2)$ 的形式报告，得到\n$$\n\\begin{pmatrix}\n\\frac{1}{10}  \\frac{2}{5}\n\\end{pmatrix}.\n$$", "answer": "$$\\boxed{\\begin{pmatrix}\\frac{1}{10}  \\frac{2}{5}\\end{pmatrix}}$$", "id": "3628646"}, {"introduction": "仅仅按比例“公平”共享资源有时会带来意想不到的后果，比如一个工作负载被另一个完全“饿死”。这个练习揭示了比例共享的局限性，并引入了一个更高级的场景：如何通过预留来保证最低服务质量 (QoS)。你将运用基本的排队论原理，推导出防止 I/O 饥饿所需的最小资源保证，从而将 cgroup 配置与系统稳定性理论联系起来 [@problem_id:3628649]。", "problem": "一位系统管理员使用 Linux 控制组 (cgroups) 来管理共享单个存储设备的2个工作负载的输入/输出 (I/O)。一个 cgroup 表示为 $W$，执行小的随机写入；另一个表示为 $R$，执行大的顺序读取。当专门服务于单个 cgroup 时，该设备的行为如下：对于 $W$，设备维持 $\\Theta_{w}$ 字节/秒的吞吐量；对于 $R$，设备维持 $\\Theta_{r}$ 字节/秒的吞吐量。写入的平均请求大小为 $B_{w}$ 字节，读取的平均请求大小为 $B_{r}$ 字节。请求作为独立的更新过程到达，对于 $W$，平均速率为 $\\lambda_{w}$ 请求/秒，对于 $R$，平均速率为 $\\lambda_{r}$ 请求/秒。\n\nI/O 控制器是工作保持的。在没有任何预留或共享配置的情况下，只要两个队列都非空，控制器就会给予 $R$ 严格的优先级，这反映了对读取操作普遍存在的延迟敏感偏向。当配置了时间片预留时，设备服务时间的 $r$ 部分被保证分配给 $W$，而 $1-r$ 部分可用于 $R$，其中 $0  r  1$。由于工作负载交错会产生开销，工作负载 $W$ 的有效服务速率是其独占使用时速率的 $\\alpha$ 倍，其中 $\\alpha \\in (0,1]$。\n\n1.  在无预留、读取优先机制下工作负载 $W$ 饿死的条件是什么？\n2.  为使 $W$ 的队列稳定，推导最小预留比例 $r_{\\min}$。将您的最终答案表达为 $\\lambda_{w}$、$\\Theta_{w}$、$B_{w}$ 和 $\\alpha$ 的函数。", "solution": "该问题包含两个部分，都可以使用排队论的基本原理来解决。单服务器队列保持稳定的核心原则是，其平均到达率（表示为 $\\lambda$）必须严格小于其平均服务率（表示为 $\\mu$）。如果 $\\lambda \\geq \\mu$，队列长度平均而言将无界增长，这种情况被称为不稳定性或非平稳性。服务器的利用率定义为 $\\rho = \\lambda / \\mu$。稳定性要求 $\\rho  1$。\n\n1. 在无预留、读取优先机制下工作负载 $W$ 饿死的条件。\n\n在这种机制下，I/O 控制器实现了一个严格的、非抢占式的优先级排队规则，其中工作负载 $R$ 具有高优先级，而工作负载 $W$ 具有低优先级。这意味着服务器（存储设备）仅在 $R$ 队列为空时才服务来自 $W$ 队列的请求。\n\n工作负载 $R$ 的到达率为每秒 $\\lambda_r$ 个请求。$R$ 的独占使用服务速率由 $\\mu_r = \\Theta_r / B_r$ 请求/秒给出。服务器忙于服务高优先级工作负载 $R$ 的时间比例是其利用率 $\\rho_r$。\n$$ \\rho_r = \\frac{\\lambda_r}{\\mu_r} = \\frac{\\lambda_r}{\\Theta_r / B_r} = \\frac{\\lambda_r B_r}{\\Theta_r} $$\n项 $\\lambda_r B_r$ 表示读取数据的平均到达率（以字节/秒为单位），而 $\\Theta_r$ 是读取数据的最大服务率（以字节/秒为单位）。因此，$\\rho_r$ 是读取工作负载所需求的设备 I/O 容量的比例。\n\n低优先级工作负载 $W$ 只有在服务器相对于工作负载 $R$ 空闲时才能获得服务。假设 $\\rho_r  1$，这种情况发生的时间比例为 $1 - \\rho_r$。如果来自高优先级工作负载的需求达到或超过服务器的容量，即如果 $\\rho_r \\geq 1$，则服务器将 $100\\%$ 的时间（在稳态或极限情况下）忙于服务 $R$ 的请求。因此，$W$ 队列将永远不会得到服务，导致其饿死。\n\n因此，$W$ 饿死的条件是：\n$$ \\rho_r \\geq 1 $$\n代入 $\\rho_r$ 的表达式，条件变为：\n$$ \\frac{\\lambda_r B_r}{\\Theta_r} \\geq 1 $$\n这等价于说，读取数据的到达率 $\\lambda_r B_r$ 大于或等于设备对该数据的服务容量 $\\Theta_r$。\n\n2. 为使 $W$ 的队列稳定，推导最小预留比例 $r_{\\min}$。\n\n在时间分片预留策略下，工作负载 $W$ 队列的稳定性取决于其自身的到达率和有效服务率。稳定性条件是 $\\lambda_w  \\mu_{w,eff}$，其中 $\\lambda_w$ 是 $W$ 的到达率，$\\mu_{w,eff}$ 是其在预留方案下的有效服务率。\n\n我们需要推导 $\\mu_{w,eff}$ 的表达式。\n工作负载 $W$ 的独占使用服务速率为 $\\mu_w = \\Theta_w / B_w$ 请求/秒。\n在时间片预留的情况下，设备服务时间的 $r$ 部分被保证分配给 $W$。这将服务速率按比例因子 $r$ 缩放。\n此外，交错的工作负载引入了低效率，由因子 $\\alpha \\in (0,1]$ 建模。该因子降低了写入请求可被处理的速率。\n\n问题陈述中提到“$W$ 的有效写入服务速率变为其独占使用时请求服务速率的 $\\alpha$ 倍”。这意味着在 $W$ 的时间片期间，瞬时服务速率是 $\\alpha \\mu_w$。由于 $W$ 被保证获得总时间的 $r$ 部分，其长期平均有效服务速率是预留时间比例、效率因子和独占使用服务速率的乘积。\n$$ \\mu_{w,eff} = r \\cdot \\alpha \\cdot \\mu_w $$\n因此，$W$ 工作负载的稳定性条件是：\n$$ \\lambda_w  r \\cdot \\alpha \\cdot \\mu_w $$\n为了找到保证稳定性的最小预留比例 $r_{\\min}$，我们考虑边界情况，即到达率等于有效服务率。任何大于此边界值的 $r$ 值都将确保稳定性。\n$$ \\lambda_w = r_{\\min} \\cdot \\alpha \\cdot \\mu_w $$\n解出 $r_{\\min}$：\n$$ r_{\\min} = \\frac{\\lambda_w}{\\alpha \\cdot \\mu_w} $$\n问题要求最终表达式用 $\\lambda_{w}$、$\\Theta_{w}$、$B_{w}$ 和 $\\alpha$ 表示。我们代入 $\\mu_w$ 的表达式：\n$$ r_{\\min} = \\frac{\\lambda_w}{\\alpha \\left( \\frac{\\Theta_w}{B_w} \\right)} $$\n化简此表达式得到最终结果：\n$$ r_{\\min} = \\frac{\\lambda_w B_w}{\\alpha \\Theta_w} $$\n这个结果是直观的：所需的最小资源比例是写入所需的吞吐量（$\\lambda_w B_w$）与设备在交错情况下对写入的有效吞吐量容量（$\\alpha \\Theta_w$）的比率。为了使稳定解可行，该比例 $r_{\\min}$ 必须小于或等于 $1$。", "answer": "$$ \\boxed{\\frac{\\lambda_w B_w}{\\alpha \\Theta_w}} $$", "id": "3628649"}]}