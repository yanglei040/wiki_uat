{"hands_on_practices": [{"introduction": "多态内联缓存 (Polymorphic Inline Caches, PICs) 是优化面向对象语言中虚方法调用的关键技术。通过对最常见的接收者类型进行快速路径检查，PIC 可以显著降低动态分派的开销。这个练习 [@problem_id:3639221] 将带你通过一个具体的计算，量化地分析检查顺序对性能的影响，从而让你亲身体会基于运行时信息进行优化的核心思想。", "problem": "一个即时 (JIT) 编译器在一个热点虚调用点使用多态内联缓存 (PIC)。PIC 存根按顺序测试接收者类型守卫，若匹配成功则尾调用一个直接目标，若所有守卫都失败则转移到一个巨态未命中处理器。考虑一个双条目 PIC，它最多可以容纳两个接收者类型条目，分别用于表示为 $\\mathrm{A}$ 和 $\\mathrm{B}$ 的类型。所有其他接收者类型被归为 \"其他\" ($\\mathrm{Other}$) 类别。\n\n假设采用以下执行和成本模型：\n- 接收者类型为 $\\mathrm{A}$ 的概率为 $p_{\\mathrm{A}} = 0.5$，类型为 $\\mathrm{B}$ 的概率为 $p_{\\mathrm{B}} = 0.3$，类型为 \"其他\" ($\\mathrm{Other}$) 的概率为 $p_{\\mathrm{O}} = 0.2$。\n- 每次守卫检查的成本为 $g = 2$ 个周期（包括比较和分支解析）。\n- 在守卫匹配成功时，直接调用序列的成本为 $c = 6$ 个周期（包括任何必要的分派和控制转移）。\n- 如果两个守卫都失败，控制转移到未命中处理器，其成本为 $m = 80$ 个周期（包括查找和调用解析出的目标）。\n- 在未命中时，两个守卫检查都会在未命中处理器之前执行；除了匹配成功时的直接调用外，没有其他提前退出的情况。除所述成本外，没有其他额外开销，并且可以忽略 $g$、$c$ 和 $m$ 中未包含的微架构效应。\n\n编译器可以将 PIC 存根中的两个守卫排序为 $\\mathrm{A}$-then-$\\mathrm{B}$ 或 $\\mathrm{B}$-then-$\\mathrm{A}$。利用概率论中的全期望定律和给定的成本模型，推导出每次调用的期望周期数作为守卫顺序的函数，确定哪种顺序可以最小化期望周期数，并计算最小的每次调用期望周期数。将最终数值答案四舍五入到四位有效数字，并以每次调用的周期数为单位表示。", "solution": "问题要求确定一个双条目多态内联缓存 (PIC) 中接收者类型检查的最优顺序，以最小化每次调用的期望执行时间（以周期为单位）。分析将基于全期望定律，并使用提供的概率和成本模型。\n\n设 $C$ 为单次虚调用所需的总周期数的随机变量。$C$ 的期望值，记为 $E[C]$，是需要最小化的量。问题提供了以下参数：\n- 接收者类型的概率：类型 $\\mathrm{A}$ 为 $p_{\\mathrm{A}} = 0.5$，类型 $\\mathrm{B}$ 为 $p_{\\mathrm{B}} = 0.3$，类型 \"其他\" ($\\mathrm{Other}$) 为 $p_{\\mathrm{O}} = 0.2$。注意 $p_{\\mathrm{A}} + p_{\\mathrm{B}} + p_{\\mathrm{O}} = 0.5 + 0.3 + 0.2 = 1$。\n- 单次守卫检查的成本：$g = 2$ 个周期。\n- 成功检查后的直接调用成本：$c = 6$ 个周期。\n- 巨态未命中处理器的成本：$m = 80$ 个周期。\n\nPIC 存根的检查可以有两种可能的顺序：($\\mathrm{A}$, $\\mathrm{B}$) 或 ($\\mathrm{B}$, $\\mathrm{A}$)。我们将为每种顺序计算期望成本。\n\n情况 1：守卫顺序为 $\\mathrm{A}$-then-$\\mathrm{B}$\n设 $C_{\\mathrm{A,B}}$ 为此顺序下的成本。总期望成本 $E[C_{\\mathrm{A,B}}]$ 是每种可能结果的成本按其概率加权后的总和。\n- 如果接收者是类型 $\\mathrm{A}$（概率为 $p_{\\mathrm{A}}$），则执行一次守卫检查并成功。总成本是一次守卫检查加上直接调用成本。成本：$g + c$。\n- 如果接收者是类型 $\\mathrm{B}$（概率为 $p_{\\mathrm{B}}$），则对 $\\mathrm{A}$ 的第一次守卫检查失败，对 $\\mathrm{B}$ 的第二次守卫检查成功。总成本是两次守卫检查加上直接调用成本。成本：$g + g + c = 2g + c$。\n- 如果接收者是 \"其他\" 类型（概率为 $p_{\\mathrm{O}}$），则对 $\\mathrm{A}$ 和 $\\mathrm{B}$ 的两次守卫检查都失败。控制转移到未命中处理器。总成本是两次守卫检查加上未命中处理器成本。成本：$g + g + m = 2g + m$。\n\n根据全期望定律，期望成本为：\n$$ E[C_{\\mathrm{A,B}}] = p_{\\mathrm{A}}(g+c) + p_{\\mathrm{B}}(2g+c) + p_{\\mathrm{O}}(2g+m) $$\n\n情况 2：守卫顺序为 $\\mathrm{B}$-then-$\\mathrm{A}$\n设 $C_{\\mathrm{B,A}}$ 为此顺序下的成本。其逻辑与第一种情况对称。\n- 如果接收者是类型 $\\mathrm{B}$（概率为 $p_{\\mathrm{B}}$），则执行一次守卫检查并成功。成本：$g + c$。\n- 如果接收者是类型 $\\mathrm{A}$（概率为 $p_{\\mathrm{A}}$），则对 $\\mathrm{B}$ 的第一次检查失败，对 $\\mathrm{A}$ 的第二次检查成功。成本：$2g + c$。\n- 如果接收者是 \"其他\" 类型（概率为 $p_{\\mathrm{O}}$），则两次检查都失败。成本：$2g + m$。\n\n此顺序的期望成本为：\n$$ E[C_{\\mathrm{B,A}}] = p_{\\mathrm{B}}(g+c) + p_{\\mathrm{A}}(2g+c) + p_{\\mathrm{O}}(2g+m) $$\n\n确定最优顺序\n为了找到最小化期望周期数的顺序，我们比较 $E[C_{\\mathrm{A,B}}]$ 和 $E[C_{\\mathrm{B,A}}]$。让我们来考察它们的差值：\n$$ E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] = \\left[ p_{\\mathrm{B}}(g+c) + p_{\\mathrm{A}}(2g+c) + p_{\\mathrm{O}}(2g+m) \\right] - \\left[ p_{\\mathrm{A}}(g+c) + p_{\\mathrm{B}}(2g+c) + p_{\\mathrm{O}}(2g+m) \\right] $$\n项 $p_{\\mathrm{O}}(2g+m)$ 在两个表达式中是共有的，因此可以抵消。\n$$ E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] = (p_{\\mathrm{B}}g + p_{\\mathrm{B}}c + 2p_{\\mathrm{A}}g + p_{\\mathrm{A}}c) - (p_{\\mathrm{A}}g + p_{\\mathrm{A}}c + 2p_{\\mathrm{B}}g + p_{\\mathrm{B}}c) $$\n项 $p_{\\mathrm{A}}c$ 和 $p_{\\mathrm{B}}c$ 也可以抵消。\n$$ E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] = (p_{\\mathrm{B}}g + 2p_{\\mathrm{A}}g) - (p_{\\mathrm{A}}g + 2p_{\\mathrm{B}}g) $$\n$$ E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] = p_{\\mathrm{B}}g + 2p_{\\mathrm{A}}g - p_{\\mathrm{A}}g - 2p_{\\mathrm{B}}g $$\n$$ E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] = p_{\\mathrm{A}}g - p_{\\mathrm{B}}g = g(p_{\\mathrm{A}} - p_{\\mathrm{B}}) $$\n由于 $g > 0$，差值的符号取决于 $(p_{\\mathrm{A}} - p_{\\mathrm{B}})$ 的符号。如果一个顺序能带来更低的期望成本，那么它就是最优的。\n- 如果 $p_{\\mathrm{A}} > p_{\\mathrm{B}}$，那么 $E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}] > 0$，这意味着 $E[C_{\\mathrm{B,A}}] > E[C_{\\mathrm{A,B}}]$。$\\mathrm{A}$-then-$\\mathrm{B}$ 的顺序是最优的。\n- 如果 $p_{\\mathrm{B}} > p_{\\mathrm{A}}$，那么 $E[C_{\\mathrm{B,A}}] - E[C_{\\mathrm{A,B}}]  0$，这意味着 $E[C_{\\mathrm{B,A}}]  E[C_{\\mathrm{A,B}}]$。$\\mathrm{B}$-then-$\\mathrm{A}$ 的顺序是最优的。\n\n这证实了一个普遍原则：为了最小化平均成本，应该首先测试最可能发生的结果。\n给定概率 $p_{\\mathrm{A}}=0.5$ 和 $p_{\\mathrm{B}}=0.3$，我们有 $p_{\\mathrm{A}} > p_{\\mathrm{B}}$。因此，最优的守卫顺序是 $\\mathrm{A}$-then-$\\mathrm{B}$。\n\n计算最小期望周期数\n现在我们使用给定的值来计算最小期望周期数 $E[C_{\\mathrm{A,B}}]$ 的数值：\n$p_{\\mathrm{A}} = 0.5$, $p_{\\mathrm{B}} = 0.3$, $p_{\\mathrm{O}} = 0.2$\n$g = 2$, $c = 6$, $m = 80$\n\n$$ E[C_{\\mathrm{A,B}}] = p_{\\mathrm{A}}(g+c) + p_{\\mathrm{B}}(2g+c) + p_{\\mathrm{O}}(2g+m) $$\n$$ E[C_{\\mathrm{A,B}}] = 0.5(2+6) + 0.3(2 \\times 2 + 6) + 0.2(2 \\times 2 + 80) $$\n$$ E[C_{\\mathrm{A,B}}] = 0.5(8) + 0.3(4 + 6) + 0.2(4 + 80) $$\n$$ E[C_{\\mathrm{A,B}}] = 0.5(8) + 0.3(10) + 0.2(84) $$\n$$ E[C_{\\mathrm{A,B}}] = 4.0 + 3.0 + 16.8 $$\n$$ E[C_{\\mathrm{A,B}}] = 23.8 $$\n问题要求将最终答案四舍五入到四位有效数字。计算出的值 $23.8$ 可以写作 $23.80$ 以满足此要求。单位是每次调用的周期数。\n\n最小的每次调用期望周期数是 $23.80$。", "answer": "$$\n\\boxed{23.80}\n$$", "id": "3639221"}, {"introduction": "推测性优化不仅是“做或不做”的二元选择，更涉及“做多少”的程度问题，例如决定内联的深度。我们可以使用概率模型来形式化地分析这一决策，找到最优的策略。这个练习 [@problem_id:3639208] 引导你构建一个基于几何分布的数学模型，来推导推测性内联 (speculative inlining) 的盈亏平衡点，这有助于你掌握如何将复杂的编译器优化问题转化为一个可解的数学问题。", "problem": "一个虚拟机采用带有推测性内联的即时编译 (JIT) 来加速一个重复调用一串函数的“热循环”。优化器考虑一个内联深度 $d$，意即它会沿着调用链将 $d$ 个函数内联到调用者中。在内联区域内有一个单一的有偏条件分支：其“热”路径结果在每次调用时独立发生，概率为 $b \\in (0,1)$，而其“冷”路径结果发生的概率为 $1-b$。JIT 生成的代码会推测热路径结果，并安装一个去优化保护，当推测失败时，该保护会将控制权转移回非推测性基线。\n\n假设以下以时间为单位的成本模型：\n- 每一级内联都会消除调用开销并带来局部优化，每次调用节省 $w$ 单位的时间。因此，当推测成立时，归因于内联深度 $d$ 的每次调用运行时节省为 $w d$。\n- 一次性编译开销随内联深度线性增长，为 $k d$。\n- 当推测首次失败时，去优化会重建执行状态并在基线中恢复执行，产生一次性成本 $L$。去优化之后，不再获得任何推测性收益；执行在基线中继续，没有额外的节省。\n- 各次调用之间的分支结果是独立的。\n\n为了分析的目的，将内联深度 $d$ 视为一个连续决策变量。使用概率论和期望值的基本定义，推导出使预期净节省时间为零的盈亏平衡内联深度 $d^{\\star}$。请用 $b$、$w$、$k$ 和 $L$ 将你的最终答案表示为单个闭式解析表达式。最终表达式无需四舍五入，也无需单位。", "solution": "目标是找到盈亏平衡内联深度，记为 $d^{\\star}$，在该深度下，预期的净节省时间为零。净节省时间是指从成功的推测性执行中节省的总时间减去一次性的编译和去优化成本。\n\n设 $S(d)$ 为给定内联深度 $d$ 的净节省时间。我们希望找到 $d^{\\star}$，使得期望值 $E[S(d^{\\star})] = 0$。\n\n问题的核心在于推测性执行的概率性质。条件分支的热路径被选择的概率为 $b$，冷路径被选择的概率为 $1-b$。JIT 推测热路径将被选择。执行以推测方式进行，直到冷路径第一次被选择，此时发生去优化事件。循环每次调用时的分支结果是独立事件。\n\n设 $I$ 为随机变量，表示第一次推测失败（即第一次选择冷路径）发生在第几次调用。这是一个经典的伯努利试验过程。第 $i$ 次调用时发生失败的事件，需要 $i-1$ 次连续的成功（热路径）和一次失败（冷路径）。这一系列事件的概率是：\n$$P(I=i) = b^{i-1}(1-b) \\quad \\text{for } i \\in \\{1, 2, 3, \\ldots\\}$$\n这为随机变量 $I$ 定义了一个几何分布，其“成功”参数为 $p = 1-b$（这里的“成功”指停止过程的事件，即推测失败）。\n\n如果第一次失败发生在第 $I$ 次调用，那么已经有 $I-1$ 次成功的推测性调用。从这些成功调用中节省的总时间是每次调用的节省量 $wd$ 乘以成功调用的次数 $I-1$。来自推测的总收益 = $(I-1)wd$。\n\n与此推测策略相关的成本是：\n1.  一次性编译开销，是内联深度的函数：$kd$。\n2.  一次性去优化惩罚，在第一次失败时产生：$L$。\n\n因此，作为随机变量 $I$ 和决策变量 $d$ 的函数，净节省时间为：\n$$S(d, I) = (I-1)wd - kd - L$$\n\n为了找到盈亏平衡点，我们需要计算预期的净节省时间 $E[S(d,I)]$。根据期望的线性性质：\n$$E[S(d,I)] = E[(I-1)wd - kd - L] = E[(I-1)wd] - E[kd] - E[L]$$\n由于 $w$、$d$、$k$ 和 $L$ 相对于随机过程（分支结果）是常数，我们可以写出：\n$$E[S(d)] = wd \\cdot E[I-1] - kd - L$$\n\n我们需要计算 $E[I-1]$。参数为 $p=1-b$ 的几何随机变量 $I$ 的期望值为 $E[I] = \\frac{1}{p} = \\frac{1}{1-b}$。第一次失败前成功调用的期望次数是：\n$$E[I-1] = E[I] - 1 = \\frac{1}{1-b} - 1 = \\frac{1 - (1-b)}{1-b} = \\frac{b}{1-b}$$\n\n将此结果代回预期净节省时间的表达式中：\n$$E[S(d)] = wd \\left(\\frac{b}{1-b}\\right) - kd - L$$\n这个表达式表示选择内联深度 $d$ 所带来的预期净收益。正值表示预期的净节省，负值表示预期的净损失。\n\n盈亏平衡内联深度 $d^{\\star}$ 是预期净节省时间恰好为零时的深度：\n$$E[S(d^{\\star})] = 0$$\n$$w d^{\\star} \\left(\\frac{b}{1-b}\\right) - k d^{\\star} - L = 0$$\n\n我们现在可以解这个关于 $d^{\\star}$ 的线性方程。首先，提出因子 $d^{\\star}$：\n$$d^{\\star} \\left(w \\frac{b}{1-b} - k\\right) = L$$\n假设括号中的项不为零，我们可以解出 $d^{\\star}$：\n$$d^{\\star} = \\frac{L}{w \\frac{b}{1-b} - k}$$\n盈亏平衡深度为非负的条件是 $w \\frac{b}{1-b} - k > 0$，这意味着额外一级内联的预期每次调用节省必须超过其编译成本。\n\n为了将表达式简化为单一分数，我们可以为主要分数的分母中的各项找到一个共同的分母：\n$$w \\frac{b}{1-b} - k = \\frac{wb}{1-b} - \\frac{k(1-b)}{1-b} = \\frac{wb - k(1-b)}{1-b}$$\n将此代回 $d^{\\star}$ 的表达式中：\n$$d^{\\star} = \\frac{L}{\\frac{wb - k(1-b)}{1-b}} = \\frac{L(1-b)}{wb - k(1-b)}$$\n这就是盈亏平衡内联深度的最终闭式解析表达式。", "answer": "$$\n\\boxed{\\frac{L(1-b)}{wb - k(1-b)}}\n$$", "id": "3639208"}]}