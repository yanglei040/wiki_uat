{"hands_on_practices": [{"introduction": "追踪 JIT 编译器通过对程序行为做出假设（即“推测”）来提升速度，例如，假设整数加法不会溢出。本练习 ([@problem_id:3623726]) 将让你量化这种权衡：在优化不再划算之前，这种假设可以出错的频率是多少？通过此练习，你将推导出推测性优化的“盈亏平衡点”，这是性能调优中的一个基本概念。", "problem": "一个动态语言运行时在一个紧凑循环中实现 $64$ 位有符号整数的加法，该循环执行许多形式为 $a+b$ 的动态加法。在此比较两种即时 (JIT) 编译策略：\n\n1. 基线即时 (JIT) 编译器，它总是生成一个内联的带溢出检查的加法。当没有溢出发生时，动态加法平均花费 $B_{n}$ 个周期。当发生溢出时，它平均花费 $B_{o}$ 个周期。对于任何给定的动态加法，溢出事件以概率 $\\rho$ 独立发生，其中 $0  \\rho  1$。\n\n2. 追踪式即时 (JIT) 编译器，它推测 $a+b$ 不会溢出，并生成一个由去优化守卫保护的未检查加法。当没有溢出发生时，动态加法平均花费 $T_{n}$ 个周期。当发生溢出时，守卫失败并触发去优化；动态加法平均花费 $T_{o}$ 个周期。对于任何给定的动态加法，溢出事件与上述相同，以概率 $\\rho$ 发生，并且在各个加法之间是独立的。\n\n假设执行处于稳态，没有预热效应，并使用全期望定律为每次动态加法的期望周期数建模。将 $B_{n}$、$B_{o}$、$T_{n}$ 和 $T_{o}$ 视为固定的正常数，它们反映了包括分支预测、流水线行为和慢路径处理在内的微架构效应，且有 $B_{o} > B_{n}$ 和 $T_{o} > T_{n}$。\n\n从期望值的定义出发，不使用任何专门的性能公式，推导出一个闭式解析表达式，用于表示盈亏平衡溢出概率 $\\rho^{*}$。在此概率下，基线 JIT 和追踪式 JIT 的每次动态加法的期望周期数相等。你的最终答案必须是关于 $B_{n}$、$B_{o}$、$T_{n}$ 和 $T_{o}$ 的单个简化解析表达式。不需要进行数值计算。将最终答案表示为不带单位的单个表达式。", "solution": "用户希望我解决一个问题。\n我的计划是首先验证问题陈述。\n如果问题有效，我将提供一个合理的解决方案。\n如果问题无效，我将解释其缺陷并终止。\n\n**问题验证**\n\n**步骤 1：提取已知条件**\n\n*   **系统：** 动态语言运行时在紧凑循环中执行 $64$ 位有符号整数加法 ($a+b$)。\n*   **策略 1：基线 JIT**\n    *   无溢出时的成本：$B_{n}$ 个周期。\n    *   发生溢出时的成本：$B_{o}$ 个周期。\n*   **策略 2：追踪式 JIT**\n    *   无溢出时的成本（推测成功）：$T_{n}$ 个周期。\n    *   发生溢出时的成本（守卫失败，去优化）：$T_{o}$ 个周期。\n*   **事件概率：**\n    *   任何单次加法发生溢出的概率为 $\\rho$。\n    *   $0  \\rho  1$。\n    *   溢出事件是独立的。\n*   **假设与约束：**\n    *   稳态执行，无预热效应。\n    *   期望周期使用全期望定律建模。\n    *   $B_{n}$、$B_{o}$、$T_{n}$ 和 $T_{o}$ 是固定的正常数。\n    *   $B_{o} > B_{n}$。\n    *   $T_{o} > T_{n}$。\n*   **目标：**\n    *   推导盈亏平衡溢出概率 $\\rho^{*}$ 的闭式解析表达式，在该概率下两种 JIT 策略的每次加法期望周期成本相等。\n    *   推导必须从期望值的定义开始。\n    *   $\\rho^{*}$ 的表达式应以 $B_{n}$、$B_{o}$、$T_{n}$ 和 $T_{o}$ 表示。\n\n**步骤 2：使用提取的已知条件进行验证**\n\n根据验证标准对问题进行评估：\n\n1.  **科学依据：** 该问题基于计算机科学中公认的原理，特别是编译器设计和性能分析。即时 (JIT) 编译、推测性优化、去优化以及使用期望值进行性能建模等概念在该领域是标准方法。\n2.  **适定性：** 这是一个适定问题。它清晰地定义了两种情景，提供了所有必要的参数（$B_{n}, B_{o}, T_{n}, T_{o}, \\rho$），说明了它们之间的关系，并要求在精确定义的盈亏平衡条件下求一个特定量（$\\rho^{*}$）。可以从给定信息中推导出唯一解。\n3.  **客观性：** 问题陈述使用精确、客观和定量的语言编写，没有歧义或主观论断。\n4.  **缺陷检查清单：**\n    *   **科学性不健全：** 无。该模型是对真实世界性能权衡的标准且有效的简化。\n    *   **无法形式化：** 该问题明确设计为可以用数学形式化。\n    *   **不完整/矛盾：** 该问题自洽且一致。约束条件 $B_{o} > B_{n}$ 和 $T_{o} > T_{n}$ 具有物理意义，可防止出现平凡或不确定的结果。\n    *   **不现实/不可行：** 该模型是对 JIT 编译器行为的现实抽象。\n    *   **不适定：** 问题结构清晰，有一个唯一的、可解的目标。\n    *   **平凡/同义反复：** 该问题需要多步推导，应用期望值的定义和代数运算，使其成为一个非平凡的练习。\n    *   **无法验证：** 推导出的解析表达式在数学上是可验证的。\n\n**步骤 3：结论与行动**\n\n问题是**有效的**。将推导解决方案。\n\n**解题推导**\n\n目标是找到盈亏平衡溢出概率 $\\rho^{*}$，在该概率下，基线 JIT 和追踪式 JIT 每次动态加法的期望周期数相同。我们将从根据全期望定律定义每种策略的期望成本开始。\n\n设 $C_B$ 为表示由基线 JIT 执行的单次动态加法周期成本的随机变量。每次加法有两个互斥的结果：\n1.  不发生溢出。此情况以概率 $1 - \\rho$ 发生，成本为 $B_{n}$ 个周期。\n2.  发生溢出。此情况以概率 $\\rho$ 发生，成本为 $B_{o}$ 个周期。\n\n根据全期望定律，基线 JIT 的期望成本 $E[C_B]$ 是每个结果的成本与其各自概率加权的和：\n$$E[C_B] = B_{n} \\cdot P(\\text{无溢出}) + B_{o} \\cdot P(\\text{溢出})$$\n$$E[C_B] = B_{n}(1 - \\rho) + B_{o}\\rho$$\n\n类似地，设 $C_T$ 为由追踪式 JIT 执行的加法周期成本的随机变量。两个结果是：\n1.  不发生溢出，且推测成功。此情况以概率 $1 - \\rho$ 发生，成本为 $T_{n}$ 个周期。\n2.  发生溢出，守卫失败，并触发去优化。此情况以概率 $\\rho$ 发生，成本为 $T_{o}$ 个周期。\n\n追踪式 JIT 的期望成本 $E[C_T]$ 是：\n$$E[C_T] = T_{n} \\cdot P(\\text{无溢出}) + T_{o} \\cdot P(\\text{溢出})$$\n$$E[C_T] = T_{n}(1 - \\rho) + T_{o}\\rho$$\n\n盈亏平衡点出现在期望成本相等的概率 $\\rho^{*}$ 处：\n$$E[C_B] = E[C_T]$$\n代入期望值的表达式，我们得到：\n$$B_{n}(1 - \\rho^{*}) + B_{o}\\rho^{*} = T_{n}(1 - \\rho^{*}) + T_{o}\\rho^{*}$$\n\n我们现在求解这个关于 $\\rho^{*}$ 的方程。首先，展开各项：\n$$B_{n} - B_{n}\\rho^{*} + B_{o}\\rho^{*} = T_{n} - T_{n}\\rho^{*} + T_{o}\\rho^{*}$$\n\n接下来，将所有包含 $\\rho^{*}$ 的项移到方程的一边，常数项移到另一边：\n$$B_{o}\\rho^{*} - B_{n}\\rho^{*} + T_{n}\\rho^{*} - T_{o}\\rho^{*} = T_{n} - B_{n}$$\n\n从左边提取公因式 $\\rho^{*}$：\n$$\\rho^{*}(B_{o} - B_{n} + T_{n} - T_{o}) = T_{n} - B_{n}$$\n\n最后，假设分母不为零，通过除以其系数来分离 $\\rho^{*}$：\n$$\\rho^{*} = \\frac{T_{n} - B_{n}}{B_{o} - B_{n} + T_{n} - T_{o}}$$\n\n为了使表达式更易于解释，我们可以重排分母，并同时将分子和分母乘以 $-1$：\n$$\\rho^{*} = \\frac{-(B_{n} - T_{n})}{-(B_{n} - T_{n}) + (T_{o} - B_{o})}$$ \n让我们从因式分解后的形式开始，使用一个更简单的代数操作：\n$$\\rho^{*} = \\frac{T_{n} - B_{n}}{(B_{o} - B_{n}) - (T_{o} - T_{n})}$$\n将分子和分母同乘以 $-1$ 得到：\n$$\\rho^{*} = \\frac{-(T_{n} - B_{n})}{-( (B_{o} - B_{n}) - (T_{o} - T_{n}) )} = \\frac{B_{n} - T_{n}}{(T_{o} - T_{n}) - (B_{o} - B_{n})}$$\n这个最终形式在物理上是直观的。分子 $B_{n} - T_{n}$ 代表了追踪式 JIT 在普遍情况（无溢出）下的性能增益（周期节省）。分母 $(T_{o} - T_{n}) - (B_{o} - B_{n})$ 代表了与基线 JIT 的溢出惩罚相比，追踪式 JIT 在溢出事件期间产生的额外惩罚。因此，盈亏平衡概率是这个快路径增益与额外慢路径成本的比率。", "answer": "$$ \\boxed{\\frac{B_n - T_n}{(T_o - T_n) - (B_o - B_n)}} $$", "id": "3623726"}, {"introduction": "在前一个练习中，我们分析了推测优化的成本效益。现在，我们将这一概念应用于一个在动态语言中更复杂的现实挑战：巨态调用（megamorphic calls）[@problem_id:3623781]。当一个函数被多种不同类型的对象调用时，由于频繁的“守卫”失败，追踪编译可能会变得效率低下，本练习要求你应用期望成本模型，来确定何时应完全避免追踪编译。", "problem": "一个动态语言运行时同时采用了一个基线即时（JIT）编译器和一个追踪JIT编译器。基线编译器在调用点使用多态内联缓存（PIC）来根据接收者的“形状”（隐藏类）进行分派。当观察到的不同接收者形状的数量（记为 $k$）很大时，该调用点是超态的（megamorphic），此时PIC链会变长，从而增加了平均分派成本。追踪JIT会形成一个锚定在调用点的特化追踪，并插入一个检查接收者形状的守卫（guard）；如果守卫失败，执行会退回到基线，产生一次去优化和重返基线的成本。设 $p$ 表示在任何给定调用中，该点的守卫失败的概率，而 $1-p$ 是守卫成功的概率。\n\n假设在 $M$ 次调用的区间内，以下以周期数（cycles）计量的单次调用成本是稳定的：基线PIC分派成本 $c_{P}$（它是 $k$ 的函数，但在此被视为一个测量平均值）、守卫成功时特化追踪的执行成本 $c_{T}$，以及守卫失败时涵盖去优化和重返基线的退回成本 $c_{B}$。追踪JIT当前正在运行此追踪，但频繁退回。有人提出一种启发式方法：当 $P(\\text{guard fail})\\gamma$ 时，将该调用点加入追踪的黑名单。其中阈值 $\\gamma$ 是根据期望成本从第一性原理推导出来的。\n\n请仅使用期望值的核心定义以及PIC和追踪守卫的操作行为，从以下选项中选择正确的启发式方法，并将其应用于以下具体测量值：一个超态调用点，在 $M=1000$ 次调用中观察到 $k=8$ 个形状，$c_{P}=80$，$c_{T}=30$，$c_{B}=200$，以及经验估计值 $\\hat{p}=0.4$。\n\n哪个选项给出了正确的阈值 $\\gamma$ 以及在这些测量值下是否加入黑名单的正确决策？\n\n- A. 设置 $\\gamma=\\dfrac{c_{P}-c_{T}}{c_{B}+c_{P}-c_{T}}$。如果 $p\\gamma$，则加入黑名单。当 $c_{P}=80$, $c_{T}=30$, $c_{B}=200$ 时，$\\gamma=\\dfrac{50}{250}=0.2$，并且由于 $\\hat{p}=0.40.2$，因此将该调用点加入黑名单。\n- B. 设置 $\\gamma=\\dfrac{c_{B}}{c_{P}}$。如果 $p\\gamma$，则加入黑名单。根据给定值，$\\gamma=\\dfrac{200}{80}=2.5$，因此不加入黑名单。\n- C. 设置 $\\gamma=\\dfrac{c_{P}-c_{T}}{c_{P}}$。如果 $p\\gamma$，则加入黑名单。根据给定值，$\\gamma=\\dfrac{80-30}{80}=0.625$，因此不加入黑名单。\n- D. 设置 $\\gamma=\\dfrac{c_{T}}{c_{P}}$。如果 $p\\gamma$，则加入黑名单。根据给定值，$\\gamma=\\dfrac{30}{80}=0.375$，因此将该调用点加入黑名单。\n- E. 只要 $k6$ 就加入黑名单，这与 $p$ 无关，理由是仅超态本身就使得在该调用点进行追踪变得不可靠。", "solution": "用户要求对问题陈述进行细致的验证，然后对所提供的选项进行完整的推导和评估。\n\n### 问题验证\n\n**第1步：提取已知条件**\n- 一个动态语言运行时，包含一个基线即时（JIT）编译器和一个追踪JIT编译器。\n- 基线编译器在调用点使用多态内联缓存（PIC）。\n- $k$：在调用点观察到的不同接收者形状的数量。\n- 当 $k$ 很大时，调用点是超态的（megamorphic）。\n- 追踪JIT创建一个带有接收者形状守卫的特化追踪。\n- $p$：守卫失败的概率。\n- $1-p$：守卫成功的概率。\n- $c_{P}$：单次调用的基线PIC分派成本（一个平均值）。\n- $c_{T}$：守卫成功时，单次调用特化追踪的执行成本。\n- $c_{B}$：守卫失败时，单次调用的退回成本，涵盖去优化和重返基线。\n- $M$：测量区间内的调用次数。\n- 启发式方法：当 $P(\\text{guard fail})  \\gamma$ 时，将该调用点的追踪加入黑名单。阈值 $\\gamma$ 将根据期望成本从第一性原理推导。\n- 具体测量值：\n  - $k=8$ 个形状\n  - $M=1000$ 次调用\n  - $c_{P} = 80$ 周期\n  - $c_{T} = 30$ 周期\n  - $c_{B} = 200$ 周期\n  - $\\hat{p} = 0.4$，$p$ 的一个经验估计值。\n\n**第2步：使用提取的已知条件进行验证**\n- **科学性：** 该问题牢固地植根于编译器设计和动态语言优化的原理之中。基线JIT、追踪JIT、多态内联缓存（PIC）、隐藏类（形状）、守卫、退回（去优化）以及基于期望值的成本效益分析等概念，都是实现高性能虚拟机（例如用于JavaScript、Java、Python）的标准主题。\n- **良构性（Well-Posed）：** 该问题要求基于最小化期望执行成本来推导决策阈值。这是一个明确定义的优化问题。给定成本参数和概率，可以确定一个唯一的阈值。\n- **客观性：** 该问题使用来自计算机科学的精确、标准的术语进行陈述。所有量都已定义，任务是形式化的数学推导和应用，没有主观因素。\n- **完整性和一致性：** 该问题提供了所有必要的变量（$c_P, c_T, c_B, p$）来构建和比较两种执行策略（基线 vs. 追踪）的期望成本。数值是一致的，并且在该领域是合理的（例如，$c_B  c_P  c_T$）。\n- **未检测到其他缺陷：** 该问题不是琐碎的、比喻性的或病态的（ill-posed）。\n\n**第3步：结论与行动**\n问题陈述是有效的。我将继续进行解决方案的推导。\n\n### 解决方案推导\n\n如果使用追踪JIT的期望成本大于使用基线编译器的成本，则应决定将特定调用点的追踪JIT加入黑名单。我们将为每种策略构建期望成本的公式。\n\n**1. 基线策略（PIC）的期望成本**\n在此策略下，每次调用都通过PIC进行分派。每次调用的成本为 $c_{P}$。因此，单次调用的期望成本 $E_{PIC}$ 是一个常数。\n$$E_{PIC} = c_{P}$$\n\n**2. 追踪JIT策略的期望成本**\n在此策略下，该调用点的每次调用会导致两种结果之一：\n- **守卫成功：** 发生概率为 $1-p$。执行将遵循特化追踪，成本为 $c_{T}$。\n- **守卫失败：** 发生概率为 $p$。执行会退回到基线。此路径的成本包括去优化和重返的惩罚 $c_{B}$，再加上实际执行调用工作的成本，这项工作现在必须由基线编译器完成。因此，一次失败调用的总成本是退回惩罚和基线执行成本之和：$c_{B} + c_{P}$。\n\n追踪策略的单次调用期望成本 $E_{Trace}$ 是这两种结果的成本与其各自概率加权的和：\n$$E_{Trace} = p \\cdot (c_{B} + c_{P}) + (1-p) \\cdot c_{T}$$\n\n**3. 黑名单阈值的推导**\n当追踪的期望成本大于使用基线PIC的期望成本时，应将该调用点加入黑名单。\n$$E_{Trace}  E_{PIC}$$\n代入期望成本的表达式：\n$$p \\cdot (c_{B} + c_{P}) + (1-p) \\cdot c_{T}  c_{P}$$\n我们现在对这个不等式求解 $p$。\n$$p \\cdot c_{B} + p \\cdot c_{P} + c_{T} - p \\cdot c_{T}  c_{P}$$\n将含有 $p$ 的项归类：\n$$p \\cdot (c_{B} + c_{P} - c_{T})  c_{P} - c_{T}$$\n为了分离出 $p$，我们除以 $(c_{B} + c_{P} - c_{T})$。我们必须检查这一项是否为正，以确保不等号方向不变。使用给定值：$200 + 80 - 30 = 250  0$。因此，加入黑名单的条件是：\n$$p  \\frac{c_{P} - c_{T}}{c_{B} + c_{P} - c_{T}}$$\n问题将 $\\gamma$ 定义为 $p$ 的阈值，当 $p$ 高于此阈值时，我们将其加入黑名单。因此，\n$$\\gamma = \\frac{c_{P} - c_{T}}{c_{B} + c_{P} - c_T}$$\n\n**4. 应用于具体测量值**\n我们已知：$c_{P}=80$，$c_{T}=30$，$c_{B}=200$，以及失败的经验概率 $\\hat{p}=0.4$。\n\n首先，计算阈值 $\\gamma$：\n$$\\gamma = \\frac{80 - 30}{200 + 80 - 30} = \\frac{50}{250} = \\frac{1}{5} = 0.2$$\n接下来，应用启发式方法：如果 $p  \\gamma$，则加入黑名单。我们使用经验估计值 $\\hat{p}$ 代替 $p$。\n我们比较 $\\hat{p}$ 和 $\\gamma$：\n$$0.4  0.2$$\n条件满足。因此，决策是将该调用点加入黑名单。\n\n### 逐项分析选项\n\n- **A. 设置 $\\gamma=\\dfrac{c_{P}-c_{T}}{c_{B}+c_{P}-c_{T}}$。如果 $p\\gamma$，则加入黑名单。当 $c_{P}=80$, $c_{T}=30$, $c_{B}=200$ 时，$\\gamma=\\dfrac{50}{250}=0.2$，并且由于 $\\hat{p}=0.40.2$，因此将该调用点加入黑名单。**\n  - $\\gamma$ 的公式与我们的推导完全匹配。\n  - 数值计算 $\\gamma=0.2$ 是正确的。\n  - 比较 $\\hat{p}=0.4  0.2$ 是正确的，以及将该调用点加入黑名单的结论也是正确的。\n  - **结论：正确**\n\n- **B. 设置 $\\gamma=\\dfrac{c_{B}}{c_{P}}$。如果 $p\\gamma$，则加入黑名单。根据给定值，$\\gamma=\\dfrac{200}{80}=2.5$，因此不加入黑名单。**\n  - $\\gamma$ 的公式不正确。它不是从期望成本模型推导出来的，因为它完全忽略了特化追踪的成本 $c_{T}$。\n  - **结论：不正确**\n\n- **C. 设置 $\\gamma=\\dfrac{c_{P}-c_{T}}{c_{P}}$。如果 $p\\gamma$，则加入黑名单。根据给定值，$\\gamma=\\dfrac{80-30}{80}=0.625$，因此不加入黑名单。**\n  - $\\gamma$ 的公式不正确。它表示追踪相对于基线的性能增益，但未能将退回的高昂成本 $c_{B}$ 正确地纳入阈值计算中。\n  - **结论：不正确**\n\n- **D. 设置 $\\gamma=\\dfrac{c_{T}}{c_{P}}$。如果 $p\\gamma$，则加入黑名单。根据给定值，$\\gamma=\\dfrac{30}{80}=0.375$，因此将该调用点加入黑名单。**\n  - $\\gamma$ 的公式不正确。它表示加速比，但与选项B一样，它没有考虑到关键的退回成本 $c_{B}$。\n  - **结论：不正确**\n\n- **E. 只要 $k6$ 就加入黑名单，这与 $p$ 无关，理由是仅超态本身就使得在该调用点进行追踪变得不可可靠。**\n  - 此选项提出了一种不同类型的启发式方法，是一种静态方法，仅依赖于多态程度 $k$。问题陈述明确要求基于包含 $c_{P}$、$c_{T}$ 和 $c_{B}$ 的期望成本模型，推导 $p$ 的概率阈值 $\\gamma$。此选项与问题核心要求（基于成本的概率阈值）相矛盾。\n  - **结论：不正确**", "answer": "$$\\boxed{A}$$", "id": "3623781"}, {"introduction": "我们已经探讨了何时进行追踪的宏观决策，现在让我们深入微观层面，探究追踪编译性能优势的根源。本练习 ([@problem_id:3623717]) 将通过分析一种常见的值表示技术——NaN-boxing，来量化追踪 JIT 如何通过消除基线 JIT 必须执行的重复性底层操作，从而获得显著的速度提升。", "problem": "一个动态语言运行时在 $64$ 位架构上使用“非数值”（NaN）装箱技术，将所有值表示在单个机器字中。在此方案中，整数存储在机器字的低 $32$ 位，并使用高位的静默 NaN 模式进行标记。掩码操作定义为单个按位掩码应用，在算术运算前后选择一个字的低 $32$ 位，通过与一个常量掩码进行一次逻辑运算来实现。一个基线即时（JIT）编译器为两个动态类型值的加法生成通用代码，过程如下：对每个操作数执行一次掩码操作以提取整数有效载荷，执行整数加法，然后应用一次掩码操作以确保结果在重新标记前被截断为 $32$ 位。因此，当两个操作数都是整数时，基线 JIT 每次动态加法恰好执行 $3$ 次掩码操作。\n\n一个跟踪 JIT 记录一个热循环，并沿着一条轨迹将其特化为整数运算。在轨迹内部，值保持未装箱状态，内部算术运算不执行任何掩码操作。然而，在轨迹边界处，跟踪 JIT 必须应用掩码，在入口处将值从已装箱转换成未装箱，在出口处将值从未装箱转换成已装箱。假设循环每次迭代有 $n$ 次算术加法，并且每次进入和退出轨迹时，有 $v$ 个活跃的整数值跨越轨迹边界，这导致在入口处产生 $v$ 次掩码操作，在出口处也产生 $v$ 次掩码操作。假设轨迹执行的迭代次数服从一个独立的几何分布，其参数为 $s$（每次迭代因守卫失败而退出轨迹的概率），然后重新进入；即，在稳态下，每次迭代都以概率 $s$ 独立地结束当前轨迹的运行。\n\n给定以下具体参数：$n = 30$，$v = 3$，$s = 0.05$，请从第一性原理出发，推导在使用特化整数轨迹（而非基线 JIT）时，在许多循环迭代的稳态下，每次算术加法平均消除的掩码操作的期望数量。将你的答案四舍五入到四位有效数字。", "solution": "该问题要求我们计算，当对一个热循环使用特化的跟踪即时（JIT）编译器时，与基线 JIT 相比，每次算术加法所消除的掩码操作的期望数量。该比较应在稳态下进行。\n\n设 $C_{base}$ 为基线 JIT 每次加法所需的掩码操作次数。根据题目描述，有 $C_{base} = 3$。\n设 $n$ 为每次循环迭代的算术加法次数，给定值为 $n = 30$。\n设 $v$ 为跨越轨迹边界的活跃整数值的数量，给定值为 $v = 3$。\n设 $s$ 为每次迭代退出轨迹的概率，给定值为 $s = 0.05$。\n\n需要确定的量是稳态下每次加法消除的掩码操作的期望数量。计算这个值的最佳方法是，在一个具有代表性的系统执行周期内，用消除的掩码总期望数量除以执行的加法总期望数量。一个自然的周期是轨迹从进入到退出的一次完整运行。\n\n设 $K$ 为单次轨迹运行所执行的迭代次数的随机变量。题目说明，每次迭代都以概率 $s$ 独立地结束轨迹运行。这描述了一个几何分布。执行恰好 $k$ 次迭代的概率，等于成功完成 $k-1$ 次迭代（每次概率为 $1-s$）然后在第 $k$ 次迭代时未能继续（概率为 $s$）的概率。\n因此，$K$ 的概率质量函数为：\n$$ P(K=k) = (1-s)^{k-1}s, \\quad \\text{for } k \\in \\{1, 2, 3, \\dots\\} $$\n这是一个标准的几何分布。$K$ 的期望值推导如下：\n$$ E[K] = \\sum_{k=1}^{\\infty} k P(K=k) = \\sum_{k=1}^{\\infty} k (1-s)^{k-1}s $$\n将 $s$ 提取出来，并使用已知的等差等比级数求和公式 $\\sum_{k=1}^{\\infty} k x^{k-1} = \\frac{1}{(1-x)^2}$，其中 $x = 1-s$：\n$$ E[K] = s \\sum_{k=1}^{\\infty} k (1-s)^{k-1} = s \\left( \\frac{1}{(1-(1-s))^2} \\right) = s \\left( \\frac{1}{s^2} \\right) = \\frac{1}{s} $$\n每次轨迹运行的期望迭代次数为 $E[K] = \\frac{1}{s}$。\n\n现在，我们计算一个完整轨迹周期内的期望加法次数和期望掩码操作次数。\n\n1.  **每个周期的期望加法次数 ($E[A]$):**\n    每次迭代执行 $n$ 次加法。一次包含 $K$ 次迭代的轨迹运行执行 $nK$ 次加法。期望加法次数为：\n    $$ E[A] = E[nK] = n E[K] = \\frac{n}{s} $$\n\n2.  **基线 JIT 每个周期的期望掩码操作次数 ($E[M_{base}]$):**\n    基线 JIT 每次加法执行 $3$ 次掩码操作。对于一次迭代中的 $n$ 次加法，它执行 $3n$ 次掩码操作。在一次包含 $K$ 次迭代的轨迹运行中，总掩码操作次数将为 $3nK$。期望掩码操作次数为：\n    $$ E[M_{base}] = E[3nK] = 3n E[K] = \\frac{3n}{s} $$\n\n3.  **跟踪 JIT 每个周期的期望掩码操作次数 ($E[M_{trace}]$):**\n    跟踪 JIT 在每次轨迹运行时产生的掩码操作次数是固定的，与其长度 $K$ 无关。入口处有 $v$ 次掩码操作，出口处有 $v$ 次掩码操作。轨迹内部的算术运算不使用掩码。任何一次轨迹运行的总掩码操作次数是恒定的：\n    $$ M_{trace} = v + v = 2v $$\n    因此，期望掩码操作次数为：\n    $$ E[M_{trace}] = E[2v] = 2v $$\n\n每个周期消除的期望掩码操作次数是基线 JIT 和跟踪 JIT 成本之间的差值：\n$$ E[M_{elim}] = E[M_{base}] - E[M_{trace}] = \\frac{3n}{s} - 2v $$\n\n最终的度量指标是每次算术加法消除的期望掩码操作次数。这是在一个周期内消除的总期望掩码次数与执行的总期望加法次数之比：\n$$ E_{elim/add} = \\frac{E[M_{elim}]}{E[A]} = \\frac{\\frac{3n}{s} - 2v}{\\frac{n}{s}} $$\n化简这个表达式：\n$$ E_{elim/add} = \\left(\\frac{3n}{s} - 2v\\right) \\frac{s}{n} = \\frac{3n}{s} \\frac{s}{n} - 2v \\frac{s}{n} = 3 - \\frac{2vs}{n} $$\n这就是从第一性原理推导出的公式。\n\n现在，我们代入给定的数值：$n = 30$，$v = 3$ 和 $s = 0.05$。\n$$ E_{elim/add} = 3 - \\frac{2 \\times 3 \\times 0.05}{30} $$\n$$ E_{elim/add} = 3 - \\frac{6 \\times 0.05}{30} $$\n$$ E_{elim/add} = 3 - \\frac{0.3}{30} $$\n$$ E_{elim/add} = 3 - 0.01 $$\n$$ E_{elim/add} = 2.99 $$\n题目要求答案四舍五入到四位有效数字。值 $2.99$ 有三位有效数字。为了用四位有效数字表示它，我们追加一个零。\n$$ E_{elim/add} \\approx 2.990 $$\n这表示在使用跟踪 JIT（而非基线 JIT）时，在热循环内执行的每次加法平均节省的掩码操作次数。", "answer": "$$\\boxed{2.990}$$", "id": "3623717"}]}