{"hands_on_practices": [{"introduction": "在决定是溢出还是重物质化一个值时，编译器必须进行成本效益分析。第一个练习将指导你推导决定这一权衡的基本阈值[@problem_id:3668340]。通过比较溢出的总成本和重新计算的总成本，你将确定一个“盈亏平衡点”，即重物质化的单位成本低于该点时，重物质化成为更优选择。", "problem": "执行寄存器分配 (RA) 的编译器必须决定，对于一个其活跃范围不能完全分配给寄存器的值，是将其溢出到内存并在每次使用时重新加载，还是在每次使用时通过从其操作数重新计算来再物质化该值。考虑一个成本模型，其中所有动态成本在独立事件上线性相加，并以每次执行的机器周期为单位进行度量。令 $C_{\\text{spill}}$ 表示如果该值被溢出，其在整个活跃范围内的总动态成本，包括任何一次性存储和所有重新加载。令 $C_{\\text{rm}}$ 表示再物质化该值的每次使用的动态成本（例如，重新生成一个立即数并应用一个简单算术运算的成本）。令 $U$ 表示该值在程序执行剖面中的动态使用计数，定义为所有静态使用点的执行计数之和。\n\n仅从这些定义和独立成本线性可加的假设出发，推导一个用 $C_{\\text{spill}}$ 和 $U$ 表示的阈值表达式 $C_{\\text{rm}}^{*}$，使得当且仅当 $C_{\\text{rm}}$ 低于此阈值时，选择再物质化能最小化总动态成本。用 $C_{\\text{rm}}$ 和 $C_{\\text{rm}}^{*}$ 陈述决策准则。\n\n然后用下面的计算示例验证该表达式。一个值 $v$ 有三个静态使用点：一个在执行 $10$ 次的基本块 $B_{1}$ 中，一个在执行 $2$ 次的 $B_{2}$ 中，一个在执行 $2$ 次的 $B_{3}$ 中，因此动态使用计数是这些使用点的执行次数之和。如果溢出，$v$ 会产生一次性存储成本 $c_{s} = 12$ 个周期和每次动态使用 $c_{\\ell} = 6$ 个周期的重新加载成本，所以总溢出成本是一次性存储成本加上所有动态使用的重新加载成本之和。如果再物质化，$v$ 可以在每次使用时通过加载一个立即数并执行一次算术运算来重新计算，其成本分别为 $c_{\\text{imm}} = 2$ 个周期和 $c_{\\text{op}} = 1$ 个周期，因此每次使用的再物质化成本是这些操作成本之和。\n\n计算：\n1. 阈值 $C_{\\text{rm}}^{*}$。\n2. 决策指示器 $D$，如果选择再物质化，则 $D = 1$，否则 $D = 0$。\n\n将数值阈值以每次使用的机器周期表示，决策指示器表示为无量纲值。将你的最终答案报告为行矩阵 $\\begin{pmatrix} C_{\\text{rm}}^{*}  D \\end{pmatrix}$。", "solution": "该问题要求推导一个决策准则，用于在一个值因其整个活跃范围无法保存在寄存器中时，在两种编译器优化策略之间进行选择：溢出到内存或再物质化。该决策应基于最小化以机器周期为单位的总动态成本。\n\n首先，我们根据所提供的定义，为每种策略建立总动态成本。令 $C_{\\text{total, spill}}$ 为溢出策略的总成本， $C_{\\text{total, rm}}$ 为再物质化策略的总成本。\n\n问题将 $C_{\\text{spill}}$ 定义为溢出策略的总动态成本，包括一次性存储和所有后续的重新加载。因此，我们有：\n$$C_{\\text{total, spill}} = C_{\\text{spill}}$$\n\n问题将 $C_{\\text{rm}}$ 定义为再物质化该值的每次使用的动态成本。该值的动态使用总次数由 $U$ 给出。问题指出成本在独立事件上线性相加。由于再物质化在 $U$ 次动态使用中的每一次都执行，因此该策略的总成本是每次使用的成本乘以使用次数：\n$$C_{\\text{total, rm}} = C_{\\text{rm}} \\times U$$\n\n为了最小化总动态成本，编译器当且仅当再物质化的总成本严格小于溢出的总成本时，才应选择再物质化。这给了我们以下不等式：\n$$C_{\\text{total, rm}}  C_{\\text{total, spill}}$$\n代入总成本的表达式，我们得到：\n$$C_{\\text{rm}} \\times U  C_{\\text{spill}}$$\n\n问题要求一个阈值 $C_{\\text{rm}}^{*}$，使得当且仅当 $C_{\\text{rm}}  C_{\\text{rm}}^{*}$ 时，再物质化是最佳选择。为了推导这个阈值，我们在不等式中分离出 $C_{\\text{rm}}$。假设该值至少被使用一次，动态使用计数 $U$ 是一个正整数（$U \\ge 1$）。因此，我们可以在不等式两边同时除以 $U$ 而不改变其方向：\n$$C_{\\text{rm}}  \\frac{C_{\\text{spill}}}{U}$$\n通过将此不等式与所需形式 $C_{\\text{rm}}  C_{\\text{rm}}^{*}$ 进行比较，我们可以直接确定阈值 $C_{\\text{rm}}^{*}$：\n$$C_{\\text{rm}}^{*} = \\frac{C_{\\text{spill}}}{U}$$\n决策准则是：如果 $C_{\\text{rm}}  C_{\\text{rm}}^{*}$，选择再物质化；否则，选择溢出。\n\n接下来，我们将此形式化推导应用于计算示例，以计算 $C_{\\text{rm}}^{*}$ 和决策指示器 $D$ 的数值。\n\n1.  **计算动态使用计数, $U$**。\n    $U$ 是所有静态使用点的执行计数之和。\n    $$U = 10 + 2 + 2 = 14$$\n\n2.  **计算总溢出成本, $C_{\\text{spill}}$**。\n    该成本包括一次性存储成本 $c_{s} = 12$ 个周期，以及每次动态使用时产生的重新加载成本 $c_{\\ell} = 6$ 个周期。\n    $$C_{\\text{spill}} = c_{s} + (c_{\\ell} \\times U) = 12 + (6 \\times 14) = 12 + 84 = 96$$\n    总溢出成本为 $96$ 个周期。\n\n3.  **计算每次使用的再物质化成本, $C_{\\text{rm}}$**。\n    该成本是加载一个立即数的成本 $c_{\\text{imm}} = 2$ 个周期和一次算术运算的成本 $c_{\\text{op}} = 1$ 个周期之和。\n    $$C_{\\text{rm}} = c_{\\text{imm}} + c_{\\text{op}} = 2 + 1 = 3$$\n    每次使用的再物质化成本为每个使用 $3$ 个周期。\n\n4.  **计算阈值, $C_{\\text{rm}}^{*}$**。\n    使用推导出的公式以及计算出的 $C_{\\text{spill}}$ 和 $U$ 的值：\n    $$C_{\\text{rm}}^{*} = \\frac{C_{\\text{spill}}}{U} = \\frac{96}{14} = \\frac{48}{7}$$\n    阈值为每个使用 $\\frac{48}{7}$ 个机器周期。\n\n5.  **确定决策指示器, $D$**。\n    我们通过将实际的每次使用成本 $C_{\\text{rm}}$ 与阈值 $C_{\\text{rm}}^{*}$ 进行比较来应用决策准则：\n    $$C_{\\text{rm}} = 3$$\n    $$C_{\\text{rm}}^{*} = \\frac{48}{7} \\approx 6.857$$\n    需要检查的不等式是 $C_{\\text{rm}}  C_{\\text{rm}}^{*}$，即 $3  \\frac{48}{7}$。两边同时乘以 $7$ 得到 $21  48$，这是成立的。\n    由于条件满足，再物质化是成本最小化的策略。问题定义决策指示器 $D$ 在选择再物质化时为 $1$。因此：\n    $$D = 1$$", "answer": "$$\\boxed{\\begin{pmatrix} \\frac{48}{7}  1 \\end{pmatrix}}$$", "id": "3668340"}, {"introduction": "真实的程序包含循环和分支，导致代码的不同部分执行频率不同。为了做出更精确的决策，编译器不能简单地计算总使用次数，而必须考虑程序结构[@problem_id:3668302]。这个练习引入了一个更复杂的成本模型，该模型使用基本块的执行频率来加权计算动态成本，从而让你能够处理更真实的优化场景。", "problem": "考虑一个编译器在执行寄存器分配时，可以选择将变量溢出或在其使用处进行重物质化。假设一个程序由基本块 $B_i$ 表示，其估计的动态执行频率为 $f(B_i)$。对于变量 $v$，定义频率加权溢出成本为 $C_{\\text{spill}}(v) = \\sum_i f(B_i)\\cdot c_i$，其中 $c_i$ 是由基本块 $B_i$ 中的溢出代码（存储和重载指令）贡献的单次执行总成本。类似地，定义频率加权重物质化成本为 $C_{\\text{rm}}(v) = \\sum_j f(B_j)\\cdot r_j$，其中 $r_j$ 是由在基本块 $B_j$ 的使用处重新计算 $v$ 所贡献的单次执行总成本。仅使用优化器应最小化预期动态成本（各基本块成本的频率加权和）这一基本原则，推导出一个决策规则，以确定何时应为变量 $v$ 选择重物质化而非溢出。\n\n然后，在以下简易控制流图上测试该决策：\n- 有两个基本块：一个循环体 $B_0$，其频率 $f(B_0)=100$；以及一个前置头/退出块 $B_1$，其频率 $f(B_1)=1$。\n- 变量 $v$ 在 $B_1$ 中定义一次，在 $B_0$ 的每次迭代中使用两次，并在循环后失效。\n- 如果 $v$ 溢出，编译器会在其定义处插入一条存储指令，并在 $B_0$ 的每次使用前插入一条重载指令。单次操作成本为：存储成本 $s=5$，重载成本 $\\ell=8$。\n- 如果 $v$ 被重物质化，则在 $B_0$ 中的每次使用都会以成本 $r=3$ 重新计算，并且在其定义处不插入存储指令。\n\n使用频率加权成本模型和你的决策规则，计算该程序的标量值 $S = C_{\\text{spill}}(v) - C_{\\text{rm}}(v)$。将 $S$ 报告为单个整数（无需四舍五入）。", "solution": "该问题要求完成两个主要任务：首先，基于成本最小化原则，推导出一个在溢出和重物质化之间进行选择的决策规则；其次，通过计算成本差异，将此规则应用于一个具体示例。\n\n首先，我们推导决策规则。问题指出，优化器的基本原则是最小化预期动态成本。变量 $v$ 溢出和重物质化的预期动态成本分别由 $C_{\\text{spill}}(v)$ 和 $C_{\\text{rm}}(v)$ 给出。它们被定义为各基本块成本的频率加权和：\n$$C_{\\text{spill}}(v) = \\sum_i f(B_i)\\cdot c_i$$\n$$C_{\\text{rm}}(v) = \\sum_j f(B_j)\\cdot r_j$$\n其中 $f(B_i)$ 是基本块 $B_i$ 的执行频率，而 $c_i$ 和 $r_j$ 是一个块内溢出和重物质化代码的单次执行成本。\n\n为了最小化总成本，优化器必须比较这两种备选方案的成本。如果重物质化的总成本低于溢出的总成本，则重物质化是首选方案。因此，决策规则是当且仅当以下条件成立时，为变量 $v$ 选择重物质化：\n$$C_{\\text{rm}}(v)  C_{\\text{spill}}(v)$$\n\n接下来，我们将此成本模型应用于所提供的控制流图。该程序包含两个基本块：一个循环体 $B_0$ 和一个前置头/退出块 $B_1$。它们的动态执行频率为 $f(B_0) = 100$ 和 $f(B_1) = 1$。变量 $v$ 在 $B_1$ 中定义一次，在 $B_0$ 中使用两次。\n\n我们现在将计算这个特定情况下的成本 $C_{\\text{spill}}(v)$ 和 $C_{\\text{rm}}(v)$。\n\n计算溢出成本 $C_{\\text{spill}}(v)$：\n如果 $v$ 溢出，则在其定义处（基本块 $B_1$ 中）插入一条存储指令，并在其两次使用前（基本块 $B_0$ 中）各插入一条重载指令。\n单次操作成本为：存储成本 $s = 5$，重载成本 $\\ell = 8$。\n\n在基本块 $B_1$ 中与溢出相关的单次执行成本（记为 $c_1$）是单条存储指令的成本。因此，$c_1 = s = 5$。\n在基本块 $B_0$ 中与溢出相关的单次执行成本（记为 $c_0$）是两条重载指令的成本。因此，$c_0 = 2 \\cdot \\ell = 2 \\cdot 8 = 16$。\n\n总的频率加权溢出成本是各基本块成本之和：\n$$C_{\\text{spill}}(v) = f(B_0) \\cdot c_0 + f(B_1) \\cdot c_1$$\n代入给定值：\n$$C_{\\text{spill}}(v) = 100 \\cdot 16 + 1 \\cdot 5 = 1600 + 5 = 1605$$\n\n计算重物质化成本 $C_{\\text{rm}}(v)$：\n如果 $v$ 被重物质化，则其值在基本块 $B_0$ 的每次使用时都会被重新计算。在基本块 $B_1$ 的定义处不需要存储指令。每次重新计算的成本为 $r = 3$。\n\n在基本块 $B_1$ 中的单次执行重物质化成本（记为 $r_1$）为零，因为在 $B_1$ 中没有对 $v$ 的使用，也未插入存储指令。因此，$r_1 = 0$。\n在基本块 $B_0$ 中的单次执行重物质化成本（记为 $r_0$）是在其两次使用处重新计算 $v$ 的成本。因此，$r_0 = 2 \\cdot r = 2 \\cdot 3 = 6$。\n\n总的频率加权重物质化成本是各基本块成本之和：\n$$C_{\\text{rm}}(v) = f(B_0) \\cdot r_0 + f(B_1) \\cdot r_1$$\n代入值：\n$$C_{\\text{rm}}(v) = 100 \\cdot 6 + 1 \\cdot 0 = 600 + 0 = 600$$\n\n最后，问题要求计算标量值 $S$，其定义为两种成本之差：\n$$S = C_{\\text{spill}}(v) - C_{\\text{rm}}(v)$$\n使用我们计算出的值：\n$$S = 1605 - 600 = 1005$$\n由于 $S > 0$，我们有 $C_{\\text{spill}}(v) > C_{\\text{rm}}(v)$，我们推导的决策规则会正确地为这种情况选择重物质化，因为它能带来更低的预期动态成本。计算出的 $S$ 值为 $1005$。", "answer": "$$\\boxed{1005}$$", "id": "3668302"}, {"introduction": "编译器的决策并非在真空中做出，它们受到目标硬件的严格限制。这个练习探讨了指令集体系结构（ISA）的一个具体细节——立即数的操作数宽度——如何影响重物质化的成本[@problem_id:3668304]。你会发现，当一个常量值无法被单条指令编码时，重物质化的成本会发生变化，这直接影响了最终的优化决策。", "problem": "针对一个给定的指令集架构（ISA）的编译器，必须决定是否在其每个使用点重新物化值 $y = x + 4096$，而不是进行溢出和重载。该ISA提供了一条加立即数指令，该指令接受一个宽度为 $w$ 位的有符号立即数。如果常量 $4096$ 无法容纳在 $w$ 位的有符号立即数字段中，编译器将使用一个规范的双指令序列在使用点重新物化 $y$。假设采用以下成本模型：每条动态指令产生 $c_{\\text{exec}}$ 周期的执行成本，每条静态指令产生一个代码大小惩罚，权重为每字节 $k$ 周期，每条指令的大小为 $b$ 字节。如果 $y$ 有 $U$ 次动态使用，则将总重新物化成本定义为\n$$\nC_{\\text{rm}}(w) = U \\cdot n(w) \\cdot \\big(c_{\\text{exec}} + k \\cdot b\\big),\n$$\n其中 $n(w)$ 是在立即数宽度为 $w$ 的情况下，在某个使用点进行重新物化所需的指令数。\n\n从核心定义出发，推导单条加立即数指令足以编码 $x + 4096$ 时 $w$ 需满足的条件，以及需要双指令序列时的互补条件。然后，对于具体参数值 $U = 750$，$c_{\\text{exec}} = 1$，$k = 0.01$ 和 $b = 4$，计算增量惩罚\n$$\n\\Delta C = C_{\\text{rm}}(13) - C_{\\text{rm}}(14),\n$$\n以周期为单位表示。提供您的最终数值答案。无需四舍五入。", "solution": "问题的核心在于确定对于给定的 $w$ 位有符号立即数字段宽度，物化常量 $4096$ 所需的指令数 $n(w)$。如果常量可以由 $w$ 位的有符号立即数字段表示，则可以使用单条加立即数指令。\n\n一个 $w$ 位的有符号整数，通常以二进制补码格式表示，可以编码的数值范围为 $[ -2^{w-1}, 2^{w-1} - 1 ]$。\n需要物化的值是 $y = x + 4096$。这要求将常量 $4096$ 编码为立即数操作数。\n\n当且仅当常量 $4096$ 位于 $w$ 位有符号立即数的可表示范围内时，单条指令才足够。由于 $4096$ 是一个正数，此条件简化为：\n$$\n4096 \\le 2^{w-1} - 1\n$$\n如果此不等式成立，则 $n(w) = 1$。如果不成立，则常量过大，根据问题陈述，将使用一个规范的双指令序列，因此 $n(w) = 2$。\n\n因此，我们可以将 $n(w)$ 定义为一个分段函数：\n$$\nn(w) =\n\\begin{cases}\n1  \\text{若 } 4096 \\le 2^{w-1} - 1 \\\\\n2  \\text{若 } 4096 > 2^{w-1} - 1\n\\end{cases}\n$$\n\n我们现在必须为 $w=13$ 和 $w=14$ 的具体情况计算 $n(w)$。\n\n对于 $w=13$：\n最大可表示的有符号值为 $2^{13-1} - 1 = 2^{12} - 1 = 4096 - 1 = 4095$。\n我们检验条件：$4096 \\le 4095$。此为假。\n因此，对于 $w=13$ 位的立即数宽度，需要两条指令。\n$$\nn(13) = 2\n$$\n\n对于 $w=14$：\n最大可表示的有符号值为 $2^{14-1} - 1 = 2^{13} - 1 = 8192 - 1 = 8191$。\n我们检验条件：$4096 \\le 8191$。此为真。\n因此，对于 $w=14$ 位的立即数宽度，单条指令就足够了。\n$$\nn(14) = 1\n$$\n\n问题要求计算增量惩罚 $\\Delta C = C_{\\text{rm}}(13) - C_{\\text{rm}}(14)$。总重新物化成本由以下公式给出：\n$$\nC_{\\text{rm}}(w) = U \\cdot n(w) \\cdot (c_{\\text{exec}} + k \\cdot b)\n$$\n给定的参数值为 $U = 750$，$c_{\\text{exec}} = 1$，$k = 0.01$ 和 $b = 4$。\n\n首先，我们计算每条指令的成本因子，这在两个计算中是共同的：\n$$\nc_{\\text{exec}} + k \\cdot b = 1 + (0.01) \\cdot 4 = 1 + 0.04 = 1.04\n$$\n该因子表示单条指令的执行成本和代码大小成本的总和，以周期为单位。\n\n现在我们可以计算 $w=13$ 和 $w=14$ 时的成本。\n$$\nC_{\\text{rm}}(13) = U \\cdot n(13) \\cdot (c_{\\text{exec}} + k \\cdot b) = 750 \\cdot 2 \\cdot (1.04)\n$$\n$$\nC_{\\text{rm}}(14) = U \\cdot n(14) \\cdot (c_{\\text{exec}} + k \\cdot b) = 750 \\cdot 1 \\cdot (1.04)\n$$\n\n最后，我们计算增量惩罚 $\\Delta C$：\n$$\n\\Delta C = C_{\\text{rm}}(13) - C_{\\text{rm}}(14)\n$$\n$$\n\\Delta C = (750 \\cdot 2 \\cdot 1.04) - (750 \\cdot 1 \\cdot 1.04)\n$$\n我们可以提取公因式：\n$$\n\\Delta C = 750 \\cdot 1.04 \\cdot (2 - 1)\n$$\n$$\n\\Delta C = 750 \\cdot 1.04 \\cdot 1\n$$\n$$\n\\Delta C = 750 \\cdot (1 + 0.04) = 750 \\cdot 1 + 750 \\cdot 0.04\n$$\n$$\n\\Delta C = 750 + 30\n$$\n$$\n\\Delta C = 780\n$$\n增量惩罚为 $780$ 周期。该值表示在此特定重新物化场景中，拥有一个 14 位宽的立即数字段相比于一个 13 位宽的字段所节省的总成本（以周期为单位）。", "answer": "$$\\boxed{780}$$", "id": "3668304"}]}