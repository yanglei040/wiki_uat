{"hands_on_practices": [{"introduction": "本练习将副本合并的抽象概念与线性扫描寄存器分配中使用的实时区间具体模型联系起来。我们将探讨副本合并如何通过合并区间来增加寄存器压力，并推导出一个精确的条件来判断何时会引发问题。这个练习有助于将副本合并对资源约束的直接影响进行可视化。[@problem_id:3671345]", "problem": "考虑一个处于静态单赋值（SSA）形式的单一基本块，其中每个 SSA 名字 $v$ 都有一个生存期区间，表示为线性指令序列上的一个半开区间 $[s_v,e_v)$。在线性扫描寄存器分配中，基本约束是在每个程序点 $t$，同时生存的 SSA 名字的数量不得超过可用寄存器 $k$ 的数量。一个副本合并遍（pass）试图通过合并两个副本相关的 SSA 名字来消除副本。在区间模型中，这种对两个不重叠的生存期区间的合并，通过用它们的并集替换这两个区间来表示，在线性序列上，该并集等于连接它们端点的凸包区间。\n\n从上述核心定义出发，提出一个从副本合并到区间合并的精确映射，并仅使用线性扫描约束，推导出一个充要条件（用块中基准的逐点生存数和 $k$ 来表示），该条件能准确刻画何时一组这样的区间合并会违反线性扫描分配器的可行性假设。\n\n然后，将您的条件应用于以下具体实例。该基本块的指令索引沿实数线分布，SSA 名字的基准生存期区间如下：\n- $x_1: [1,3)$，\n- $x_2: [2,5)$，\n- $x_3: [4,7)$，\n- $x_4: [6,9)$，\n- $x_5: [8,11)$，\n- $x_6: [10,13)$，\n- $y_1: [3,10)$。\n\n假设有 $k = 3$ 个寄存器。唯一符合合并条件的候选副本相关对是：\n- $(x_1,x_3)$，\n- $(x_2,x_4)$，\n- $(x_3,x_5)$，\n- $(x_4,x_6)$，\n- $(x_1,x_4)$，\n- $(x_2,x_5)$。\n\n所列出的每一对都有不重叠的生存期区间。将每次合并处理为用两个区间的凸包区间替换它们，从而使该名字在整个凸包内都处于生存状态。使用您推导出的条件，确定在不违反 $k=3$ 个寄存器的线性扫描可行性的前提下，可以同时合并的上述列表中的候选对的最大数量。只陈述这个最大数量作为您的最终答案。无需四舍五入。", "solution": "问题要求两大部分：首先，推导出一个通用条件，用于判断一组副本合并何时会违反线性扫描寄存器分配的可行性约束；其次，将此条件应用于一个具体实例，以找到有效的同步合并的最大数量。\n\n### 第一部分：通用条件的推导\n\n设 $V$ 是一个基本块中的静态单赋值（SSA）名字的集合。每个 SSA 名字 $v \\in V$ 都有一个生存期区间 $[s_v, e_v)$。可用物理寄存器的数量为 $k$。\n\n线性扫描寄存器分配的基本约束是，在任何程序点 $t$，同时生存的变量数量（称为寄存器压力或生存数）不得超过可用寄存器的数量。设 $L(t)$ 为点 $t$ 的生存数。\n$$L(t) = \\sum_{v \\in V} \\mathbb{I}(t \\in [s_v, e_v))$$\n其中 $\\mathbb{I}(\\cdot)$ 是指示函数，当其参数为真时为 $1$，否则为 $0$。\n基准系统是可行的，当且仅当 $\\forall t, L_{base}(t) \\le k$，其中 $L_{base}(t)$ 是进行任何合并之前的生存数。\n\n副本合并将两个由副本指令相关的 SSA 名字（例如 $u$ 和 $v$）合并。问题将此操作建模为：用其非重叠生存期区间 $[s_u, e_u)$ 和 $[s_v, e_v)$ 的凸包所对应的单一新区间来替换它们。不失一般性地假设 $e_u \\le s_v$，新区间为 $[\\min(s_u, s_v), \\max(e_u, e_v)) = [s_u, e_v)$。\n\n此操作会影响生存数。最初，两个变量 $u$ 和 $v$ 仅在它们各自的区间内对生存数有贡献。合并后，新变量在整个凸包 $[s_u, e_v)$ 内都对生存数有贡献。生存状态的变化发生在原始区间之间的“空洞”或“桥接”区间，即 $[e_u, s_v)$。在这个桥接区间内，生存数恰好增加 $1$。对于原始区间 $[s_u, e_u)$ 或 $[s_v, e_v)$ 内的点，生存数不变，因为一个新的生存变量取代了一个旧的生存变量。对于凸包 $[s_u, e_v)$ 之外的点，生存数也不变。\n\n现在，考虑一组用于同步合并的候选对 $C = \\{(u_1, v_1), (u_2, v_2), \\dots, (u_m, v_m)\\}$。设每个对 $P_i = (u_i, v_i)$ 的桥接区间为 $B_i = [\\min(e_{u_i}, e_{v_i}), \\max(s_{u_i}, s_{v_i}))。当 $C$ 中的所有对都合并后，在点 $t$ 处生存数的总增量，记为 $\\Delta_C(t)$，等于包含 $t$ 的桥接区间（来自集合 $\\{B_i\\}_{i=1}^m$）的数量。即使 $C$ 中的对共享变量，此结论也成立，因为合并相应变量的等价类会桥接其所有组成区间之间的所有间隙。生存数的总增量为：\n$$\\Delta_C(t) = \\sum_{P_i = (u_i, v_i) \\in C} \\mathbb{I}(t \\in B_i)$$\n合并 $C$ 中的对之后，新的生存数为 $L_{new}(t) = L_{base}(t) + \\Delta_C(t)$。\n\n合并集 $C$ 违反线性扫描可行性约束，当且仅当存在至少一个点 $t$，使得新的生存数超过 $k$。这给出了违规的充要条件：\n$$\\exists t \\text{ 使得 } L_{base}(t) + \\sum_{(u,v) \\in C} \\mathbb{I}(t \\in [\\min(e_u, e_v), \\max(s_u, s_v))) > k$$\n等价地，一组合并 $C$ 是有效的，当且仅当对于所有点 $t$：\n$$L_{base}(t) + \\sum_{(u,v) \\in C} \\mathbb{I}(t \\in [\\min(e_u, e_v), \\max(s_u, s_v))) \\le k$$\n\n### 第二部分：应用于具体实例\n\n我们将推导出的条件应用于给定的问题实例。\n可用寄存器数量为 $k=3$。\n基准生存期区间为：$x_1: [1,3)$, $x_2: [2,5)$, $x_3: [4,7)$, $x_4: [6,9)$, $x_5: [8,11)$, $x_6: [10,13)$，以及 $y_1: [3,10)$。\n\n首先，我们计算相关点的基准生存数 $L_{base}(t)$。生存数仅在区间的端点处发生变化。\n- $t \\in [1,2)$: $\\{x_1\\}$ 生存。$L_{base}(t)=1$。\n- $t \\in [2,3)$: $\\{x_1, x_2\\}$ 生存。$L_{base}(t)=2$。\n- $t \\in [3,4)$: $\\{x_2, y_1\\}$ 生存。$L_{base}(t)=2$。\n- $t \\in [4,5)$: $\\{x_2, y_1, x_3\\}$ 生存。$L_{base}(t)=3$。\n- $t \\in [5,6)$: $\\{y_1, x_3\\}$ 生存。$L_{base}(t)=2$。\n- $t \\in [6,7)$: $\\{y_1, x_3, x_4\\}$ 生存。$L_{base}(t)=3$。\n- $t \\in [7,8)$: $\\{y_1, x_4\\}$ 生存。$L_{base}(t)=2$。\n- $t \\in [8,9)$: $\\{y_1, x_4, x_5\\}$ 生存。$L_{base}(t)=3$。\n- $t \\in [9,10)$: $\\{y_1, x_5\\}$ 生存。$L_{base}(t)=2$。\n- $t \\in [10,11)$: $\\{x_5, x_6\\}$ 生存。$L_{base}(t)=2$。\n- $t \\in [11,13)$: $\\{x_6\\}$ 生存。$L_{base}(t)=1$。\n\n基准配置是可行的，因为 $\\max_t L_{base}(t) = 3 = k$。\n\n用于合并的候选对及其对应的桥接区间是：\n- $P_1 = (x_1,x_3)$: 桥接区间 $B_1 = [3,4)$。\n- $P_2 = (x_2,x_4)$: 桥接区间 $B_2 = [5,6)$。\n- $P_3 = (x_3,x_5)$: 桥接区间 $B_3 = [7,8)$。\n- $P_4 = (x_4,x_6)$: 桥接区间 $B_4 = [9,10)$。\n- $P_5 = (x_1,x_4)$: 桥接区间 $B_5 = [3,6)$。\n- $P_6 = (x_2,x_5)$: 桥接区间 $B_6 = [5,8)$。\n\n一组合并 $C$ 是有效的，如果 $\\forall t, \\sum_{P_j \\in C} \\mathbb{I}(t \\in B_j) \\le k - L_{base}(t)$。\n项 $R(t) = k - L_{base}(t)$ 表示在点 $t$ 处增加寄存器压力的可用“裕量”。\n我们有 $k=3$。关键区域是 $L_{base}(t)=3$ 的地方，因为在这些地方裕量 $R(t)=0$。任何在这些区域增加生存状态的合并都是无效的。\n高压力区间是：\n- $H_1 = [4,5)$，其中 $L_{base}(t)=3$ 因而 $R(t)=0$。\n- $H_2 = [6,7)$，其中 $L_{base}(t)=3$ 因而 $R(t)=0$。\n- $H_3 = [8,9)$，其中 $L_{base}(t)=3$ 因而 $R(t)=0$。\n\n对于任何有效的合并集 $C$，我们必须有 $\\sum_{P_j \\in C} \\mathbb{I}(t \\in B_j) = 0$ 对于任何 $t \\in H_1 \\cup H_2 \\cup H_3$。这意味着与所选对相关联的桥接区间不能与这些高压力区域重叠。\n\n让我们检查候选对：\n- $P_5$: 其桥接区间 $B_5 = [3,6)$ 包含了区间 $[4,5) = H_1$。因此，合并 $P_5$ 是无效的，因为对于任何 $t \\in [4,5)$，$L_{new}(t) = L_{base}(t) + 1 = 3 + 1 = 4 > k$。所以 $P_5$ 不能在任何有效集合中。\n- $P_6$: 其桥接区间 $B_6 = [5,8)$ 包含了区间 $[6,7) = H_2$。因此，合并 $P_6$ 是无效的，因为对于任何 $t \\in [6,7)$，$L_{new}(t) = L_{base}(t) + 1 = 3 + 1 = 4 > k$。所以 $P_6$ 不能在任何有效集合中。\n\n必须排除对 $P_5$ 和 $P_6$。因此，合并的最大数量最多为剩余集合的大小，即 $\\{P_1, P_2, P_3, P_4\\}$。这个集合的大小是 $4$。让我们测试是否可以同时合并所有四个对 $P_1, P_2, P_3, P_4$。\n设 $C' = \\{P_1, P_2, P_3, P_4\\}$。桥接区间为 $B_1=[3,4)$, $B_2=[5,6)$, $B_3=[7,8)$, $B_4=[9,10)$。\n\n这四个桥接区间相互不交。因此，对于任何点 $t$，最多只有一个桥接区间是活跃的。这意味着总生存数增量 $\\Delta_{C'}(t) = \\sum_{j=1}^4 \\mathbb{I}(t \\in B_j)$ 要么是 $0$ 要么是 $1$。\n有效性条件 $L_{base}(t) + \\Delta_{C'}(t) \\le 3$ 仅在某个 $t$ 满足 $\\Delta_{C'}(t)=1$ 且 $L_{base}(t)=3$ 时被违反。\n这意味着我们需要检查是否有任何桥接区间 $B_1, B_2, B_3, B_4$ 与高压力区域 $H_1, H_2, H_3$ 重叠。\n- $B_1 = [3,4)$，不与 $[4,5), [6,7), [8,9)$ 重叠。\n- $B_2 = [5,6)$，不与 $[4,5), [6,7), [8,9)$ 重叠。\n- $B_3 = [7,8)$，不与 $[4,5), [6,7), [8,9)$ 重叠。\n- $B_4 = [9,10)$，不与 $[4,5), [6,7), [8,9)$ 重叠。\n\n$C'$ 中各对的桥接区间都没有跨越最大压力的区域。\n为了完全严谨，我们检查每个桥接区间内的压力：\n- 对于 $t \\in B_1=[3,4)$，$L_{base}(t)=2$。$L_{new}(t) = 2+1=3 \\le k$。有效。\n- 对于 $t \\in B_2=[5,6)$，$L_{base}(t)=2$。$L_{new}(t) = 2+1=3 \\le k$。有效。\n- 对于 $t \\in B_3=[7,8)$，$L_{base}(t)=2$。$L_{new}(t) = 2+1=3 \\le k$。有效。\n- 对于 $t \\in B_4=[9,10)$，$L_{base}(t)=2$。$L_{new}(t) = 2+1=3 \\le k$。有效。\n\n由于所有条件都满足，集合 $C' = \\{P_1, P_2, P_3, P_4\\}$ 是一组有效的同步合并。这个集合的大小是 $4$。由于我们已经排除了所有可能性，并且不能包含 $P_5$ 或 $P_6$，因此可以同时合并的对的最大数量是 $4$。", "answer": "$$\\boxed{4}$$", "id": "3671345"}, {"introduction": "消除静态单赋值（SSA）形式通常会产生并行副本，其中一些会形成难以顺序实现的循环。本练习探讨了这样一种场景，展示了副本合并如何简化这些循环依赖，但未必总能消除对临时变量的需求。这突出了副本合并与代码生成结构性挑战之间的相互作用。[@problem_id:3671347]", "problem": "您正在优化寄存器到寄存器的移动，这些移动是在控制流连接点消除静态单赋值 (SSA) 形式的 $\\phi$ 函数时产生的。在一个块边界上的 $\\phi$ 函数消除会产生一组单一的同时并行复制，其精确语义是：在同一个抽象点，所有的右侧值都从前一状态读取，而所有的左侧值都写入后一状态。因此：\n- 并行复制集为 $P=\\{a \\rightarrow b,\\ b \\rightarrow c,\\ c \\rightarrow a\\}$。\n- 一个合法的实现必须使用一个有限的普通移动序列来完成 $P$，其中每个普通移动 $x \\leftarrow y$ 会用 $y$ 的当前值破坏性地覆盖 $x$。\n- 由于普通移动不是同时发生的，除非使用新的临时变量进行额外的重命名，否则覆盖操作可能会破坏一个需要的源值。\n\n在对 $P$ 进行线性化之前，您被允许执行副本合并：\n- 两个名称当且仅当它们的活跃范围不重叠时，才可以合并（即合并分配到同一位置），也就是说，它们在冲突图中不冲突。\n- 合并具有传递性：如果 $x$ 与 $y$ 合并，且 $y$ 与 $z$ 合并，那么 $x$ 也与 $z$ 合并，并且一个合并集内的每一对都必须保持两两不冲突。\n\n假设存在以下活跃性事实，这些事实与 $P$ 执行边界处的标准 SSA 活跃性一致：\n- 在 $\\{a,b,c\\}$ 中唯一冲突的一对是 $\\{a,c\\}$，这意味着 $a$ 和 $c$ 在并行复制点之外的某个点上具有重叠的活跃范围。因此 $a$ 和 $c$ 不能合并。\n- 对 $\\{a,b\\}$ 和 $\\{b,c\\}$ 是不冲突的，所以它们中的任何一对都可以单独合并，但它们不能同时合并，因为这将意味着 $a$ 和 $c$ 被间接合并，从而违反了传递性不冲突的规则。\n\n您可以根据需要引入任意数量的新临时变量，但您的目标是最小化它们的数量。在这些约束条件下，在执行您选择的任何合法合并后，将并行复制集 $P$ 实现为有效的普通移动序列所需的新临时变量的最小数量是多少？请以单个整数形式给出您的答案。无需四舍五入，也不涉及单位。", "solution": "问题要求找到实现一个给定的并行复制集所需的最小新临时变量数量，这可能是在应用了副本合并优化之后。\n\n初始并行复制集为 $P = \\{a \\rightarrow b, b \\rightarrow c, c \\rightarrow a\\}$。这个表示法意味着我们必须同时执行赋值操作 $b \\leftarrow (\\text{old } a)$、$c \\leftarrow (\\text{old } b)$ 和 $a \\leftarrow (\\text{old } c)$。为了分析依赖关系，我们可以将其建模为一个有向图，其中一条边 $u \\rightarrow v$ 表示变量 $u$ 的值必须被复制到变量 $v$。$P$ 的图包含变量 $\\{a, b, c\\}$作为节点，以及代表复制操作的边。这构成了一个长度为 3 的单一有向环：$a \\rightarrow b \\rightarrow c \\rightarrow a$。\n\n编译器理论中关于并行复制线性化的一个基本结论是：任何形成有向无环图 (DAG) 的复制集都可以通过一系列普通移动来实现，而无需任何临时变量。然而，如果图中包含一个或多个环，则每个环至少需要一个临时变量来打破循环依赖。一个长度为 $k \\ge 2$ 的简单环可以使用一个临时变量来打破。\n\n我们将分析在问题陈述所允许的所有合法优化场景下所需的临时变量数量。\n\n情况 1：不执行副本合并。\n并行复制集保持为 $P = \\{a \\rightarrow b, b \\rightarrow c, c \\rightarrow a\\}$，这是一个 3-环。要用顺序的、破坏性的移动来实现它，我们必须在其中一个值被覆盖之前保存它。设 $t$ 为一个新的临时变量。一个可能的有效普通移动序列是：\n1. $t \\leftarrow a$ (保存 $a$ 的值)\n2. $a \\leftarrow c$ (现在 $a$ 的旧值被覆盖了，但我们已经把它保存在 $t$ 中)\n3. $c \\leftarrow b$\n4. $b \\leftarrow t$ (将保存的 $a$ 的值赋给 $b$)\n这个序列正确地实现了 $P$，并且恰好需要一个临时变量。\n\n情况 2：执行合法的副本合并。\n问题提供了限制哪些变量可以合并的活跃性信息。合并意味着将两个变量分配到同一个物理位置（例如，同一个寄存器）。这仅在它们的活跃范围不重叠，即它们不冲突的情况下才是合法的。\n给定的冲突事实是：\n- 对 $\\{a, c\\}$ 冲突，所以它们不能合并。\n- 对 $\\{a, b\\}$ 不冲突。\n- 对 $\\{b, c\\}$ 不冲突。\n\n我们还被告知，我们不能同时合并 $\\{a, b\\}$ 和 $\\{b, c\\}$，因为合并是传递性的。如果我们合并了 $\\{a, b\\}$ 和 $\\{b, c\\}$，那就意味着 $a$ 和 $c$ 也被合并了，这是不允许的。因此，我们有两个不同的合并选择。\n\n子情况 2a：合并对 $\\{a, b\\}$。\n我们将 $a$ 和 $b$ 合并为一个单一变量。这可以通过在并行复制集 $P$ 中用 $a$ 替换所有 $b$ 的实例来建模。\n- 复制 $a \\rightarrow b$ 变成 $a \\rightarrow a$，这是一个空操作，被消除了。\n- 复制 $b \\rightarrow c$ 变成 $a \\rightarrow c$。\n- 复制 $c \\rightarrow a$ 保持不变。\n得到的并行复制集是 $P' = \\{a \\rightarrow c, c \\rightarrow a\\}$。这表示 $a$ 和 $c$ 之间的交换。依赖图是一个 2-环：$a \\rightarrow c \\rightarrow a$。与任何长度 $k \\ge 2$ 的环一样，这需要一个临时变量来实现。一个有效的序列是：\n1. $t \\leftarrow a$\n2. $a \\leftarrow c$\n3. $c \\leftarrow t$\n这个实现需要一个临时变量。\n\n子情况 2b：合并对 $\\{b, c\\}$。\n我们合并 $b$ 和 $c$，这可以通过用 $b$ 替换所有 $c$ 的实例来建模。\n- 复制 $a \\rightarrow b$ 保持不变。\n- 复制 $b \\rightarrow c$ 变成 $b \\rightarrow b$，这是一个空操作，被消除了。\n- 复制 $c \\rightarrow a$ 变成 $b \\rightarrow a$。\n得到的并行复制集是 $P'' = \\{a \\rightarrow b, b \\rightarrow a\\}$。这表示 $a$ 和 $b$ 之间的交换。依赖图是一个 2-环：$a \\rightarrow b \\rightarrow a$。这也需要一个临时变量来实现：\n1. $t \\leftarrow a$\n2. $a \\leftarrow b$\n3. $b \\leftarrow t$\n这个实现也需要一个临时变量。\n\n结果总结：\n- 不进行合并：需要 1 个临时变量。\n- 合并 $\\{a, b\\}$：需要 1 个临时变量。\n- 合并 $\\{b, c\\}$：需要 1 个临时变量。\n\n所有可能的合法选择（包括不采取任何操作）都导致需要恰好一个临时变量的情况。最小临时变量数是通过在所有这些结果中取最小值来找到的。由于所有结果都要求 1 个临时变量，所以最小值是 1。通过允许的合并操作无法消除循环依赖，尽管它可以从一个 3-环减少到一个 2-环。", "answer": "$$\n\\boxed{1}\n$$", "id": "3671347"}, {"introduction": "编译器优化最终是为了提升性能，这通常涉及到权衡取舍。最后一个练习提出了一个现实场景，我们必须在合并副本（可能导致寄存器溢出）和使用如重新物化（rematerialization）等替代策略之间做出抉择。通过基于程序剖析数据计算预期的动态成本，我们可以做出一个有根据的、数据驱动的优化决策。[@problem_id:3671373]", "problem": "考虑一种静态单赋值（SSA）形式的中间表示（IR），其中一个控制流汇合点形成一个 $\\phi$ 节点，该节点合并了一个常量和一个变量：\n- 前驱 $P_v$（热前驱）计算一个变量 $v$。\n- 前驱 $P_c$（冷前驱）提供一个常量 $c$。\n- 在汇合块 $J$ 中，我们有 $x \\leftarrow \\phi(c, v)$。\n- 然后，块 $J$ 执行一个包含 $u$ 次 $x$ 的使用的直线序列（没有中间的控制流），之后 $x$ 死亡。\n\n假设以下目标成本和剖析模型：\n- 从 $P_v$ 到 $J$ 的边每次运行执行 $f_v$ 次，其中 $f_v = 1000$。\n- 从 $P_c$ 到 $J$ 的边每次运行执行 $f_c$ 次，其中 $f_c = 10$。\n- 汇合块 $J$ 每次运行执行 $f_J = f_v + f_c$ 次，其中 $f_J = 1010$。\n- 在 $J$ 中 $x$ 的使用次数为 $u = 3$。\n- 一次寄存器到寄存器的复制成本为 $c_{\\mathrm{mov}} = 1$（例如，如果在热边上 $x$ 没有与 $v$ 合并，则在热边 $v \\to x$ 上降低一个 $\\phi$ 并行复制）。\n- 将 $c$ 物化到一个寄存器中（立即数移动）的成本为 $c_{\\mathrm{imm}} = 1$。\n- 在 $J$ 中使用 $x$ 的每条指令，当值为常量 $c$ 时，都可以等效地使用立即数形式，相对于使用寄存器操作数，没有额外的延迟或代码大小惩罚，即，在一次使用中将 $c$ 作为立即数使用的额外成本为 $0$，相比于从寄存器中使用 $x$。\n- 在不进行合并的情况下，分配器可以在 $J$ 中容纳所有活跃范围而无需溢出。如果我们合并 $x$ 和 $v$，$v$ 的活跃范围会扩展以覆盖 $J$ 中的所有 $u$ 次使用，这将使 $J$ 中的瞬时寄存器压力增加 $1$，并导致每次执行 $J$ 时恰好发生一次溢出-重载对；每次溢出-重载对的动态成本为 $c_{\\mathrm{spill}} = 3$。\n\n考虑两种实现策略：\n- 策略 $\\mathsf{COAL}$：基于 SSA 的副本合并将 $x$ 和 $v$ 分配给同一个寄存器（将常量载体与变量合并）。这消除了热边 $P_v \\to J$ 上的副本。在冷边 $P_c \\to J$ 上，我们必须在该边每次执行时将 $c$ 物化到 $v$ 的寄存器中。由于 $J$ 中 $v$ 的活跃范围延长，每次执行 $J$ 都会发生一次溢出-重载对。\n- 策略 $\\mathsf{REMAT}$：不合并 $x$ 和 $v$。通过在热边插入一个副本 $v \\to x$ 来降低 $\\phi$，而在冷边上，不将 $c$ 移动到 $x$ 中；相反，在 $J$ 的每次使用处，对于那些从 $P_c$ 到达的动态执行，通过选择指令的立即数操作数形式来重新物化 $c$。在此策略下，$J$ 中的活跃集合相对于基线保持不变，不会发生额外的溢出。\n\n根据上述模型，以下哪项是对哪种策略能最小化预期动态成本的正确评估，以及为什么？\n\nA. 选择 $\\mathsf{COAL}$。其总预期成本为 $f_c \\cdot c_{\\mathrm{imm}} = 10$，因为它移除了 $f_v \\cdot c_{\\mathrm{mov}}$ 的热边副本；溢出成本不变，因为 $v$ 在 $J$ 中已经是活跃的。\n\nB. 选择 $\\mathsf{REMAT}$。其总预期成本为 $f_v \\cdot c_{\\mathrm{mov}} = 1000$，没有溢出开销，这低于 $\\mathsf{COAL}$ 的成本 $f_c \\cdot c_{\\mathrm{imm}} + f_J \\cdot c_{\\mathrm{spill}} = 10 + 1010 \\cdot 3$。\n\nC. 当且仅当 $c$ 适合指令的立即数字段时，才选择 $\\mathsf{COAL}$；由于它确实适合，$\\mathsf{COAL}$ 在这种情况下严格优于 $\\mathsf{REMAT}$。\n\nD. 两种策略的成本基本相等，因为在 $\\phi$ 节点之后只有 $u = 3$ 次对 $x$ 的使用，因此在任何一条路径上差异都可以忽略不计。", "solution": "我们从静态单赋值（SSA）的核心定义和标准的 $\\phi$-消除开始。一个在汇合点的 $\\phi$ 节点 $x \\leftarrow \\phi(c, v)$ 的语义是：如果控制流来自 $P_c$，则 $x$ 的值等于 $c$；如果控制流来自 $P_v$，则 $x$ 的值等于 $v$。在传统的降低过程中，这会变成一组放置在入边上的并行副本：在 $P_v \\to J$ 上，是一个副本 $v \\to x$；在 $P_c \\to J$ 上，是一个将 $c$ 产生到 $x$ 中的定义（通常是一个立即数移动）。基于 SSA 的副本合并尝试将相同的物理寄存器分配给 $x$ 和 $v$ 以消除热边副本，但这会扩展 $v$ 的活跃范围穿过 $J$，可能增加冲突并导致溢出。\n\n给定成本模型，我们比较两种策略的预期动态成本。\n\n定义以下量：\n- $f_v = 1000$, $f_c = 10$, $f_J = 1010$。\n- $u = 3$。\n- $c_{\\mathrm{mov}} = 1$, $c_{\\mathrm{imm}} = 1$, $c_{\\mathrm{spill}} = 3$。\n\n计算每种策略的成本。\n\n1) 策略 $\\mathsf{COAL}$：\n- 消除热边副本：通过合并 $x$ 与 $v$，边 $P_v \\to J$ 上的副本 $v \\to x$ 被移除。移除的成本是 $f_v \\cdot c_{\\mathrm{mov}} = 1000 \\cdot 1 = 1000$。然而，我们将计算绝对产生的成本并进行比较；在一个策略中消除一个成本等同于在这里不支付它。\n- 冷边物化：为确保 $x$（现在与 $v$ 是同一个寄存器）在冷边上持有 $c$，我们必须在 $P_c \\to J$ 上插入一个将 $c$ 立即数移动到 $v$ 寄存器的操作。这产生的成本是 $f_c \\cdot c_{\\mathrm{imm}} = 10 \\cdot 1 = 10$。\n- 由于活跃范围延长导致的溢出-重载：合并操作将 $v$ 的活跃范围扩展至 $J$ 中的所有 $u$ 次使用，增加了瞬时压力，并且根据前提，每次执行 $J$ 会强制产生恰好一次溢出-重载对。动态成本为 $f_J \\cdot c_{\\mathrm{spill}} = 1010 \\cdot 3 = 3030$。\n- $\\mathsf{COAL}$ 的总成本：\n$$\nC_{\\mathsf{COAL}} = f_c \\cdot c_{\\mathrm{imm}} + f_J \\cdot c_{\\mathrm{spill}} = 10 + 3030 = 3040.\n$$\n\n2) 策略 $\\mathsf{REMAT}$：\n- 保留热边副本：不进行合并，边 $P_v \\to J$ 必须执行副本操作 $v \\to x$，成本为 $f_v \\cdot c_{\\mathrm{mov}} = 1000 \\cdot 1 = 1000$。\n- 通过在使用处重新物化来处理冷边：不在 $P_c \\to J$ 上定义 $x$；而是在 $J$ 中的每次使用时，当动态流来自 $P_c$ 时，选择指令的立即数形式。根据前提，选择立即数形式相对于使用寄存器会产生 $0$ 的额外成本，所以冷边的贡献为 $0$，并且在 $J$ 中除了基本操作外没有额外的工作。\n- 寄存器压力：由于不将 $v$ 的活跃范围扩展到 $J$ 中，没有溢出发生。因此溢出成本为 $0$。\n- $\\mathsf{REMAT}$ 的总成本：\n$$\nC_{\\mathsf{REMAT}} = f_v \\cdot c_{\\mathrm{mov}} = 1000.\n$$\n\n比较：\n$$\nC_{\\mathsf{REMAT}} = 1000 \\quad \\text{对比} \\quad C_{\\mathsf{COAL}} = 3040,\n$$\n因此，在给定模型下，$\\mathsf{REMAT}$ 严格更优。\n\n基于原则的解释：从 SSA 和冲突的第一性原理来看，如果热路径副本节省的成本超过 (i) 任何冷边常量物化成本和 (ii) 由活跃范围扩展引起的任何溢出开销的总和，那么合并是有益的。用符号代数地表示，\n$$\n\\text{当} \\quad f_v \\cdot c_{\\mathrm{mov}} > f_c \\cdot c_{\\mathrm{imm}} + f_J \\cdot c_{\\mathrm{spill}} \\quad \\text{时，合并是有益的。}\n$$\n这里，我们有\n$$\nf_v \\cdot c_{\\mathrm{mov}} = 1000, \\quad f_c \\cdot c_{\\mathrm{imm}} + f_J \\cdot c_{\\mathrm{spill}} = 10 + 3030 = 3040,\n$$\n因此不等式不成立，支持重新物化。\n\n逐个选项分析：\n- 选项 A：不正确。它忽略了规定的溢出-重载成本 $f_J \\cdot c_{\\mathrm{spill}} = 3030$。声称溢出成本不变的说法与前提相矛盾，前提是合并会增加压力并在每次执行 $J$ 时强制产生一次溢出-重载。\n- 选项 B：正确。它正确地计算了 $C_{\\mathsf{REMAT}} = f_v \\cdot c_{\\mathrm{mov}} = 1000$，并将其与 $C_{\\mathsf{COAL}} = f_c \\cdot c_{\\mathrm{imm}} + f_J \\cdot c_{\\mathrm{spill}} = 10 + 1010 \\cdot 3 = 3040$ 进行比较，得出 $\\mathsf{REMAT}$ 更好的结论。\n- 选项 C：不正确。$c$ 是否适合立即数字段会影响重新物化的可行性和成本，但本身并不意味着合并策略占优。即使立即数可用，溢出项 $f_J \\cdot c_{\\mathrm{spill}}$ 也可能远超热边副本节省的成本。\n- 选项 D：不正确。在此模型中，使用次数 $u$ 不是决定性因素；主导成本是热边副本频率 $f_v$ 和溢出开销 $f_J \\cdot c_{\\mathrm{spill}}$。在这里，尽管 $u=3$，两种策略的预期动态成本差异巨大。", "answer": "$$\\boxed{B}$$", "id": "3671373"}]}